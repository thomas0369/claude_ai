import { NextRequest, NextResponse } from 'next/server';
import { PythonExecutor } from '@/lib/python-executor';
import { isValidUUID } from '@/lib/api-validation-utils';
import path from 'path';

// Disable response caching for SSE
export const dynamic = 'force-dynamic';
export const runtime = 'nodejs';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { productIds } = body;

    // Validate: productIds must exist and be non-empty array
    if (!productIds || !Array.isArray(productIds) || productIds.length === 0) {
      return NextResponse.json(
        { error: 'No product IDs provided', message: 'productIds must be a non-empty array' },
        { status: 400 }
      );
    }

    // Validate: array length limit (max 100 products per import)
    if (productIds.length > 100) {
      return NextResponse.json(
        {
          error: 'Too many products',
          message: `Maximum 100 products allowed per import, received ${productIds.length}`
        },
        { status: 400 }
      );
    }

    // Validate: each productId must be a valid UUID
    const invalidIds: string[] = [];
    for (const id of productIds) {
      if (!isValidUUID(id)) {
        invalidIds.push(id);
      }
    }

    if (invalidIds.length > 0) {
      return NextResponse.json(
        {
          error: 'Invalid product IDs',
          message: `${invalidIds.length} invalid UUID(s) found`,
          invalidIds: invalidIds.slice(0, 5) // Show first 5 invalid IDs
        },
        { status: 400 }
      );
    }

    // Validate: check for duplicate IDs
    const uniqueIds = new Set(productIds);
    if (uniqueIds.size !== productIds.length) {
      return NextResponse.json(
        {
          error: 'Duplicate product IDs',
          message: `Found ${productIds.length - uniqueIds.size} duplicate ID(s)`
        },
        { status: 400 }
      );
    }

    // Get repo root for output directory
    const REPO_ROOT = process.env.REPO_ROOT || path.join(process.cwd(), '..');

    // Create SSE stream using Python Executor
    const stream = PythonExecutor.createStreamingResponse({
      scriptName: 'zerez_detail_importer.py',
      args: [
        '--product-ids', JSON.stringify(productIds),
        '--output-dir', path.join(REPO_ROOT, 'data', 'zerez', 'imports'),
        '--stream-progress'
      ]
    });

    return new Response(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache, no-transform',
        'Connection': 'keep-alive',
        'X-Accel-Buffering': 'no', // Disable Nginx buffering
      },
    });
  } catch (error) {
    return NextResponse.json(
      {
        error: 'Internal server error',
        message: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}
