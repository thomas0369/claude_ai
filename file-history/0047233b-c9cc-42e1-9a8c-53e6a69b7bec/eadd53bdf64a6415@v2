#!/usr/bin/env python3
"""
Simple test to demonstrate local Claude CLI integration.

This shows exactly how the app calls Claude locally without any API.
"""

import subprocess
import json

def test_local_claude_cli():
    """Test that local Claude CLI works."""

    print("Testing local Claude CLI integration...")
    print("=" * 80)

    # This is a simple test prompt
    test_prompt = """You are a trading expert. Analyze this setup and respond with JSON.

Market: EUR/USD
Price: 1.0850
Signal: LONG
Score: 125/194

Respond with this JSON format:
{
  "signal": "buy",
  "confidence": 0.85,
  "justification": "Your reasoning here",
  "wave_count": "Wave 3 of Wave 5",
  "exit_plan": {
    "stop_loss": 1.0817,
    "take_profit": 1.1119,
    "invalidation_level": 1.0750,
    "invalidation_reason": "Your reason here"
  }
}
"""

    print("Sending prompt to Claude CLI...")
    print("-" * 80)

    try:
        # This is exactly what the app does
        result = subprocess.run(
            ["claude"],  # Just call 'claude' - uses local config
            input=test_prompt,
            capture_output=True,
            text=True,
            timeout=30
        )

        if result.returncode != 0:
            print(f"ERROR: Claude CLI failed")
            print(f"Error message: {result.stderr}")
            return False

        print("Response received!")
        print("-" * 80)
        print(result.stdout)
        print("-" * 80)

        # Try to parse JSON
        response_text = result.stdout.strip()

        # Remove markdown code blocks if present
        if response_text.startswith("```json"):
            response_text = response_text[7:]
        elif response_text.startswith("```"):
            response_text = response_text[3:]

        if response_text.endswith("```"):
            response_text = response_text[:-3]

        response_text = response_text.strip()

        # Extract JSON
        json_start = response_text.find('{')
        json_end = response_text.rfind('}') + 1

        if json_start != -1 and json_end > 0:
            json_text = response_text[json_start:json_end]
            decision = json.loads(json_text)

            print("\nParsed decision:")
            print(json.dumps(decision, indent=2))
            print("\n✅ Test successful! Claude CLI is working.")
            return True
        else:
            print("\n⚠️ Response received but couldn't find JSON")
            return False

    except subprocess.TimeoutExpired:
        print("ERROR: Claude CLI timed out after 30 seconds")
        return False
    except FileNotFoundError:
        print("ERROR: 'claude' command not found in PATH")
        print("\nMake sure Claude CLI is installed and accessible.")
        print("Try running 'claude --version' in your terminal.")
        return False
    except Exception as e:
        print(f"ERROR: {e}")
        return False


if __name__ == "__main__":
    success = test_local_claude_cli()
    exit(0 if success else 1)
