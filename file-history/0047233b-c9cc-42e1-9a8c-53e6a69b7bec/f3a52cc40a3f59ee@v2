# Local Claude CLI Architecture - No API Calls

## Visual Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                     YOUR LOCAL MACHINE                          │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  Python Trading Bot (claude_trading_bot.py)               │ │
│  │                                                           │ │
│  │  1. Run Screener                                          │ │
│  │     └─→ EUR/USD: Score 125/194 ✅ Tradeable              │ │
│  │                                                           │ │
│  │  2. Build Prompt                                          │ │
│  │     └─→ Nof1-style prompt with:                          │ │
│  │         - Multi-timeframe data (oldest → newest)         │ │
│  │         - Screening score breakdown                      │ │
│  │         - Account state & trade history                  │ │
│  │                                                           │ │
│  │  3. Call Local Claude CLI                                │ │
│  │     ┌──────────────────────────────────────┐             │ │
│  │     │  subprocess.run(["claude"])          │             │ │
│  │     │  input = prompt                      │             │ │
│  │     │  capture_output = True               │             │ │
│  │     └──────────────────────────────────────┘             │ │
│  │                    │                                     │ │
│  │                    ↓                                     │ │
│  └────────────────────┼─────────────────────────────────────┘ │
│                       │                                       │
│  ┌────────────────────┼─────────────────────────────────────┐ │
│  │  Local Claude CLI  │                                     │ │
│  │                    ↓                                     │ │
│  │  ┌─────────────────────────────────────────────┐        │ │
│  │  │  Receives prompt via stdin                  │        │ │
│  │  │  Analyzes Elliott Wave setup                │        │ │
│  │  │  Generates JSON response                    │        │ │
│  │  │  Returns via stdout                         │        │ │
│  │  └─────────────────────────────────────────────┘        │ │
│  │                    │                                     │ │
│  │                    ↓                                     │ │
│  └────────────────────┼─────────────────────────────────────┘ │
│                       │                                       │
│  ┌────────────────────┼─────────────────────────────────────┐ │
│  │  Python Trading Bot│                                     │ │
│  │                    ↓                                     │ │
│  │  4. Parse Response                                      │ │
│  │     └─→ Extract JSON from Claude's output              │ │
│  │                                                         │ │
│  │  5. Validate Decision                                  │ │
│  │     └─→ Check required fields (signal, confidence...)  │ │
│  │                                                         │ │
│  │  6. Execute Decision                                   │ │
│  │     └─→ [PAPER TRADE] Opening LONG EUR/USD            │ │
│  │         Entry: 1.0850                                  │ │
│  │         Stop: 1.0817                                   │ │
│  │         Target: 1.1119                                 │ │
│  │                                                         │ │
│  │  7. Store Trade + LLM Reasoning                        │ │
│  │     └─→ data/llm_trade_history.json                   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

                    NO INTERNET REQUIRED
                    NO API KEYS NEEDED
                    NO API CHARGES
```

---

## Equivalent Terminal Commands

What the app does is essentially:

### Manual Way (What you'd do yourself):
```bash
# 1. Screen for signals
python src/screener.py

# 2. Copy market data and manually type a prompt
echo "You are an Elliott Wave expert. EUR/USD is at 1.0850..." | claude

# 3. Read Claude's response
# 4. Manually enter the trade
# 5. Manually track the reasoning
```

### Automated Way (What the app does):
```bash
# All steps automated in one command
python src/claude_trading_bot.py --mode paper --method cli
```

The app just **automates the manual process** of asking Claude for trading advice!

---

## Code Snippet: The Actual CLI Call

Here's the exact code that calls Claude locally:

```python
# From src/claude_integration.py line 150-157

result = subprocess.run(
    ["claude"],              # Call 'claude' command
    input=combined_prompt,   # Send prompt via stdin
    capture_output=True,     # Capture stdout/stderr
    text=True,               # Text mode (not bytes)
    timeout=30               # 30 second timeout
)

# Claude's response is in result.stdout
response = result.stdout.strip()
```

That's it! Just like running:
```bash
echo "prompt" | claude
```

---

## Data Flow Detail

### Input to Claude (stdin):
```
You are an expert Elliott Wave trader analyzing forex, crypto, and commodity markets.

Your task: Analyze the provided market data and technical indicators to make a
high-conviction trading decision.

CRITICAL RULES:
1. Only trade when setup scores ≥75 points (out of 194)
2. Focus on fewer, larger, high-conviction positions
...

---

It has been 45 minutes since you started trading.
Current UTC time: 2025-03-11T14:30:00Z

Below, we are providing you with multi-timeframe Elliott Wave analysis...

**ALL OF THE PRICE AND INDICATOR DATA BELOW IS ORDERED: OLDEST → NEWEST**

### EUR/USD DETAILED ANALYSIS

**Current State:**
current_price = 1.0850, current_ema_8 = 1.0845, current_ema_21 = 1.0840
...

**15-MINUTE TIMEFRAME (Entry Timing):**
Last 10 candles (oldest → newest):
Close prices: [1.0830, 1.0835, ..., 1.0850]
EMA 8: [1.0828, 1.0831, ..., 1.0845]
...
```

### Output from Claude (stdout):
```json
{
  "signal": "buy",
  "confidence": 0.87,
  "position_size_eur": 10.0,
  "leverage": 8,
  "justification": "Wave 3 of larger degree Wave 5 confirmed at 0.618 Fibonacci retracement with EMA confluence across all timeframes",
  "exit_plan": {
    "stop_loss": 1.0817,
    "take_profit": 1.1119,
    "invalidation_level": 1.0750,
    "invalidation_reason": "Break below Wave 4 low invalidates the impulsive count"
  },
  "wave_count": "Wave 3 of larger degree Wave 5",
  "risk_reward_ratio": 2.618,
  "concerns": "ADX weakening slightly on 4H timeframe, monitor for momentum loss"
}
```

---

## File Locations

### Generated Prompts (for debugging):
```
data/prompts/EUR_USD_20250311_143000.txt
```
This shows exactly what Claude received.

### Trade History (with Claude's reasoning):
```
data/llm_trade_history.json
```
Contains all trades with Claude's original justification and wave count.

### Hold Decisions (when Claude says "hold"):
```
data/hold_decisions.jsonl
```
Log of when Claude decided not to trade and why.

---

## Comparison: CLI vs API vs Simulate

| Feature | CLI (Local) | API (Cloud) | Simulate |
|---------|-------------|-------------|----------|
| Calls Claude | ✅ Yes (local) | ✅ Yes (API) | ❌ No |
| API Key Needed | ❌ No | ✅ Yes | ❌ No |
| API Charges | ❌ No | ✅ Yes | ❌ No |
| Internet Required | ⚠️ Maybe* | ✅ Yes | ❌ No |
| Speed | Medium | Fast | Instant |
| Real Analysis | ✅ Yes | ✅ Yes | ❌ No |
| Best For | Production | High volume | Testing |

*Claude CLI may need internet for authentication/updates

---

## Summary

When you run:
```bash
python src/claude_trading_bot.py --mode paper --method cli
```

The app:
1. ✅ Screens markets using your existing screener
2. ✅ Builds a comprehensive Nof1-style prompt
3. ✅ Calls `claude` command locally (like `echo "prompt" | claude`)
4. ✅ Parses Claude's JSON response
5. ✅ Executes or logs the trade
6. ✅ Stores Claude's reasoning for future reference

**Zero API calls. Zero API charges. Completely local.**
