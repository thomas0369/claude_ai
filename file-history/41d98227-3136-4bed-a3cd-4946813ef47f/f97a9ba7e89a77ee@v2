'use client';

import { useState, useEffect, useCallback } from 'react';
import Link from 'next/link';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import { Progress } from '@/components/ui/progress';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Filter,
  Download,
  Database,
  CheckCircle2,
  AlertCircle,
  Loader2,
  ArrowRight,
  ArrowLeft,
  FileText
} from 'lucide-react';
import { ZEREZUnit } from '@/lib/zerez-types';
import { enrichZEREZUnits } from '@/lib/zerez-data-utils';
import { filterValidEnumValues } from '@/lib/ui-utils';
import { consumeSSEStream, SSE_CONFIG } from '@/lib/sse-utils';
import {
  ZEREZ_IMPORT_LIMITS,
  DEFAULT_FILTERS,
  ALL_OPTIONS_SENTINEL,
  CERTIFICATE_NORMS,
  CertificateNormValue
} from '@/lib/zerez-constants';
import VirtualizedProductTable from '@/components/VirtualizedProductTable';
import { Skeleton } from '@/components/ui/skeleton';

type ZEREZUnitWithSelection = ZEREZUnit & {
  selected?: boolean;
};

type ImportStep = 'filter' | 'import' | 'match';

type ImportProgress = {
  total: number;
  downloaded: number;
  failed: number;
  saved_files: number;
  current: string;
  errors: string[];
};

type MatchResult = {
  zerezProduct: string;
  pdfMatch: string | null;
  confidence: number;
};

type Manufacturer = {
  id: string;    // UUID
  name: string;  // Manufacturer name
};

type Authority = {
  id: string;    // UUID
  name: string;  // Authority name
};

export default function ZEREZImportPage() {
  // Step management
  const [currentStep, setCurrentStep] = useState<ImportStep>('filter');

  // Enum values from GraphQL
  const [enumValues, setEnumValues] = useState<{
    primaryEnergySource: string[];
    category: string[];
  }>({
    primaryEnergySource: [],
    category: []
  });
  const [isLoadingEnums, setIsLoadingEnums] = useState(true);
  const [enumError, setEnumError] = useState<string | null>(null);

  // Manufacturers for autocomplete
  const [manufacturers, setManufacturers] = useState<Manufacturer[]>([]);
  const [isLoadingManufacturers, setIsLoadingManufacturers] = useState(true);
  const [manufacturerSearchTerm, setManufacturerSearchTerm] = useState('');
  const [manufacturerError, setManufacturerError] = useState<string | null>(null);

  // Certificate Authorities for autocomplete
  const [authorities, setAuthorities] = useState<Authority[]>([]);
  const [isLoadingAuthorities, setIsLoadingAuthorities] = useState(true);
  const [authoritySearchTerm, setAuthoritySearchTerm] = useState('');
  const [authorityError, setAuthorityError] = useState<string | null>(null);

  // Products to match with PDF (stored for step 3)
  const [, setProductsForMatching] = useState<ZEREZUnit[]>([]);

  // Step 2: Import state
  const [importProgress, setImportProgress] = useState<ImportProgress>({
    total: 0,
    downloaded: 0,
    failed: 0,
    saved_files: 0,
    current: '',
    errors: []
  });

  // Step 3: Match state
  const [matchResults, setMatchResults] = useState<MatchResult[]>([]);
  const [isMatching, setIsMatching] = useState(false);

  // Step 1: Filter state
  const defaultFilters = {
    powerMin: DEFAULT_FILTERS.POWER_MIN,
    powerMax: DEFAULT_FILTERS.POWER_MAX,
    voltageMin: DEFAULT_FILTERS.VOLTAGE_MIN,
    voltageMax: DEFAULT_FILTERS.VOLTAGE_MAX,
    primaryEnergySource: ALL_OPTIONS_SENTINEL,
    category: ALL_OPTIONS_SENTINEL,
    isVerified: DEFAULT_FILTERS.IS_VERIFIED,
    // Certificate norms with type-safe validation
    certificateNorms: [] as CertificateNormValue[],
    createdAfter: '',
    createdBefore: '',
    modifiedAfter: '',
    modifiedBefore: '',
    manufacturerId: ALL_OPTIONS_SENTINEL,
    authorityId: ALL_OPTIONS_SENTINEL
  };

  type FilterState = typeof defaultFilters;
  const [filters, setFilters] = useState<FilterState>(defaultFilters);
  const [products, setProducts] = useState<ZEREZUnitWithSelection[]>([]);
  const [totalCount, setTotalCount] = useState<number>(0);
  const [isLoadingPreview, setIsLoadingPreview] = useState(false);
  const [previewError, setPreviewError] = useState<string | null>(null);

  // UI state for collapsible sections (reserved for future progressive disclosure)
  // const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);

  // Load enum values on mount
  useEffect(() => {
    async function loadEnumValues() {
      try {
        const response = await fetch('/api/zerez/enum-values');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        setEnumValues(data);
        setEnumError(null); // Clear any previous errors
      } catch (error) {
        setEnumError(
          'Failed to load filter options from ZEREZ. Dropdown filters will show all available values when data loads.'
        );
        console.error('Failed to load enum values:', error);
      } finally {
        setIsLoadingEnums(false);
      }
    }
    loadEnumValues();
  }, []);

  // Load manufacturers and authorities in parallel for better performance
  useEffect(() => {
    async function loadManufacturersAndAuthorities() {
      // Fetch both in parallel to reduce loading time
      const [manufacturersResult, authoritiesResult] = await Promise.allSettled([
        fetch('/api/zerez/manufacturers').then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        }),
        fetch('/api/zerez/authorities').then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
      ]);

      // Handle manufacturers result
      if (manufacturersResult.status === 'fulfilled') {
        setManufacturers(manufacturersResult.value);
        setManufacturerError(null);
      } else {
        const message = 'Failed to load manufacturer list. Filter will still work with manually entered UUIDs.';
        setManufacturerError(message);
        console.error('Failed to load manufacturers:', manufacturersResult.reason);
      }
      setIsLoadingManufacturers(false);

      // Handle authorities result
      if (authoritiesResult.status === 'fulfilled') {
        setAuthorities(authoritiesResult.value);
        setAuthorityError(null);
      } else {
        const message = 'Failed to load certificate authority list. Filter will still work with manually entered UUIDs.';
        setAuthorityError(message);
        console.error('Failed to load authorities:', authoritiesResult.reason);
      }
      setIsLoadingAuthorities(false);
    }

    loadManufacturersAndAuthorities();
  }, []);

  // Step 3: Match with PDF knowledge base
  const handleMatchWithPDF = useCallback(async (importedProducts: ZEREZUnit[]) => {
    setIsMatching(true);

    try {
      const response = await fetch('/api/zerez/match-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          products: importedProducts
        })
      });

      const data = await response.json();
      setMatchResults(data.matches);
    } catch (error) {
      console.error('PDF matching failed:', error);
      setPreviewError(error instanceof Error ? error.message : 'Matching failed');
    } finally {
      setIsMatching(false);
    }
  }, []); // Empty deps array - setState functions are stable


  // Step 1: Load product preview from GraphQL
  const handlePreviewProducts = async () => {
    // Validate filters before making API call
    const validationErrors: string[] = [];

    // Validate power range (only if both values are specified)
    if (filters.powerMin !== null && filters.powerMax !== null && filters.powerMin > filters.powerMax) {
      validationErrors.push('Minimum power cannot be greater than maximum power');
    }

    // Validate voltage range (only if both values are specified)
    if (filters.voltageMin !== null && filters.voltageMax !== null && filters.voltageMin > filters.voltageMax) {
      validationErrors.push('Minimum voltage cannot be greater than maximum voltage');
    }

    if (validationErrors.length > 0) {
      setPreviewError(validationErrors.join('. '));
      return;
    }

    setIsLoadingPreview(true);
    setPreviewError(null);

    try {
      // Build request body with only non-empty values
      const requestBody: Record<string, unknown> = {
        isVerified: filters.isVerified
      };

      // Only add power filters if they're specified (not null)
      if (filters.powerMin !== null) {
        requestBody.powerMin = filters.powerMin;
      }
      if (filters.powerMax !== null) {
        requestBody.powerMax = filters.powerMax;
      }

      // Only add voltage filters if they're specified (not null)
      if (filters.voltageMin !== null) {
        requestBody.voltageMin = filters.voltageMin;
      }
      if (filters.voltageMax !== null) {
        requestBody.voltageMax = filters.voltageMax;
      }
      // Only send enum filters if they're not the "All" sentinel value
      if (filters.primaryEnergySource && filters.primaryEnergySource !== ALL_OPTIONS_SENTINEL) {
        requestBody.primaryEnergySource = filters.primaryEnergySource;
      }
      if (filters.category && filters.category !== ALL_OPTIONS_SENTINEL) {
        requestBody.category = filters.category;
      }

      // NEW: Certificate norms filter (use array directly)
      if (filters.certificateNorms && filters.certificateNorms.length > 0) {
        requestBody.certificateNorms = filters.certificateNorms;
      }

      // NEW: Date filters
      if (filters.createdAfter && filters.createdAfter.trim() !== '') {
        requestBody.createdAfter = filters.createdAfter;
      }
      if (filters.createdBefore && filters.createdBefore.trim() !== '') {
        requestBody.createdBefore = filters.createdBefore;
      }
      if (filters.modifiedAfter && filters.modifiedAfter.trim() !== '') {
        requestBody.modifiedAfter = filters.modifiedAfter;
      }
      if (filters.modifiedBefore && filters.modifiedBefore.trim() !== '') {
        requestBody.modifiedBefore = filters.modifiedBefore;
      }

      // NEW: ID filters (UUID format)
      if (filters.manufacturerId && filters.manufacturerId !== ALL_OPTIONS_SENTINEL && filters.manufacturerId.trim() !== '') {
        requestBody.manufacturerId = filters.manufacturerId.trim();
      }
      if (filters.authorityId && filters.authorityId !== ALL_OPTIONS_SENTINEL && filters.authorityId.trim() !== '') {
        requestBody.authorityId = filters.authorityId.trim();
      }

      // Limit preview for faster response
      requestBody.maxResults = ZEREZ_IMPORT_LIMITS.PREVIEW_PRODUCT_LIMIT;

      const response = await fetch('/api/zerez/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();

      // Extract unit IDs for detailed fetch
      const unitIds = data.units.map((u: ZEREZUnit) => u.id);

      // Fetch detailed unit data (75+ fields including all German technical specifications)
      let detailedUnits: ZEREZUnit[] = [];
      let detailFetchWarning: string | null = null;

      if (unitIds.length > 0) {
        try {
          const detailedResponse = await fetch('/api/zerez/fetch-detailed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ unitIds })
          });

          if (detailedResponse.ok) {
            const detailedData = await detailedResponse.json();
            detailedUnits = detailedData.units;

            // Notify user if some detailed specs failed to load
            if (detailedData.failed > 0) {
              detailFetchWarning = `⚠️ ${detailedData.failed} of ${detailedData.total} units: Technical specifications unavailable (showing basic data only)`;
              console.warn(`[Preview] ${detailedData.failed} of ${detailedData.total} units failed to fetch detailed data`);
            }
          } else {
            detailFetchWarning = '⚠️ Unable to load detailed technical specifications. Showing basic data only.';
            console.error('[Preview] Failed to fetch detailed data, using basic search results');
          }
        } catch (detailError) {
          detailFetchWarning = '⚠️ Unable to load detailed technical specifications. Showing basic data only.';
          console.error('[Preview] Error fetching detailed data:', detailError);
          // Fall back to basic search results if detailed fetch fails
        }
      }

      // Merge detailed data with basic search results using utility function
      // This preserves unitOverview-only fields (manufacturerName, category, etc.)
      // while adding technical specs from unit(id) query
      const enrichedUnits = enrichZEREZUnits(data.units, detailedUnits);

      setProducts(enrichedUnits.map((u: ZEREZUnit) => ({ ...u, selected: true })));
      setTotalCount(data.totalCount);

      // Show warning if detailed fetch had issues (but don't block the preview)
      if (detailFetchWarning) {
        setPreviewError(detailFetchWarning);
      }
    } catch (error) {
      setPreviewError(error instanceof Error ? error.message : 'Failed to load products');
    } finally {
      setIsLoadingPreview(false);
    }
  };

  // Step 2: Import HTML details
  const handleImportDetails = async () => {
    const selectedProducts = products.filter(p => p.selected);

    // Track final progress using local variable (fixes race condition)
    let finalProgress: ImportProgress = {
      total: selectedProducts.length,
      downloaded: 0,
      failed: 0,
      saved_files: 0,
      current: '',
      errors: []
    };

    setImportProgress(finalProgress);
    setCurrentStep('import');

    try {
      const response = await fetch('/api/zerez/import-details', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          units: selectedProducts
        })
      });

      // Check for HTTP errors before attempting to stream
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);
      }

      // Consume stream and capture final progress synchronously
      await consumeSSEStream<ImportProgress>(
        response.body,
        (progressData) => {
          // Update both local variable and React state
          finalProgress = { ...finalProgress, ...progressData };
          setImportProgress(finalProgress);
        },
        {
          maxParseErrors: SSE_CONFIG.MAX_PARSE_ERRORS,
          onError: (errorMsg) => {
            console.error('SSE Error:', errorMsg);
            finalProgress.errors.push(errorMsg);
          }
        }
      );

      // Verify import using FINAL state from local variable (not React state)
      const verificationErrors = [...finalProgress.errors];
      let hasVerificationFailure = false;

      if (finalProgress.saved_files !== finalProgress.downloaded && finalProgress.downloaded > 0) {
        const diff = finalProgress.downloaded - finalProgress.saved_files;
        const failurePercent = (diff / finalProgress.downloaded) * 100;

        if (failurePercent > 10) {
          hasVerificationFailure = true;
          verificationErrors.push(
            `❌ CRITICAL: ${diff} file(s) not saved (${failurePercent.toFixed(1)}% failure rate). Import may be incomplete.`
          );
        } else {
          verificationErrors.push(
            `⚠️ Warning: ${diff} file(s) may not have been saved properly (${failurePercent.toFixed(1)}% of downloads)`
          );
        }
      }

      // Update final state with verification errors
      setImportProgress(prev => ({ ...prev, errors: verificationErrors }));

      // Decision based on FINAL state (no race condition)
      if (!hasVerificationFailure && finalProgress.saved_files > 0) {
        // Store products and move to match step
        setProductsForMatching(selectedProducts);
        setCurrentStep('match');
        // Trigger PDF matching directly
        await handleMatchWithPDF(selectedProducts);
      } else if (hasVerificationFailure) {
        setPreviewError(
          `Import verification failed: More than 10% of files could not be saved. Please check disk space and file permissions.`
        );
      } else if (finalProgress.saved_files === 0) {
        setPreviewError(
          `Import failed: No files were saved. Please check the error messages above and try again.`
        );
      }
    } catch (error) {
      console.error('Import failed:', error);
      setPreviewError(error instanceof Error ? error.message : 'Import failed');
    }
  };

  const selectedCount = products.filter(p => p.selected).length;

  return (
    <div className="container mx-auto p-6 max-w-6xl">
      {/* Navigation Header */}
      <div className="mb-6 flex items-center justify-between">
        <Link
          href="/dashboard"
          className="flex items-center gap-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 transition-colors"
          aria-label="Navigate back to dashboard"
        >
          <ArrowLeft size={20} aria-hidden="true" />
          <span>Back to Dashboard</span>
        </Link>

        <div className="flex items-center gap-2 text-gray-500" role="status" aria-label="Current location">
          <Database size={20} aria-hidden="true" />
          <span className="text-sm">Import Wizard</span>
        </div>
      </div>

      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">ZEREZ Import Wizard</h1>
        <p className="text-gray-600">
          Import battery storage systems from ZEREZ database with 3 easy steps
        </p>
      </div>

      {/* Progress Steps */}
      <div className="flex items-center justify-between mb-8">
        <div className={`flex items-center ${currentStep === 'filter' ? 'text-blue-600' : 'text-gray-400'}`}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
            currentStep === 'filter' ? 'bg-blue-600 text-white' : 'bg-gray-200'
          }`}>
            <Filter size={20} />
          </div>
          <span className="ml-2 font-medium">Filter & Preview</span>
        </div>

        <ArrowRight className="text-gray-400" />

        <div className={`flex items-center ${currentStep === 'import' ? 'text-blue-600' : 'text-gray-400'}`}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
            currentStep === 'import' ? 'bg-blue-600 text-white' : 'bg-gray-200'
          }`}>
            <Download size={20} />
          </div>
          <span className="ml-2 font-medium">Import Details</span>
        </div>

        <ArrowRight className="text-gray-400" />

        <div className={`flex items-center ${currentStep === 'match' ? 'text-blue-600' : 'text-gray-400'}`}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
            currentStep === 'match' ? 'bg-blue-600 text-white' : 'bg-gray-200'
          }`}>
            <Database size={20} />
          </div>
          <span className="ml-2 font-medium">Match with PDFs</span>
        </div>
      </div>

      {/* STEP 1: Filter & Preview */}
      {currentStep === 'filter' && (
        <Card>
          <CardHeader>
            <CardTitle>Step 1: Configure Filters</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Category Filters - Always Visible */}
            <div className="space-y-4">
              <div>
                <h3 className="text-sm font-semibold mb-3">Category Filters</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="primaryEnergySource">Energy Source</Label>
                    <Select
                      value={filters.primaryEnergySource}
                      onValueChange={(value) => setFilters({ ...filters, primaryEnergySource: value })}
                      disabled={isLoadingEnums}
                    >
                      <SelectTrigger id="primaryEnergySource">
                        <SelectValue placeholder={isLoadingEnums ? "Loading..." : "All Sources"} />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value={ALL_OPTIONS_SENTINEL}>All Sources</SelectItem>
                        {/* Filter out invalid values (empty/null/whitespace) - Radix doesn't allow empty strings */}
                        {filterValidEnumValues(enumValues.primaryEnergySource).map((source) => (
                          <SelectItem key={source} value={source}>
                            {source}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="category">Category</Label>
                    <Select
                      value={filters.category}
                      onValueChange={(value) => setFilters({ ...filters, category: value })}
                      disabled={isLoadingEnums}
                    >
                      <SelectTrigger id="category">
                        <SelectValue placeholder={isLoadingEnums ? "Loading..." : "All Categories"} />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value={ALL_OPTIONS_SENTINEL}>All Categories</SelectItem>
                        {/* Filter out invalid values (empty/null/whitespace) - Radix doesn't allow empty strings */}
                        {filterValidEnumValues(enumValues.category).map((cat) => (
                          <SelectItem key={cat} value={cat}>
                            {cat}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </div>
            </div>

            {/* Advanced Filters - Tabbed Interface */}
            <Tabs defaultValue="technical" className="w-full">
              <TabsList
                className="grid w-full grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-1"
                aria-label="Advanced filter categories"
              >
                <TabsTrigger value="technical" title="Technical Specification - Power and Voltage ranges">
                  <span className="hidden md:inline">Technical Specification</span>
                  <span className="md:hidden">Technical</span>
                </TabsTrigger>
                <TabsTrigger value="compliance" title="Compliance & Verification - Certificate standards">
                  Compliance
                </TabsTrigger>
                <TabsTrigger value="dates" title="Date Range Filters - Created and Modified dates">
                  <span className="hidden sm:inline">Date Filters</span>
                  <span className="sm:hidden">Dates</span>
                </TabsTrigger>
                <TabsTrigger value="manufacturer" title="Filter by Manufacturer">
                  <span className="hidden sm:inline">Manufacturer</span>
                  <span className="sm:hidden">Mfr</span>
                </TabsTrigger>
                <TabsTrigger value="authority" title="Filter by Certification Authority">
                  <span className="hidden md:inline">Certification Authority</span>
                  <span className="md:hidden">Authority</span>
                </TabsTrigger>
              </TabsList>

              {/* Context for screen readers */}
              <div className="sr-only" id="advanced-filters-description">
                Use tabs to access different filter categories for refining product search
              </div>

              {/* Technical Specification Tab */}
              <TabsContent value="technical" className="space-y-4">
                {/* Power Range */}
                <div>
                  <h3 className="text-sm font-semibold mb-3">
                    Power Range
                    <span className="text-xs text-gray-500 font-normal ml-2">(optional - leave empty to search all)</span>
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="powerMin">Minimum (kW)</Label>
                      <Input
                        id="powerMin"
                        type="number"
                        placeholder="e.g., 50"
                        value={filters.powerMin === null ? '' : filters.powerMin}
                        onChange={(e) => setFilters({ ...filters, powerMin: e.target.value === '' ? null : Number(e.target.value) })}
                      />
                    </div>
                    <div>
                      <Label htmlFor="powerMax">Maximum (kW)</Label>
                      <Input
                        id="powerMax"
                        type="number"
                        placeholder="e.g., 200"
                        value={filters.powerMax === null ? '' : filters.powerMax}
                        onChange={(e) => setFilters({ ...filters, powerMax: e.target.value === '' ? null : Number(e.target.value) })}
                    />
                    </div>
                  </div>
                </div>

                {/* Voltage Range */}
                <div>
                  <h3 className="text-sm font-semibold mb-3">
                    Voltage Range
                    <span className="text-xs text-gray-500 font-normal ml-2">(optional - leave empty to search all)</span>
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="voltageMin">Minimum (V)</Label>
                      <Input
                        id="voltageMin"
                        type="number"
                        placeholder="e.g., 230"
                        value={filters.voltageMin === null ? '' : filters.voltageMin}
                        onChange={(e) => setFilters({ ...filters, voltageMin: e.target.value === '' ? null : Number(e.target.value) })}
                      />
                    </div>
                    <div>
                      <Label htmlFor="voltageMax">Maximum (V)</Label>
                      <Input
                        id="voltageMax"
                        type="number"
                        placeholder="e.g., 1000"
                        value={filters.voltageMax === null ? '' : filters.voltageMax}
                        onChange={(e) => setFilters({ ...filters, voltageMax: e.target.value === '' ? null : Number(e.target.value) })}
                      />
                    </div>
                  </div>
                </div>
              </TabsContent>

              {/* Compliance Tab */}
              <TabsContent value="compliance" className="space-y-4">
                {/* Verified Products Checkbox */}
                <div>
                  <h3 className="text-sm font-semibold mb-3">Verification Status</h3>
                  <div className="flex items-center space-x-2">
                    <Checkbox
                      id="isVerified"
                      checked={filters.isVerified}
                      onCheckedChange={(checked) => setFilters({ ...filters, isVerified: checked as boolean })}
                    />
                    <Label htmlFor="isVerified">Only Verified Products</Label>
                  </div>
                </div>

                {/* Certificate Norms - Multi-select with WCAG 2.1 AA accessibility */}
              <fieldset className="border border-gray-200 rounded-lg p-4">
                <legend className="text-sm font-semibold px-2">
                  Certificate Standards (Optional)
                  <span className="text-xs text-gray-500 font-normal ml-2">Select multiple standards</span>
                  {filters.certificateNorms.length > 0 && (
                    <span className="ml-2 text-xs font-normal text-blue-600" aria-live="polite">
                      ({filters.certificateNorms.length} selected)
                    </span>
                  )}
                </legend>

                {/* Select All / Clear All buttons */}
                <div className="flex gap-2 mb-3">
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setFilters({
                      ...filters,
                      certificateNorms: CERTIFICATE_NORMS.map(n => n.value)
                    })}
                    disabled={filters.certificateNorms.length === CERTIFICATE_NORMS.length}
                    aria-label="Select all certificate standards"
                  >
                    Select All
                  </Button>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setFilters({
                      ...filters,
                      certificateNorms: []
                    })}
                    disabled={filters.certificateNorms.length === 0}
                    aria-label="Clear all certificate standards"
                  >
                    Clear All
                  </Button>
                </div>

                <div
                  className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"
                  role="group"
                  aria-label="Certificate standards options"
                >
                  {CERTIFICATE_NORMS.map((norm) => {
                    // Extract value with proper literal type
                    const normValue: CertificateNormValue = norm.value;
                    // Sanitize ID to avoid issues with special characters
                    const sanitizedId = `cert-norm-${normValue.replace(/[^a-zA-Z0-9]/g, '-')}`;

                    return (
                      <div
                        key={normValue}
                        className="flex items-center space-x-3 min-h-[24px]"
                        title={norm.description}
                      >
                        <Checkbox
                          id={sanitizedId}
                          checked={filters.certificateNorms.includes(normValue)}
                          onCheckedChange={(checked) => {
                            if (checked) {
                              // Type-safe addition: normValue is CertificateNormValue
                              setFilters({
                                ...filters,
                                certificateNorms: [...filters.certificateNorms, normValue]
                              });
                            } else {
                              // Type-safe filtering with proper type inference
                              setFilters({
                                ...filters,
                                certificateNorms: filters.certificateNorms.filter(n => n !== normValue)
                              });
                            }
                          }}
                          className="h-5 w-5"
                          aria-describedby={`${sanitizedId}-desc`}
                        />
                        <Label
                          htmlFor={sanitizedId}
                          className="text-sm cursor-pointer leading-tight py-1"
                        >
                          {norm.label}
                          <span id={`${sanitizedId}-desc`} className="sr-only">
                            {norm.description}
                          </span>
                        </Label>
                      </div>
                    );
                  })}
                </div>
              </fieldset>
              </TabsContent>

              {/* Date Filters Tab */}
              <TabsContent value="dates" className="space-y-4">
                <div>
                  <h3 className="text-sm font-semibold mb-3">Date Filters (Optional)</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="createdAfter">Created After</Label>
                    <Input
                      id="createdAfter"
                      type="date"
                      value={filters.createdAfter}
                      onChange={(e) => setFilters({ ...filters, createdAfter: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="createdBefore">Created Before</Label>
                    <Input
                      id="createdBefore"
                      type="date"
                      value={filters.createdBefore}
                      onChange={(e) => setFilters({ ...filters, createdBefore: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="modifiedAfter">Modified After</Label>
                    <Input
                      id="modifiedAfter"
                      type="date"
                      value={filters.modifiedAfter}
                      onChange={(e) => setFilters({ ...filters, modifiedAfter: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="modifiedBefore">Modified Before</Label>
                    <Input
                      id="modifiedBefore"
                      type="date"
                      value={filters.modifiedBefore}
                      onChange={(e) => setFilters({ ...filters, modifiedBefore: e.target.value })}
                    />
                  </div>
                </div>
                </div>
              </TabsContent>

              {/* Manufacturer Tab */}
              <TabsContent value="manufacturer" className="space-y-4">
                <div>
                  <Label htmlFor="manufacturerId">Manufacturer Filter</Label>
                    {isLoadingManufacturers ? (
                      <div className="space-y-2">
                        <Skeleton className="h-10 w-full" />
                        <div className="flex gap-2">
                          <Skeleton className="h-4 w-32" />
                          <Skeleton className="h-4 w-24" />
                        </div>
                      </div>
                    ) : (
                      <Select
                        value={filters.manufacturerId}
                        onValueChange={(value) => setFilters({ ...filters, manufacturerId: value })}
                        disabled={isLoadingManufacturers}
                      >
                        <SelectTrigger id="manufacturerId">
                          <SelectValue placeholder="Search manufacturer..." />
                        </SelectTrigger>
                      <SelectContent>
                        <div className="sticky top-0 bg-white dark:bg-gray-950 p-2 border-b">
                          <label htmlFor="manufacturer-search" className="sr-only">
                            Search manufacturers by name
                          </label>
                          <Input
                            id="manufacturer-search"
                            placeholder="Type to search..."
                            value={manufacturerSearchTerm}
                            onChange={(e) => setManufacturerSearchTerm(e.target.value)}
                            onClick={(e) => e.stopPropagation()}
                            onKeyDown={(e) => {
                              // Prevent Select dropdown from closing when Enter is pressed in search
                              if (e.key === 'Enter') {
                                e.preventDefault();
                                e.stopPropagation();
                              }
                              // Allow clearing search with Escape
                              if (e.key === 'Escape') {
                                e.stopPropagation();
                                setManufacturerSearchTerm('');
                              }
                            }}
                            className="h-8"
                            role="searchbox"
                            aria-label="Search manufacturers by name"
                            aria-controls="manufacturer-list"
                          />
                        </div>
                        <div id="manufacturer-list" role="group" aria-label="Manufacturer options">
                          <SelectItem value={ALL_OPTIONS_SENTINEL}>All Manufacturers</SelectItem>
                          {(() => {
                            // Filter first, then slice to avoid incorrect count
                            const filteredManufacturers = manufacturers.filter((m) =>
                              m.name.toLowerCase().includes(manufacturerSearchTerm.toLowerCase())
                            );
                            const displayedManufacturers = filteredManufacturers.slice(0, 50);

                            return (
                              <>
                                {displayedManufacturers.map((manufacturer) => (
                                  <SelectItem key={manufacturer.id} value={manufacturer.id}>
                                    {manufacturer.name}
                                  </SelectItem>
                                ))}
                                {filteredManufacturers.length > 50 && (
                                  <div className="p-2 text-xs text-gray-500 italic text-center">
                                    Showing first 50 of {filteredManufacturers.length} results. Type to narrow down.
                                  </div>
                                )}
                              </>
                            );
                          })()}
                        </div>
                      </SelectContent>
                      </Select>
                    )}
                    {!isLoadingManufacturers && manufacturers.length > 0 && (
                      <p className="text-xs text-gray-500 mt-1">
                        {manufacturers.length} manufacturers available
                      </p>
                    )}
                    {manufacturerError && (
                      <Alert className="mt-2">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>{manufacturerError}</AlertDescription>
                      </Alert>
                    )}
                </div>
              </TabsContent>

              {/* Certification Authority Tab */}
              <TabsContent value="authority" className="space-y-4">
                <div>
                  <Label htmlFor="authorityId">Certificate Authority Filter</Label>
                    {isLoadingAuthorities ? (
                      <div className="space-y-2">
                        <Skeleton className="h-10 w-full" />
                        <div className="flex gap-2">
                          <Skeleton className="h-4 w-32" />
                          <Skeleton className="h-4 w-24" />
                        </div>
                      </div>
                    ) : (
                      <Select
                        value={filters.authorityId}
                        onValueChange={(value) => setFilters({ ...filters, authorityId: value })}
                        disabled={isLoadingAuthorities}
                      >
                        <SelectTrigger id="authorityId">
                          <SelectValue placeholder="Search certificate authority..." />
                        </SelectTrigger>
                        <SelectContent>
                          <div className="sticky top-0 bg-white dark:bg-gray-950 p-2 border-b">
                            <label htmlFor="authority-search" className="sr-only">
                              Search certificate authorities by name
                            </label>
                            <Input
                              id="authority-search"
                              placeholder="Type to search..."
                              value={authoritySearchTerm}
                              onChange={(e) => setAuthoritySearchTerm(e.target.value)}
                              onClick={(e) => e.stopPropagation()}
                              onKeyDown={(e) => {
                                // Prevent Select dropdown from closing when Enter is pressed in search
                                if (e.key === 'Enter') {
                                  e.preventDefault();
                                  e.stopPropagation();
                                }
                                // Allow clearing search with Escape
                                if (e.key === 'Escape') {
                                  e.stopPropagation();
                                  setAuthoritySearchTerm('');
                                }
                              }}
                              className="h-8"
                              role="searchbox"
                              aria-label="Search certificate authorities by name"
                              aria-controls="authority-list"
                            />
                          </div>
                          <div id="authority-list" role="group" aria-label="Certificate Authority options">
                            <SelectItem value={ALL_OPTIONS_SENTINEL}>All Certificate Authorities</SelectItem>
                            {(() => {
                              // Filter first, then slice to avoid incorrect count
                              const filteredAuthorities = authorities.filter((a) =>
                                a.name.toLowerCase().includes(authoritySearchTerm.toLowerCase())
                              );
                              const displayedAuthorities = filteredAuthorities.slice(0, 50);

                              return (
                                <>
                                  {displayedAuthorities.map((authority) => (
                                    <SelectItem key={authority.id} value={authority.id}>
                                      {authority.name}
                                    </SelectItem>
                                  ))}
                                  {filteredAuthorities.length > 50 && (
                                    <div className="p-2 text-xs text-gray-500 italic text-center">
                                      Showing first 50 of {filteredAuthorities.length} results. Type to narrow down.
                                    </div>
                                  )}
                                </>
                              );
                            })()}
                          </div>
                        </SelectContent>
                      </Select>
                    )}
                    {!isLoadingAuthorities && authorities.length > 0 && (
                      <p className="text-xs text-gray-500 mt-1">
                        {authorities.length} certificate authorities available
                      </p>
                    )}
                    {authorityError && (
                      <Alert className="mt-2">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>{authorityError}</AlertDescription>
                      </Alert>
                    )}
                </div>
              </TabsContent>
            </Tabs>

            {enumError && (
              <Alert>
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{enumError}</AlertDescription>
              </Alert>
            )}

            <div className="flex flex-col sm:flex-row gap-2">
              <Button
                onClick={handlePreviewProducts}
                disabled={isLoadingPreview}
                className="flex-1"
              >
                {isLoadingPreview ? (
                  <>
                    <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                    <div className="flex flex-col items-start">
                      <span className="font-medium">Loading Products...</span>
                      <span className="text-xs text-blue-200">Please wait, this may take a moment</span>
                    </div>
                  </>
                ) : (
                  <>
                    <Filter className="mr-2 h-4 w-4" />
                    <span>Preview Products</span>
                  </>
                )}
              </Button>
              <Button
                onClick={() => {
                  setFilters(defaultFilters);
                  setProducts([]);
                  setTotalCount(0);
                  setPreviewError(null);
                }}
                variant="outline"
                disabled={isLoadingPreview}
              >
                Reset Filters
              </Button>
            </div>

            {previewError && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{previewError}</AlertDescription>
              </Alert>
            )}

            {/* Product Preview Table */}
            {products.length > 0 && (
              <div className="mt-6">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">
                    Found {products.length}{totalCount > products.length && ` of ${totalCount.toLocaleString()}`} products
                    {totalCount > products.length && ' (preview limited)'}
                  </h3>
                  <div className="space-x-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setProducts(products.map(p => ({ ...p, selected: true })))}
                    >
                      Select All
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setProducts(products.map(p => ({ ...p, selected: false })))}
                    >
                      Select None
                    </Button>
                  </div>
                </div>

                {/* Virtualized Product Table with 6 essential columns */}
                <VirtualizedProductTable
                  products={products}
                  onToggleSelection={(id, checked) => {
                    setProducts(products.map(p =>
                      p.id === id ? { ...p, selected: checked } : p
                    ));
                  }}
                />

                <div className="mt-4 flex justify-between items-center">
                  <p className="text-sm text-gray-600">
                    {selectedCount} of {products.length} products selected
                  </p>
                  <Button
                    onClick={handleImportDetails}
                    disabled={selectedCount === 0}
                  >
                    Proceed to Import Details
                    <ArrowRight className="ml-2 h-4 w-4" />
                  </Button>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* STEP 2: Import HTML Details */}
      {currentStep === 'import' && (
        <Card>
          <CardHeader>
            <CardTitle>Step 2: Importing Product Details</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <div>
              <div className="flex justify-between text-sm mb-2">
                <span>Progress</span>
                <span>{importProgress.downloaded} / {importProgress.total}</span>
              </div>
              <Progress
                value={(importProgress.downloaded / importProgress.total) * 100}
                className="h-3"
              />
            </div>

            {importProgress.current && (
              <div className="bg-blue-50 p-4 rounded-lg">
                <div className="flex items-center">
                  <Loader2 className="h-5 w-5 animate-spin text-blue-600 mr-3" />
                  <div>
                    <p className="font-medium">Currently Processing</p>
                    <p className="text-sm text-gray-600">{importProgress.current}</p>
                  </div>
                </div>
              </div>
            )}

            <div className="grid grid-cols-3 gap-4">
              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <CheckCircle2 className="h-8 w-8 text-green-600 mx-auto mb-2" />
                    <p className="text-2xl font-bold">{importProgress.downloaded}</p>
                    <p className="text-sm text-gray-600">Downloaded</p>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <AlertCircle className="h-8 w-8 text-red-600 mx-auto mb-2" />
                    <p className="text-2xl font-bold">{importProgress.failed}</p>
                    <p className="text-sm text-gray-600">Failed</p>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <Loader2 className="h-8 w-8 text-gray-400 mx-auto mb-2" />
                    <p className="text-2xl font-bold">{importProgress.total - importProgress.downloaded}</p>
                    <p className="text-sm text-gray-600">Remaining</p>
                  </div>
                </CardContent>
              </Card>
            </div>

            {importProgress.errors.length > 0 && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  <p className="font-medium mb-2">Errors occurred during import:</p>
                  <ul className="list-disc list-inside text-sm space-y-1">
                    {importProgress.errors.slice(0, ZEREZ_IMPORT_LIMITS.MAX_DISPLAYED_ERRORS).map((error, i) => (
                      <li key={i}>{error}</li>
                    ))}
                  </ul>
                  {importProgress.errors.length > ZEREZ_IMPORT_LIMITS.MAX_DISPLAYED_ERRORS && (
                    <p className="text-sm mt-2">... and {importProgress.errors.length - ZEREZ_IMPORT_LIMITS.MAX_DISPLAYED_ERRORS} more errors</p>
                  )}
                </AlertDescription>
              </Alert>
            )}

            {/* Note: Pause/Cancel functionality not yet implemented */}
            {/* TODO: Add AbortController support for canceling imports */}
          </CardContent>
        </Card>
      )}

      {/* STEP 3: Match with PDF Knowledge Base */}
      {currentStep === 'match' && (
        <Card>
          <CardHeader>
            <CardTitle>Step 3: PDF Knowledge Base Matching</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {isMatching ? (
              <div className="text-center py-12">
                <Loader2 className="h-12 w-12 animate-spin text-blue-600 mx-auto mb-4" />
                <p className="text-lg font-medium">Matching products with PDF database...</p>
                <p className="text-sm text-gray-600 mt-2">This may take a few moments</p>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-3 gap-4">
                  <Card className="bg-green-50">
                    <CardContent className="pt-6">
                      <div className="text-center">
                        <CheckCircle2 className="h-8 w-8 text-green-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">
                          {matchResults.filter(r => r.pdfMatch).length}
                        </p>
                        <p className="text-sm text-gray-600">PDF Enriched</p>
                        <p className="text-xs text-gray-500 mt-1">
                          {((matchResults.filter(r => r.pdfMatch).length / matchResults.length) * 100).toFixed(1)}%
                        </p>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="bg-yellow-50">
                    <CardContent className="pt-6">
                      <div className="text-center">
                        <AlertCircle className="h-8 w-8 text-yellow-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">
                          {matchResults.filter(r => !r.pdfMatch).length}
                        </p>
                        <p className="text-sm text-gray-600">ZEREZ Only</p>
                        <p className="text-xs text-gray-500 mt-1">No PDF match</p>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="bg-blue-50">
                    <CardContent className="pt-6">
                      <div className="text-center">
                        <FileText className="h-8 w-8 text-blue-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">{matchResults.length}</p>
                        <p className="text-sm text-gray-600">Total Products</p>
                        <p className="text-xs text-gray-500 mt-1">Import complete</p>
                      </div>
                    </CardContent>
                  </Card>
                </div>

                <div className="border rounded-lg overflow-hidden">
                  <div className="max-h-96 overflow-y-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 sticky top-0">
                        <tr>
                          <th className="px-4 py-2 text-left">ZEREZ Product</th>
                          <th className="px-4 py-2 text-left">PDF Match</th>
                          <th className="px-4 py-2 text-left">Confidence</th>
                          <th className="px-4 py-2 text-left">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {matchResults.map((result, i) => (
                          <tr key={i} className="border-t hover:bg-gray-50">
                            <td className="px-4 py-2 font-medium">{result.zerezProduct}</td>
                            <td className="px-4 py-2 text-sm text-gray-600">
                              {result.pdfMatch || '-'}
                            </td>
                            <td className="px-4 py-2">
                              {result.pdfMatch && (
                                <div className="flex items-center">
                                  <div className="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                    <div
                                      className="bg-green-600 h-2 rounded-full"
                                      style={{ width: `${result.confidence}%` }}
                                    />
                                  </div>
                                  <span className="text-sm">{result.confidence}%</span>
                                </div>
                              )}
                            </td>
                            <td className="px-4 py-2">
                              {result.pdfMatch ? (
                                <CheckCircle2 className="h-5 w-5 text-green-600" />
                              ) : (
                                <AlertCircle className="h-5 w-5 text-yellow-600" />
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                <div className="flex space-x-2">
                  <Button className="flex-1">
                    <Download className="mr-2 h-4 w-4" />
                    Download Results (JSON)
                  </Button>
                  <Button variant="outline" className="flex-1">
                    <FileText className="mr-2 h-4 w-4" />
                    View Detailed Report
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      setCurrentStep('filter');
                      setProducts([]);
                      setMatchResults([]);
                    }}
                  >
                    Import Again
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  );
}
