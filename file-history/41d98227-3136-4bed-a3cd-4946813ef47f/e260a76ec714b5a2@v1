import { NextResponse } from 'next/server';
import { PythonExecutor } from '@/lib/python-executor';
import { filterValidEnumValues } from '@/lib/ui-utils';
import { EnumValuesResponse, EnumValuesResponseSchema } from '@/lib/zerez-types';
import { validateWithErrorHandling } from '@/lib/api-validation-helpers';

export async function GET() {
  try {
    // Execute Python script to get enum values
    const stdout = await PythonExecutor.execute({
      scriptName: 'zerez_get_enum_values.py',
      args: [],
      timeout: 15000 // 15 seconds
    });

    // Parse the enum values from Python
    const rawEnumValues = JSON.parse(stdout);

    // Filter out invalid values (empty strings, null, undefined, whitespace-only)
    // This implements defense-in-depth: Python filters → API filters → Component filters
    // Radix UI Select doesn't allow empty string values, which can come from GraphQL introspection
    const sanitizedEnumValues = {
      primaryEnergySource: filterValidEnumValues(rawEnumValues.primaryEnergySource || []),
      category: filterValidEnumValues(rawEnumValues.category || []),
    };

    // Validate response structure against Zod schema
    const result = validateWithErrorHandling(
      EnumValuesResponseSchema,
      sanitizedEnumValues,
      {
        operation: 'enum values retrieval',
        logContext: {
          totalPrimaryEnergySources: sanitizedEnumValues.primaryEnergySource.length,
          totalCategories: sanitizedEnumValues.category.length
        },
        sampleData: {
          primaryEnergySource: sanitizedEnumValues.primaryEnergySource.slice(0, 3),
          category: sanitizedEnumValues.category.slice(0, 3)
        }
      }
    );

    if (!result.success) return result.response;

    // Type-safe validated data
    return NextResponse.json<EnumValuesResponse>(result.data);
  } catch (error) {
    return NextResponse.json(
      {
        error: 'Failed to fetch enum values',
        message: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}
