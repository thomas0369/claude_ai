import { ZEREZUnit } from '@/lib/zerez-types';

/**
 * Enriches basic ZEREZ search results with detailed technical specifications.
 *
 * CRITICAL: The ZEREZ GraphQL API has TWO queries with different field sets:
 * - `unitOverview`: Returns ~30 fields including manufacturerName, primaryEnergySource,
 *   category, certificateNumber (used by search API)
 * - `unit(id)`: Returns 75+ technical fields but LACKS the above fields
 *
 * This function merges both by spreading basicUnit FIRST to preserve unitOverview-only
 * fields, then overlaying detailedUnit to add technical specifications.
 *
 * @param basicUnits - Units from unitOverview query (has manufacturer, category, etc.)
 * @param detailedUnits - Units from unit(id) query (has 75+ technical specs)
 * @returns Enriched units with both search fields and technical specs
 *
 * @example
 * ```typescript
 * const searchResults = await searchZEREZ(filters); // unitOverview query
 * const detailedData = await fetchDetailedUnits(searchResults.map(u => u.id));
 * const enriched = enrichZEREZUnits(searchResults, detailedData);
 * // enriched[0] now has BOTH manufacturerName AND ratedVoltage
 * ```
 */
export function enrichZEREZUnits(
  basicUnits: ZEREZUnit[],
  detailedUnits: ZEREZUnit[]
): ZEREZUnit[] {
  if (basicUnits.length === 0) return [];
  if (detailedUnits.length === 0) return basicUnits;

  // Validate that all units have IDs - critical for enrichment
  const invalidBasicUnits = basicUnits.filter(u => !u.id);
  const invalidDetailedUnits = detailedUnits.filter(u => !u.id);

  if (invalidBasicUnits.length > 0) {
    console.warn(
      `enrichZEREZUnits: ${invalidBasicUnits.length} basic units missing 'id' field`,
      invalidBasicUnits.slice(0, 3)
    );
  }

  if (invalidDetailedUnits.length > 0) {
    console.warn(
      `enrichZEREZUnits: ${invalidDetailedUnits.length} detailed units missing 'id' field`,
      invalidDetailedUnits.slice(0, 3)
    );
  }

  // Build lookup map for O(1) access instead of O(n) find() in loop
  // This improves performance from O(n²) to O(n) for large datasets
  // Only include units with valid IDs in the map
  const detailedMap = new Map(
    detailedUnits
      .filter(u => u.id) // Only units with valid IDs
      .map(u => [u.id, u])
  );

  return basicUnits.map(basicUnit => {
    // Skip enrichment for units without IDs
    if (!basicUnit.id) {
      console.warn('Skipping enrichment for unit without ID:', basicUnit);
      return basicUnit;
    }

    const detailedUnit = detailedMap.get(basicUnit.id);

    if (!detailedUnit) {
      return basicUnit;
    }

    // Spread order is CRITICAL:
    // 1. basicUnit first → preserves unitOverview-only fields
    //    (manufacturerName, primaryEnergySource, category, certificateNumber)
    // 2. detailedUnit second → adds technical specs, overwrites shared fields
    //    (maxActivePower, ratedVoltage, all German technical specs)
    return { ...basicUnit, ...detailedUnit };
  });
}

/**
 * Type-safe field preservation validator.
 * Verifies that critical unitOverview fields are not lost during enrichment.
 *
 * @param original - Original unit from search
 * @param enriched - Enriched unit after merge
 * @returns Validation result with list of any missing fields
 *
 * @internal Used by tests and development validation
 */
export function validateEnrichment(
  original: ZEREZUnit,
  enriched: ZEREZUnit
): { valid: boolean; missingFields: string[] } {
  const criticalFields = [
    'manufacturerName',
    'primaryEnergySource',
    'category',
    'certificateNumber'
  ] as const;

  const missingFields = criticalFields.filter(field => {
    // Field was present in original but is now null/undefined in enriched
    return original[field] !== null &&
           original[field] !== undefined &&
           (enriched[field] === null || enriched[field] === undefined);
  });

  return {
    valid: missingFields.length === 0,
    missingFields
  };
}

/**
 * Analyzes field coverage across a set of units.
 * Useful for debugging missing data issues and understanding data quality.
 *
 * @param units - Array of ZEREZ units to analyze
 * @returns Object mapping field names to percentage of units with that field populated
 *
 * @example
 * ```typescript
 * const coverage = analyzeFieldCoverage(enrichedUnits);
 * console.table(coverage);
 * // Shows:
 * // manufacturerName: 95.5%
 * // maxActivePower: 87.2%
 * // ratedVoltage: 82.1%
 * // ...
 * ```
 */
export function analyzeFieldCoverage(units: ZEREZUnit[]): Record<string, number> {
  if (units.length === 0) return {};

  const fields = Object.keys(units[0]) as (keyof ZEREZUnit)[];
  const coverage: Record<string, number> = {};

  fields.forEach(field => {
    const nonNullCount = units.filter(u =>
      u[field] !== null && u[field] !== undefined
    ).length;
    coverage[field] = Math.round((nonNullCount / units.length) * 1000) / 10; // Round to 1 decimal
  });

  return coverage;
}
