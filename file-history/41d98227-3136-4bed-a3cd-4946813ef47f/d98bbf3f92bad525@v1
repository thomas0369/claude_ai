#!/usr/bin/env python3
"""
ZEREZ JSON Saver
================

Saves ZEREZ unit data to JSON files.
Designed to work with data already fetched from GraphQL search.

This script receives complete unit data from the search results
and saves each unit to an individual JSON file with all 58 fields.

Usage:
    python3 zerez_json_saver.py --units '[...]' --output-dir data/zerez/imports --stream-progress
"""

import argparse
import json
import logging
import sys
import time
from pathlib import Path
from typing import Dict
from zerez_import_base import (
    ZEREZImporterBase,
    parse_unit_input,
    validate_output_directory
)

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class ZEREZJSONSaver(ZEREZImporterBase):
    """Save ZEREZ product data to JSON files."""

    def process_unit(self, unit_data: Dict, model_name: str) -> bool:
        """
        Save a single unit to JSON file.

        Args:
            unit_data: Complete unit data from GraphQL (all 58 fields)
            model_name: Display name for logging

        Returns:
            True if saved successfully, False otherwise
        """
        unit_id = unit_data.get('id')

        if not unit_id:
            error_msg = f"Invalid data for {model_name}: Unit data missing 'id' field"
            logger.error(f"✗ {error_msg}")
            self.stats.add_error(error_msg)
            return False

        # Add import metadata
        enhanced_data = {
            **unit_data,
            'importedAt': time.strftime('%Y-%m-%d %H:%M:%S'),
            'importMethod': 'graphql_api_search',
            'apiVersion': '1.0',
        }

        # Use shared file writer
        success, error = self.writer.save_json(unit_id, enhanced_data, model_name)

        if success:
            self.stats.increment('saved_files')
            return True
        else:
            logger.error(f"✗ {error}")
            self.stats.add_error(error)
            return False


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='Save ZEREZ product data to JSON files',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Save products from search results
  python3 zerez_json_saver.py \\
    --units '[{"id":"uuid1","modelName":"Model 1",...}]' \\
    --output-dir data/zerez/imports \\
    --stream-progress

Input Format:
  --units expects a JSON array of complete unit objects from GraphQL search.
  Each unit should contain all 58 fields returned by the API.

Output Format:
  Each product is saved as {uuid}.json with:
  - All original fields from GraphQL
  - importedAt timestamp
  - importMethod metadata
        """
    )
    parser.add_argument('--units', required=True, help='JSON array of complete unit data')
    parser.add_argument('--output-dir', required=True, help='Output directory for JSON files')
    parser.add_argument('--stream-progress', action='store_true', help='Stream progress updates (for SSE)')

    args = parser.parse_args()

    try:
        # Parse and validate input using shared utility
        units, _ = parse_unit_input(args.units)
        output_dir = Path(args.output_dir)
        validate_output_directory(output_dir)

        # Run saver
        saver = ZEREZJSONSaver(output_dir, stream_progress=args.stream_progress)
        result = saver.process_units(units)

        # Print final result (if not streaming)
        if not args.stream_progress:
            print(json.dumps(result, indent=2))

        # Exit with error code if any failures
        sys.exit(1 if result['failed'] > 0 else 0)

    except ValueError as e:
        print(json.dumps({'error': str(e)}), file=sys.stderr)
        sys.exit(1)

    except KeyboardInterrupt:
        logger.warning("\n⚠️  Save interrupted by user")
        sys.exit(130)

    except Exception as e:
        logger.error(f"❌ Fatal error: {e}")
        print(json.dumps({'error': str(e)}), file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
