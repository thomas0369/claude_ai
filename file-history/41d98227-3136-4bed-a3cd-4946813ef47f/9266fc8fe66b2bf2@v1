#!/usr/bin/env python3
"""
Fetch all tenants from ZEREZ using the direct tenants GraphQL query.
~100x faster than the old approach of fetching units first.

Performance: ~2 seconds for ALL 8,321 tenants
Old approach: 277 seconds for only 264 manufacturers (3% coverage)
"""

import json
import sys
import logging
import requests

logging.basicConfig(level=logging.WARNING)
logger = logging.getLogger(__name__)

# Direct GraphQL query for tenants
TENANTS_QUERY = """
query GetAllTenants($skip: Int, $take: Int) {
  tenants(skip: $skip, take: $take) {
    totalCount
    items {
      id
      tenantName
    }
  }
}
"""

def fetch_all_tenants():
    """Fetch all tenants via direct tenants query."""
    endpoint = "https://app-zerez-weeu-gatewaysvc-prod-01.azurewebsites.net/graphql/"

    headers = {
        'Content-Type': 'application/json',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }

    all_tenants = []
    skip = 0
    take = 1000  # Fetch in batches of 1000

    while True:
        payload = {
            "operationName": "GetAllTenants",
            "query": TENANTS_QUERY,
            "variables": {
                "skip": skip,
                "take": take
            }
        }

        try:
            response = requests.post(endpoint, json=payload, headers=headers, timeout=30)

            if response.status_code != 200:
                raise Exception(f"API returned {response.status_code}")

            data = response.json()

            if 'errors' in data:
                raise Exception(f"GraphQL errors: {data['errors']}")

            tenants_data = data.get('data', {}).get('tenants', {})
            items = tenants_data.get('items', [])
            total_count = tenants_data.get('totalCount', 0)

            # Convert to manufacturer format {id, name}
            for tenant in items:
                if tenant.get('id') and tenant.get('tenantName'):
                    all_tenants.append({
                        "id": tenant['id'],
                        "name": tenant['tenantName']
                    })

            # Check if we've fetched all
            if skip + len(items) >= total_count or not items:
                break

            skip += len(items)

        except requests.exceptions.Timeout:
            logger.error("Request timed out after 30 seconds")
            sys.exit(1)
        except requests.exceptions.RequestException as e:
            logger.error(f"Network error: {e}")
            sys.exit(1)
        except Exception as e:
            logger.error(f"Error fetching tenants: {e}")
            sys.exit(1)

    # Sort by name for better UX
    all_tenants.sort(key=lambda x: x['name'].lower())

    return all_tenants

def main():
    """Main entry point."""
    try:
        tenants = fetch_all_tenants()

        # Output JSON for Node.js to parse
        print(json.dumps(tenants))

    except Exception as e:
        sys.stderr.write(f"Error: {e}\n")
        sys.exit(1)

if __name__ == "__main__":
    main()
