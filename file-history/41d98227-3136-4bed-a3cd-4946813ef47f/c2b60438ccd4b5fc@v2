import { NextResponse } from 'next/server';
import { getZEREZClient } from '@/lib/zerez-graphql-client';

/**
 * Certificate Authority response type
 */
type Authority = {
  id: string;      // UUID
  name: string;    // Authority/tenant name
};

type AuthoritiesResponse = Authority[];

/**
 * GET /api/zerez/authorities
 *
 * Fetches ONLY certificate authorities that are actually used in the ZEREZ database.
 * Analyzes units to find unique certificateAuthorityId values, then resolves to names.
 *
 * This differs from manufacturers endpoint which returns ALL tenants.
 * Certificate authorities are a specific subset of tenants.
 *
 * Performance: ~5-10 seconds (samples 10,000 units + resolves ~50 authority IDs)
 * Coverage: All actual certificate authorities used in the database
 *
 * Returns: Array of {id: UUID, name: string} sorted alphabetically
 *
 * @example
 * ```typescript
 * const response = await fetch('/api/zerez/authorities');
 * const authorities = await response.json();
 * // [{ id: "uuid-1", name: "VDE Pr√ºf- und Zertifizierungsinstitut GmbH" }, ...] (~50 entries)
 * ```
 */
export async function GET() {
  try {
    // Get TypeScript GraphQL client
    const client = await getZEREZClient();

    // Fetch certificate authorities using sampling + resolution
    const tenants = await client.getCertificateAuthorities();

    // Convert to expected response format
    const authorities: AuthoritiesResponse = tenants;

    // Validate response structure
    if (!Array.isArray(authorities)) {
      throw new Error('Invalid response format: expected array');
    }

    // Add caching headers (authorities don't change frequently)
    // 1-hour cache reduces server load and improves performance
    return NextResponse.json<AuthoritiesResponse>(authorities, {
      headers: {
        'Cache-Control': 'public, max-age=3600, s-maxage=3600', // Cache for 1 hour
        'CDN-Cache-Control': 'max-age=3600',
        'Vercel-CDN-Cache-Control': 'max-age=3600'
      }
    });
  } catch (error) {
    // PythonExecutor already logs detailed errors server-side
    return NextResponse.json(
      {
        error: 'Failed to fetch certificate authorities',
        message: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}
