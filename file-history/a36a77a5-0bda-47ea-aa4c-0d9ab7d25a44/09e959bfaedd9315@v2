'use client';

import { useState } from 'react';
import dynamic from 'next/dynamic';
import { useRouter } from 'next/navigation';
import { GameHUD } from '@/components/game/GameHUD';
import { Button, Modal } from '@/components/ui';
import type { LevelConfig } from '@/lib/game/levels/levelService';

// Dynamically import Konva game to avoid SSR issues
const KonvaGame = dynamic(
  () => import('@/components/game/KonvaGame').then(mod => mod.KonvaGame),
  {
    ssr: false,
    loading: () => (
      <div className="w-full h-96 flex items-center justify-center bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
          <p className="text-white text-xl">Loading game engine...</p>
        </div>
      </div>
    ),
  }
);

interface GameClientProps {
  level: string;
  levelData: LevelConfig;
}

export function GameClient({ level, levelData }: GameClientProps) {
  const router = useRouter();
  const [score, setScore] = useState(0);
  const [moves, setMoves] = useState(0);
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState<'complete' | 'gameover'>('complete');
  const [isImmersiveMode, setIsImmersiveMode] = useState(false);
  const [showHUD, setShowHUD] = useState(true);

  const handleScoreUpdate = (newScore: number) => {
    setScore(newScore);
    setMoves(prev => prev + 1);
  };

  const handleLevelComplete = () => {
    setModalType('complete');
    setShowModal(true);
  };

  const handleGameOver = () => {
    setModalType('gameover');
    setShowModal(true);
  };

  const handleContinue = () => {
    setShowModal(false);
    router.push('/levels');
  };

  const handleRestart = () => {
    setShowModal(false);
    setScore(0);
    setMoves(0);
    router.refresh();
  };

  const handleGameplayStart = () => {
    // Enter immersive mode on first interaction (mobile only)
    if (typeof window !== 'undefined' && window.innerWidth < 768) {
      setIsImmersiveMode(true);
      // Auto-hide HUD after 2 seconds
      setTimeout(() => setShowHUD(false), 2000);
    }
  };

  const toggleHUD = () => {
    setShowHUD(prev => !prev);
  };

  return (
    <div className={`container mx-auto transition-all duration-300 ${
      isImmersiveMode ? 'px-0 py-0' : 'px-2 py-2 md:px-4 md:py-8'
    }`}>
      <div className="max-w-6xl mx-auto">
        {/* Back button - Hidden on mobile for max screen space */}
        {!isImmersiveMode && (
          <div className="mb-2 md:mb-6 hidden md:block">
            <Button variant="ghost" onClick={() => router.push('/levels')}>
              <svg
                className="w-5 h-5 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              Back to Levels
            </Button>
          </div>
        )}

        {/* Immersive Mode: Fullscreen game with overlay HUD */}
        {isImmersiveMode ? (
          <div className="relative min-h-screen flex flex-col">
            {/* Compact Score Overlay - Top of screen */}
            <div
              className={`absolute top-0 left-0 right-0 z-30 transition-all duration-300 ${
                showHUD ? 'translate-y-0 opacity-100' : '-translate-y-full opacity-0'
              }`}
            >
              <div className="bg-gradient-to-b from-gray-900/95 to-gray-900/80 backdrop-blur-sm text-white px-3 py-2 flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="text-lg font-bold">{score.toLocaleString()}</div>
                  <div className="text-xs text-gray-300">/ {levelData.targetScore.toLocaleString()}</div>
                </div>
                <div className="flex items-center gap-3">
                  {moves !== undefined && (
                    <div className="text-sm text-gray-300">Moves: {moves}</div>
                  )}
                  <button
                    onClick={() => router.push('/levels')}
                    className="text-gray-300 hover:text-white"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            {/* Toggle HUD Button - Floating */}
            <button
              onClick={toggleHUD}
              className="absolute top-4 right-4 z-40 bg-white/10 backdrop-blur-sm text-white rounded-full p-2 shadow-lg hover:bg-white/20 transition-all"
              aria-label="Toggle HUD"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={showHUD ? "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" : "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"} />
              </svg>
            </button>

            {/* Game Canvas - Centered Fullscreen */}
            <div className="flex-1 flex items-center justify-center bg-gray-50">
              <KonvaGame
                level={levelData}
                onScoreUpdate={handleScoreUpdate}
                onLevelComplete={handleLevelComplete}
                onGameOver={handleGameOver}
                onGameplayStart={handleGameplayStart}
                immersiveMode={true}
              />
            </div>
          </div>
        ) : (
          /* Desktop Mode: Traditional layout */
          <div className="flex flex-col lg:grid lg:grid-cols-3 gap-2 md:gap-6">
            {/* Game HUD - Compact on mobile */}
            <div className="lg:col-span-1 order-1 lg:order-none">
              <GameHUD
                score={score}
                targetScore={levelData.targetScore}
                timeLimit={levelData.timeLimit}
                moves={moves}
                levelNumber={levelData.levelNumber}
              />
            </div>

            {/* Game Canvas - Takes most space on mobile */}
            <div className="lg:col-span-2 order-2 lg:order-none">
              <KonvaGame
                level={levelData}
                onScoreUpdate={handleScoreUpdate}
                onLevelComplete={handleLevelComplete}
                onGameOver={handleGameOver}
                onGameplayStart={handleGameplayStart}
                immersiveMode={false}
              />
            </div>
          </div>
        )}

        {/* Completion/Game Over Modal */}
        <Modal
          isOpen={showModal}
          onClose={() => setShowModal(false)}
          title={modalType === 'complete' ? 'Level Complete!' : 'Game Over'}
        >
          <div className="text-center py-6">
            {modalType === 'complete' ? (
              <>
                <div className="text-6xl mb-4">ðŸŽ‰</div>
                <h3 className="text-2xl font-bold text-gray-900 mb-2">Congratulations!</h3>
                <p className="text-gray-600 mb-6">
                  You scored {score.toLocaleString()} points in {moves} moves
                </p>
              </>
            ) : (
              <>
                <div className="text-6xl mb-4">ðŸ˜…</div>
                <h3 className="text-2xl font-bold text-gray-900 mb-2">Time&apos;s Up!</h3>
                <p className="text-gray-600 mb-6">
                  You scored {score.toLocaleString()} points. Try again?
                </p>
              </>
            )}

            <div className="flex gap-4 justify-center">
              <Button variant="outline" onClick={handleRestart}>
                Play Again
              </Button>
              <Button variant="primary" onClick={handleContinue}>
                Continue
              </Button>
            </div>

            {modalType === 'complete' && parseInt(level) === 3 && (
              <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p className="text-sm text-blue-900 font-medium mb-2">
                  ðŸŽŠ You&apos;ve completed all free levels!
                </p>
                <p className="text-sm text-blue-800 mb-3">
                  Start your 7-day free trial to unlock 7 more levels
                </p>
                <Button variant="primary" size="sm" onClick={() => router.push('/trial')}>
                  Start Free Trial
                </Button>
              </div>
            )}
          </div>
        </Modal>
      </div>
    </div>
  );
}
