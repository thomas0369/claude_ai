"""
Configuration for Elliott Wave Trading Bot
"""

import os
import logging
from typing import List
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# === BROKER CONFIGURATION ===
CAPITAL_API_KEY = os.getenv("CAPITAL_API_KEY", "")
CAPITAL_API_SECRET = os.getenv("CAPITAL_API_SECRET", "")
CAPITAL_PASSWORD = os.getenv("CAPITAL_PASSWORD", "")

# Capital.com API Mode
DEMO_MODE = os.getenv("DEMO_MODE", "true").lower() == "true"

# === DATA PROVIDER CONFIGURATION ===
# TradingView Integration (optional, requires tradingview-scraper)
TRADINGVIEW_ENABLED = os.getenv("TRADINGVIEW_ENABLED", "true").lower() == "true"


# === CONFIGURATION VALIDATION ===
def validate_config():
    """Validate required configuration is present"""
    required_vars = {
        "CAPITAL_API_KEY": CAPITAL_API_KEY,
        "CAPITAL_API_SECRET": CAPITAL_API_SECRET,
        "CAPITAL_PASSWORD": CAPITAL_PASSWORD,
    }

    missing = [k for k, v in required_vars.items() if not v]

    if missing and not DEMO_MODE:
        raise ValueError(
            f"Missing required environment variables: {', '.join(missing)}. "
            f"Set in .env file or GitHub Secrets."
        )
    elif missing and DEMO_MODE:
        logging.warning(f"Running in DEMO_MODE with missing credentials: {', '.join(missing)}")


# Call validation at module load
validate_config()

# === ASSET UNIVERSE ===
#
# RECOMMENDED CONFIGURATION: Conservative-Balanced Portfolio
# - Focus on liquid Forex majors + Gold (excellent Elliott Wave characteristics)
# - Moderate volatility with manageable risk
# - Optimal for FREE tier: 5 assets × 3 calls = 15 calls/scan → ~50 scans/day
#
# Asset Selection Criteria:
# ⭐⭐ EUR/USD: Most liquid, clear wave structures, LOW risk
# ⭐⭐ XAU/USD: Gold - respects Fibonacci exceptionally, MEDIUM risk
# ⭐⭐ GBP/USD: Higher volatility than EUR/USD, still liquid, LOW-MEDIUM risk
# ⭐  USD/JPY: Stable trends, predictable, LOW risk
# ⭐  AUD/USD: Commodity-linked, good trends, MEDIUM risk
#
# Removed from default (HIGH RISK):
# ❌ BTC/USD: Extreme volatility (2-5% daily), crypto risk
# ❌ ETH/USD: Extreme volatility (3-8% daily), crypto risk
# ❌ USD/CHF: Low volatility, less trending (kept as optional)

# === COMPREHENSIVE 16-ASSET PORTFOLIO ===
# ALL TIERS: Tier 1 (Excellent 80-95%), Tier 2 (Good 70-75%), Tier 3 (Moderate 45-57%)
# 16 assets × 3 API calls = 48 calls/scan → 16 scans/day (uses more API credits)
#
# NOTE: With Twelve Data FREE tier (800 calls/day), this allows ~16 full scans per day
# Monitor API usage closely!

# ========================================================================
# TIER 1: EXCELLENT PREDICTABILITY (80-95%)
# ========================================================================

# FOREX MAJORS - Best predictability
FOREX_PAIRS: List[str] = [
    # Tier 1
    "EUR/USD",  # ⭐⭐⭐⭐⭐ 88% predictable - Most liquid, clear Elliott Waves
    "GBP/USD",  # ⭐⭐⭐⭐ 84% predictable - Higher volatility, excellent Fibonacci respect

    # Tier 2 - Good diversification
    "USD/JPY",  # ⭐⭐⭐⭐ 73% predictable - Stable trends, Asian session coverage
    "AUD/USD",  # ⭐⭐⭐⭐ 70% predictable - Commodity-linked, moderate risk

    # Tier 3 - Moderate risk
    "USD/CHF",  # ⭐⭐⭐ 57% predictable - Safe-haven, low volatility
]

# COMMODITIES - Exceptional for Elliott Wave
COMMODITIES: List[str] = [
    # Tier 1
    "XAU/USD",  # ⭐⭐⭐⭐⭐ 95% predictable - Gold, respects Fibonacci religiously
    "USOIL",    # ⭐⭐⭐⭐ 82% predictable - WTI Oil, clear 5-wave structures

    # Tier 3 - HIGH RISK (extreme volatility, weather-driven)
    "NGAS",     # ⭐⭐ 55% predictable - Natural Gas (⚠️ USE WITH CAUTION: 5-10% daily swings)
]

# INDICES - Diversified stock exposure (safer than individual stocks)
INDICES: List[str] = [
    # Tier 1
    "SPY",      # ⭐⭐⭐⭐ 80% predictable - S&P 500 (500 stocks, diversified)
    "QQQ",      # ⭐⭐⭐⭐ 78% predictable - NASDAQ 100 (tech exposure)
]

# ========================================================================
# TIER 2: INDIVIDUAL STOCKS (70-75% predictable, higher risk)
# ========================================================================
# ⚠️ WARNING: Stocks have gap risk, earnings shocks, single-company risk
# Require: 5% stops (vs 2.36% for Forex), smaller position sizes (5% vs 10%)

STOCKS: List[str] = [
    "NVDA",     # ⭐⭐⭐⭐⭐ 75-80% predictable - Nvidia (AI leader, clear trends)
    "AAPL",     # ⭐⭐⭐⭐ 75% predictable - Apple (mega-cap, lower volatility)
    "MSFT",     # ⭐⭐⭐⭐ 75% predictable - Microsoft (stable, institutional)
    "TSLA",     # ⭐⭐⭐⭐ 75% predictable - Tesla (⚠️ HIGH RISK: 3-8% daily, Elon tweets)
]

# ========================================================================
# TIER 3: CRYPTO (45-50% predictable, VERY HIGH RISK)
# ========================================================================
# ⚠️ WARNING: Extreme volatility (2-8% daily), manipulation risk, 24/7 gaps
# Require: Higher score threshold (90 vs 75), smaller positions (3% vs 10%)

CRYPTO: List[str] = [
    "BTC/USD",  # ⭐⭐⭐ 50% predictable - Bitcoin (⚠️ HIGH RISK: 2-5% daily volatility)
    "ETH/USD",  # ⭐⭐⭐ 45% predictable - Ethereum (⚠️ VERY HIGH RISK: 3-8% daily volatility)
]

# ========================================================================
# ALL TRADEABLE ASSETS (16 total)
# ========================================================================
ALL_ASSETS = FOREX_PAIRS + COMMODITIES + INDICES + STOCKS + CRYPTO

# === ASSET STATISTICS (For Reference) - 16 Assets ===
# Asset         | Predict% | Daily Vol | Risk Level | Elliott Wave | Stop Loss | Position
# --------------|----------|-----------|------------|--------------|-----------|----------
# XAU/USD       | 95%      | 1.0-1.5%  | MEDIUM     | ⭐⭐⭐⭐⭐     | 2.36%     | 10%
# EUR/USD       | 88%      | 0.6-1.0%  | LOW        | ⭐⭐⭐⭐⭐     | 2.36%     | 10%
# GBP/USD       | 84%      | 1.0-1.5%  | LOW-MED    | ⭐⭐⭐⭐      | 2.36%     | 10%
# USOIL         | 82%      | 2.0-4.0%  | MEDIUM     | ⭐⭐⭐⭐      | 3.00%     | 8%
# SPY           | 80%      | 1.0-2.0%  | MEDIUM     | ⭐⭐⭐⭐      | 3.00%     | 8%
# QQQ           | 78%      | 1.5-3.0%  | MED-HIGH   | ⭐⭐⭐⭐      | 3.50%     | 7%
# NVDA          | 75-80%   | 3.0-6.0%  | HIGH       | ⭐⭐⭐⭐⭐     | 5.00%     | 5%
# AAPL          | 75%      | 1.0-3.0%  | MEDIUM     | ⭐⭐⭐⭐      | 4.00%     | 6%
# MSFT          | 75%      | 1.0-3.0%  | MEDIUM     | ⭐⭐⭐⭐      | 4.00%     | 6%
# TSLA          | 75%      | 3.0-8.0%  | VERY HIGH  | ⭐⭐⭐⭐      | 5.00%     | 3%
# USD/JPY       | 73%      | 0.5-0.8%  | LOW        | ⭐⭐⭐⭐      | 2.36%     | 10%
# AUD/USD       | 70%      | 0.6-1.0%  | MEDIUM     | ⭐⭐⭐⭐      | 2.36%     | 10%
# USD/CHF       | 57%      | 0.4-0.7%  | LOW        | ⭐⭐⭐       | 2.36%     | 10%
# NGAS          | 55%      | 5.0-10.0% | VERY HIGH  | ⭐⭐        | 6.00%     | 3%
# BTC/USD       | 50%      | 2.0-5.0%  | VERY HIGH  | ⭐⭐⭐⭐      | 5.00%     | 3%
# ETH/USD       | 45%      | 3.0-8.0%  | EXTREME    | ⭐⭐⭐       | 6.00%     | 2%
#
# AVERAGE PREDICTABILITY: 73% (weighted by position size)
# API USAGE: 16 assets × 3 calls = 48 calls/scan → ~16 scans/day (800/day limit)

# === TIMEFRAMES ===
TIMEFRAMES = {
    "daily": "1d",  # Makro-Trend-Filter
    "h4": "4h",  # Trend-Richtung
    "h1": "1h",  # HAUPT-ANALYSE (Setup-Identifikation)
    "m15": "15m",  # Entry-Timing
}

# === FIBONACCI-OPTIMIZED INDICATORS ===
# All Fibonacci numbers!
EMA_PERIODS: List[int] = [3, 5, 8, 13, 21, 34, 55, 89, 144, 200]

# Bollinger Bands (Golden Ratio)
BB_PERIOD = 21
BB_STD_DEV = 1.618  # Golden Ratio instead of standard 2.0

# Stochastic (Fibonacci)
STOCH_K = 13
STOCH_D = 5
STOCH_SMOOTH = 8

# ADX (Fibonacci)
ADX_PERIOD = 13

# RSI
RSI_PERIOD = 14

# === SCORING SYSTEM (Total: 113 points) ===
SCORE_WEIGHTS = {
    "fibonacci_levels": 34,  # Fibonacci retracements/extensions
    "ema_structure": 21,  # EMA alignment
    "stochastic": 13,  # Stochastic position
    "bollinger_bands": 13,  # BB squeeze/expansion
    "adx": 8,  # Trend strength
    "elliott_wave": 8,  # Wave pattern
    "fibonacci_time": 5,  # Time-based Fibonacci
    "volume": 3,  # Volume confirmation
    "confluence_bonus": 13,  # Multiple confirmations
}

# Minimum score to trigger trade
MIN_SCORE = 75
OPTIMAL_SCORE = 85

# === RISK MANAGEMENT (Golden Ratio) ===
PORTFOLIO_SIZE = 100.0  # EUR
POSITION_SIZE_PCT = 0.10  # 10% per trade
POSITION_SIZE = PORTFOLIO_SIZE * POSITION_SIZE_PCT  # 10 EUR

# Stop-Loss & Take-Profit (Fibonacci)
STOP_LOSS_PCT = 0.0236  # -2.36% (Fibonacci)
TAKE_PROFIT_PCT = 0.0618  # +6.18% (Golden Ratio)

# Risk/Reward Ratio
RISK_REWARD_RATIO = TAKE_PROFIT_PCT / STOP_LOSS_PCT  # 2.618:1

# Leverage based on score (8:5:3 Fibonacci Ratio)
LEVERAGE_MAP = {"low": 3, "medium": 5, "high": 8}  # Score 75-79  # Score 80-84  # Score 85+

# === TRADING HOURS (MEZ) ===
TRADING_START_HOUR = 9  # 09:00 MEZ
TRADING_END_HOUR = 16  # 16:00 MEZ (last entry)
FORCE_CLOSE_HOUR = 22  # 22:00 MEZ (force close all positions)

# === TRADING RULES ===
MAX_TRADES_PER_DAY = 1
INTRADAY_ONLY = True  # No overnight positions

# === DATA QUALITY ===
# Strict validation mode: False for testing (allows synthetic data), True for production
STRICT_DATA_VALIDATION = os.getenv("STRICT_DATA_VALIDATION", "false").lower() == "true"

# === DATA PATHS ===
DATA_DIR = "data"
SCREENING_RESULTS_FILE = f"{DATA_DIR}/screening_results.json"
TRADES_FILE = f"{DATA_DIR}/trades.json"
PERFORMANCE_FILE = f"{DATA_DIR}/performance.json"

# === EMAIL NOTIFICATIONS (Optional) ===
EMAIL_ENABLED = os.getenv("EMAIL_ENABLED", "false").lower() == "true"
EMAIL_USER = os.getenv("EMAIL_USER", "")
EMAIL_PASSWORD = os.getenv("EMAIL_PASSWORD", "")
EMAIL_TO = os.getenv("EMAIL_TO", "")
