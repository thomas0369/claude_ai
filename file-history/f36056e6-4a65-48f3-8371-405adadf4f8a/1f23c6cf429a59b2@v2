"""
Unit tests for data_quality.py module - SIMPLIFIED VERSION

Tests the DataQualityAssessment class which provides 0-100 quality scoring
for market data based on completeness, freshness, gaps, integrity, and volume.
"""

import pytest
import pandas as pd
import numpy as np
from datetime import datetime, timezone, timedelta
from data_quality import DataQualityAssessment


class TestDataQualityAssessment:
    """Test suite for Data QualityAssessment class."""

    def test_initialization(self):
        """Test DataQualityAssessment initialization."""
        dqa = DataQualityAssessment()
        assert dqa is not None
        assert hasattr(dqa, 'assess_quality')

    def test_basic_quality_assessment(self, sample_ohlcv_data):
        """Test basic quality assessment functionality."""
        dqa = DataQualityAssessment()

        result = dqa.assess_quality(
            symbol="EUR/USD",
            timeframe="5m",
            df=sample_ohlcv_data,
            metadata=None,
            target_candles=500
        )

        # Check result structure
        assert 'overall_score' in result
        assert 'breakdown' in result
        assert 'status' in result
        assert 'ready_for_trading' in result

        # Score should be 0-100
        assert 0 <= result['overall_score'] <= 100

    def test_breakdown_structure(self, sample_ohlcv_data):
        """Test that breakdown contains all metrics."""
        dqa = DataQualityAssessment()

        result = dqa.assess_quality(
            symbol="EUR/USD",
            timeframe="5m",
            df=sample_ohlcv_data
        )

        breakdown = result['breakdown']
        assert 'completeness' in breakdown
        assert 'freshness' in breakdown
        assert 'gaps' in breakdown
        assert 'integrity' in breakdown
        assert 'volume' in breakdown

    def test_scoring_range(self, sample_ohlcv_data):
        """Test that scores are within valid ranges."""
        dqa = DataQualityAssessment()

        result = dqa.assess_quality(
            symbol="EUR/USD",
            timeframe="5m",
            df=sample_ohlcv_data
        )

        # Overall score 0-100
        assert 0 <= result['overall_score'] <= 100

        # Individual scores within limits
        breakdown = result['breakdown']
        assert 0 <= breakdown['completeness']['score'] <= 25
        assert 0 <= breakdown['freshness']['score'] <= 25
        assert 0 <= breakdown['gaps']['score'] <= 20
        assert 0 <= breakdown['integrity']['score'] <= 15
        assert 0 <= breakdown['volume']['score'] <= 15

