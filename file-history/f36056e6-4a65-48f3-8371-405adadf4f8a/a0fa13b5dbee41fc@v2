"""
System Verification Script

Checks that all components of the Elliott Wave Trading Bot v3.0
are properly configured and functioning.
"""

import sys
import os
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent / 'src'))

def print_section(title):
    """Print a section header."""
    print(f"\n{'='*60}")
    print(f"{title}")
    print('='*60)

def check_mark(condition, message):
    """Print a check mark or X based on condition."""
    symbol = "‚úÖ" if condition else "‚ùå"
    print(f"{symbol} {message}")
    return condition

def verify_environment():
    """Verify environment setup."""
    print_section("1. ENVIRONMENT VERIFICATION")

    all_good = True

    # Check Python version
    version = sys.version_info
    version_ok = version.major == 3 and version.minor >= 8
    all_good &= check_mark(
        version_ok,
        f"Python version: {version.major}.{version.minor}.{version.micro}"
    )

    # Check virtual environment
    venv_exists = Path('.venv').exists()
    all_good &= check_mark(venv_exists, "Virtual environment exists")

    # Check .env file
    env_exists = Path('.env').exists()
    all_good &= check_mark(env_exists, ".env file exists")

    if env_exists:
        with open('.env', 'r') as f:
            env_content = f.read()

        has_twelvedata = 'TWELVEDATA_API_KEY' in env_content
        has_anthropic = 'ANTHROPIC_API_KEY' in env_content

        all_good &= check_mark(
            has_twelvedata,
            "TWELVEDATA_API_KEY configured (required)"
        )

        # Anthropic is optional (for Claude validation)
        if has_anthropic:
            check_mark(True, "ANTHROPIC_API_KEY configured (optional)")
        else:
            print(f"‚ö†Ô∏è  ANTHROPIC_API_KEY not configured (Claude validation disabled)")

    return all_good

def verify_project_structure():
    """Verify project file structure."""
    print_section("2. PROJECT STRUCTURE VERIFICATION")

    all_good = True

    # Core files
    core_files = {
        'src/web_backend.py': 'Flask backend',
        'src/screener.py': 'Asset screener',
        'src/data_cache.py': 'Data cache',
        'src/data_quality.py': 'Data quality module',
        'src/timeframe_engine.py': 'Timeframe engine',
        'src/claude_validation_queue.py': 'Claude validation queue',
        'src/twelvedata_provider.py': 'TwelveData provider',
        'src/frontend/dashboard.html': 'Dashboard UI',
        'src/frontend/index.html': 'Original UI',
    }

    for file_path, description in core_files.items():
        exists = Path(file_path).exists()
        all_good &= check_mark(exists, f"{description}: {file_path}")

    # Documentation files
    doc_files = {
        'START_HERE.md': 'Quick start guide',
        'IMPLEMENTATION_COMPLETE.md': 'Implementation summary',
        'DASHBOARD_README.md': 'Dashboard user guide',
        'CLAUDE_VALIDATION_QUEUE_README.md': 'Claude queue docs',
        'TWELVE_DATA_SETUP.md': 'TwelveData setup guide',
    }

    print("\nDocumentation:")
    for file_path, description in doc_files.items():
        exists = Path(file_path).exists()
        all_good &= check_mark(exists, f"{description}: {file_path}")

    return all_good

def verify_modules():
    """Verify Python modules can be imported."""
    print_section("3. MODULE IMPORT VERIFICATION")

    all_good = True

    modules = [
        ('data_quality', 'DataQualityAssessment'),
        ('timeframe_engine', 'TimeframeEngine'),
        ('claude_validation_queue', 'ClaudeValidationQueue'),
        ('data_cache', 'DataCache'),
        ('twelvedata_provider', 'TwelveDataProvider'),
        ('screener', 'AssetScreener'),
    ]

    for module_name, class_name in modules:
        try:
            module = __import__(module_name, fromlist=[class_name])
            cls = getattr(module, class_name)
            all_good &= check_mark(True, f"Import {module_name}.{class_name}")
        except Exception as e:
            all_good &= check_mark(False, f"Import {module_name}.{class_name}: {e}")

    return all_good

def verify_data_directories():
    """Verify data directories exist."""
    print_section("4. DATA DIRECTORY VERIFICATION")

    all_good = True

    directories = [
        'data',
        'data/cache',
        'data/claude_cache',
    ]

    for dir_path in directories:
        exists = Path(dir_path).exists()
        if not exists:
            Path(dir_path).mkdir(parents=True, exist_ok=True)
            exists = True
        all_good &= check_mark(exists, f"Directory: {dir_path}")

    return all_good

def verify_claude_queue():
    """Verify Claude validation queue system."""
    print_section("5. CLAUDE VALIDATION QUEUE VERIFICATION")

    try:
        from claude_validation_queue import ClaudeValidationQueue

        # Create instance
        queue = ClaudeValidationQueue(
            max_validations_per_day=20,
            min_score_for_validation=85,
            cache_dir="data/test_verification_cache"
        )

        check_mark(True, "Queue instance created")

        # Test validation check
        should, reason = queue.should_validate("TEST/USD", 100)
        check_mark(True, f"Validation check: {reason}")

        # Test queue status
        status = queue.get_queue_status()
        check_mark(True, f"Queue status: {status['queue_length']} items")

        # Test performance stats
        perf = queue.get_performance_stats()
        check_mark(True, f"Performance stats: {perf['total_validations']} validations")

        return True

    except Exception as e:
        check_mark(False, f"Queue verification failed: {e}")
        return False

def verify_api_endpoints():
    """Verify API endpoint structure."""
    print_section("6. API ENDPOINT VERIFICATION")

    try:
        from web_backend import app

        # Get all routes
        routes = []
        for rule in app.url_map.iter_rules():
            if rule.endpoint != 'static':
                routes.append((rule.rule, list(rule.methods)))

        # Expected endpoints
        expected = [
            '/',
            '/dashboard',
            '/api/health',
            '/api/scan',
            '/api/twelvedata/status',
            '/api/twelvedata/symbols',
            '/api/twelvedata/refresh',
            '/api/quality/assess',
            '/api/quality/system',
            '/api/quality/startup',
            '/api/timeframes/available',
            '/api/timeframes/calculate',
            '/api/timeframes/resample',
            '/api/timeframes/recommend',
            '/api/claude/enqueue',
            '/api/claude/queue/status',
            '/api/claude/performance',
            '/api/claude/settings',
        ]

        route_paths = [r[0] for r in routes]

        all_good = True
        for endpoint in expected:
            exists = endpoint in route_paths
            all_good &= check_mark(exists, f"Endpoint: {endpoint}")

        print(f"\nTotal endpoints: {len(routes)}")

        return all_good

    except Exception as e:
        check_mark(False, f"API verification failed: {e}")
        return False

def verify_dashboard_html():
    """Verify dashboard HTML structure."""
    print_section("7. DASHBOARD HTML VERIFICATION")

    try:
        dashboard_path = Path('src/frontend/dashboard.html')

        if not dashboard_path.exists():
            check_mark(False, "Dashboard HTML file not found")
            return False

        with open(dashboard_path, 'r') as f:
            html_content = f.read()

        # Check for key sections
        checks = [
            ('Data Pipeline tab', 'tab-pipeline' in html_content),
            ('Timeframe Engine tab', 'tab-timeframes' in html_content),
            ('Data Quality tab', 'tab-quality' in html_content),
            ('Live Signals tab', 'tab-signals' in html_content),
            ('Claude AI tab', 'tab-claude' in html_content),
            ('API_URL constant', 'API_URL' in html_content),
            ('loadClaudeData function', 'loadClaudeData' in html_content),
            ('saveClaudeSettings function', 'saveClaudeSettings' in html_content),
        ]

        all_good = True
        for check_name, condition in checks:
            all_good &= check_mark(condition, check_name)

        return all_good

    except Exception as e:
        check_mark(False, f"Dashboard verification failed: {e}")
        return False

def print_summary(results):
    """Print verification summary."""
    print_section("VERIFICATION SUMMARY")

    all_passed = all(results.values())

    for section, passed in results.items():
        status = "‚úÖ PASSED" if passed else "‚ùå FAILED"
        print(f"{status} - {section}")

    print(f"\n{'='*60}")
    if all_passed:
        print("üéâ ALL VERIFICATIONS PASSED!")
        print("‚úÖ System is ready for production")
        print(f"{'='*60}")
        print("\nNext steps:")
        print("1. python src/web_backend.py")
        print("2. Open http://localhost:5000/dashboard")
        print("3. Run quality check (Tab 3)")
        print("4. Run signal scan (Tab 4)")
    else:
        print("‚ö†Ô∏è  SOME VERIFICATIONS FAILED")
        print("Please review the failed checks above")
        print(f"{'='*60}")

    return all_passed

def run_verification():
    """Run all verification checks."""
    print("\n")
    print("="*60)
    print("ELLIOTT WAVE TRADING BOT v3.0 - SYSTEM VERIFICATION")
    print("="*60)

    results = {
        'Environment': verify_environment(),
        'Project Structure': verify_project_structure(),
        'Module Imports': verify_modules(),
        'Data Directories': verify_data_directories(),
        'Claude Queue': verify_claude_queue(),
        'API Endpoints': verify_api_endpoints(),
        'Dashboard HTML': verify_dashboard_html(),
    }

    return print_summary(results)

if __name__ == "__main__":
    success = run_verification()
    sys.exit(0 if success else 1)
