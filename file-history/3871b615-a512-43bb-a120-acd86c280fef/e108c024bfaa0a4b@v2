'use client';

/**
 * Time Attack Game Mode Client
 *
 * Features:
 * - Countdown timer (60s, 180s, or 300s based on variant)
 * - Game ends when timer reaches 0
 * - Goal: Maximize score within time limit
 * - Timer warnings (yellow at 30s, red at 10s)
 * - Auto-submit score when time expires
 * - High score tracking via leaderboard
 * - Audio feedback for time warnings
 * - Haptic feedback on time milestones
 */

import { useState, useEffect, useCallback, useRef } from 'react';
import dynamic from 'next/dynamic';
import { useRouter } from 'next/navigation';
import { Timer } from '@/components/ui/Timer';
import { Button, Modal } from '@/components/ui';
import { LeaderboardUtils } from '@/components/game/Leaderboard';
import { saveLevelProgress, updateStats } from '@/lib/storage/progressStorage';
import { soundEffects } from '@/lib/audio/SoundEffects';
import { haptics } from '@/lib/utils/haptics';

// Dynamically import Konva game to avoid SSR issues
const KonvaGame = dynamic(
  () => import('@/components/game/KonvaGame').then(mod => mod.KonvaGame),
  {
    ssr: false,
    loading: () => (
      <div className="w-full h-96 flex items-center justify-center bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <p className="text-white text-xl">Loading game engine...</p>
        </div>
      </div>
    ),
  }
);

interface TimeAttackGameClientProps {
  variant: '60s' | '180s' | '300s';
}

interface TimeAttackModeData {
  id: string;
  name: string;
  timeLimit: number;
  gridSize: number;
  difficulty: 'easy' | 'medium' | 'hard';
  tier: 'FREE' | 'TRIAL' | 'PREMIUM';
  gridConfig: {
    rows: number;
    cols: number;
  };
  blocks: Array<{
    id: string;
    shape: number[][];
    color: string;
    frequency: number;
  }>;
}

export function TimeAttackGameClient({ variant }: TimeAttackGameClientProps) {
  const router = useRouter();
  const [modeData, setModeData] = useState<TimeAttackModeData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [score, setScore] = useState(0);
  const [linesCleared, setLinesCleared] = useState(0);
  const [maxCombo, setMaxCombo] = useState(0);
  const [timeRemaining, setTimeRemaining] = useState(0);
  const [isPaused] = useState(false);
  const [isDragging, setIsDragging] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [hasWarned30s, setHasWarned30s] = useState(false);
  const [hasWarned10s, setHasWarned10s] = useState(false);

  const gameStartTimeRef = useRef<number>(Date.now());
  const previousScoreRef = useRef<number>(0);
  const previousLinesRef = useRef<number>(0);

  // Load mode configuration
  useEffect(() => {
    async function loadMode() {
      try {
        const basePath = process.env.NODE_ENV === 'production' ? '/block-puzzle-hero' : '';
        const response = await fetch(`${basePath}/modes/time-attack/${variant}.json`);

        if (!response.ok) {
          throw new Error(`Time Attack ${variant} mode not found`);
        }

        const data = (await response.json()) as TimeAttackModeData;
        setModeData(data);
        setTimeRemaining(data.timeLimit);
        gameStartTimeRef.current = Date.now();
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to load mode');
      } finally {
        setLoading(false);
      }
    }

    loadMode();
  }, [variant]);

  // Handle timer countdown and warnings
  useEffect(() => {
    if (!modeData || timeRemaining <= 0 || isPaused || isDragging) return;

    const interval = setInterval(() => {
      setTimeRemaining(prev => {
        const newTime = prev - 1;

        // Time's up!
        if (newTime <= 0) {
          clearInterval(interval);
          handleTimeUp();
          return 0;
        }

        // 30 second warning
        if (newTime === 30 && !hasWarned30s) {
          setHasWarned30s(true);
          soundEffects.play('blockPlace', { pitch: 0.8, volume: 0.6 });
          haptics.trigger('medium');
        }

        // 10 second warning (critical)
        if (newTime === 10 && !hasWarned10s) {
          setHasWarned10s(true);
          soundEffects.play('blockPlace', { pitch: 0.6, volume: 0.8 });
          haptics.trigger('heavy');
        }

        // Tick sound every second in last 5 seconds
        if (newTime <= 5) {
          soundEffects.play('blockPlace', { pitch: 1.5, volume: 0.4 });
        }

        return newTime;
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [modeData, timeRemaining, isPaused, isDragging, hasWarned30s, hasWarned10s, handleTimeUp]);

  // Handle score update and track combo
  const handleScoreUpdate = useCallback((newScore: number) => {
    // Calculate lines cleared (approximate based on score increase)
    const scoreDelta = newScore - previousScoreRef.current;
    if (scoreDelta >= 100) {
      const newLines = Math.floor(scoreDelta / 100);
      setLinesCleared(prev => prev + newLines);
      previousLinesRef.current += newLines;
    }

    setScore(newScore);
    previousScoreRef.current = newScore;
  }, []);

  // Track max combo (currently not used - will be needed when KonvaGame supports combo callbacks)

  // Handle time up
  const handleTimeUp = useCallback(() => {
    if (showModal) return; // Prevent duplicate calls

    // Play time's up sound
    soundEffects.play('gameOver');
    haptics.gameOver();

    // Calculate play time
    const playTime = Math.floor((Date.now() - gameStartTimeRef.current) / 1000);

    // Save to leaderboard
    if (modeData) {
      LeaderboardUtils.addScore({
        score,
        mode: 'time-attack',
        date: new Date().toISOString(),
        playerName: 'Player',
      });

      // Save progress
      saveLevelProgress({
        levelId: modeData.id,
        mode: 'time-attack',
        completed: true,
        highScore: score,
        stars: calculateStars(score),
        time: playTime,
        lastPlayed: new Date().toISOString(),
        attempts: 0,
      });

      // Update stats
      updateStats({
        totalGamesPlayed: 1,
        totalScore: score,
        totalLines: linesCleared,
        bestCombo: maxCombo,
        totalPlayTime: playTime,
      });
    }

    // Show modal
    setShowModal(true);
  }, [score, linesCleared, maxCombo, modeData, showModal, calculateStars]);

  // Calculate stars based on score (simplified)
  const calculateStars = (finalScore: number): number => {
    if (!modeData) return 0;

    // Thresholds based on time limit
    const thresholds = {
      '60s': [1000, 2500, 5000],
      '180s': [3000, 7000, 12000],
      '300s': [5000, 12000, 20000],
    };

    const limits = thresholds[variant];
    if (finalScore >= limits[2]) return 3;
    if (finalScore >= limits[1]) return 2;
    if (finalScore >= limits[0]) return 1;
    return 0;
  };

  // Handle restart
  const handleRestart = () => {
    setShowModal(false);
    setScore(0);
    setLinesCleared(0);
    setMaxCombo(0);
    setHasWarned30s(false);
    setHasWarned10s(false);

    if (modeData) {
      setTimeRemaining(modeData.timeLimit);
    }

    gameStartTimeRef.current = Date.now();
    previousScoreRef.current = 0;
    previousLinesRef.current = 0;

    router.refresh();
  };

  // Handle back to mode selection
  const handleBackToModes = () => {
    router.push('/modes/time-attack');
  };

  // Pause timer when dragging blocks
  const handleDragStart = () => {
    setIsDragging(true);
  };

  const handleDragEnd = () => {
    setIsDragging(false);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900/20 to-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-500 mx-auto mb-4"></div>
          <p className="text-white text-xl">Loading Time Attack Mode...</p>
        </div>
      </div>
    );
  }

  if (error || !modeData) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900/20 to-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">‚ùå</div>
          <h2 className="text-2xl font-bold text-white mb-2">Mode Not Found</h2>
          <p className="text-gray-400 mb-6">{error || 'This mode does not exist'}</p>
          <Button onClick={handleBackToModes}>Back to Time Attack</Button>
        </div>
      </div>
    );
  }

  // Get timer variant based on time remaining
  const getTimerVariant = () => {
    if (timeRemaining <= 10) return 'danger';
    if (timeRemaining <= 30) return 'warning';
    return 'default';
  };

  // Create level config for KonvaGame (adapt mode data to level format)
  const levelConfig = {
    levelNumber: 0,
    name: modeData.name,
    description: `Score as many points as you can in ${modeData.timeLimit} seconds!`,
    difficulty: modeData.difficulty === 'easy' ? 1 : modeData.difficulty === 'medium' ? 2 : 3,
    tier: modeData.tier,
    gridConfig: modeData.gridConfig,
    targetScore: 0, // No target score for time attack
    timeLimit: null, // We manage time externally
    blocks: modeData.blocks,
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900/20 to-gray-900">
      <div className="container mx-auto px-4 py-8">
        <div className="max-w-6xl mx-auto">
          {/* Header */}
          <div className="mb-6 flex items-center justify-between">
            <Button variant="ghost" onClick={handleBackToModes}>
              <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              Back to Modes
            </Button>

            <div className="text-right">
              <h2 className="text-xl font-bold text-white">{modeData.name}</h2>
              <p className="text-gray-400 text-sm capitalize">Time Attack - {modeData.difficulty}</p>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* HUD Panel */}
            <div className="lg:col-span-1 space-y-4">
              {/* Timer - Most Prominent */}
              <Timer
                timeLimit={modeData.timeLimit}
                onTimeUp={handleTimeUp}
                isPaused={isPaused || isDragging}
                variant={getTimerVariant()}
              />

              {/* Score Display */}
              <div className="bg-gradient-to-br from-gray-800 to-gray-900 border-2 border-gray-700 rounded-xl p-6">
                <div className="text-center">
                  <p className="text-gray-400 text-sm font-medium mb-2">Score</p>
                  <p className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 font-mono">
                    {score.toLocaleString()}
                  </p>
                </div>

                {/* Stats */}
                <div className="mt-6 grid grid-cols-2 gap-4">
                  <div className="text-center">
                    <p className="text-gray-500 text-xs mb-1">Lines</p>
                    <p className="text-white text-2xl font-bold">{linesCleared}</p>
                  </div>
                  <div className="text-center">
                    <p className="text-gray-500 text-xs mb-1">Best Combo</p>
                    <p className="text-white text-2xl font-bold">{maxCombo > 0 ? `x${maxCombo}` : '-'}</p>
                  </div>
                </div>
              </div>

              {/* High Score */}
              <div className="bg-gradient-to-br from-yellow-900/20 to-orange-900/20 border-2 border-yellow-600/30 rounded-xl p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">üèÜ</span>
                    <span className="text-gray-400 text-sm">High Score</span>
                  </div>
                  <span className="text-yellow-400 text-xl font-bold font-mono">
                    {LeaderboardUtils.getHighScore('time-attack').toLocaleString()}
                  </span>
                </div>
              </div>

              {/* Objective */}
              <div className="bg-gray-800 border border-gray-700 rounded-xl p-4">
                <h3 className="text-white font-bold mb-2 flex items-center gap-2">
                  <span className="text-xl">üéØ</span>
                  Objective
                </h3>
                <p className="text-gray-400 text-sm">
                  Score as many points as possible before time runs out! Clear lines for bonus points and build combos for multipliers.
                </p>
              </div>
            </div>

            {/* Game Canvas */}
            <div className="lg:col-span-2">
              <div
                onMouseDown={handleDragStart}
                onMouseUp={handleDragEnd}
                onTouchStart={handleDragStart}
                onTouchEnd={handleDragEnd}
              >
                <KonvaGame
                  level={levelConfig}
                  onScoreUpdate={handleScoreUpdate}
                  onGameOver={() => {}} // Ignore game over from grid full
                  onLevelComplete={() => {}} // No level complete in time attack
                />
              </div>
            </div>
          </div>

          {/* Time's Up Modal */}
          <Modal
            isOpen={showModal}
            onClose={() => setShowModal(false)}
            title="Time's Up!"
          >
            <div className="text-center py-6">
              <div className="text-6xl mb-4">‚è±Ô∏è</div>
              <h3 className="text-2xl font-bold text-gray-900 mb-2">Time&apos;s Up!</h3>
              <p className="text-gray-600 mb-6">
                You survived {modeData.timeLimit} seconds!
              </p>

              {/* Final Score */}
              <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 mb-6">
                <div className="text-sm text-gray-600 mb-2">Final Score</div>
                <div className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-4">
                  {score.toLocaleString()}
                </div>

                {/* Stats Grid */}
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <div className="text-gray-500 mb-1">Lines</div>
                    <div className="text-gray-900 font-bold text-lg">{linesCleared}</div>
                  </div>
                  <div>
                    <div className="text-gray-500 mb-1">Best Combo</div>
                    <div className="text-gray-900 font-bold text-lg">
                      {maxCombo > 0 ? `x${maxCombo}` : '-'}
                    </div>
                  </div>
                  <div>
                    <div className="text-gray-500 mb-1">Time</div>
                    <div className="text-gray-900 font-bold text-lg">{modeData.timeLimit}s</div>
                  </div>
                </div>
              </div>

              {/* Stars */}
              {calculateStars(score) > 0 && (
                <div className="flex justify-center gap-2 mb-6">
                  {Array.from({ length: calculateStars(score) }, (_, i) => (
                    <span key={i} className="text-4xl animate-bounce" style={{ animationDelay: `${i * 0.1}s` }}>
                      ‚≠ê
                    </span>
                  ))}
                </div>
              )}

              {/* High Score Check */}
              {score > LeaderboardUtils.getHighScore('time-attack') && (
                <div className="mb-6 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                  <p className="text-yellow-900 font-bold flex items-center justify-center gap-2">
                    <span className="text-2xl">üéâ</span>
                    New High Score!
                  </p>
                </div>
              )}

              {/* Action Buttons */}
              <div className="flex gap-4 justify-center">
                <Button variant="outline" onClick={handleBackToModes}>
                  Change Mode
                </Button>
                <Button variant="primary" onClick={handleRestart}>
                  Play Again
                </Button>
              </div>

              {/* Share Score */}
              <div className="mt-6">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    const text = `I scored ${score.toLocaleString()} points in Time Attack ${variant}! Can you beat that? üéÆ`;
                    if (navigator.share) {
                      navigator.share({ text });
                    } else {
                      navigator.clipboard.writeText(text);
                      alert('Score copied to clipboard!');
                    }
                  }}
                >
                  üì§ Share Score
                </Button>
              </div>
            </div>
          </Modal>
        </div>
      </div>
    </div>
  );
}
