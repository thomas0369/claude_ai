/**
 * DeepSeek Vision API Types
 * ==========================
 *
 * TypeScript types and Zod schemas for DeepSeek Vision API integration.
 * Based on Python implementation: scripts/deepseek_vision_client.py
 */

import { z } from 'zod';

/**
 * DeepSeek Client Configuration
 */
export interface DeepSeekConfig {
  /** DeepSeek API key (or set DEEPSEEK_API_KEY env var) */
  apiKey: string;
  /** API base URL */
  baseUrl?: string;
  /** Maximum requests per minute (default: 60) */
  maxRequestsPerMinute?: number;
  /** Maximum cost in USD per session (default: $1.00) */
  maxCostUsd?: number;
  /** Request timeout in milliseconds (default: 60000) */
  timeout?: number;
  /** Number of retry attempts (default: 3) */
  retries?: number;
}

/**
 * Power Specifications
 */
export const PowerSchema = z.object({
  rated_power_kw: z.number().nullable(),
  max_power_kw: z.number().nullable(),
  continuous_power_kw: z.number().nullable(),
});

export type Power = z.infer<typeof PowerSchema>;

/**
 * Efficiency Specifications
 */
export const EfficiencySchema = z.object({
  peak_percent: z.number().nullable(),
  rated_percent: z.number().nullable(),
});

export type Efficiency = z.infer<typeof EfficiencySchema>;

/**
 * Voltage Specifications
 */
export const VoltageSchema = z.object({
  nominal_v: z.number().nullable(),
  max_v: z.number().nullable(),
  min_v: z.number().nullable(),
});

export type Voltage = z.infer<typeof VoltageSchema>;

/**
 * Physical Dimensions
 */
export const PhysicalSchema = z.object({
  width_mm: z.number().nullable(),
  height_mm: z.number().nullable(),
  depth_mm: z.number().nullable(),
  weight_kg: z.number().nullable(),
});

export type Physical = z.infer<typeof PhysicalSchema>;

/**
 * Environmental Specifications
 */
export const EnvironmentalSchema = z.object({
  operating_temp_min_c: z.number().nullable(),
  operating_temp_max_c: z.number().nullable(),
  humidity_max_percent: z.number().nullable(),
});

export type Environmental = z.infer<typeof EnvironmentalSchema>;

/**
 * Battery Specifications
 */
export const BatterySchema = z.object({
  capacity_kwh: z.number().nullable(),
  type: z.string().nullable(),
  cycles: z.number().nullable(),
});

export type Battery = z.infer<typeof BatterySchema>;

/**
 * Complete Extraction Result from DeepSeek Vision API
 */
export const ExtractionResultSchema = z.object({
  model_name: z.string(),
  manufacturer: z.string().nullable(),
  power: PowerSchema,
  efficiency: EfficiencySchema,
  voltage: VoltageSchema,
  physical: PhysicalSchema,
  environmental: EnvironmentalSchema,
  battery: BatterySchema,
  certifications: z.array(z.string()),
});

export type ExtractionResult = z.infer<typeof ExtractionResultSchema>;

/**
 * DeepSeek API Message Content (text or image)
 */
export type MessageContent =
  | { type: 'text'; text: string }
  | { type: 'image_url'; image_url: { url: string } };

/**
 * DeepSeek API Message
 */
export interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string | MessageContent[];
}

/**
 * DeepSeek API Request Payload
 */
export interface DeepSeekAPIRequest {
  model: string;
  messages: Message[];
  temperature?: number;
  max_tokens?: number;
}

/**
 * DeepSeek API Response
 */
export interface DeepSeekAPIResponse {
  id: string;
  object: string;
  created: number;
  model: string;
  choices: Array<{
    index: number;
    message: {
      role: string;
      content: string;
    };
    finish_reason: string;
  }>;
  usage?: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}

/**
 * Rate Limiting State
 */
export interface RateLimitState {
  requestTimes: Date[];
  totalCost: number;
  requestCount: number;
}

/**
 * Extraction Statistics
 */
export interface ExtractionStats {
  requestCount: number;
  totalCost: number;
  averageDuration: number;
  successRate: number;
}

/**
 * Error Types
 */
export class DeepSeekAPIError extends Error {
  constructor(
    message: string,
    public statusCode?: number,
    public response?: any
  ) {
    super(message);
    this.name = 'DeepSeekAPIError';
  }
}

export class DeepSeekRateLimitError extends Error {
  constructor(message: string, public retryAfter?: number) {
    super(message);
    this.name = 'DeepSeekRateLimitError';
  }
}

export class DeepSeekCostLimitError extends Error {
  constructor(
    message: string,
    public currentCost: number,
    public estimatedCost: number,
    public limit: number
  ) {
    super(message);
    this.name = 'DeepSeekCostLimitError';
  }
}

/**
 * Pricing Constants (update when DeepSeek changes pricing)
 */
export const DEEPSEEK_PRICING = {
  INPUT_PER_M_TOKENS: 0.14,
  OUTPUT_PER_M_TOKENS: 0.28,
  AVG_INPUT_TOKENS_PER_IMAGE: 2000,
  AVG_OUTPUT_TOKENS_PER_IMAGE: 500,
} as const;

/**
 * Default Configuration Values
 */
export const DEFAULT_CONFIG: Partial<DeepSeekConfig> = {
  baseUrl: 'https://api.deepseek.com/v1',
  maxRequestsPerMinute: 60,
  maxCostUsd: 1.0,
  timeout: 60000,
  retries: 3,
} as const;
