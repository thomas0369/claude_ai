# Intelligent Multi-Product PDF Extraction System

## √úbersicht

Komplettes System f√ºr die intelligente Extraktion von Multi-Produkt-Datasheets mit:

‚úÖ **Multi-Produkt Tabellen** - Ein PDF = Mehrere Produkte
‚úÖ **Automatische Validierung** - Plausibilit√§tspr√ºfung
‚úÖ **Database Cross-Check** - Vergleich mit existierenden Daten
‚úÖ **Self-Verification** - AI pr√ºft sich selbst
‚úÖ **Unit Normalization** - Automatische Umrechnung (Punkt/Komma, kW/MW, etc.)
‚úÖ **Confidence Scoring** - Pro Feld und gesamt

## Was wurde implementiert

### 1. Enhanced Prompts (`lib/deepseek/enhanced-prompts.ts`)

**Spezielle Prompts f√ºr**:
- Multi-Produkt Tabellen (Spalte 1 = Features, Spalten 2-4 = Produkte)
- Dezimaltrennzeichen (Punkt vs. Komma: 97.5 vs 97,5)
- Unit-Erkennung (kW, MW, W, kV, V, kg, tons, etc.)
- Herstellerspezifische Formate
- Sprachen (Deutsch/Englisch)

**Funktionen**:
```typescript
getExtractionPrompt(context: PromptContext): string
createValidationPrompt(extractedData, referenceData): string
createWebVerificationPrompt(model, manufacturer, specs): string
```

### 2. Data Validator (`lib/validation/data-validator.ts`)

**Validierungsregeln**:
- **Power**: > 0, max ‚â• rated, typischer Bereich 1-10,000 kW
- **Efficiency**: 0-100%, typisch 90-99%
- **Voltage**: Min < Max, typischer Bereich 100-2000V
- **Physical**: Positive Werte, Gewicht proportional zu Leistung
- **Environmental**: Min < Max Temperatur
- **Consistency**: Alle zusammenh√§ngenden Werte pr√ºfen

**Funktionen**:
```typescript
validateProductData(product): ValidationResult
crossValidateWithDatabase(extracted, existing): ValidationIssue[]
normalizeDecimal(value): number  // 97,5 ‚Üí 97.5
convertToKW(value, unit): number // 1 MW ‚Üí 1000 kW
```

### 3. Intelligent Extractor (`lib/extraction/intelligent-extractor.ts`)

**Komplette Pipeline**:
1. Extraktion mit enhanced prompt
2. Plausibilit√§ts-Validierung
3. Database Cross-Check
4. AI Self-Verification
5. Automatische Korrekturen
6. Confidence-Berechnung

**Hauptklasse**:
```typescript
class IntelligentExtractor {
  extractWithValidation(images, context): ExtractionReport
}
```

## Verwendung

### Basis-Beispiel

```typescript
import { IntelligentExtractor } from '@/lib/extraction/intelligent-extractor';
import { PDFProcessor } from '@/lib/pdf/processor';

// 1. PDF zu Bildern konvertieren
const processor = new PDFProcessor({ scale: 2.0, maxPages: 5 });
const images = await processor.convertToImages(pdfFile);

// 2. Intelligente Extraktion
const extractor = new IntelligentExtractor(process.env.DEEPSEEK_API_KEY!);

const report = await extractor.extractWithValidation(images, {
  manufacturer: 'GoodWe',
  expectedModels: ['GW50K-ETC', 'GW75K-ETC', 'GW100K-ETC'],
  language: 'en',
  strictValidation: false,  // Warnungen erlauben
});

// 3. Ergebnisse auswerten
console.log(`Extracted ${report.products.length} products`);
console.log(`Overall confidence: ${report.metadata.overallConfidence}%`);
console.log(`Issues found: ${report.allIssues.length}`);

// 4. Produkte verwenden
for (const product of report.products) {
  console.log(`${product.model_name}: ${product.power.rated_power_kw} kW`);
}
```

### Mit Database Cross-Check

```typescript
import { loadProducts } from '@/lib/dataLoader';

// Existierende Produkte laden
const existingProducts = await loadProducts();

// Referenzdaten f√ºr Hersteller filtern
const referenceData = existingProducts.filter(
  (p) => p.identification?.manufacturer === 'GoodWe'
);

// Extraktion mit Cross-Check
const report = await extractor.extractWithValidation(images, {
  manufacturer: 'GoodWe',
  referenceData,  // Vergleich mit DB
  strictValidation: true,  // Fehler = Ablehnung
});

// Warnungen bei Abweichungen
report.allIssues.forEach((issue) => {
  if (issue.severity === 'warning') {
    console.warn(`${issue.field}: ${issue.message}`);
    console.warn(`  Extracted: ${issue.extractedValue}`);
    console.warn(`  Database: ${issue.suggestedValue}`);
  }
});
```

### Strenge Validierung

```typescript
try {
  const report = await extractor.extractWithValidation(images, {
    manufacturer: 'Huawei',
    strictValidation: true,  // ‚ùå Fehler = Exception
  });

  // Wenn wir hier sind: Alle Daten sind valid
  console.log('‚úÖ All data validated successfully');

} catch (error) {
  // Kritische Fehler gefunden
  console.error('‚ùå Validation failed:', error.message);
  // Nutzer muss manuell korrigieren
}
```

## Typische Szenarien

### Szenario 1: Multi-Produkt Tabelle

**PDF Format**:
```
Specification        | GW50K-ETC | GW75K-ETC | GW100K-ETC
---------------------|-----------|-----------|------------
Rated Power (kW)     | 50        | 75        | 100
Max Efficiency (%)   | 98.4      | 98.6      | 98.7
Dimensions (mm)      | 660√ó430√ó195
Weight (kg)          | 95        | 110       | 125
```

**Extraktion**:
```typescript
const report = await extractor.extractWithValidation(images, {
  manufacturer: 'GoodWe',
  multiProduct: true,  // ‚úÖ Multi-Produkt erkennen
});

// Ergebnis: 3 separate Produkte
console.log(report.products.length);  // 3
console.log(report.metadata.tableDetected);  // true
console.log(report.metadata.multiProduct);  // true
```

### Szenario 2: Dezimaltrennzeichen (Deutsch)

**PDF Format** (Deutsch):
```
Nennleistung:    100 kW
Wirkungsgrad:    97,5 %    ‚Üê Komma!
Gewicht:         1.234 kg  ‚Üê Punkt als Tausendertrennzeichen!
```

**Extraktion**:
```typescript
const report = await extractor.extractWithValidation(images, {
  manufacturer: 'Kaco',
  language: 'de',  // ‚úÖ Deutsche Locale
});

// Automatische Konvertierung:
// 97,5 % ‚Üí 97.5
// 1.234 kg ‚Üí 1234
console.log(report.products[0].efficiency.peak_percent);  // 97.5
console.log(report.products[0].physical.weight_kg);        // 1234
```

### Szenario 3: Unit Confusion

**PDF Format**:
```
Rated Power: 100000 W    ‚Üê In Watt statt kW!
Voltage: 1.5 kV          ‚Üê In kV statt V!
Weight: 0.125 tons       ‚Üê In Tonnen statt kg!
```

**Automatische Korrektur**:
```typescript
const report = await extractor.extractWithValidation(images);

// Validator erkennt Unit-Fehler
const powerIssue = report.allIssues.find(i =>
  i.field === 'power.rated_power_kw' && i.suggestedValue
);

console.log(powerIssue.extractedValue);  // 100000
console.log(powerIssue.suggestedValue);  // 100 (automatisch korrigiert)
console.log(powerIssue.reason);          // "Likely unit error (W vs kW)"
```

### Szenario 4: Efficiency Error (Dezimalpunkt vergessen)

**PDF Format**:
```
Peak Efficiency: 975 %   ‚Üê Fehler! Sollte 97.5% sein
```

**Automatische Erkennung**:
```typescript
const report = await extractor.extractWithValidation(images);

// Validator erkennt unm√∂glichen Wert
const efficiencyIssue = report.allIssues.find(i =>
  i.field === 'efficiency.peak_percent'
);

console.log(efficiencyIssue.severity);          // 'error'
console.log(efficiencyIssue.extractedValue);    // 975
console.log(efficiencyIssue.suggestedValue);    // 97.5
console.log(efficiencyIssue.reason);            // "Likely decimal point error"
```

## Validation Rules

### Power Validation
```typescript
‚úÖ Valid:
- 50 kW, 100 kW, 1000 kW
- max_power_kw ‚â• rated_power_kw
- peak_power_kw ‚â• max_power_kw ‚â• rated_power_kw

‚ùå Invalid:
- Negative power
- 0 kW
- max < rated (Werte vertauscht!)
- < 1 kW or > 10,000 kW (ungew√∂hnlich)
```

### Efficiency Validation
```typescript
‚úÖ Valid:
- 90-99% (typisch)
- 95-99.5% (modern)

‚ö†Ô∏è  Warning:
- < 90% (ungew√∂hnlich niedrig)
- > 99.5% (ungew√∂hnlich hoch, aber m√∂glich)

‚ùå Invalid:
- ‚â§ 0% or > 100%
- 975% (Dezimalpunkt vergessen ‚Üí 97.5%)
```

### Physical Validation
```typescript
‚úÖ Valid:
- Weight proportional to power (ca. 1-5 kg/kW)
- Reasonable dimensions (100-5000 mm)

‚ö†Ô∏è  Warning:
- Weight/Power ratio < 0.1 (tons statt kg?)
- Weight/Power ratio > 50 (g statt kg?)
- Dimensions outside typical range
```

## API Response Format

```typescript
interface ExtractionReport {
  // Extrahierte Produkte (mit Korrekturen)
  products: ExtractedProduct[];

  // Validierungsergebnisse pro Produkt
  validations: ValidationResult[];

  // Gesamt-Metadaten
  metadata: {
    pagesProcessed: number;
    tableDetected: boolean;         // Tabelle erkannt?
    multiProduct: boolean;          // Mehrere Produkte?
    extractionDuration: number;     // ms
    cost: number;                   // USD
    overallConfidence: number;      // 0-100
  };

  // Alle gefundenen Issues
  allIssues: ValidationIssue[];     // errors, warnings, info

  // Zusammenfassung
  summary: string;
}

interface ValidationIssue {
  field: string;                    // "power.rated_power_kw"
  severity: 'error' | 'warning' | 'info';
  message: string;
  extractedValue: any;
  suggestedValue?: any;             // Korrekturvorschlag
  reason: string;                   // Warum falsch?
}
```

## Testing

### Test-Script erstellen

```bash
# Create test script
cat > benchmark-app/scripts/test-extraction.ts << 'EOF'
import { IntelligentExtractor } from '@/lib/extraction/intelligent-extractor';
import { PDFProcessor } from '@/lib/pdf/processor';
import { promises as fs } from 'fs';

async function testExtraction() {
  // PDF laden
  const pdfPath = '../datasheets/goodwe/gw_etc_50-100k_combined_datasheet.pdf';
  const pdfBuffer = await fs.readFile(pdfPath);
  const pdfFile = new File([pdfBuffer], 'test.pdf', { type: 'application/pdf' });

  // Zu Bildern konvertieren
  const processor = new PDFProcessor({ scale: 2.0, maxPages: 3 });
  const images = await processor.convertToImages(pdfFile);

  // Extraktion mit Validierung
  const extractor = new IntelligentExtractor(process.env.DEEPSEEK_API_KEY!);
  const report = await extractor.extractWithValidation(images, {
    manufacturer: 'GoodWe',
    expectedModels: ['GW50K-ETC', 'GW75K-ETC', 'GW100K-ETC'],
    language: 'en',
  });

  // Ergebnisse ausgeben
  console.log('\nüìä EXTRACTION REPORT\n');
  console.log(`Products found: ${report.products.length}`);
  console.log(`Overall confidence: ${report.metadata.overallConfidence.toFixed(1)}%`);
  console.log(`Issues: ${report.allIssues.length}`);
  console.log(`Cost: $${report.metadata.cost.toFixed(4)}`);
  console.log(`\n${report.summary}\n`);

  // Produkte
  report.products.forEach((product, i) => {
    console.log(`\nProduct ${i + 1}: ${product.model_name}`);
    console.log(`  Power: ${product.power.rated_power_kw} kW`);
    console.log(`  Efficiency: ${product.efficiency.peak_percent}%`);
    console.log(`  Validation: ${report.validations[i].valid ? '‚úÖ' : '‚ùå'} (${report.validations[i].confidence}%)`);
  });

  // Issues
  if (report.allIssues.length > 0) {
    console.log('\n‚ö†Ô∏è  ISSUES FOUND:\n');
    report.allIssues.forEach((issue) => {
      console.log(`[${issue.severity.toUpperCase()}] ${issue.field}`);
      console.log(`  ${issue.message}`);
      if (issue.suggestedValue !== undefined) {
        console.log(`  ${issue.extractedValue} ‚Üí ${issue.suggestedValue}`);
      }
    });
  }
}

testExtraction().catch(console.error);
EOF

# Run test
npx tsx scripts/test-extraction.ts
```

### Erwartete Ausgabe

```
üìä EXTRACTION REPORT

Products found: 3
Overall confidence: 94.2%
Issues: 2
Cost: $0.0036

Extracted 3 product(s) in 8.4s. Found 0 error(s) and 2 warning(s).

Product 1: GW50K-ETC
  Power: 50 kW
  Efficiency: 98.4%
  Validation: ‚úÖ (96%)

Product 2: GW75K-ETC
  Power: 75 kW
  Efficiency: 98.6%
  Validation: ‚úÖ (94%)

Product 3: GW100K-ETC
  Power: 100 kW
  Efficiency: 98.7%
  Validation: ‚úÖ (93%)

‚ö†Ô∏è  ISSUES FOUND:

[WARNING] physical.weight_kg
  Weight seems unusually low for power rating
  95 ‚Üí Check if correct or missing factor

[INFO] efficiency.peak_percent
  Very high efficiency (> 98.5%) - please verify
```

## Best Practices

### ‚úÖ DO

1. **Immer Hersteller angeben**:
   ```typescript
   { manufacturer: 'GoodWe' }  // Hilft bei Format-Erkennung
   ```

2. **Sprache angeben wenn Deutsch**:
   ```typescript
   { language: 'de' }  // F√ºr Dezimalkomma-Erkennung
   ```

3. **Expected Models angeben wenn bekannt**:
   ```typescript
   { expectedModels: ['GW50K', 'GW75K'] }  // Hilft bei Erkennung
   ```

4. **Referenzdaten mitgeben**:
   ```typescript
   { referenceData: existingProducts }  // F√ºr Cross-Check
   ```

5. **Strict Validation f√ºr Produktion**:
   ```typescript
   { strictValidation: true }  // Fehler = Ablehnung
   ```

### ‚ùå DON'T

1. **Nicht zu wenige Pages**:
   ```typescript
   maxPages: 1  // ‚ùå Tabelle kann auf Seite 2 sein!
   maxPages: 3  // ‚úÖ Minimum f√ºr Multi-Product PDFs
   ```

2. **Nicht niedrige Qualit√§t**:
   ```typescript
   scale: 1.0  // ‚ùå Schlechte Texterkenn

ung
   scale: 2.0  // ‚úÖ Gute Balance
   ```

3. **Nicht Issues ignorieren**:
   ```typescript
   // ‚ùå Issues ignorieren
   await extract(...)

   // ‚úÖ Issues pr√ºfen
   const report = await extract(...)
   if (report.allIssues.some(i => i.severity === 'error')) {
     throw new Error('Manual review required');
   }
   ```

## Zusammenfassung

**Was Sie jetzt haben**:

‚úÖ **3 neue Module**:
- `enhanced-prompts.ts` (270 Zeilen)
- `data-validator.ts` (450 Zeilen)
- `intelligent-extractor.ts` (370 Zeilen)

‚úÖ **Gesamt**: ~1,090 Zeilen intelligente Extraktion

‚úÖ **Features**:
- Multi-Produkt Tabellen ‚úÖ
- Unit Normalization ‚úÖ
- Plausibilit√§ts-Check ‚úÖ
- Database Cross-Check ‚úÖ
- AI Self-Verification ‚úÖ
- Automatische Korrekturen ‚úÖ
- Confidence Scoring ‚úÖ

**Ready to test!** üöÄ
