# DeepSeek PDF Extraction Setup Guide

## Quick Start (3 Steps)

### 1. Configure API Key

Create `.env.local` file in the `benchmark-app/` directory:

```bash
cd benchmark-app
echo "DEEPSEEK_API_KEY=sk-812d550b63ef41dab70775bc6d84a5da" > .env.local
```

Or create manually with this content:
```
DEEPSEEK_API_KEY=sk-812d550b63ef41dab70775bc6d84a5da
```

**Security Note**: `.env.local` is already in `.gitignore` and will NOT be committed to Git.

### 2. Test Locally

Start the development server:
```bash
npm run dev
```

Navigate to: `http://localhost:3000/pdf-extractor` (or create a test page)

Test the PDF extraction:
1. Upload a BESS datasheet PDF
2. Click "Extract Data"
3. Verify the extracted specifications

### 3. Deploy to Vercel

Set the environment variable in Vercel:
```bash
vercel env add DEEPSEEK_API_KEY
```

When prompted:
- Value: `sk-812d550b63ef41dab70775bc6d84a5da`
- Environments: Production, Preview, Development (select all)

Then deploy:
```bash
vercel --prod
```

## API Endpoints

### Extract PDF Data
```
POST /api/pdf/extract
```

**Request**:
```json
{
  "images": ["base64-encoded-image-1", "base64-encoded-image-2"],
  "aggregate": true
}
```

**Response**:
```json
{
  "success": true,
  "data": {
    "model_name": "BYD Cube Pro C230",
    "manufacturer": "BYD",
    "power": {
      "rated_power_kw": 230,
      "max_power_kw": null
    },
    "efficiency": {
      "peak_percent": 89.5
    },
    ...
  },
  "metadata": {
    "pagesProcessed": 2,
    "durationMs": 3420,
    "cost": 0.0012,
    "requestCount": 2
  }
}
```

### Check API Status
```
GET /api/pdf/extract
```

**Response**:
```json
{
  "status": "operational",
  "apiKeyConfigured": true,
  "maxImageCount": 10,
  "maxDuration": 60,
  "version": "1.0.0"
}
```

## Usage Examples

### React Component

```tsx
import { PDFExtractor } from '@/components/pdf-extractor';

export default function PDFUploadPage() {
  return (
    <div className="container mx-auto p-8">
      <h1>PDF Datasheet Extractor</h1>
      <PDFExtractor />
    </div>
  );
}
```

### Programmatic API Call

```typescript
import { DeepSeekVisionClient } from '@/lib/deepseek';
import { PDFProcessor } from '@/lib/pdf/processor';

// Convert PDF to images
const processor = new PDFProcessor({ scale: 2.0, maxPages: 3 });
const images = await processor.convertToImages(pdfFile);

// Extract data
const client = new DeepSeekVisionClient({
  apiKey: process.env.DEEPSEEK_API_KEY!,
  maxCostUsd: 0.05,
});

const result = await client.extractFromImages(images, true);
console.log(result);
```

## Cost Controls

Default safety limits:
- **Max cost per request**: $0.05
- **Max requests per minute**: 60
- **Timeout**: 90 seconds

Customize limits:
```typescript
const client = new DeepSeekVisionClient({
  apiKey: process.env.DEEPSEEK_API_KEY!,
  maxCostUsd: 1.00,           // $1.00 limit
  maxRequestsPerMinute: 30,   // 30 req/min
  timeout: 120000,            // 2 minute timeout
});
```

## Pricing Reference

DeepSeek-VL2 API costs:
- **Input**: $0.14 per million tokens (~$0.00028 per image)
- **Output**: $0.28 per million tokens (~$0.00014 per image)
- **Average cost per page**: ~$0.00042

Example costs:
- Single page PDF: ~$0.0004
- 3-page PDF: ~$0.0012
- 100 PDFs (3 pages each): ~$0.12

## Monitoring

Get usage statistics:
```typescript
const stats = client.getStats();
console.log({
  requestCount: stats.requestCount,
  totalCost: stats.totalCost,
  averageDuration: stats.averageDuration,
  successRate: stats.successRate,
});
```

Reset counters:
```typescript
client.resetStats();
```

## Troubleshooting

### API Key Not Configured
**Error**: "DeepSeek API key not configured"

**Solution**: Ensure `.env.local` exists with correct key:
```bash
cat benchmark-app/.env.local
# Should output: DEEPSEEK_API_KEY=sk-812d550b63ef41dab70775bc6d84a5da
```

### PDF Conversion Failed
**Error**: "Failed to convert PDF to images"

**Possible causes**:
- Corrupted PDF file
- PDF too large (>10 pages not recommended)
- Browser memory limit exceeded

**Solution**: Try with smaller PDF or reduce scale factor

### Extraction Failed
**Error**: "DeepSeek API did not return valid data"

**Possible causes**:
- Invalid API key
- Rate limit exceeded
- API timeout
- Network error

**Solution**: Check API status endpoint and retry

### Cost Limit Exceeded
**Error**: "Cost limit reached"

**Solution**: Either:
- Increase `maxCostUsd` in client configuration
- Call `client.resetStats()` to reset counter
- Wait for automatic reset (per-session)

## File Structure

```
benchmark-app/
├── .env.local                    # API key (you create this)
├── lib/
│   ├── deepseek/
│   │   ├── client.ts            # DeepSeek API client
│   │   ├── types.ts             # TypeScript types & schemas
│   │   ├── index.ts             # Module exports
│   │   └── README.md            # API documentation
│   └── pdf/
│       ├── processor.ts         # PDF to image conversion
│       └── matcher.ts           # Confidence scoring
├── components/
│   └── pdf-extractor.tsx        # React upload component
└── app/
    └── api/
        └── pdf/
            └── extract/
                └── route.ts     # Next.js API route
```

## Features

- ✅ Drag & drop or file picker upload
- ✅ Client-side PDF to image conversion (no server dependencies)
- ✅ Real-time progress tracking
- ✅ Cost estimation and monitoring
- ✅ Rate limiting (60 req/min)
- ✅ Retry logic with exponential backoff
- ✅ Multi-page PDF aggregation
- ✅ Type-safe with Zod validation
- ✅ Vercel serverless compatible
- ✅ Zero Python dependencies

## Next Steps

1. **Create test page**: Add `/app/pdf-extractor/page.tsx` with the PDFExtractor component
2. **Test with real PDFs**: Try with actual BESS datasheets
3. **Monitor costs**: Check extraction costs with `client.getStats()`
4. **Integrate with database**: Save extracted data to products.json
5. **Add batch processing**: Extract multiple PDFs in sequence

## Support

- **Documentation**: See `lib/deepseek/README.md` for full API reference
- **DeepSeek API Docs**: https://platform.deepseek.com/api-docs/
- **PDF.js Documentation**: https://mozilla.github.io/pdf.js/
