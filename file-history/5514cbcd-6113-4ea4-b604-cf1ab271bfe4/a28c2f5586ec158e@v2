#!/usr/bin/env python3
"""
DeepSeek Vision API Client
============================

Uses DeepSeek-VL2 model for intelligent PDF datasheet extraction.
Supports table understanding, OCR, and structured data extraction.

Usage:
    client = DeepSeekVisionClient(api_key="your-api-key")
    result = client.extract_datasheet(image_path)
"""

import os
import json
import base64
import logging
import time
from pathlib import Path
from typing import Dict, List, Optional, Union
from collections import deque
from datetime import datetime, timedelta
import requests

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class DeepSeekVisionClient:
    """Client for DeepSeek Vision API with rate limiting and cost controls."""

    def __init__(
        self,
        api_key: Optional[str] = None,
        base_url: str = "https://api.deepseek.com/v1",
        max_requests_per_minute: int = 60,
        max_cost_usd: float = 1.0,
        timeout: int = 60,
        retries: int = 3
    ):
        """
        Initialize DeepSeek Vision client with safety controls.

        Args:
            api_key: DeepSeek API key (defaults to DEEPSEEK_API_KEY env var)
            base_url: API base URL
            max_requests_per_minute: Rate limit (default: 60)
            max_cost_usd: Maximum spend limit (default: $1.00)
            timeout: Request timeout in seconds (default: 60)
            retries: Number of retry attempts (default: 3)
        """
        self.api_key = api_key or os.getenv("DEEPSEEK_API_KEY")
        if not self.api_key:
            raise ValueError("API key required. Set DEEPSEEK_API_KEY environment variable or pass api_key parameter.")

        self.base_url = base_url.rstrip('/')
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

        # Rate limiting
        self.max_requests_per_minute = max_requests_per_minute
        self.request_times = deque()

        # Cost controls
        self.max_cost_usd = max_cost_usd
        self.total_cost_usd = 0.0
        self.request_count = 0

        # Request configuration
        self.timeout = timeout
        self.retries = retries

    def _encode_image(self, image_path: Path) -> str:
        """Encode image to base64."""
        with open(image_path, 'rb') as f:
            return base64.b64encode(f.read()).decode('utf-8')

    def _create_extraction_prompt(self) -> str:
        """Create structured prompt for datasheet extraction."""
        return """Extract technical specifications from this battery energy storage system (BESS) datasheet.

Extract the following information in JSON format:

{
  "model_name": "exact product model name",
  "manufacturer": "manufacturer name",
  "power": {
    "rated_power_kw": number or null,
    "max_power_kw": number or null,
    "continuous_power_kw": number or null
  },
  "efficiency": {
    "peak_percent": number or null,
    "rated_percent": number or null
  },
  "voltage": {
    "nominal_v": number or null,
    "max_v": number or null,
    "min_v": number or null
  },
  "physical": {
    "width_mm": number or null,
    "height_mm": number or null,
    "depth_mm": number or null,
    "weight_kg": number or null
  },
  "environmental": {
    "operating_temp_min_c": number or null,
    "operating_temp_max_c": number or null,
    "humidity_max_percent": number or null
  },
  "certifications": ["list of certifications"],
  "battery": {
    "capacity_kwh": number or null,
    "type": "battery chemistry type",
    "cycles": number or null
  }
}

Rules:
- Extract only values explicitly stated in the document
- Use null for missing values
- Extract numeric values without units
- For ranges, use the nominal/typical value
- Model name should be the exact product designation
- Return ONLY valid JSON, no additional text"""

    def extract_from_image(self, image_path: Union[str, Path], temperature: float = 0.1) -> Dict:
        """
        Extract structured data from datasheet image.

        Args:
            image_path: Path to image file
            temperature: Model temperature (lower = more deterministic)

        Returns:
            Extracted structured data
        """
        image_path = Path(image_path)

        if not image_path.exists():
            raise FileNotFoundError(f"Image not found: {image_path}")

        # Encode image
        image_b64 = self._encode_image(image_path)

        # Create request
        payload = {
            "model": "deepseek-vl2",
            "messages": [
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": self._create_extraction_prompt()
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/png;base64,{image_b64}"
                            }
                        }
                    ]
                }
            ],
            "temperature": temperature,
            "max_tokens": 2000
        }

        try:
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=self.headers,
                json=payload,
                timeout=60
            )
            response.raise_for_status()

            result = response.json()
            content = result['choices'][0]['message']['content']

            # Parse JSON from response
            # Remove markdown code blocks if present
            if '```json' in content:
                content = content.split('```json')[1].split('```')[0]
            elif '```' in content:
                content = content.split('```')[1].split('```')[0]

            extracted_data = json.loads(content.strip())

            logger.info(f"âœ“ Successfully extracted data from {image_path.name}")
            return extracted_data

        except requests.RequestException as e:
            logger.error(f"API request failed: {e}")
            return None
        except json.JSONDecodeError as e:
            logger.error(f"Failed to parse JSON response: {e}")
            logger.debug(f"Response content: {content}")
            return None
        except Exception as e:
            logger.error(f"Unexpected error: {e}")
            return None

    def extract_from_pdf_images(self, image_paths: List[Path], aggregate: bool = True) -> Union[Dict, List[Dict]]:
        """
        Extract data from multiple PDF page images.

        Args:
            image_paths: List of image paths (PDF pages)
            aggregate: If True, merge results from all pages

        Returns:
            Aggregated dict or list of dicts
        """
        results = []

        for image_path in image_paths:
            result = self.extract_from_image(image_path)
            if result:
                results.append(result)

        if not results:
            return None

        if aggregate and len(results) > 1:
            # Merge results - take first non-null value for each field
            merged = results[0].copy()

            for result in results[1:]:
                for key, value in result.items():
                    if isinstance(value, dict):
                        for sub_key, sub_value in value.items():
                            if merged[key].get(sub_key) is None and sub_value is not None:
                                merged[key][sub_key] = sub_value
                    elif isinstance(value, list):
                        # Merge lists, remove duplicates
                        merged[key] = list(set(merged.get(key, []) + value))
                    elif merged.get(key) is None and value is not None:
                        merged[key] = value

            return merged

        return results[0] if len(results) == 1 else results


def main():
    """Test the DeepSeek Vision client."""
    import sys

    if len(sys.argv) < 2:
        print("Usage: python deepseek_vision_client.py <image_path>")
        sys.exit(1)

    image_path = Path(sys.argv[1])

    client = DeepSeekVisionClient()
    result = client.extract_from_image(image_path)

    if result:
        print(json.dumps(result, indent=2))
    else:
        print("Extraction failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
