#!/usr/bin/env python3
"""
DeepSeek Integration Test
==========================

Tests actual API connectivity and response format.
Run this FIRST before using the full extraction pipeline.

Usage:
    export DEEPSEEK_API_KEY="your-key"
    python3 test_deepseek_integration.py
"""

import os
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent))

from deepseek_vision_client import DeepSeekVisionClient
from pdf_to_images import PDFToImageConverter


def test_api_authentication():
    """Test 1: Verify API key works."""
    print("\n" + "="*70)
    print("TEST 1: API Authentication")
    print("="*70)

    api_key = os.getenv("DEEPSEEK_API_KEY")
    if not api_key:
        print("‚ùå FAIL: DEEPSEEK_API_KEY environment variable not set")
        return False

    print(f"‚úì API key found: {api_key[:15]}...")

    try:
        client = DeepSeekVisionClient(
            api_key=api_key,
            max_cost_usd=0.01  # Safety: max $0.01 for testing
        )
        print("‚úì Client initialized successfully")
        return True
    except Exception as e:
        print(f"‚ùå FAIL: {e}")
        return False


def test_pdf_conversion():
    """Test 2: PDF to image conversion."""
    print("\n" + "="*70)
    print("TEST 2: PDF to Image Conversion")
    print("="*70)

    # Find smallest PDF for testing
    project_root = Path(__file__).parent.parent
    test_pdfs = list(project_root.glob("datasheets/*/InPower*.pdf"))

    if not test_pdfs:
        # Fallback to any PDF
        test_pdfs = list(project_root.glob("datasheets/*/*.pdf"))

    if not test_pdfs:
        print("‚ùå FAIL: No test PDFs found")
        return False, None

    test_pdf = test_pdfs[0]
    print(f"üìÑ Using test PDF: {test_pdf.name}")

    try:
        converter = PDFToImageConverter(dpi=300, format='png')
        images = converter.convert(test_pdf, max_pages=1)

        if not images:
            print("‚ùå FAIL: No images generated")
            return False, None

        print(f"‚úì Converted to {len(images)} image(s)")
        print(f"‚úì Image path: {images[0]}")
        print(f"‚úì Image size: {images[0].stat().st_size / 1024:.1f} KB")

        return True, images[0]

    except Exception as e:
        print(f"‚ùå FAIL: {e}")
        import traceback
        traceback.print_exc()
        return False, None


def test_api_extraction(image_path: Path):
    """Test 3: Actual API extraction."""
    print("\n" + "="*70)
    print("TEST 3: DeepSeek API Extraction")
    print("="*70)

    api_key = os.getenv("DEEPSEEK_API_KEY")

    try:
        client = DeepSeekVisionClient(
            api_key=api_key,
            max_cost_usd=0.01,  # Safety limit
            timeout=90  # Allow more time for first request
        )

        print(f"üîç Extracting from: {image_path.name}")
        print("‚è≥ This may take 30-60 seconds...")

        result = client.extract_from_image(image_path, temperature=0.1)

        if not result:
            print("‚ùå FAIL: API returned None")
            return False

        print("\n‚úÖ SUCCESS! Extraction worked!")
        print("\nüìä EXTRACTED DATA:")
        print("-" * 70)

        # Show what we got
        import json
        print(json.dumps(result, indent=2))

        # Validate structure
        print("\nüîç VALIDATION:")
        required_keys = ['model_name', 'power', 'efficiency']
        for key in required_keys:
            has_key = key in result
            status = "‚úì" if has_key else "‚úó"
            print(f"  {status} Has '{key}': {has_key}")

        # Check data quality
        model = result.get('model_name')
        power = result.get('power', {}).get('rated_power_kw')

        print(f"\nüìù EXTRACTED VALUES:")
        print(f"  Model: {model}")
        print(f"  Power: {power} kW")

        print(f"\nüí∞ API USAGE:")
        print(f"  Requests: {client.request_count}")
        print(f"  Cost: ${client.total_cost_usd:.4f}")

        return True

    except Exception as e:
        print(f"‚ùå FAIL: {e}")
        import traceback
        traceback.print_exc()
        return False


def main():
    """Run all integration tests."""
    print("="*70)
    print("DEEPSEEK INTEGRATION TEST SUITE")
    print("="*70)

    # Test 1: Authentication
    if not test_api_authentication():
        print("\n‚ùå FAILED: Cannot proceed without valid API key")
        return 1

    # Test 2: PDF Conversion
    success, image_path = test_pdf_conversion()
    if not success or not image_path:
        print("\n‚ùå FAILED: Cannot proceed without test image")
        return 1

    # Test 3: API Extraction
    if not test_api_extraction(image_path):
        print("\n‚ùå FAILED: API extraction did not work")
        return 1

    # All tests passed!
    print("\n" + "="*70)
    print("‚úÖ ALL TESTS PASSED!")
    print("="*70)
    print("\n‚úì DeepSeek API integration is working correctly")
    print("‚úì You can now run: python3 scripts/step2_pdf_to_json_enhanced.py")
    print()

    return 0


if __name__ == "__main__":
    exit(main())
