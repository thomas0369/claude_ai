'use client';

/**
 * PDF Extractor Component
 * ========================
 *
 * Upload PDF datasheets and extract specifications using DeepSeek Vision API
 *
 * Features:
 * - Drag & drop or file picker
 * - Client-side PDF to image conversion
 * - Real-time progress tracking
 * - Extracted data display
 * - Cost estimation
 */

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { PDFProcessor, isPDFFile, formatFileSize } from '@/lib/pdf/processor';
import type { ExtractionResult } from '@/lib/deepseek/types';

interface ExtractionState {
  status: 'idle' | 'converting' | 'extracting' | 'success' | 'error';
  progress: string;
  result?: ExtractionResult;
  metadata?: {
    pagesProcessed: number;
    durationMs: number;
    cost: number;
  };
  error?: string;
}

export function PDFExtractor() {
  const [file, setFile] = useState<File | null>(null);
  const [state, setState] = useState<ExtractionState>({
    status: 'idle',
    progress: '',
  });
  const [dragActive, setDragActive] = useState(false);

  const handleDrag = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);

    const droppedFile = e.dataTransfer.files[0];
    if (droppedFile && isPDFFile(droppedFile)) {
      setFile(droppedFile);
      setState({ status: 'idle', progress: '' });
    } else {
      setState({
        status: 'error',
        progress: '',
        error: 'Please upload a PDF file',
      });
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (selectedFile && isPDFFile(selectedFile)) {
      setFile(selectedFile);
      setState({ status: 'idle', progress: '' });
    }
  };

  const handleExtract = async () => {
    if (!file) return;

    try {
      // Step 1: Convert PDF to images (client-side)
      setState({
        status: 'converting',
        progress: 'Converting PDF to images...',
      });

      const processor = new PDFProcessor({
        scale: 2.0, // High quality
        maxPages: 3, // Process first 3 pages
      });

      const images = await processor.convertToImages(file);

      setState({
        status: 'converting',
        progress: `Converted ${images.length} page(s)`,
      });

      // Step 2: Send images to API for extraction
      setState({
        status: 'extracting',
        progress: 'Extracting data with DeepSeek Vision AI...',
      });

      const response = await fetch('/api/pdf/extract', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          images,
          aggregate: true,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Extraction failed');
      }

      const data = await response.json();

      setState({
        status: 'success',
        progress: 'Extraction complete!',
        result: data.data,
        metadata: data.metadata,
      });
    } catch (error) {
      console.error('Extraction error:', error);
      setState({
        status: 'error',
        progress: '',
        error: error instanceof Error ? error.message : 'Unknown error occurred',
      });
    }
  };

  const resetState = () => {
    setFile(null);
    setState({ status: 'idle', progress: '' });
  };

  return (
    <div className="space-y-6">
      {/* File Upload Area */}
      {!file && (
        <div
          className={`
            border-2 border-dashed rounded-lg p-12 text-center
            transition-colors cursor-pointer
            ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'}
          `}
          onDragEnter={handleDrag}
          onDragLeave={handleDrag}
          onDragOver={handleDrag}
          onDrop={handleDrop}
          onClick={() => document.getElementById('pdf-upload')?.click()}
        >
          <input
            id="pdf-upload"
            type="file"
            accept=".pdf,application/pdf"
            onChange={handleFileChange}
            className="hidden"
          />

          <svg
            className="mx-auto h-12 w-12 text-gray-400"
            stroke="currentColor"
            fill="none"
            viewBox="0 0 48 48"
          >
            <path
              d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
              strokeWidth={2}
              strokeLinecap="round"
              strokeLinejoin="round"
            />
          </svg>

          <p className="mt-2 text-sm text-gray-600">
            <span className="font-semibold">Click to upload</span> or drag and drop
          </p>
          <p className="text-xs text-gray-500 mt-1">
            PDF files only • Max 3 pages processed
          </p>
        </div>
      )}

      {/* File Info & Actions */}
      {file && (
        <div className="border rounded-lg p-4 space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium">{file.name}</p>
              <p className="text-sm text-gray-500">{formatFileSize(file.size)}</p>
            </div>
            <Button variant="outline" size="sm" onClick={resetState}>
              Remove
            </Button>
          </div>

          {state.status === 'idle' && (
            <Button onClick={handleExtract} className="w-full">
              Extract Data
            </Button>
          )}

          {/* Progress */}
          {(state.status === 'converting' || state.status === 'extracting') && (
            <div className="space-y-2">
              <div className="flex items-center justify-between text-sm">
                <span>{state.progress}</span>
                <span className="text-gray-500">
                  {state.status === 'converting' ? 'Step 1/2' : 'Step 2/2'}
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div
                  className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                  style={{
                    width: state.status === 'converting' ? '50%' : '100%',
                  }}
                />
              </div>
            </div>
          )}

          {/* Error */}
          {state.status === 'error' && (
            <div className="bg-red-50 border border-red-200 rounded p-4">
              <p className="text-sm text-red-800 font-medium">Extraction Failed</p>
              <p className="text-sm text-red-600 mt-1">{state.error}</p>
              <Button
                variant="outline"
                size="sm"
                onClick={() => setState({ status: 'idle', progress: '' })}
                className="mt-2"
              >
                Try Again
              </Button>
            </div>
          )}

          {/* Success - Extracted Data */}
          {state.status === 'success' && state.result && (
            <div className="space-y-4">
              <div className="bg-green-50 border border-green-200 rounded p-4">
                <p className="text-sm text-green-800 font-medium">
                  Extraction Successful!
                </p>
                {state.metadata && (
                  <div className="text-xs text-green-700 mt-2 space-y-1">
                    <p>
                      Pages processed: {state.metadata.pagesProcessed} •
                      Duration: {(state.metadata.durationMs / 1000).toFixed(1)}s •
                      Cost: ${state.metadata.cost.toFixed(4)}
                    </p>
                  </div>
                )}
              </div>

              {/* Display Extracted Data */}
              <div className="bg-gray-50 rounded p-4 max-h-96 overflow-auto">
                <h3 className="font-semibold mb-2">Extracted Specifications:</h3>

                <dl className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <dt className="font-medium text-gray-700">Model</dt>
                    <dd>{state.result.model_name}</dd>
                  </div>

                  {state.result.manufacturer && (
                    <div>
                      <dt className="font-medium text-gray-700">Manufacturer</dt>
                      <dd>{state.result.manufacturer}</dd>
                    </div>
                  )}

                  {state.result.power.rated_power_kw && (
                    <div>
                      <dt className="font-medium text-gray-700">Rated Power</dt>
                      <dd>{state.result.power.rated_power_kw} kW</dd>
                    </div>
                  )}

                  {state.result.efficiency.peak_percent && (
                    <div>
                      <dt className="font-medium text-gray-700">Peak Efficiency</dt>
                      <dd>{state.result.efficiency.peak_percent}%</dd>
                    </div>
                  )}

                  {state.result.battery.capacity_kwh && (
                    <div>
                      <dt className="font-medium text-gray-700">Capacity</dt>
                      <dd>{state.result.battery.capacity_kwh} kWh</dd>
                    </div>
                  )}

                  {state.result.physical.weight_kg && (
                    <div>
                      <dt className="font-medium text-gray-700">Weight</dt>
                      <dd>{state.result.physical.weight_kg} kg</dd>
                    </div>
                  )}
                </dl>

                {/* Raw JSON View */}
                <details className="mt-4">
                  <summary className="cursor-pointer text-sm font-medium text-gray-700">
                    View Raw JSON
                  </summary>
                  <pre className="mt-2 p-2 bg-white rounded text-xs overflow-auto max-h-48">
                    {JSON.stringify(state.result, null, 2)}
                  </pre>
                </details>
              </div>

              <Button variant="outline" onClick={resetState} className="w-full">
                Extract Another PDF
              </Button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
