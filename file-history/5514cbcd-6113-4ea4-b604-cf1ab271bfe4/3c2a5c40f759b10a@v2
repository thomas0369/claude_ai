/**
 * Enhanced DeepSeek Prompts for Multi-Product Datasheets
 * ========================================================
 *
 * Optimized prompts for extracting data from complex PDFs with:
 * - Multiple products in one datasheet
 * - Tables with features in rows, products in columns
 * - Various units and decimal formats
 * - Different manufacturer formats
 */

export interface PromptContext {
  /** Manufacturer name (helps with format recognition) */
  manufacturer?: string;
  /** Expected product models (if known) */
  expectedModels?: string[];
  /** Language of the datasheet */
  language?: 'en' | 'de' | 'auto';
  /** Whether to extract multiple products */
  multiProduct?: boolean;
}

/**
 * Create enhanced extraction prompt for multi-product datasheets
 */
export function createMultiProductPrompt(context: PromptContext = {}): string {
  const { manufacturer, expectedModels, language = 'auto', multiProduct = true } = context;

  let prompt = `You are an expert at extracting technical specifications from BESS (Battery Energy Storage System) datasheets.

**YOUR TASK:**
Extract ALL product specifications from this datasheet. Many datasheets contain MULTIPLE products (e.g., Model A, Model B, Model C) in a single document.

**CRITICAL INSTRUCTIONS FOR TABLES:**
1. If you see a table with:
   - Column 1: Feature names (e.g., "Rated Power", "Efficiency", "Weight")
   - Columns 2, 3, 4, etc.: Different product models

   Extract EACH product as a SEPARATE object in an array.

2. Example table format:
   \`\`\`
   Specification        | GW50K-ETC | GW75K-ETC | GW100K-ETC
   ---------------------|-----------|-----------|------------
   Rated Power (kW)     | 50        | 75        | 100
   Max Efficiency (%)   | 98.4      | 98.6      | 98.7
   Weight (kg)          | 95        | 110       | 125
   \`\`\`

   Should extract as:
   \`\`\`json
   {
     "products": [
       {
         "model_name": "GW50K-ETC",
         "power": { "rated_power_kw": 50 },
         "efficiency": { "peak_percent": 98.4 },
         "physical": { "weight_kg": 95 }
       },
       {
         "model_name": "GW75K-ETC",
         "power": { "rated_power_kw": 75 },
         "efficiency": { "peak_percent": 98.6 },
         "physical": { "weight_kg": 110 }
       },
       {
         "model_name": "GW100K-ETC",
         "power": { "rated_power_kw": 100 },
         "efficiency": { "peak_percent": 98.7 },
         "physical": { "weight_kg": 125 }
       }
     ]
   }
   \`\`\`

**NUMBER FORMATS:**
- Accept both DECIMAL POINT (98.5) and DECIMAL COMMA (98,5)
- Always convert to decimal point in JSON output
- Examples:
  - Input: "98,5 %" → Output: 98.5
  - Input: "2.450 kg" → Output: 2450
  - Input: "1 234,56" → Output: 1234.56

**UNITS - CRITICAL:**
- Remove ALL units from numbers
- Convert to standard units:
  - Power: kW (if W, divide by 1000)
  - Voltage: V (if kV, multiply by 1000)
  - Weight: kg (if tons, multiply by 1000)
  - Dimensions: mm
  - Temperature: °C
  - Capacity: kWh (if Wh, divide by 1000; if MWh, multiply by 1000)

**MODEL NAME EXTRACTION:**
- Look for model numbers in:
  1. Table headers (column names)
  2. Page headers/titles
  3. First mention in text
  4. Product images/diagrams
- Common patterns:
  - "GW100K-ETC", "Cube Pro C230", "Luna2000-100KTL"
  - May include dashes, spaces, or slashes
  - May have suffix like "-M0", "-H1", "V1.2"

`;

  // Add manufacturer-specific guidance
  if (manufacturer) {
    prompt += `\n**MANUFACTURER CONTEXT:**
This is a ${manufacturer} datasheet. Be aware of their naming conventions and typical product families.\n`;
  }

  // Add expected models hint
  if (expectedModels && expectedModels.length > 0) {
    prompt += `\n**EXPECTED MODELS:**
Look for these model names: ${expectedModels.join(', ')}
(But also extract any other models you find)\n`;
  }

  // Add language-specific guidance
  if (language === 'de') {
    prompt += `\n**LANGUAGE NOTE:**
This is a German datasheet. Be aware of:
- Decimal comma instead of point (e.g., "97,5%")
- Unit abbreviations may differ (e.g., "kWh" vs "kW⋅h")
- Feature names in German (e.g., "Nennleistung" = "Rated Power")\n`;
  }

  prompt += `\n**OUTPUT FORMAT:**
Return a JSON object with this EXACT structure:

\`\`\`json
{
  "products": [
    {
      "model_name": "exact model designation from datasheet",
      "manufacturer": "${manufacturer || 'extract from datasheet'}",
      "power": {
        "rated_power_kw": number or null,
        "max_power_kw": number or null,
        "continuous_power_kw": number or null,
        "peak_power_kw": number or null
      },
      "efficiency": {
        "peak_percent": number or null,
        "rated_percent": number or null,
        "euro_percent": number or null,
        "cec_percent": number or null
      },
      "voltage": {
        "nominal_v": number or null,
        "max_v": number or null,
        "min_v": number or null,
        "mppt_min_v": number or null,
        "mppt_max_v": number or null
      },
      "current": {
        "max_input_a": number or null,
        "max_output_a": number or null,
        "rated_output_a": number or null
      },
      "physical": {
        "width_mm": number or null,
        "height_mm": number or null,
        "depth_mm": number or null,
        "weight_kg": number or null
      },
      "environmental": {
        "operating_temp_min_c": number or null,
        "operating_temp_max_c": number or null,
        "humidity_max_percent": number or null,
        "altitude_max_m": number or null,
        "ip_rating": "string or null"
      },
      "certifications": ["list of certifications as strings"],
      "battery": {
        "capacity_kwh": number or null,
        "type": "battery chemistry type or null",
        "cycles": number or null,
        "dod_percent": number or null
      },
      "connection": {
        "mppt_count": number or null,
        "strings_per_mppt": number or null,
        "max_strings": number or null
      },
      "features": ["list of special features as strings"]
    }
  ],
  "extraction_confidence": {
    "overall": number (0-100),
    "per_field": {
      "model_name": number (0-100),
      "power": number (0-100),
      "efficiency": number (0-100),
      ...
    }
  },
  "table_detected": boolean,
  "multi_product": boolean,
  "page_numbers": [1, 2, 3],
  "notes": "any extraction challenges or ambiguities"
}
\`\`\`

**CONFIDENCE SCORING:**
- 100: Value clearly stated with label
- 80-99: Value found but label slightly ambiguous
- 50-79: Value inferred from context
- 0-49: Uncertain or conflicting values
- 0: Not found

**VALIDATION RULES:**
1. Power values must be positive
2. Efficiency must be 0-100%
3. Voltages: Reasonable ranges (e.g., DC: 200-1500V, AC: 200-800V)
4. Weight must be positive
5. Dimensions must be positive
6. Temperature range: min < max

**WHAT TO DO IF:**
- Multiple conflicting values: Use the value from the technical specifications table (highest confidence)
- Range given (e.g., "50-100 kW"): Use the nominal/typical value, or extract min/max separately
- Value with tolerance (e.g., "100 kW ±10%"): Use the nominal value (100)
- Missing value: Use null (do NOT guess or estimate)

**RETURN ONLY VALID JSON** - no explanations, no markdown formatting around the JSON.`;

  return prompt;
}

/**
 * Create validation prompt for cross-checking extracted data
 */
export function createValidationPrompt(
  extractedData: any,
  referenceData?: any
): string {
  let prompt = `You are a technical validator for BESS specifications.

**YOUR TASK:**
Review the extracted data and identify any suspicious or incorrect values.

**EXTRACTED DATA:**
\`\`\`json
${JSON.stringify(extractedData, null, 2)}
\`\`\`
`;

  if (referenceData) {
    prompt += `\n**REFERENCE DATA (from database):**
\`\`\`json
${JSON.stringify(referenceData, null, 2)}
\`\`\`
`;
  }

  prompt += `\n**VALIDATION CHECKS:**

1. **Plausibility:**
   - Power ratings reasonable for product size/type?
   - Efficiency values realistic (typically 95-99% for modern inverters)?
   - Weight proportional to power rating?
   - Dimensions reasonable?

2. **Consistency:**
   - Max power ≥ Rated power?
   - MPPT max voltage > MPPT min voltage?
   - Operating temp max > min?
   - All related values make sense together?

3. **Common Errors:**
   - Decimal point/comma confusion (e.g., 975 instead of 97.5)?
   - Unit conversion errors (e.g., W vs kW, V vs kV)?
   - Swapped values (e.g., width/height confused)?
   - Missing zeros (e.g., 50 instead of 500)?

4. **Cross-Reference (if reference data provided):**
   - Do values match or are they close to reference data?
   - If different, which is more likely correct?
   - Are model names consistent?

**OUTPUT FORMAT:**
Return JSON with validation results:

\`\`\`json
{
  "valid": boolean,
  "confidence": number (0-100),
  "issues": [
    {
      "field": "path.to.field",
      "severity": "error" | "warning" | "info",
      "message": "description of issue",
      "extracted_value": value,
      "suggested_value": value or null,
      "reason": "why this might be wrong"
    }
  ],
  "corrections": {
    "field.path": corrected_value
  },
  "overall_assessment": "brief summary"
}
\`\`\`

**SEVERITY LEVELS:**
- **error**: Definitely wrong (e.g., efficiency > 100%)
- **warning**: Suspicious but might be correct (e.g., unusually high efficiency)
- **info**: Minor issue or note (e.g., could not cross-reference)

Return ONLY the JSON validation result.`;

  return prompt;
}

/**
 * Create comparison prompt for manufacturer website verification
 */
export function createWebVerificationPrompt(
  modelName: string,
  manufacturer: string,
  extractedSpecs: any
): string {
  return `You are verifying BESS specifications against manufacturer website data.

**PRODUCT:**
- Model: ${modelName}
- Manufacturer: ${manufacturer}

**EXTRACTED SPECIFICATIONS:**
\`\`\`json
${JSON.stringify(extractedSpecs, null, 2)}
\`\`\`

**YOUR TASK:**
Compare the extracted specifications with the information visible on this manufacturer website page.

**WHAT TO CHECK:**
1. Is the model name correct and matches the website?
2. Do the key specifications match (power, efficiency, dimensions)?
3. Are there any obvious discrepancies?
4. Is this the current/latest version of the product?

**OUTPUT FORMAT:**
\`\`\`json
{
  "match_confidence": number (0-100),
  "model_name_matches": boolean,
  "specifications_match": {
    "power": "matches" | "differs" | "not_found",
    "efficiency": "matches" | "differs" | "not_found",
    "dimensions": "matches" | "differs" | "not_found",
    "weight": "matches" | "differs" | "not_found"
  },
  "discrepancies": [
    {
      "field": "field name",
      "extracted": value,
      "website": value,
      "likely_correct": "extracted" | "website" | "unknown"
    }
  ],
  "product_version": "detected version or generation",
  "notes": "additional observations",
  "confidence_factors": {
    "website_quality": "high" | "medium" | "low",
    "information_completeness": "complete" | "partial" | "minimal",
    "version_match": "same" | "different" | "unclear"
  }
}
\`\`\`

Return ONLY the JSON comparison result.`;
}

/**
 * Get appropriate prompt based on context
 */
export function getExtractionPrompt(context: PromptContext = {}): string {
  return createMultiProductPrompt(context);
}
