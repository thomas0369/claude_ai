/**
 * PDF Extraction API Route
 * =========================
 *
 * Next.js API route for extracting data from PDF datasheets using DeepSeek Vision API
 *
 * POST /api/pdf/extract
 * Body: { images: string[] } - Array of base64-encoded images
 *
 * Returns: ExtractionResult
 */

import { NextRequest, NextResponse } from 'next/server';
import { DeepSeekVisionClient } from '@/lib/deepseek/client';
import { z } from 'zod';
import { validateWithErrorHandling } from '@/lib/api-validation-helpers';
import { createErrorResponse } from '@/lib/api-error-handler';

// Request schema validation
const ExtractRequestSchema = z.object({
  images: z.array(z.string()).min(1).max(10), // 1-10 images
  aggregate: z.boolean().optional().default(true),
});

// Response schema for type safety
const ExtractResponseSchema = z.object({
  success: z.boolean(),
  data: z.any(), // ExtractionResult validated by DeepSeek client
  metadata: z.object({
    pagesProcessed: z.number(),
    durationMs: z.number(),
    cost: z.number(),
    requestCount: z.number(),
  }),
});

export const runtime = 'nodejs'; // Use Node.js runtime for better compatibility

// Increase timeout for PDF processing (default is 10s on hobby plan)
export const maxDuration = 60; // 60 seconds max

export async function POST(request: NextRequest) {
  try {
    // Parse and validate request body
    const body = await request.json();

    // Validate request with standardized error handling
    const requestValidation = validateWithErrorHandling(
      ExtractRequestSchema,
      body,
      {
        operation: 'PDF extraction request',
        logContext: { imageCount: Array.isArray(body.images) ? body.images.length : 0 },
      }
    );

    if (!requestValidation.success) return requestValidation.response;

    const { images, aggregate } = requestValidation.data;

    // Check for API key
    const apiKey = process.env.DEEPSEEK_API_KEY;
    if (!apiKey) {
      return createErrorResponse(
        'extract PDF data',
        new Error('DeepSeek API key not configured. Please set DEEPSEEK_API_KEY environment variable in Vercel settings'),
        500
      );
    }

    console.log(`Processing ${images.length} image(s) with DeepSeek Vision API`);

    // Initialize DeepSeek client with safety limits
    const client = new DeepSeekVisionClient({
      apiKey,
      maxCostUsd: 0.05, // Safety limit: $0.05 per request
      maxRequestsPerMinute: 60,
      timeout: 90000, // 90 second timeout per API call
      retries: 3,
    });

    // Extract data from images
    const startTime = Date.now();
    const result = await client.extractFromImages(images, aggregate);
    const duration = Date.now() - startTime;

    if (!result) {
      return createErrorResponse(
        'extract PDF data',
        new Error('DeepSeek API did not return valid data'),
        500
      );
    }

    // Get usage statistics
    const stats = client.getStats();

    console.log(
      `Extraction completed in ${(duration / 1000).toFixed(1)}s, ` +
        `cost: $${stats.totalCost.toFixed(4)}`
    );

    const responseData = {
      success: true,
      data: result,
      metadata: {
        pagesProcessed: images.length,
        durationMs: duration,
        cost: stats.totalCost,
        requestCount: stats.requestCount,
      },
    };

    // Validate response structure
    const responseValidation = validateWithErrorHandling(
      ExtractResponseSchema,
      responseData,
      {
        operation: 'PDF extraction response',
        logContext: {
          pagesProcessed: images.length,
          cost: stats.totalCost,
        },
      }
    );

    if (!responseValidation.success) return responseValidation.response;

    return NextResponse.json(responseValidation.data);
  } catch (error) {
    // Standardized error response with logging
    return createErrorResponse('extract PDF data', error);
  }
}

/**
 * GET endpoint to check API status
 */
export async function GET() {
  const apiKeyConfigured = !!process.env.DEEPSEEK_API_KEY;

  return NextResponse.json({
    status: 'operational',
    apiKeyConfigured,
    maxImageCount: 10,
    maxDuration: 60,
    version: '1.0.0',
  });
}
