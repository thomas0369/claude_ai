/**
 * Staging Database Types
 * =======================
 *
 * TypeScript types for the PDF extraction staging database
 */

import { z } from 'zod';
import { ExtractionResultSchema } from '@/lib/deepseek/types';
import { randomUUID } from 'crypto';

/**
 * Generate UUID (Node.js crypto API)
 * Only used server-side in API routes
 */
function generateUUID(): string {
  return randomUUID();
}

/**
 * Staging item status
 */
export type StagingStatus =
  | 'pending_review'   // Waiting for manual verification
  | 'in_review'        // Currently being reviewed
  | 'verified'         // Approved and imported to main DB
  | 'rejected';        // Rejected by reviewer

/**
 * Data source type
 */
export type DataSource =
  | 'manual_upload'
  | 'auto_search'
  | 'manufacturer_website'
  | 'zerez_enhanced';

/**
 * Field-level confidence scores
 */
export interface FieldConfidenceScores {
  model_name?: number;
  manufacturer?: number;
  'power.rated_power_kw'?: number;
  'power.max_power_kw'?: number;
  'efficiency.peak_percent'?: number;
  'voltage.nominal_v'?: number;
  'battery.capacity_kwh'?: number;
  'physical.weight_kg'?: number;
  [key: string]: number | undefined;
}

/**
 * Confidence scores schema
 */
export const ConfidenceScoresSchema = z.object({
  overall: z.number().min(0).max(100),
  fields: z.record(z.number().min(0).max(100)),
});

export type ConfidenceScores = z.infer<typeof ConfidenceScoresSchema>;

/**
 * Extraction metadata
 */
export const ExtractionMetadataSchema = z.object({
  extraction_date: z.string(),
  cost_usd: z.number(),
  pages_processed: z.number(),
  extraction_method: z.string(),
  duration_ms: z.number().optional(),
});

export type ExtractionMetadata = z.infer<typeof ExtractionMetadataSchema>;

/**
 * Staging item - represents unverified extraction
 */
export const StagingItemSchema = z.object({
  id: z.string().uuid(),
  status: z.enum(['pending_review', 'in_review', 'verified', 'rejected']),
  source: z.enum([
    'manual_upload',
    'auto_search',
    'manufacturer_website',
    'zerez_enhanced',
  ]),

  // Link to original ZEREZ product (if applicable)
  zerez_product_id: z.string().nullable(),

  // Link to original main DB product (for updates)
  main_product_id: z.string().nullable(),

  // PDF file location
  pdf_path: z.string(),

  // Extracted data from DeepSeek
  extracted_data: ExtractionResultSchema,

  // Confidence scores
  confidence_scores: ConfidenceScoresSchema,

  // Extraction metadata
  extraction_metadata: ExtractionMetadataSchema,

  // Manual edits (null if no edits made)
  edited_data: ExtractionResultSchema.partial().nullable(),

  // Editor notes
  editor_notes: z.string(),

  // Verification info
  verified_by: z.string().nullable(),
  verified_at: z.string().nullable(),
  rejected_reason: z.string().nullable(),

  // Timestamps
  created_at: z.string(),
  updated_at: z.string(),
});

export type StagingItem = z.infer<typeof StagingItemSchema>;

/**
 * Staging index - list of all staging items
 */
export const StagingIndexSchema = z.object({
  items: z.array(
    z.object({
      id: z.string().uuid(),
      status: z.enum(['pending_review', 'in_review', 'verified', 'rejected']),
      manufacturer: z.string(),
      model: z.string(),
      confidence: z.number(),
      created_at: z.string(),
    })
  ),
  updated_at: z.string(),
});

export type StagingIndex = z.infer<typeof StagingIndexSchema>;

/**
 * Create new staging item
 */
export function createStagingItem(params: {
  source: DataSource;
  zerez_product_id: string | null;
  main_product_id: string | null;
  pdf_path: string;
  extracted_data: z.infer<typeof ExtractionResultSchema>;
  confidence_scores: ConfidenceScores;
  extraction_metadata: ExtractionMetadata;
}): StagingItem {
  const now = new Date().toISOString();

  return {
    id: generateUUID(),
    status: 'pending_review',
    source: params.source,
    zerez_product_id: params.zerez_product_id,
    main_product_id: params.main_product_id,
    pdf_path: params.pdf_path,
    extracted_data: params.extracted_data,
    confidence_scores: params.confidence_scores,
    extraction_metadata: params.extraction_metadata,
    edited_data: null,
    editor_notes: '',
    verified_by: null,
    verified_at: null,
    rejected_reason: null,
    created_at: now,
    updated_at: now,
  };
}

/**
 * Staging filter options
 */
export interface StagingFilterOptions {
  status?: StagingStatus[];
  minConfidence?: number;
  maxConfidence?: number;
  manufacturer?: string;
  source?: DataSource[];
  hasEdits?: boolean;
}

/**
 * Staging sort options
 */
export type StagingSortBy =
  | 'created_at'
  | 'confidence'
  | 'manufacturer'
  | 'model'
  | 'status';

export type StagingSortOrder = 'asc' | 'desc';
