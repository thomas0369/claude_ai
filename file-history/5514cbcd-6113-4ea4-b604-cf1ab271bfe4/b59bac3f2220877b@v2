# PDF Import Architecture - Visual Overview

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         PDF Import Pipeline                          │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│  ZEREZ Database  │ (10,177 products)
└────────┬─────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Strategy 1: Manual Import                         │
└─────────────────────────────────────────────────────────────────────┘

    ┌────────────────┐
    │ Product Select │ ◄── User selects product from database
    └───────┬────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   PDF Acquisition              │
    ├────────────────────────────────┤
    │ • Manual Upload                │
    │ • Internet Search (Google API) │
    │ • Manufacturer Website Crawl   │
    └───────┬────────────────────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   File Organization            │
    ├────────────────────────────────┤
    │ /pdfs/{manufacturer}/{model}/  │
    │   ├── datasheet.pdf            │
    │   ├── extracted.json           │
    │   └── metadata.json            │
    └───────┬────────────────────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   DeepSeek Extraction          │
    ├────────────────────────────────┤
    │ • PDF → Images (pdf.js)        │
    │ • Vision API Processing        │
    │ • Confidence Scoring           │
    └───────┬────────────────────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   Staging Database             │
    ├────────────────────────────────┤
    │ /staging/products/{id}.json    │
    │ • Status: pending_review       │
    │ • Extracted data               │
    │ • Confidence scores            │
    └───────┬────────────────────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   UI Verification Editor       │
    ├────────────────────────────────┤
    │ [PDF View] | [Edit Form]       │
    │ • Highlight low confidence     │
    │ • Manual corrections           │
    │ • Add notes                    │
    └───────┬────────────────────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   Verify & Import              │
    ├────────────────────────────────┤
    │ • Merge ZEREZ + PDF data       │
    │ • Update products.yaml         │
    │ • Mark as verified             │
    └───────┬────────────────────────┘
            │
            ▼
    ┌────────────────────────────────┐
    │   Main Database                │
    │   (Verified Products)          │
    └────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│          Strategy 2: Auto-import (Optional Add-on)                   │
└─────────────────────────────────────────────────────────────────────┘

    ┌────────────────────────┐
    │ ZEREZ Import Complete  │
    └───────┬────────────────┘
            │
            ▼
    ┌────────────────────────┐    NO
    │ Auto-import Enabled? ─────────► [Manual Review Later]
    └───────┬────────────────┘
            │ YES
            ▼
    ┌─────────────────────────────────────┐
    │   Background Processing (SSE)       │
    ├─────────────────────────────────────┤
    │ For each product (1-199):           │
    │   1. Search for PDF                 │
    │   2. Download best match            │
    │   3. Extract with DeepSeek          │
    │   4. Save to staging                │
    │   5. Report progress                │
    └───────┬─────────────────────────────┘
            │
            ▼
    ┌─────────────────────────────────────┐
    │   Review Dashboard                  │
    ├─────────────────────────────────────┤
    │ ✓ 45 High confidence (>90%)         │
    │ ⚠ 12 Medium confidence (60-90%)     │
    │ ✗ 5 Failed to find PDF              │
    │                                     │
    │ [Auto-verify High] [Review All]     │
    └───────┬─────────────────────────────┘
            │
            ├──► High confidence → Auto-verify → Main DB
            │
            └──► Medium/Low → Manual Review → Strategy 1 Flow


## Data Flow Diagram

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Internet   │         │  User Upload │         │ ZEREZ Import │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │
       │  PDF Search            │  File Upload           │  Product Info
       ▼                        ▼                        ▼
┌────────────────────────────────────────────────────────────────┐
│                     PDF Acquisition Layer                       │
│  • Google Custom Search  • Manual Upload  • Product Metadata   │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                    File System Storage                          │
│  /public/data/pdfs/{manufacturer}/{model}/                     │
│    ├── datasheet.pdf                                           │
│    ├── extracted.json                                          │
│    └── metadata.json                                           │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                   DeepSeek Vision Pipeline                      │
│  PDF → Images → API → Structured Data → Confidence Scores      │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                   Staging Database (JSON)                       │
│  /public/data/staging/products/{id}.json                       │
│    • Status: pending_review / verified / rejected              │
│    • Extracted data + confidence scores                        │
│    • Editor notes + verification metadata                      │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                   Verification UI Layer                         │
│  • PDF Viewer (left) | Edit Form (right)                       │
│  • Confidence indicators • Diff view • Manual override          │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                    Data Merge Service                           │
│  Combine: ZEREZ Data + PDF Extracted Data + Manual Edits       │
│  • Conflict resolution • Field prioritization • Audit trail    │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                   Main Database (YAML)                          │
│  /public/data/products.yaml                                    │
│    • Verified product data                                     │
│    • PDF metadata (path, confidence, verifier)                 │
│    • Data provenance (ZEREZ + PDF sources)                     │
└────────────────────────────────────────────────────────────────┘
```

## Component Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend (React)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐   │
│  │ PDF Search UI  │  │ Upload Widget  │  │ Staging List   │   │
│  └────────────────┘  └────────────────┘  └────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           Verification Editor (Split View)                │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  ┌──────────────┐  │  ┌───────────────────────────────┐ │  │
│  │  │  PDF Viewer  │  │  │   Editable Form Fields        │ │  │
│  │  │  (pdf.js)    │  │  │   • Model Name                │ │  │
│  │  │              │  │  │   • Power [Confidence: 87%]   │ │  │
│  │  │  Page 1/3    │  │  │   • Efficiency [75%] ⚠        │ │  │
│  │  │              │  │  │   • Dimensions [92%]          │ │  │
│  │  └──────────────┘  │  └───────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           Review Dashboard (Auto-import)                  │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  Progress: ████████░░ 45/199                             │  │
│  │                                                            │  │
│  │  ✓ High Confidence (>90%): 12 products                   │  │
│  │  ⚠ Medium Confidence (60-90%): 28 products               │  │
│  │  ✗ Failed: 5 products                                    │  │
│  │                                                            │  │
│  │  [Auto-verify High] [Review All] [Export Report]         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     API Routes (Next.js)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  POST /api/pdf/search        - Search internet for PDFs         │
│  POST /api/pdf/download      - Download & organize PDF          │
│  POST /api/pdf/extract       - DeepSeek extraction              │
│  POST /api/pdf/auto-import   - Background batch processing      │
│                                                                  │
│  GET  /api/staging/list      - List pending verifications       │
│  GET  /api/staging/[id]      - Get specific staging item        │
│  POST /api/staging/save      - Save edits to staging            │
│  POST /api/staging/verify    - Verify & import to main DB       │
│  DELETE /api/staging/[id]    - Reject staging item              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Business Logic (lib/)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  lib/pdf/                                                        │
│    ├── search.ts          - PDF search algorithms               │
│    ├── storage.ts         - File organization & management      │
│    ├── staging.ts         - Staging database CRUD               │
│    └── processor.ts       - PDF to image conversion (existing)  │
│                                                                  │
│  lib/deepseek/                                                   │
│    ├── client.ts          - DeepSeek API client (existing)      │
│    ├── types.ts           - Type definitions (existing)         │
│    └── matcher.ts         - Confidence scoring (existing)       │
│                                                                  │
│  lib/verification/                                               │
│    ├── merge.ts           - Merge ZEREZ + PDF data             │
│    ├── import.ts          - Import verified data to main DB     │
│    └── diff.ts            - Calculate data differences          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                   External Services                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  • Google Custom Search API  - Find PDFs on internet            │
│  • DeepSeek Vision API       - Extract data from PDFs           │
│  • File System               - Store PDFs and staging data      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## State Management

```
┌─────────────────────────────────────────────────────────────────┐
│                      Application State                           │
└─────────────────────────────────────────────────────────────────┘

Global State (Zustand):
  ├── stagingStore
  │   ├── items: StagingItem[]
  │   ├── selectedId: string | null
  │   ├── filters: { status, confidence, manufacturer }
  │   └── actions: { load, filter, select, remove }
  │
  ├── verificationStore
  │   ├── currentItem: StagingItem | null
  │   ├── editedData: Partial<ProductData>
  │   ├── notes: string
  │   ├── isModified: boolean
  │   └── actions: { edit, save, verify, reset }
  │
  └── autoImportStore
      ├── progress: { current, total }
      ├── results: ImportResult[]
      ├── isRunning: boolean
      └── actions: { start, pause, resume, stop }

URL State (Next.js Router):
  ├── /import/verify              - Staging list
  ├── /import/verify/[id]         - Verification editor
  └── /import/verify/batch        - Auto-import dashboard
```

## Security Model

```
┌─────────────────────────────────────────────────────────────────┐
│                      Security Layers                             │
└─────────────────────────────────────────────────────────────────┘

1. Input Validation
   ├── PDF file validation (size, type, structure)
   ├── URL validation (whitelist, SSRF prevention)
   └── User input sanitization

2. Authentication & Authorization
   ├── Only authenticated users can verify
   ├── Rate limiting per user
   └── Audit log of all verifications

3. API Security
   ├── DeepSeek API key stored in env vars
   ├── Request signing & validation
   └── Cost limits enforced

4. File System Security
   ├── PDFs stored in public/ (read-only from web)
   ├── Staging data not publicly accessible
   └── Path traversal prevention

5. Data Validation
   ├── Zod schemas for all API inputs/outputs
   ├── Confidence thresholds enforced
   └── Manual verification required for low confidence
```

## Deployment Considerations

### Vercel Deployment
- ✅ Next.js API routes (serverless)
- ✅ Static file storage (`/public/data/`)
- ✅ Environment variables (API keys)
- ⚠️ File uploads (limited to 4.5 MB on Hobby plan)
- ⚠️ Background jobs (max 60s on Hobby, 900s on Pro)

### Alternative: Self-hosted
- Use background workers for long-running auto-import
- Larger file storage capacity
- More control over rate limiting

### Recommended Hybrid Approach
- Vercel: Frontend + API routes
- Background service: Auto-import worker (optional)
- Storage: Vercel static files or S3-compatible storage
