#!/usr/bin/env python3
"""
PDF to Images Converter
=======================

Converts PDF datasheets to images for processing with vision models.

Usage:
    python pdf_to_images.py <pdf_path> --output-dir <output_dir>
"""

import logging
import subprocess
import sys
from pathlib import Path
from typing import List, Optional

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class PDFToImageConverter:
    """Convert PDF files to images using pdftoppm."""

    def __init__(self, dpi: int = 300, format: str = 'png'):
        """
        Initialize converter.

        Args:
            dpi: Resolution for image conversion (default: 300)
            format: Output format (png, jpg)
        """
        self.dpi = dpi
        self.format = format

        # Check if pdftoppm is available
        try:
            subprocess.run(['pdftoppm', '-v'], capture_output=True, check=False)
        except FileNotFoundError:
            raise RuntimeError("pdftoppm not found. Install with: sudo apt-get install poppler-utils")

    def convert(self, pdf_path: Path, output_dir: Optional[Path] = None, max_pages: int = 5) -> List[Path]:
        """
        Convert PDF to images.

        Args:
            pdf_path: Path to PDF file
            output_dir: Output directory (defaults to same as PDF)
            max_pages: Maximum pages to convert (default: 5)

        Returns:
            List of image paths
        """
        pdf_path = Path(pdf_path)

        if not pdf_path.exists():
            raise FileNotFoundError(f"PDF not found: {pdf_path}")

        if output_dir is None:
            output_dir = pdf_path.parent
        else:
            output_dir = Path(output_dir)
            output_dir.mkdir(parents=True, exist_ok=True)

        # Output filename prefix
        output_prefix = pdf_path.stem

        try:
            # Convert PDF to images
            # -png: output format
            # -r {dpi}: resolution
            # -f 1 -l {max_pages}: page range
            cmd = [
                'pdftoppm',
                '-png' if self.format == 'png' else '-jpeg',
                '-r', str(self.dpi),
                '-f', '1',
                '-l', str(max_pages),
                str(pdf_path.resolve()),
                str(output_dir / output_prefix)
            ]

            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=60,
                check=False
            )

            if result.returncode != 0:
                logger.warning(f"pdftoppm warning for {pdf_path.name}: {result.stderr[:200]}")

            # Find generated images
            pattern = f"{output_prefix}-*.{self.format}"
            image_files = sorted(output_dir.glob(pattern))

            if not image_files:
                logger.error(f"No images generated from {pdf_path.name}")
                return []

            logger.info(f"âœ“ Converted {pdf_path.name} to {len(image_files)} images")
            return image_files

        except subprocess.TimeoutExpired:
            logger.error(f"Timeout converting {pdf_path.name}")
            return []
        except Exception as e:
            logger.error(f"Error converting {pdf_path.name}: {e}")
            return []

    def convert_single_page(self, pdf_path: Path, page_num: int = 1, output_dir: Optional[Path] = None) -> Optional[Path]:
        """
        Convert single PDF page to image.

        Args:
            pdf_path: Path to PDF file
            page_num: Page number to convert (1-indexed)
            output_dir: Output directory

        Returns:
            Path to generated image or None
        """
        images = self.convert(pdf_path, output_dir, max_pages=page_num)

        if images and len(images) >= page_num:
            return images[page_num - 1]

        return None


def main():
    """CLI interface."""
    import argparse

    parser = argparse.ArgumentParser(description='Convert PDF to images')
    parser.add_argument('pdf_path', type=str, help='Path to PDF file')
    parser.add_argument('--output-dir', type=str, help='Output directory')
    parser.add_argument('--dpi', type=int, default=300, help='Image resolution (default: 300)')
    parser.add_argument('--format', type=str, default='png', choices=['png', 'jpg'], help='Output format')
    parser.add_argument('--max-pages', type=int, default=5, help='Maximum pages to convert (default: 5)')

    args = parser.parse_args()

    pdf_path = Path(args.pdf_path)
    output_dir = Path(args.output_dir) if args.output_dir else None

    converter = PDFToImageConverter(dpi=args.dpi, format=args.format)
    images = converter.convert(pdf_path, output_dir, max_pages=args.max_pages)

    if images:
        print(f"Generated {len(images)} images:")
        for img in images:
            print(f"  {img}")
    else:
        print("Conversion failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
