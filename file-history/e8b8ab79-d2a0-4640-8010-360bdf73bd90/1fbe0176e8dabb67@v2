import { test, expect } from '@playwright/test';
import * as fs from 'fs';
import * as path from 'path';

/**
 * ZEREZ Import Validation Test
 *
 * Test Requirements:
 * - Category: PV_WITH_STORAGE or STORAGE_INVERTER
 * - Power Minimum: 90 kW
 * - Verify all 3 import modes work correctly
 * - Validate database changes
 */

test.describe('ZEREZ Import Validation', () => {
  test.setTimeout(120000); // 2 minutes for full import flow

  test.beforeEach(async ({ page }) => {
    // Navigate to ZEREZ import page with cache bypass
    await page.goto('http://localhost:3000/import/zerez', { waitUntil: 'networkidle' });

    // Force reload to ensure latest code
    await page.reload({ waitUntil: 'networkidle' });

    // Wait for page to load
    await expect(page.locator('h1')).toContainText('ZEREZ Import Wizard');

    // Wait for enums to load
    await page.waitForTimeout(2000);
  });

  test('Step 1: Configure filters and preview products', async ({ page }) => {
    console.log('üìã Step 1: Configuring filters...');

    // Select Category: STORAGE_INVERTER (visible in dropdown)
    await page.locator('#category').click();
    await page.waitForTimeout(1000); // Wait for dropdown to open

    // Click on STORAGE_INVERTER option (Radix UI Select uses text content)
    await page.getByText('STORAGE_INVERTER', { exact: true }).click();
    console.log('‚úì Selected category: STORAGE_INVERTER');

    // Set Power Minimum to 90 kW
    await page.locator('#powerMin').fill('90');
    console.log('‚úì Set power minimum: 90 kW');

    // Click Preview Products
    await page.getByRole('button', { name: /Preview Products/i }).click();
    console.log('‚è≥ Loading preview...');

    // Wait for preview to load (max 30 seconds)
    await expect(page.locator('text=Preview: Showing')).toBeVisible({ timeout: 30000 });

    // Extract product count from preview
    const previewText = await page.locator('h3:has-text("Preview: Showing")').textContent();
    console.log(`‚úì Preview loaded: ${previewText}`);

    // Scroll down to see Import Mode section
    await page.evaluate(() => window.scrollBy(0, 500));
    await page.waitForTimeout(500);

    // Verify Import Mode options are visible
    await expect(page.locator('text=Import Mode')).toBeVisible();
    await expect(page.locator('label[for="mode-replace"]')).toBeVisible();
    await expect(page.locator('label[for="mode-merge"]')).toBeVisible();
    await expect(page.locator('label[for="mode-add"]')).toBeVisible();
    console.log('‚úì All 3 import mode options visible');

    // Verify 'merge' is selected by default
    const mergeRadio = page.locator('#mode-merge');
    await expect(mergeRadio).toBeChecked();
    console.log('‚úì Merge mode is selected by default');

    // Take screenshot of Step 1
    await page.screenshot({ path: 'test-results/zerez-step1-filters.png', fullPage: true });
    console.log('üì∏ Screenshot saved: test-results/zerez-step1-filters.png');
  });

  test('Step 2: Test merge import mode', async ({ page }) => {
    console.log('üìã Step 2: Testing merge import mode...');

    // Configure filters
    await page.locator('#category').click();
    await page.waitForTimeout(1000);
    await page.getByText('STORAGE_INVERTER', { exact: true }).click();
    await page.locator('#powerMin').fill('90');

    // Preview products
    await page.getByRole('button', { name: /Preview Products/i }).click();
    await expect(page.locator('text=Preview: Showing')).toBeVisible({ timeout: 30000 });

    // Scroll down to see Import Mode section
    await page.evaluate(() => window.scrollBy(0, 500));
    await page.waitForTimeout(500);

    // Read existing database before import
    const dbPath = path.join(process.cwd(), 'public', 'data', 'zerez', 'products.json');
    let existingProducts: any[] = [];
    if (fs.existsSync(dbPath)) {
      existingProducts = JSON.parse(fs.readFileSync(dbPath, 'utf-8'));
      console.log(`üìä Existing database: ${existingProducts.length} products`);
    }

    // Select merge mode (should already be selected)
    const mergeRadio = page.locator('#mode-merge');
    await mergeRadio.check();
    await expect(mergeRadio).toBeChecked();
    console.log('‚úì Merge mode selected');

    // Scroll down a bit more to see Import button
    await page.evaluate(() => window.scrollBy(0, 200));
    await page.waitForTimeout(300);

    // Click Import button
    const importButton = page.getByRole('button', { name: /Import.*Products/i });
    await importButton.click();
    console.log('‚è≥ Starting import...');

    // Wait for import to complete (check for success message)
    await expect(page.getByText('‚úÖ Import Complete!')).toBeVisible({ timeout: 60000 });
    console.log('‚úì Import completed successfully');

    // Verify success alert
    await expect(page.locator('text=Successfully imported')).toBeVisible();

    // Read database after import
    const updatedProducts = JSON.parse(fs.readFileSync(dbPath, 'utf-8'));
    console.log(`üìä Updated database: ${updatedProducts.length} products`);

    // Verify database was updated
    expect(updatedProducts.length).toBeGreaterThan(0);
    console.log('‚úì Database updated successfully');

    // Take screenshot of success
    await page.screenshot({ path: 'test-results/zerez-step2-import-success.png', fullPage: true });
    console.log('üì∏ Screenshot saved: test-results/zerez-step2-import-success.png');
  });

  test('Step 3: Verify all import modes work', async ({ page }) => {
    console.log('üìã Step 3: Testing all import modes...');

    // Helper function to run import with specific mode
    async function testImportMode(mode: 'replace' | 'merge' | 'add', expectedBehavior: string) {
      console.log(`\nüß™ Testing ${mode} mode...`);

      // Navigate to import page
      await page.goto('http://localhost:3000/import/zerez');
      await page.waitForTimeout(2000);

      // Configure filters
      await page.locator('#category').click();
      await page.waitForTimeout(1000);
      await page.getByText('STORAGE_INVERTER', { exact: true }).click();
      await page.locator('#powerMin').fill('90');

      // Preview
      await page.getByRole('button', { name: /Preview Products/i }).click();
      await expect(page.locator('text=Preview: Showing')).toBeVisible({ timeout: 30000 });

      // Scroll down to see Import Mode section
      await page.evaluate(() => window.scrollBy(0, 500));
      await page.waitForTimeout(500);

      // Select mode
      const modeRadio = page.locator(`#mode-${mode}`);
      await modeRadio.check();
      await expect(modeRadio).toBeChecked();
      console.log(`‚úì ${mode} mode selected`);

      // Read database before
      const dbPath = path.join(process.cwd(), 'public', 'data', 'zerez', 'products.json');
      let beforeCount = 0;
      if (fs.existsSync(dbPath)) {
        beforeCount = JSON.parse(fs.readFileSync(dbPath, 'utf-8')).length;
      }
      console.log(`üìä Before: ${beforeCount} products`);

      // Scroll down to see Import button
      await page.evaluate(() => window.scrollBy(0, 200));
      await page.waitForTimeout(300);

      // Import
      await page.getByRole('button', { name: /Import.*Products/i }).click();
      await expect(page.getByText('‚úÖ Import Complete!')).toBeVisible({ timeout: 60000 });

      // Read database after
      const afterProducts = JSON.parse(fs.readFileSync(dbPath, 'utf-8'));
      console.log(`üìä After: ${afterProducts.length} products`);

      // Verify behavior
      if (mode === 'replace') {
        console.log(`‚úì Replace mode: Database reset and populated with new data`);
      } else if (mode === 'merge') {
        expect(afterProducts.length).toBeGreaterThanOrEqual(beforeCount);
        console.log(`‚úì Merge mode: ${afterProducts.length - beforeCount} products merged`);
      } else if (mode === 'add') {
        console.log(`‚úì Add mode: Only new products added, existing preserved`);
      }

      return afterProducts.length;
    }

    // Test each mode
    const replaceCount = await testImportMode('replace', 'Clears database and imports fresh');
    const mergeCount = await testImportMode('merge', 'Updates existing + adds new');
    const addCount = await testImportMode('add', 'Only adds new products');

    console.log('\nüìä Final Results:');
    console.log(`  Replace mode: ${replaceCount} products`);
    console.log(`  Merge mode: ${mergeCount} products`);
    console.log(`  Add mode: ${addCount} products`);
    console.log('‚úÖ All import modes tested successfully');
  });

  test('Step 4: Validate imported data quality', async ({ page }) => {
    console.log('üìã Step 4: Validating data quality...');

    // Configure and import
    await page.locator('#category').click();
    await page.waitForTimeout(1000);
    await page.getByText('STORAGE_INVERTER', { exact: true }).click();
    await page.locator('#powerMin').fill('90');

    await page.getByRole('button', { name: /Preview Products/i }).click();
    await expect(page.locator('text=Preview: Showing')).toBeVisible({ timeout: 30000 });

    // Scroll down to see Import button
    await page.evaluate(() => window.scrollBy(0, 500));
    await page.waitForTimeout(500);

    await page.getByRole('button', { name: /Import.*Products/i }).click();
    await expect(page.getByText('‚úÖ Import Complete!')).toBeVisible({ timeout: 60000 });

    // Read imported database
    const dbPath = path.join(process.cwd(), 'public', 'data', 'zerez', 'products.json');
    const products = JSON.parse(fs.readFileSync(dbPath, 'utf-8'));

    console.log(`\nüìä Analyzing ${products.length} imported products...`);

    // Validate data structure
    let validCount = 0;
    let invalidCount = 0;

    for (const product of products) {
      // Check required fields
      if (product.identification?.zerez_id &&
          product.identification?.model &&
          product.data_source?.source === 'zerez_graphql_api') {
        validCount++;

        // Check power constraint (should be >= 90 kW)
        const ratedPower = product.power?.rated_power_kw || 0;
        if (ratedPower > 0 && ratedPower < 90) {
          console.warn(`‚ö†Ô∏è Product ${product.identification.model} has power ${ratedPower} kW (expected >= 90)`);
        }
      } else {
        invalidCount++;
        console.error(`‚ùå Invalid product structure: ${JSON.stringify(product.identification)}`);
      }
    }

    console.log(`‚úì Valid products: ${validCount}/${products.length}`);
    console.log(`‚úì Invalid products: ${invalidCount}/${products.length}`);

    // Verify at least 90% are valid
    const validPercent = (validCount / products.length) * 100;
    expect(validPercent).toBeGreaterThan(90);

    console.log(`‚úÖ Data quality validation passed: ${validPercent.toFixed(1)}% valid`);
  });
});
