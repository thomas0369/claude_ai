'use client';

import { useState, useEffect, useCallback, useRef } from 'react';
import Link from 'next/link';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import { Progress } from '@/components/ui/progress';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Filter,
  Download,
  Database,
  CheckCircle2,
  AlertCircle,
  Loader2,
  ArrowRight,
  ArrowLeft,
  FileText
} from 'lucide-react';
import { ZEREZUnit } from '@/lib/zerez-types';
import { enrichZEREZUnits } from '@/lib/zerez-data-utils';
import { filterValidEnumValues } from '@/lib/ui-utils';
// SSE utilities imported when needed (parseSSEStream used directly in async functions)
import {
  ZEREZ_IMPORT_LIMITS,
  DEFAULT_FILTERS,
  ALL_OPTIONS_SENTINEL,
  CERTIFICATE_NORMS,
  CertificateNormValue
} from '@/lib/zerez-constants';
import VirtualizedProductTable from '@/components/VirtualizedProductTable';
import { Skeleton } from '@/components/ui/skeleton';

type ZEREZUnitWithSelection = ZEREZUnit & {
  selected?: boolean;
};

type ImportStep = 'filter' | 'import' | 'match';

type ImportProgress = {
  total: number;
  downloaded: number;
  failed: number;
  saved_files: number;
  current: string;
  errors: string[];
};

type MatchResult = {
  productId: string;
  productModel: string;
  pdfPath: string | null;
  pdfFilename: string | null;
  matchConfidence: number;
};

type SyncResult = {
  success: boolean;
  total: number;
  enriched: number;
  skipped: number;
  pdfFilesScanned: number;
  minConfidenceUsed: number;
  matches: MatchResult[];
};

type Manufacturer = {
  id: string;    // UUID
  name: string;  // Manufacturer name
};

type Authority = {
  id: string;    // UUID
  name: string;  // Authority name
};

export default function ZEREZImportPage() {
  // Step management
  const [currentStep, setCurrentStep] = useState<ImportStep>('filter');

  // Enum values from GraphQL
  const [enumValues, setEnumValues] = useState<{
    primaryEnergySource: string[];
    category: string[];
  }>({
    primaryEnergySource: [],
    category: []
  });
  const [isLoadingEnums, setIsLoadingEnums] = useState(true);
  const [enumError, setEnumError] = useState<string | null>(null);

  // Manufacturers for autocomplete
  const [manufacturers, setManufacturers] = useState<Manufacturer[]>([]);
  const [isLoadingManufacturers, setIsLoadingManufacturers] = useState(true);
  const [manufacturerSearchTerm, setManufacturerSearchTerm] = useState('');
  const [manufacturerError, setManufacturerError] = useState<string | null>(null);

  // Certificate Authorities for autocomplete
  const [authorities, setAuthorities] = useState<Authority[]>([]);
  const [isLoadingAuthorities, setIsLoadingAuthorities] = useState(true);
  const [authoritySearchTerm, setAuthoritySearchTerm] = useState('');
  const [authorityError, setAuthorityError] = useState<string | null>(null);

  // Products to match with PDF (stored for step 3)
  const [, setProductsForMatching] = useState<ZEREZUnit[]>([]);

  // Step 2: Import state
  const [importProgress, setImportProgress] = useState<ImportProgress>({
    total: 0,
    downloaded: 0,
    failed: 0,
    saved_files: 0,
    current: '',
    errors: []
  });
  const [importedJsonFile, setImportedJsonFile] = useState<string | null>(null);
  const [importComplete, setImportComplete] = useState(false);
  const [importMode, setImportMode] = useState<'replace' | 'merge' | 'add'>('merge');

  // Step 3: PDF Sync state
  const [syncResult, setSyncResult] = useState<SyncResult | null>(null);
  const [isMatching, setIsMatching] = useState(false);

  // AbortController for canceling operations - separate controllers to prevent race conditions
  const importAbortControllerRef = useRef<AbortController | null>(null);
  const syncAbortControllerRef = useRef<AbortController | null>(null);

  // Cleanup AbortControllers on unmount
  useEffect(() => {
    return () => {
      importAbortControllerRef.current?.abort();
      syncAbortControllerRef.current?.abort();
    };
  }, []);

  // Handle Start Over with confirmation (Èò≤Ê≠¢ accidental data loss)
  const handleStartOver = useCallback(() => {
    const confirmed = window.confirm(
      'Sind Sie sicher?\n\n' +
      'Dies setzt alle Filter und importierten Daten zur√ºck. ' +
      'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.'
    );

    if (confirmed) {
      setCurrentStep('filter');
      setProducts([]);
      setImportComplete(false);
      setImportedJsonFile(null);
      setImportProgress({
        total: 0,
        downloaded: 0,
        failed: 0,
        saved_files: 0,
        current: '',
        errors: []
      });
    }
  }, []);

  // Step 1: Filter state
  const defaultFilters = {
    powerMin: DEFAULT_FILTERS.POWER_MIN,
    powerMax: DEFAULT_FILTERS.POWER_MAX,
    voltageMin: DEFAULT_FILTERS.VOLTAGE_MIN,
    voltageMax: DEFAULT_FILTERS.VOLTAGE_MAX,
    primaryEnergySource: ALL_OPTIONS_SENTINEL,
    category: ALL_OPTIONS_SENTINEL,
    isVerified: DEFAULT_FILTERS.IS_VERIFIED,
    // Certificate norms with type-safe validation
    certificateNorms: [] as CertificateNormValue[],
    createdAfter: '',
    createdBefore: '',
    modifiedAfter: '',
    modifiedBefore: '',
    manufacturerId: ALL_OPTIONS_SENTINEL,
    authorityId: ALL_OPTIONS_SENTINEL
  };

  type FilterState = typeof defaultFilters;
  const [filters, setFilters] = useState<FilterState>(defaultFilters);
  const [products, setProducts] = useState<ZEREZUnitWithSelection[]>([]);
  const [totalCount, setTotalCount] = useState<number>(0);
  const [isLoadingPreview, setIsLoadingPreview] = useState(false);
  const [isLoadingAllProducts, setIsLoadingAllProducts] = useState(false);
  const [previewError, setPreviewError] = useState<string | null>(null);

  // UI state for collapsible sections (reserved for future progressive disclosure)
  // const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);

  // Load enum values on mount
  useEffect(() => {
    async function loadEnumValues() {
      try {
        const response = await fetch('/api/zerez/enum-values');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        setEnumValues(data);
        setEnumError(null); // Clear any previous errors
      } catch (error) {
        setEnumError(
          'Failed to load filter options from ZEREZ. Dropdown filters will show all available values when data loads.'
        );
        console.error('Failed to load enum values:', error);
      } finally {
        setIsLoadingEnums(false);
      }
    }
    loadEnumValues();
  }, []);

  // Load manufacturers and authorities in parallel for better performance
  useEffect(() => {
    async function loadManufacturersAndAuthorities() {
      // Fetch both in parallel to reduce loading time
      const [manufacturersResult, authoritiesResult] = await Promise.allSettled([
        fetch('/api/zerez/manufacturers').then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        }),
        fetch('/api/zerez/authorities').then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
      ]);

      // Handle manufacturers result
      if (manufacturersResult.status === 'fulfilled') {
        setManufacturers(manufacturersResult.value);
        setManufacturerError(null);
      } else {
        const message = 'Failed to load manufacturer list. Filter will still work with manually entered UUIDs.';
        setManufacturerError(message);
        console.error('Failed to load manufacturers:', manufacturersResult.reason);
      }
      setIsLoadingManufacturers(false);

      // Handle authorities result
      if (authoritiesResult.status === 'fulfilled') {
        setAuthorities(authoritiesResult.value);
        setAuthorityError(null);
      } else {
        const message = 'Failed to load certificate authority list. Filter will still work with manually entered UUIDs.';
        setAuthorityError(message);
        console.error('Failed to load authorities:', authoritiesResult.reason);
      }
      setIsLoadingAuthorities(false);
    }

    loadManufacturersAndAuthorities();
  }, []);

  /**
   * Helper function to build a search request body from filters
   * Reusable for both preview and full product fetch
   *
   * @param currentFilters - The filter state to convert to a request
   * @param maxResults - Optional limit on results (defaults to MAX_SEARCH_RESULTS)
   * @returns Request body object for the /api/zerez/search endpoint
   */
  const buildSearchRequest = useCallback((currentFilters: FilterState, maxResults?: number): Record<string, unknown> => {
    const requestBody: Record<string, unknown> = {
      isVerified: currentFilters.isVerified
    };

    // Only add power filters if they're specified (not null)
    if (currentFilters.powerMin !== null) {
      requestBody.powerMin = currentFilters.powerMin;
    }
    if (currentFilters.powerMax !== null) {
      requestBody.powerMax = currentFilters.powerMax;
    }

    // Only add voltage filters if they're specified (not null)
    if (currentFilters.voltageMin !== null) {
      requestBody.voltageMin = currentFilters.voltageMin;
    }
    if (currentFilters.voltageMax !== null) {
      requestBody.voltageMax = currentFilters.voltageMax;
    }

    // Only send enum filters if they're not the "All" sentinel value
    if (currentFilters.primaryEnergySource && currentFilters.primaryEnergySource !== ALL_OPTIONS_SENTINEL) {
      requestBody.primaryEnergySource = currentFilters.primaryEnergySource;
    }
    if (currentFilters.category && currentFilters.category !== ALL_OPTIONS_SENTINEL) {
      requestBody.category = currentFilters.category;
    }

    // Certificate norms filter (use array directly)
    if (currentFilters.certificateNorms && currentFilters.certificateNorms.length > 0) {
      requestBody.certificateNorms = currentFilters.certificateNorms;
    }

    // Date filters
    if (currentFilters.createdAfter && currentFilters.createdAfter.trim() !== '') {
      requestBody.createdAfter = currentFilters.createdAfter;
    }
    if (currentFilters.createdBefore && currentFilters.createdBefore.trim() !== '') {
      requestBody.createdBefore = currentFilters.createdBefore;
    }
    if (currentFilters.modifiedAfter && currentFilters.modifiedAfter.trim() !== '') {
      requestBody.modifiedAfter = currentFilters.modifiedAfter;
    }
    if (currentFilters.modifiedBefore && currentFilters.modifiedBefore.trim() !== '') {
      requestBody.modifiedBefore = currentFilters.modifiedBefore;
    }

    // ID filters (UUID format)
    if (currentFilters.manufacturerId && currentFilters.manufacturerId !== ALL_OPTIONS_SENTINEL && currentFilters.manufacturerId.trim() !== '') {
      requestBody.manufacturerId = currentFilters.manufacturerId.trim();
    }
    if (currentFilters.authorityId && currentFilters.authorityId !== ALL_OPTIONS_SENTINEL && currentFilters.authorityId.trim() !== '') {
      requestBody.authorityId = currentFilters.authorityId.trim();
    }

    // Set result limit
    requestBody.maxResults = maxResults ?? ZEREZ_IMPORT_LIMITS.MAX_SEARCH_RESULTS;

    return requestBody;
  }, []); // No external dependencies - all parameters are passed in

  /**
   * Fetches ZEREZ products matching filters and enriches them with detailed technical specifications.
   *
   * This function implements the complete fetch-and-enrich pattern:
   * 1. Fetches basic product data from search API (unitOverview fields)
   * 2. Extracts unit IDs from search results
   * 3. Fetches detailed technical specs (75+ fields) via unit(id) query
   * 4. Merges detailed specs with basic data using enrichZEREZUnits utility
   * 5. Returns enriched units with warnings if any detailed specs failed
   *
   * Traffic Optimization:
   * - Single search API call with configurable maxResults
   * - Single detailed fetch API call for all unit IDs
   * - No redundant fetches - each product fetched only once
   * - Graceful degradation: Falls back to basic data if detailed fetch fails
   *
   * @param currentFilters - The filter state to apply to the search
   * @param maxResults - Maximum number of results to fetch (defaults to MAX_SEARCH_RESULTS)
   * @param context - Logging context for debugging (e.g., "Preview" or "Full Fetch")
   * @returns Promise resolving to enriched units, total count, and optional warning message
   * @throws Error if search API fails or returns non-OK response
   */
  const fetchAndEnrichProducts = useCallback(async (
    currentFilters: FilterState,
    maxResults: number,
    context: string
  ): Promise<{
    units: ZEREZUnit[];
    totalCount: number;
    warning: string | null;
  }> => {
    // Build request body using reusable helper
    const requestBody = buildSearchRequest(currentFilters, maxResults);

    // Step 1: Fetch basic product data from search API
    const response = await fetch('/api/zerez/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    const data = await response.json();

    // Step 2: Extract unit IDs for detailed fetch
    const unitIds = data.units.map((u: ZEREZUnit) => u.id);

    // Step 3: Fetch detailed unit data (75+ fields including all German technical specifications)
    // **BATCHING** - API limit is 100 units per request
    let detailedUnits: ZEREZUnit[] = [];
    let detailFetchWarning: string | null = null;

    if (unitIds.length > 0) {
      try {
        const DETAIL_BATCH_SIZE = 100;
        const totalDetailBatches = Math.ceil(unitIds.length / DETAIL_BATCH_SIZE);
        let totalFailed = 0;

        // Process in batches
        for (let batchIdx = 0; batchIdx < totalDetailBatches; batchIdx++) {
          const startIdx = batchIdx * DETAIL_BATCH_SIZE;
          const endIdx = Math.min(startIdx + DETAIL_BATCH_SIZE, unitIds.length);
          const batchIds = unitIds.slice(startIdx, endIdx);

          console.log(`[${context}] Fetching detailed data batch ${batchIdx + 1}/${totalDetailBatches} (${batchIds.length} units)`);

          const detailedResponse = await fetch('/api/zerez/fetch-detailed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ unitIds: batchIds })
          });

          if (detailedResponse.ok) {
            const detailedData = await detailedResponse.json();
            detailedUnits = [...detailedUnits, ...detailedData.units];
            totalFailed += detailedData.failed || 0;
          } else {
            console.error(`[${context}] Batch ${batchIdx + 1} failed to fetch detailed data`);
            totalFailed += batchIds.length;
          }
        }

        // Step 4: Handle partial failures - notify user if some detailed specs failed to load
        if (totalFailed > 0) {
          const warningPrefix = context === 'Preview' ? '‚ö†Ô∏è ' : 'Warning: ';
          const warningSuffix = context === 'Preview'
            ? ' units: Technical specifications unavailable (showing basic data only)'
            : ' units had incomplete technical specifications';

          detailFetchWarning = `${warningPrefix}${totalFailed} of ${unitIds.length}${warningSuffix}`;
          console.warn(`[${context}] ${totalFailed} of ${unitIds.length} units failed to fetch detailed data`);
        }
      } catch (detailError) {
        detailFetchWarning = context === 'Preview'
          ? '‚ö†Ô∏è Unable to load detailed technical specifications. Showing basic data only.'
          : 'Warning: Unable to load detailed technical specifications for some products.';
        console.error(`[${context}] Error fetching detailed data:`, detailError);
        // Fall back to basic search results if detailed fetch fails
      }
    }

    // Step 5: Merge detailed data with basic search results using utility function
    // This preserves unitOverview-only fields (manufacturerName, category, etc.)
    // while adding technical specs from unit(id) query
    const enrichedUnits = enrichZEREZUnits(data.units, detailedUnits);

    return {
      units: enrichedUnits,
      totalCount: data.totalCount,
      warning: detailFetchWarning
    };
  }, [buildSearchRequest]); // Depends on buildSearchRequest

  // Handler to proceed from Step 2 to Step 3 - Sync database with PDFs
  const handleProceedToMatching = useCallback(async () => {
    // Create new AbortController for this operation
    syncAbortControllerRef.current = new AbortController();

    // Move to step 3
    setCurrentStep('match');
    setIsMatching(true);

    console.log('üîÑ Starting PDF sync with database...');

    try {
      const response = await fetch('/api/zerez/sync-with-pdfs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          minConfidence: 50 // Only match PDFs with 50%+ confidence
        }),
        signal: syncAbortControllerRef.current.signal
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);
      }

      const data: SyncResult = await response.json();
      setSyncResult(data);

      console.log(`‚úÖ PDF sync complete: ${data.enriched} enriched, ${data.skipped} skipped`);
    } catch (error) {
      // Check if the error is an abort error
      if (error instanceof Error && error.name === 'AbortError') {
        console.log('‚úÖ PDF sync canceled successfully');
        return;
      }

      console.error('PDF sync failed:', error);
      setPreviewError(error instanceof Error ? error.message : 'PDF sync failed');
    } finally {
      setIsMatching(false);
      // Clean up AbortController
      syncAbortControllerRef.current = null;
    }
  }, []); // No dependencies - syncs entire database


  // Step 1: Load product preview from GraphQL
  const handlePreviewProducts = async () => {
    // Validate filters before making API call
    const validationErrors: string[] = [];

    // Validate power range (only if both values are specified)
    if (filters.powerMin !== null && filters.powerMax !== null && filters.powerMin > filters.powerMax) {
      validationErrors.push('Minimum power cannot be greater than maximum power');
    }

    // Validate voltage range (only if both values are specified)
    if (filters.voltageMin !== null && filters.voltageMax !== null && filters.voltageMin > filters.voltageMax) {
      validationErrors.push('Minimum voltage cannot be greater than maximum voltage');
    }

    if (validationErrors.length > 0) {
      setPreviewError(validationErrors.join('. '));
      return;
    }

    setIsLoadingPreview(true);
    setPreviewError(null);

    try {
      // Use extracted fetch-and-enrich function (limit to preview size)
      const result = await fetchAndEnrichProducts(
        filters,
        ZEREZ_IMPORT_LIMITS.PREVIEW_PRODUCT_LIMIT,
        'Preview'
      );

      // Update UI with enriched products (all selected by default)
      setProducts(result.units.map((u: ZEREZUnit) => ({ ...u, selected: true })));
      setTotalCount(result.totalCount);

      // Show warning if detailed fetch had issues (but don't block the preview)
      if (result.warning) {
        setPreviewError(result.warning);
      }
    } catch (error) {
      setPreviewError(error instanceof Error ? error.message : 'Failed to load products');
    } finally {
      setIsLoadingPreview(false);
    }
  };

  // Cancel import operation
  const handleCancelImport = useCallback(() => {
    if (importAbortControllerRef.current) {
      console.log('üõë Canceling import operation...');
      importAbortControllerRef.current.abort();
      importAbortControllerRef.current = null;

      // Update UI to show cancellation
      setImportProgress(prev => ({
        ...prev,
        current: 'Import canceled by user',
        errors: [...prev.errors, 'Import operation was canceled']
      }));
    }
  }, []);

  // Cancel PDF sync operation
  const handleCancelSync = useCallback(() => {
    if (syncAbortControllerRef.current) {
      console.log('üõë Canceling PDF sync operation...');
      syncAbortControllerRef.current.abort();
      syncAbortControllerRef.current = null;
    }
  }, []);

  // Step 2: Import to main database with batching for progress tracking
  const handleImportDetails = async () => {
    // Create new AbortController for this operation
    importAbortControllerRef.current = new AbortController();

    // ALWAYS fetch ALL products matching the filters (preview is just for verification)
    let productsToImport: ZEREZUnit[];

    // Check if we've already shown a preview (and thus need to fetch the full dataset)
    const needsFullFetch = totalCount > products.length;

    if (needsFullFetch) {
      console.log(`üöÄ Fetching all ${totalCount.toLocaleString()} products matching your filters for import...`);

      setIsLoadingAllProducts(true);
      setPreviewError(null);

      try {
        const result = await fetchAndEnrichProducts(
          filters,
          ZEREZ_IMPORT_LIMITS.MAX_SEARCH_RESULTS,
          'Full Import Fetch'
        );

        productsToImport = result.units;

        if (result.warning) {
          console.warn(result.warning);
        }

        console.log(`‚úÖ Successfully fetched ${productsToImport.length} products for import`);
      } catch (error) {
        console.error('Failed to fetch all products:', error);
        setIsLoadingAllProducts(false);
        setPreviewError(
          error instanceof Error
            ? `Failed to fetch all products: ${error.message}`
            : 'Failed to fetch all products'
        );
        return;
      } finally {
        setIsLoadingAllProducts(false);
      }
    } else {
      productsToImport = products;
      console.log(`‚ÑπÔ∏è Importing ${productsToImport.length} products (no additional fetch needed)`);
    }

    // Initialize progress
    const progress: ImportProgress = {
      total: productsToImport.length,
      downloaded: 0,
      failed: 0,
      saved_files: 0,
      current: 'Starting import...',
      errors: []
    };

    setImportProgress(progress);
    setCurrentStep('import');

    console.log(`üì¶ Importing ${productsToImport.length} products to database (${importMode} mode)...`);

    // **BATCHING** - Process in chunks of 100 for progress tracking
    const BATCH_SIZE = 100;
    const totalBatches = Math.ceil(productsToImport.length / BATCH_SIZE);

    try {
      let totalAdded = 0;
      let totalUpdated = 0;
      let totalSkipped = 0;

      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
        const startIdx = batchIndex * BATCH_SIZE;
        const endIdx = Math.min(startIdx + BATCH_SIZE, productsToImport.length);
        const batch = productsToImport.slice(startIdx, endIdx);

        // Update progress (0-100%) using state updater function
        const percentComplete = Math.round((batchIndex / totalBatches) * 100);
        setImportProgress(prev => ({
          ...prev,
          current: `Importing to database: ${percentComplete}% (batch ${batchIndex + 1}/${totalBatches})`,
          downloaded: endIdx  // Use endIdx to show actual progress
        }));

        console.log(`üì¶ Processing batch ${batchIndex + 1}/${totalBatches} (${batch.length} products)`);

        // Call the new import-to-database endpoint
        const response = await fetch('/api/zerez/import-to-database', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            products: batch,
            mode: importMode
          }),
          signal: importAbortControllerRef.current?.signal
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        totalAdded += result.added || 0;
        totalUpdated += result.updated || 0;
        totalSkipped += result.skipped || 0;

        console.log(`‚úÖ Batch ${batchIndex + 1}/${totalBatches}: ${result.added} added, ${result.updated} updated, ${result.skipped} skipped`);

        // Update failed count after each batch
        setImportProgress(prev => ({
          ...prev,
          failed: totalSkipped,
          saved_files: totalAdded + totalUpdated
        }));
      }

      // Final progress update (100%)
      setImportProgress(prev => ({
        ...prev,
        downloaded: productsToImport.length,
        saved_files: totalAdded + totalUpdated,
        failed: totalSkipped,
        current: 'Import complete'
      }));

      // Store products for step 3
      setProductsForMatching(productsToImport);
      setProducts(productsToImport);

      // Mark import as complete
      setImportComplete(true);
      setImportedJsonFile('public/data/zerez/products.json');

      console.log(`‚úÖ Import complete! ${totalAdded} added, ${totalUpdated} updated, ${totalSkipped} skipped`);

    } catch (error) {
      // Check if the error is an abort error
      if (error instanceof Error && error.name === 'AbortError') {
        console.log('‚úÖ Import canceled successfully');
        return;
      }

      console.error('Import failed:', error);
      const errorMessage = error instanceof Error ? error.message : 'Import failed';
      setImportProgress(prev => ({
        ...prev,
        errors: [...prev.errors, errorMessage],
        current: 'Import failed'
      }));
      setPreviewError(errorMessage);
    } finally {
      // Clean up AbortController
      importAbortControllerRef.current = null;
    }
  };

  return (
    <div className="container mx-auto p-6 max-w-6xl">
      {/* Navigation Header */}
      <div className="mb-6 flex items-center justify-between">
        <Link
          href="/dashboard"
          className="flex items-center gap-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 transition-colors"
          aria-label="Navigate back to dashboard"
        >
          <ArrowLeft size={20} aria-hidden="true" />
          <span>Back to Dashboard</span>
        </Link>

        <div className="flex items-center gap-2 text-gray-500" role="status" aria-label="Current location">
          <Database size={20} aria-hidden="true" />
          <span className="text-sm">Import Wizard</span>
        </div>
      </div>

      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">ZEREZ Import Wizard</h1>
        <p className="text-gray-600">
          Import battery storage systems from ZEREZ database with 3 easy steps
        </p>
      </div>

      {/* Progress Steps */}
      <div className="flex items-center justify-between mb-8">
        <div className={`flex items-center ${currentStep === 'filter' ? 'text-blue-600' : 'text-gray-400'}`}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
            currentStep === 'filter' ? 'bg-blue-600 text-white' : 'bg-gray-200'
          }`}>
            <Filter size={20} />
          </div>
          <span className="ml-2 font-medium">Filter & Preview</span>
        </div>

        <ArrowRight className="text-gray-400" />

        <div className={`flex items-center ${currentStep === 'import' ? 'text-blue-600' : 'text-gray-400'}`}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
            currentStep === 'import' ? 'bg-blue-600 text-white' : 'bg-gray-200'
          }`}>
            <Download size={20} />
          </div>
          <span className="ml-2 font-medium">Import Details</span>
        </div>

        <ArrowRight className="text-gray-400" />

        <div className={`flex items-center ${currentStep === 'match' ? 'text-blue-600' : 'text-gray-400'}`}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
            currentStep === 'match' ? 'bg-blue-600 text-white' : 'bg-gray-200'
          }`}>
            <Database size={20} />
          </div>
          <span className="ml-2 font-medium">Match with PDFs</span>
        </div>
      </div>

      {/* STEP 1: Filter & Preview */}
      {currentStep === 'filter' && (
        <Card>
          <CardHeader>
            <CardTitle>Step 1: Configure Filters</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Category Filters - Always Visible */}
            <div className="space-y-4">
              <div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="primaryEnergySource">Energy Source</Label>
                    <Select
                      value={filters.primaryEnergySource}
                      onValueChange={(value) => setFilters({ ...filters, primaryEnergySource: value })}
                      disabled={isLoadingEnums}
                    >
                      <SelectTrigger id="primaryEnergySource">
                        <SelectValue placeholder={isLoadingEnums ? "Loading..." : "All Sources"} />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value={ALL_OPTIONS_SENTINEL}>All Sources</SelectItem>
                        {/* Filter out invalid values (empty/null/whitespace) - Radix doesn't allow empty strings */}
                        {filterValidEnumValues(enumValues.primaryEnergySource).map((source) => (
                          <SelectItem key={source} value={source}>
                            {source}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="category">Category</Label>
                    <Select
                      value={filters.category}
                      onValueChange={(value) => setFilters({ ...filters, category: value })}
                      disabled={isLoadingEnums}
                    >
                      <SelectTrigger id="category">
                        <SelectValue placeholder={isLoadingEnums ? "Loading..." : "All Categories"} />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value={ALL_OPTIONS_SENTINEL}>All Categories</SelectItem>
                        {/* Filter out invalid values (empty/null/whitespace) - Radix doesn't allow empty strings */}
                        {filterValidEnumValues(enumValues.category).map((cat) => (
                          <SelectItem key={cat} value={cat}>
                            {cat}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </div>
            </div>

            {/* Advanced Filters - Tabbed Interface */}
            <Tabs defaultValue="technical" className="w-full">
              <TabsList
                className="grid w-full grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-1"
                aria-label="Advanced filter categories"
              >
                <TabsTrigger value="technical" title="Technical Specification - Power and Voltage ranges">
                  <span className="hidden md:inline">Technical Specification</span>
                  <span className="md:hidden">Technical</span>
                </TabsTrigger>
                <TabsTrigger value="compliance" title="Compliance & Verification - Certificate standards">
                  Compliance
                </TabsTrigger>
                <TabsTrigger value="dates" title="Date Range Filters - Created and Modified dates">
                  <span className="hidden sm:inline">Date Filters</span>
                  <span className="sm:hidden">Dates</span>
                </TabsTrigger>
                <TabsTrigger value="manufacturer" title="Filter by Manufacturer">
                  <span className="hidden sm:inline">Manufacturer</span>
                  <span className="sm:hidden">Mfr</span>
                </TabsTrigger>
                <TabsTrigger value="authority" title="Filter by Certification Authority">
                  <span className="hidden md:inline">Certification Authority</span>
                  <span className="md:hidden">Authority</span>
                </TabsTrigger>
              </TabsList>

              {/* Context for screen readers */}
              <div className="sr-only" id="advanced-filters-description">
                Use tabs to access different filter categories for refining product search
              </div>

              {/* Technical Specification Tab */}
              <TabsContent value="technical">
                {/* Power Range */}
                <div>
                  <Label className="text-sm mb-3 block">
                    Power Range
                    <span className="text-xs text-gray-500 font-normal ml-2">(optional - leave empty to search all)</span>
                  </Label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="powerMin">Minimum (kW)</Label>
                      <Input
                        id="powerMin"
                        type="number"
                        placeholder="e.g., 50"
                        value={filters.powerMin === null ? '' : filters.powerMin}
                        onChange={(e) => setFilters({ ...filters, powerMin: e.target.value === '' ? null : Number(e.target.value) })}
                      />
                    </div>
                    <div>
                      <Label htmlFor="powerMax">Maximum (kW)</Label>
                      <Input
                        id="powerMax"
                        type="number"
                        placeholder="e.g., 200"
                        value={filters.powerMax === null ? '' : filters.powerMax}
                        onChange={(e) => setFilters({ ...filters, powerMax: e.target.value === '' ? null : Number(e.target.value) })}
                    />
                    </div>
                  </div>
                </div>

                {/* Voltage Range */}
                <div>
                  <Label className="text-sm mb-3 block">
                    Voltage Range
                    <span className="text-xs text-gray-500 font-normal ml-2">(optional - leave empty to search all)</span>
                  </Label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="voltageMin">Minimum (V)</Label>
                      <Input
                        id="voltageMin"
                        type="number"
                        placeholder="e.g., 230"
                        value={filters.voltageMin === null ? '' : filters.voltageMin}
                        onChange={(e) => setFilters({ ...filters, voltageMin: e.target.value === '' ? null : Number(e.target.value) })}
                      />
                    </div>
                    <div>
                      <Label htmlFor="voltageMax">Maximum (V)</Label>
                      <Input
                        id="voltageMax"
                        type="number"
                        placeholder="e.g., 1000"
                        value={filters.voltageMax === null ? '' : filters.voltageMax}
                        onChange={(e) => setFilters({ ...filters, voltageMax: e.target.value === '' ? null : Number(e.target.value) })}
                      />
                    </div>
                  </div>
                </div>
              </TabsContent>

              {/* Compliance Tab */}
              <TabsContent value="compliance">
                {/* Verified Products Checkbox */}
                <div className="flex items-center space-x-2 mb-4">
                  <Checkbox
                    id="isVerified"
                    checked={filters.isVerified}
                    onCheckedChange={(checked) => setFilters({ ...filters, isVerified: checked as boolean })}
                  />
                  <Label htmlFor="isVerified">Only Verified Products</Label>
                </div>

                {/* Certificate Norms - Multi-select with WCAG 2.1 AA accessibility */}
              <fieldset className="border border-gray-200 rounded-lg p-4">
                <legend className="text-sm font-semibold px-2">
                  Certificate Standards (Optional)
                  <span className="text-xs text-gray-500 font-normal ml-2">Select multiple standards</span>
                  {filters.certificateNorms.length > 0 && (
                    <span className="ml-2 text-xs font-normal text-blue-600" aria-live="polite">
                      ({filters.certificateNorms.length} selected)
                    </span>
                  )}
                </legend>

                {/* Select All / Clear All buttons */}
                <div className="flex gap-2 mb-3">
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setFilters({
                      ...filters,
                      certificateNorms: CERTIFICATE_NORMS.map(n => n.value)
                    })}
                    disabled={filters.certificateNorms.length === CERTIFICATE_NORMS.length}
                    aria-label="Select all certificate standards"
                  >
                    Select All
                  </Button>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setFilters({
                      ...filters,
                      certificateNorms: []
                    })}
                    disabled={filters.certificateNorms.length === 0}
                    aria-label="Clear all certificate standards"
                  >
                    Clear All
                  </Button>
                </div>

                <div
                  className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"
                  role="group"
                  aria-label="Certificate standards options"
                >
                  {CERTIFICATE_NORMS.map((norm) => {
                    // Extract value with proper literal type
                    const normValue: CertificateNormValue = norm.value;
                    // Sanitize ID to avoid issues with special characters
                    const sanitizedId = `cert-norm-${normValue.replace(/[^a-zA-Z0-9]/g, '-')}`;

                    return (
                      <div
                        key={normValue}
                        className="flex items-center space-x-3 min-h-[24px]"
                        title={norm.description}
                      >
                        <Checkbox
                          id={sanitizedId}
                          checked={filters.certificateNorms.includes(normValue)}
                          onCheckedChange={(checked) => {
                            if (checked) {
                              // Type-safe addition: normValue is CertificateNormValue
                              setFilters({
                                ...filters,
                                certificateNorms: [...filters.certificateNorms, normValue]
                              });
                            } else {
                              // Type-safe filtering with proper type inference
                              setFilters({
                                ...filters,
                                certificateNorms: filters.certificateNorms.filter(n => n !== normValue)
                              });
                            }
                          }}
                          className="h-5 w-5"
                          aria-describedby={`${sanitizedId}-desc`}
                        />
                        <Label
                          htmlFor={sanitizedId}
                          className="text-sm cursor-pointer leading-tight py-1"
                        >
                          {norm.label}
                          <span id={`${sanitizedId}-desc`} className="sr-only">
                            {norm.description}
                          </span>
                        </Label>
                      </div>
                    );
                  })}
                </div>
              </fieldset>
              </TabsContent>

              {/* Date Filters Tab */}
              <TabsContent value="dates">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="createdAfter">Created After</Label>
                    <Input
                      id="createdAfter"
                      type="date"
                      value={filters.createdAfter}
                      onChange={(e) => setFilters({ ...filters, createdAfter: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="createdBefore">Created Before</Label>
                    <Input
                      id="createdBefore"
                      type="date"
                      value={filters.createdBefore}
                      onChange={(e) => setFilters({ ...filters, createdBefore: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="modifiedAfter">Modified After</Label>
                    <Input
                      id="modifiedAfter"
                      type="date"
                      value={filters.modifiedAfter}
                      onChange={(e) => setFilters({ ...filters, modifiedAfter: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="modifiedBefore">Modified Before</Label>
                    <Input
                      id="modifiedBefore"
                      type="date"
                      value={filters.modifiedBefore}
                      onChange={(e) => setFilters({ ...filters, modifiedBefore: e.target.value })}
                    />
                  </div>
                </div>
              </TabsContent>

              {/* Manufacturer Tab */}
              <TabsContent value="manufacturer">
                    {isLoadingManufacturers ? (
                      <div className="space-y-2">
                        <Skeleton className="h-10 w-full" />
                        <div className="flex gap-2">
                          <Skeleton className="h-4 w-32" />
                          <Skeleton className="h-4 w-24" />
                        </div>
                      </div>
                    ) : (
                      <Select
                        value={filters.manufacturerId}
                        onValueChange={(value) => setFilters({ ...filters, manufacturerId: value })}
                        disabled={isLoadingManufacturers}
                      >
                        <SelectTrigger id="manufacturerId">
                          <SelectValue placeholder="Search manufacturer..." />
                        </SelectTrigger>
                      <SelectContent>
                        <div className="sticky top-0 bg-white dark:bg-gray-950 p-2 border-b">
                          <label htmlFor="manufacturer-search" className="sr-only">
                            Search manufacturers by name
                          </label>
                          <Input
                            id="manufacturer-search"
                            placeholder="Type to search..."
                            value={manufacturerSearchTerm}
                            onChange={(e) => setManufacturerSearchTerm(e.target.value)}
                            onClick={(e) => e.stopPropagation()}
                            onKeyDown={(e) => {
                              // Prevent Select dropdown from closing when Enter is pressed in search
                              if (e.key === 'Enter') {
                                e.preventDefault();
                                e.stopPropagation();
                              }
                              // Allow clearing search with Escape
                              if (e.key === 'Escape') {
                                e.stopPropagation();
                                setManufacturerSearchTerm('');
                              }
                            }}
                            className="h-8"
                            role="searchbox"
                            aria-label="Search manufacturers by name"
                            aria-controls="manufacturer-list"
                          />
                        </div>
                        <div id="manufacturer-list" role="group" aria-label="Manufacturer options">
                          <SelectItem value={ALL_OPTIONS_SENTINEL}>All Manufacturers</SelectItem>
                          {(() => {
                            // Filter first, then slice to avoid incorrect count
                            const filteredManufacturers = manufacturers.filter((m) =>
                              m.name.toLowerCase().includes(manufacturerSearchTerm.toLowerCase())
                            );
                            const displayedManufacturers = filteredManufacturers.slice(0, 50);

                            return (
                              <>
                                {displayedManufacturers.map((manufacturer) => (
                                  <SelectItem key={manufacturer.id} value={manufacturer.id}>
                                    {manufacturer.name}
                                  </SelectItem>
                                ))}
                                {filteredManufacturers.length > 50 && (
                                  <div className="p-2 text-xs text-gray-500 italic text-center">
                                    Showing first 50 of {filteredManufacturers.length} results. Type to narrow down.
                                  </div>
                                )}
                              </>
                            );
                          })()}
                        </div>
                      </SelectContent>
                      </Select>
                    )}
                    {!isLoadingManufacturers && manufacturers.length > 0 && (
                      <p className="text-xs text-gray-500 mt-1">
                        {manufacturers.length} manufacturers available
                      </p>
                    )}
                    {manufacturerError && (
                      <Alert className="mt-2">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>{manufacturerError}</AlertDescription>
                      </Alert>
                    )}
              </TabsContent>

              {/* Certification Authority Tab */}
              <TabsContent value="authority">
                    {isLoadingAuthorities ? (
                      <div className="space-y-2">
                        <Skeleton className="h-10 w-full" />
                        <div className="flex gap-2">
                          <Skeleton className="h-4 w-32" />
                          <Skeleton className="h-4 w-24" />
                        </div>
                      </div>
                    ) : (
                      <Select
                        value={filters.authorityId}
                        onValueChange={(value) => setFilters({ ...filters, authorityId: value })}
                        disabled={isLoadingAuthorities}
                      >
                        <SelectTrigger id="authorityId">
                          <SelectValue placeholder="Search certificate authority..." />
                        </SelectTrigger>
                        <SelectContent>
                          <div className="sticky top-0 bg-white dark:bg-gray-950 p-2 border-b">
                            <label htmlFor="authority-search" className="sr-only">
                              Search certificate authorities by name
                            </label>
                            <Input
                              id="authority-search"
                              placeholder="Type to search..."
                              value={authoritySearchTerm}
                              onChange={(e) => setAuthoritySearchTerm(e.target.value)}
                              onClick={(e) => e.stopPropagation()}
                              onKeyDown={(e) => {
                                // Prevent Select dropdown from closing when Enter is pressed in search
                                if (e.key === 'Enter') {
                                  e.preventDefault();
                                  e.stopPropagation();
                                }
                                // Allow clearing search with Escape
                                if (e.key === 'Escape') {
                                  e.stopPropagation();
                                  setAuthoritySearchTerm('');
                                }
                              }}
                              className="h-8"
                              role="searchbox"
                              aria-label="Search certificate authorities by name"
                              aria-controls="authority-list"
                            />
                          </div>
                          <div id="authority-list" role="group" aria-label="Certificate Authority options">
                            <SelectItem value={ALL_OPTIONS_SENTINEL}>All Certificate Authorities</SelectItem>
                            {(() => {
                              // Filter first, then slice to avoid incorrect count
                              const filteredAuthorities = authorities.filter((a) =>
                                a.name.toLowerCase().includes(authoritySearchTerm.toLowerCase())
                              );
                              const displayedAuthorities = filteredAuthorities.slice(0, 50);

                              return (
                                <>
                                  {displayedAuthorities.map((authority) => (
                                    <SelectItem key={authority.id} value={authority.id}>
                                      {authority.name}
                                    </SelectItem>
                                  ))}
                                  {filteredAuthorities.length > 50 && (
                                    <div className="p-2 text-xs text-gray-500 italic text-center">
                                      Showing first 50 of {filteredAuthorities.length} results. Type to narrow down.
                                    </div>
                                  )}
                                </>
                              );
                            })()}
                          </div>
                        </SelectContent>
                      </Select>
                    )}
                    {!isLoadingAuthorities && authorities.length > 0 && (
                      <p className="text-xs text-gray-500 mt-1">
                        {authorities.length} certificate authorities available
                      </p>
                    )}
                    {authorityError && (
                      <Alert className="mt-2">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>{authorityError}</AlertDescription>
                      </Alert>
                    )}
              </TabsContent>
            </Tabs>

            {enumError && (
              <Alert>
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{enumError}</AlertDescription>
              </Alert>
            )}

            <div className="flex flex-col sm:flex-row gap-2">
              <Button
                onClick={handlePreviewProducts}
                disabled={isLoadingPreview}
                className="flex-1"
              >
                {isLoadingPreview ? (
                  <>
                    <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                    <div className="flex flex-col items-start">
                      <span className="font-medium">Loading Products...</span>
                      <span className="text-xs text-blue-200">Please wait, this may take a moment</span>
                    </div>
                  </>
                ) : (
                  <>
                    <Filter className="mr-2 h-4 w-4" />
                    <span>Preview Products</span>
                  </>
                )}
              </Button>
              <Button
                onClick={() => {
                  setFilters(defaultFilters);
                  setProducts([]);
                  setTotalCount(0);
                  setPreviewError(null);
                }}
                variant="outline"
                disabled={isLoadingPreview}
              >
                Reset Filters
              </Button>
            </div>

            {previewError && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{previewError}</AlertDescription>
              </Alert>
            )}

            {/* Loading All Products Alert */}
            {isLoadingAllProducts && (
              <Alert className="bg-blue-50 border-blue-200">
                <Loader2 className="h-4 w-4 animate-spin text-blue-600" />
                <AlertDescription className="text-blue-900">
                  <span className="font-semibold">Fetching all {totalCount.toLocaleString()} products matching your filters...</span>
                  <br />
                  <span className="text-sm">This may take a moment. Please wait while we load the complete dataset.</span>
                </AlertDescription>
              </Alert>
            )}

            {/* Product Preview Table */}
            {products.length > 0 && (
              <div className="mt-6">
                <div className="mb-4">
                  <h3 className="text-lg font-semibold mb-2">
                    Preview: Showing {products.length}{totalCount > products.length && ` of ${totalCount.toLocaleString()}`} products
                  </h3>
                  <Alert className="bg-blue-50 border-blue-200">
                    <AlertDescription className="text-blue-900 text-sm">
                      ‚ÑπÔ∏è <strong>Preview is for verification only.</strong> When you proceed,
                      {totalCount > products.length
                        ? ` ALL ${totalCount.toLocaleString()} products matching your filters will be imported.`
                        : ' all shown products will be imported.'}
                    </AlertDescription>
                  </Alert>
                </div>

                {/* Virtualized Product Table - read-only preview mode */}
                <VirtualizedProductTable
                  products={products}
                  onToggleSelection={(id, checked) => {
                    setProducts(products.map(p =>
                      p.id === id ? { ...p, selected: checked } : p
                    ));
                  }}
                  readOnly={true}
                />

                {/* Import Mode Selection */}
                <div className="p-6 pt-4">
                  <Label className="text-sm font-semibold mb-3 block">Import Mode</Label>
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3 border border-orange-200 rounded-lg p-3 bg-orange-50">
                      <input
                        id="mode-replace"
                        className="mt-1 h-4 w-4 text-orange-600 focus:ring-orange-500"
                        type="radio"
                        name="import-mode"
                        checked={importMode === 'replace'}
                        onChange={() => setImportMode('replace')}
                      />
                      <Label htmlFor="mode-replace" className="cursor-pointer flex-1">
                        <span className="font-medium text-orange-900">üîÑ Replace (Reset & Import Fresh)</span>
                        <p className="text-xs text-orange-700 mt-1">
                          <strong>‚ö†Ô∏è Destructive:</strong> Clears entire database and imports selected products as new dataset
                        </p>
                      </Label>
                    </div>
                    <div className="flex items-start space-x-3 border border-blue-200 rounded-lg p-3 bg-blue-50">
                      <input
                        id="mode-merge"
                        className="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500"
                        type="radio"
                        name="import-mode"
                        checked={importMode === 'merge'}
                        onChange={() => setImportMode('merge')}
                      />
                      <Label htmlFor="mode-merge" className="cursor-pointer flex-1">
                        <span className="font-medium text-blue-900">
                          üîÄ Merge (Add + Update){' '}
                          <span className="text-xs bg-blue-200 px-2 py-0.5 rounded">Recommended</span>
                        </span>
                        <p className="text-xs text-blue-700 mt-1">
                          Updates existing products with latest data + adds new products that don&apos;t exist yet
                        </p>
                      </Label>
                    </div>
                    <div className="flex items-start space-x-3 border border-gray-200 rounded-lg p-3">
                      <input
                        id="mode-add"
                        className="mt-1 h-4 w-4 text-gray-600 focus:ring-gray-500"
                        type="radio"
                        name="import-mode"
                        checked={importMode === 'add'}
                        onChange={() => setImportMode('add')}
                      />
                      <Label htmlFor="mode-add" className="cursor-pointer flex-1">
                        <span className="font-medium">‚ûï Add Only (Preserve Existing)</span>
                        <p className="text-xs text-gray-600 mt-1">
                          Only adds products that don&apos;t exist yet (skips all existing products)
                        </p>
                      </Label>
                    </div>
                  </div>
                </div>

                <div className="mt-4 flex justify-end items-center">
                  <Button
                    onClick={handleImportDetails}
                    disabled={isLoadingAllProducts}
                    size="lg"
                  >
                    {isLoadingAllProducts ? (
                      <>
                        <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                        <div className="flex flex-col items-start">
                          <span className="font-medium">Fetching All Products...</span>
                          <span className="text-xs text-blue-200">
                            Loading {totalCount.toLocaleString()} products
                          </span>
                        </div>
                      </>
                    ) : (
                      <>
                        {totalCount > products.length
                          ? `Import All ${totalCount.toLocaleString()} Products`
                          : `Import ${products.length} Products`}
                        <ArrowRight className="ml-2 h-5 w-5" />
                      </>
                    )}
                  </Button>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* STEP 2: Import HTML Details */}
      {currentStep === 'import' && (
        <Card>
          <CardHeader>
            <CardTitle>Step 2: Importing Product Details</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <div>
              <div className="flex justify-between text-sm mb-2">
                <span>Progress</span>
                <span>{importProgress.downloaded} / {importProgress.total}</span>
              </div>
              <Progress
                value={(importProgress.downloaded / importProgress.total) * 100}
                className="h-3"
              />
            </div>

            {importProgress.current && (
              <div className="bg-blue-50 p-4 rounded-lg">
                <div className="flex items-center">
                  <Loader2 className="h-5 w-5 animate-spin text-blue-600 mr-3" />
                  <div>
                    <p className="font-medium">Currently Processing</p>
                    <p className="text-sm text-gray-600">{importProgress.current}</p>
                  </div>
                </div>
              </div>
            )}

            <div className="grid grid-cols-3 gap-4">
              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <CheckCircle2 className="h-8 w-8 text-green-600 mx-auto mb-2" />
                    <p className="text-2xl font-bold">{importProgress.downloaded}</p>
                    <p className="text-sm text-gray-600">Downloaded</p>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <AlertCircle className="h-8 w-8 text-red-600 mx-auto mb-2" />
                    <p className="text-2xl font-bold">{importProgress.failed}</p>
                    <p className="text-sm text-gray-600">Failed</p>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <Loader2 className="h-8 w-8 text-gray-400 mx-auto mb-2" />
                    <p className="text-2xl font-bold">{importProgress.total - importProgress.downloaded}</p>
                    <p className="text-sm text-gray-600">Remaining</p>
                  </div>
                </CardContent>
              </Card>
            </div>

            {importProgress.errors.length > 0 && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  <p className="font-medium mb-2">Errors occurred during import:</p>
                  <ul className="list-disc list-inside text-sm space-y-1">
                    {importProgress.errors.slice(0, ZEREZ_IMPORT_LIMITS.MAX_DISPLAYED_ERRORS).map((error, i) => (
                      <li key={i}>{error}</li>
                    ))}
                  </ul>
                  {importProgress.errors.length > ZEREZ_IMPORT_LIMITS.MAX_DISPLAYED_ERRORS && (
                    <p className="text-sm mt-2">... and {importProgress.errors.length - ZEREZ_IMPORT_LIMITS.MAX_DISPLAYED_ERRORS} more errors</p>
                  )}
                </AlertDescription>
              </Alert>
            )}

            {/* Import Complete - Show Success and Next Step Button */}
            {importComplete && importedJsonFile && (
              <div className="mt-6 space-y-4">
                <Alert className="bg-green-50 border-green-200">
                  <CheckCircle2 className="h-5 w-5 text-green-600" />
                  <AlertDescription className="text-green-900">
                    <p className="font-semibold text-lg mb-2">‚úÖ Import Complete!</p>
                    <p className="text-sm">
                      Successfully imported <strong>{importProgress.saved_files} products</strong> to:
                    </p>
                    <p className="text-sm font-mono mt-1 bg-white p-2 rounded border border-green-300">
                      {importedJsonFile}
                    </p>
                  </AlertDescription>
                </Alert>

                <div className="flex gap-3">
                  <Button
                    size="lg"
                    onClick={handleProceedToMatching}
                    className="flex-1"
                  >
                    Continue to PDF Matching
                    <ArrowRight className="ml-2 h-5 w-5" />
                  </Button>

                  <Button
                    size="lg"
                    variant="outline"
                    onClick={() => {
                      // Download the JSON file
                      const dataStr = JSON.stringify(products, null, 2);
                      const dataBlob = new Blob([dataStr], { type: 'application/json' });
                      const url = URL.createObjectURL(dataBlob);
                      const link = document.createElement('a');
                      link.href = url;
                      link.download = importedJsonFile;
                      link.click();
                      URL.revokeObjectURL(url);
                    }}
                  >
                    <Download className="mr-2 h-4 w-4" />
                    Download JSON
                  </Button>

                  <Button
                    size="lg"
                    variant="outline"
                    onClick={handleStartOver}
                  >
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Start Over
                  </Button>
                </div>
              </div>
            )}

            {/* Cancel Button - Show during import only */}
            {!importComplete && importProgress.total > 0 && (
              <div className="mt-6 flex justify-center">
                <Button
                  size="lg"
                  variant="destructive"
                  onClick={handleCancelImport}
                  disabled={!importAbortControllerRef.current}
                >
                  <AlertCircle className="mr-2 h-5 w-5" />
                  Cancel Import
                </Button>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* STEP 3: Sync Database with PDF Files */}
      {currentStep === 'match' && (
        <Card>
          <CardHeader>
            <CardTitle>Step 3: Sync Database with PDF Files</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {isMatching ? (
              <div className="text-center py-12 space-y-6">
                <div>
                  <Loader2 className="h-12 w-12 animate-spin text-blue-600 mx-auto mb-4" />
                  <p className="text-lg font-medium">Syncing database with PDF datasheets...</p>
                  <p className="text-sm text-gray-600 mt-2">Scanning PDF files and matching with products</p>
                </div>

                {/* Cancel Button */}
                <Button
                  size="lg"
                  variant="destructive"
                  onClick={handleCancelSync}
                  disabled={!syncAbortControllerRef.current}
                >
                  <AlertCircle className="mr-2 h-5 w-5" />
                  Cancel PDF Sync
                </Button>
              </div>
            ) : syncResult ? (
              <>
                <Alert className="bg-green-50 border-green-200">
                  <CheckCircle2 className="h-5 w-5 text-green-600" />
                  <AlertDescription className="text-green-900">
                    <p className="font-semibold text-lg mb-2">‚úÖ PDF Sync Complete!</p>
                    <p className="text-sm">
                      Scanned <strong>{syncResult.pdfFilesScanned} PDF files</strong> and enriched <strong>{syncResult.enriched} products</strong> in the database.
                    </p>
                  </AlertDescription>
                </Alert>

                <div className="grid grid-cols-3 gap-4">
                  <Card className="bg-green-50">
                    <CardContent className="pt-6">
                      <div className="text-center">
                        <CheckCircle2 className="h-8 w-8 text-green-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">{syncResult.enriched}</p>
                        <p className="text-sm text-gray-600">PDF Enriched</p>
                        <p className="text-xs text-gray-500 mt-1">
                          {((syncResult.enriched / syncResult.total) * 100).toFixed(1)}% of database
                        </p>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="bg-yellow-50">
                    <CardContent className="pt-6">
                      <div className="text-center">
                        <AlertCircle className="h-8 w-8 text-yellow-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">{syncResult.skipped}</p>
                        <p className="text-sm text-gray-600">No Match Found</p>
                        <p className="text-xs text-gray-500 mt-1">Below {syncResult.minConfidenceUsed}% confidence</p>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="bg-blue-50">
                    <CardContent className="pt-6">
                      <div className="text-center">
                        <FileText className="h-8 w-8 text-blue-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">{syncResult.total}</p>
                        <p className="text-sm text-gray-600">Total Products</p>
                        <p className="text-xs text-gray-500 mt-1">In database</p>
                      </div>
                    </CardContent>
                  </Card>
                </div>

                <div className="border rounded-lg overflow-hidden">
                  <div className="max-h-96 overflow-y-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 sticky top-0">
                        <tr>
                          <th className="px-4 py-2 text-left">Product Model</th>
                          <th className="px-4 py-2 text-left">PDF Match</th>
                          <th className="px-4 py-2 text-left">Confidence</th>
                          <th className="px-4 py-2 text-left">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {syncResult.matches.map((result, i) => (
                          <tr key={i} className="border-t hover:bg-gray-50">
                            <td className="px-4 py-2 font-medium">{result.productModel}</td>
                            <td className="px-4 py-2 text-sm text-gray-600">
                              {result.pdfFilename || '-'}
                            </td>
                            <td className="px-4 py-2">
                              {result.pdfPath && (
                                <div className="flex items-center">
                                  <div className="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                    <div
                                      className="bg-green-600 h-2 rounded-full"
                                      style={{ width: `${result.matchConfidence}%` }}
                                    />
                                  </div>
                                  <span className="text-sm">{result.matchConfidence}%</span>
                                </div>
                              )}
                            </td>
                            <td className="px-4 py-2">
                              {result.pdfPath ? (
                                <CheckCircle2 className="h-5 w-5 text-green-600" />
                              ) : (
                                <AlertCircle className="h-5 w-5 text-yellow-600" />
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                <div className="flex space-x-2">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setCurrentStep('filter');
                      setProducts([]);
                      setSyncResult(null);
                      setImportComplete(false);
                      setImportedJsonFile(null);
                    }}
                    className="flex-1"
                  >
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Start New Import
                  </Button>
                  <Button
                    onClick={() => {
                      // Navigate back to dashboard
                      window.location.href = '/dashboard';
                    }}
                    className="flex-1"
                  >
                    <CheckCircle2 className="mr-2 h-4 w-4" />
                    Back to Dashboard
                  </Button>
                </div>
              </>
            ) : (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  No sync results available. Please try again.
                </AlertDescription>
              </Alert>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  );
}
