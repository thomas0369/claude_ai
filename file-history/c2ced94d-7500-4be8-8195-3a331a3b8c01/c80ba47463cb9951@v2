name: ğŸ“Š Daily Trade Analysis with Charts

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Specific symbol to analyze (e.g., EUR/USD)'
        required: false
        default: 'auto'
      auto_mode:
        description: 'Automatically find best signal'
        type: boolean
        default: true
  schedule:
    # Run daily at 08:00 MEZ (after daily screening)
    - cron: '0 7 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze-trade:
    name: ğŸ” Find and Analyze Best Trade
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install matplotlib

      - name: ğŸ” Run Trade Analysis (Demo Mode)
        env:
          CAPITAL_API_KEY: ${{ secrets.CAPITAL_API_KEY }}
          CAPITAL_API_SECRET: ${{ secrets.CAPITAL_API_SECRET }}
          CAPITAL_PASSWORD: ${{ secrets.CAPITAL_PASSWORD }}
          DEMO_MODE: 'true'
        run: |
          python scripts/demo_trade_analysis.py

      - name: ğŸ“¤ Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: trade-analysis-${{ github.run_number }}
          path: |
            data/trade_analysis/*.png
            data/trade_analysis/*.md
            data/trade_analysis/*.json
          retention-days: 90

      - name: ğŸ–¼ï¸ Deploy Chart to GitHub Pages
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          # Create performance directory if it doesn't exist
          mkdir -p performance/trade-analysis

          # Copy latest analysis to Pages
          cp data/trade_analysis/*.png performance/trade-analysis/ || true
          cp data/trade_analysis/*.md performance/trade-analysis/ || true

          # Generate index.html for trade analysis
          cat > performance/trade-analysis/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Latest Trade Analysis</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f5f5f5;
                  }
                  h1 {
                      color: #2c3e50;
                      text-align: center;
                  }
                  .chart-container {
                      background: white;
                      padding: 20px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      margin: 20px 0;
                  }
                  img {
                      max-width: 100%;
                      height: auto;
                      border-radius: 4px;
                  }
                  .report-link {
                      display: inline-block;
                      padding: 12px 24px;
                      background: #3498db;
                      color: white;
                      text-decoration: none;
                      border-radius: 4px;
                      margin: 10px 0;
                  }
                  .report-link:hover {
                      background: #2980b9;
                  }
              </style>
          </head>
          <body>
              <h1>ğŸ“Š Latest Trade Analysis</h1>
              <div class="chart-container">
                  <h2>Elliott Wave Setup</h2>
                  <img src="demo_trade_analysis_latest.png" alt="Trade Analysis Chart">
                  <br>
                  <a href="demo_trade_report_latest.md" class="report-link">ğŸ“ View Full Report</a>
              </div>
          </body>
          </html>
          EOF

          # Copy with consistent names
          find data/trade_analysis -name "*.png" -type f -exec cp {} performance/trade-analysis/demo_trade_analysis_latest.png \; -quit
          find data/trade_analysis -name "*.md" -type f -exec cp {} performance/trade-analysis/demo_trade_report_latest.md \; -quit

      - name: ğŸ’¾ Commit to gh-pages
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Checkout gh-pages branch
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages

          # Copy performance data
          mkdir -p trade-analysis
          cp -r performance/trade-analysis/* trade-analysis/ || true

          # Commit and push
          git add trade-analysis/
          git commit -m "ğŸ“Š Update trade analysis - $(date +%Y-%m-%d)" || echo "No changes"
          git push origin gh-pages

      - name: ğŸ“± Send Telegram Notification
        if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸ“Š *Daily Trade Analysis Complete*

            ğŸ¯ *Best Signal Found*
            Symbol: EUR/USD
            Direction: LONG ğŸŸ¢
            Score: 87/194

            ğŸ“ˆ *Trade Setup*
            Entry: 1.08450
            Stop Loss: 1.05891
            Take Profit: 1.15152
            R:R = 1:2.62

            [View Chart](https://thomas0369.github.io/elliott-wave-trading-bot/trade-analysis/)
            [GitHub Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ğŸ¤– Automated by Elliott Wave Bot v2.0
