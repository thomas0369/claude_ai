"""
Data Provider wrapper for Capital.com API
Compatible with DataCacheManager interface
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

import pandas as pd
from typing import Optional
import logging
from capital_api import get_api

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class CapitalDataProvider:
    """
    Data provider wrapping Capital.com API for cache manager compatibility
    """

    def __init__(self, demo_mode: bool = True):
        """
        Initialize data provider

        Args:
            demo_mode: Use demo account (True) or live account (False)
        """
        self.api = get_api(demo_mode=demo_mode)
        logger.info(f"CapitalDataProvider initialized (demo: {demo_mode})")

    def fetch_ohlcv(
        self,
        symbol: str,
        timeframe: str = '1h',
        limit: int = 200
    ) -> Optional[pd.DataFrame]:
        """
        Fetch OHLCV data for symbol

        Args:
            symbol: Trading pair (e.g., 'EUR/USD', 'BTC/USD')
            timeframe: Timeframe (e.g., '1h', '30min', '15m', '4h', '1d')
            limit: Number of bars to fetch

        Returns:
            DataFrame with columns: timestamp (index), open, high, low, close, volume
            Or None if failed
        """
        try:
            # Convert timeframe format if needed (30min -> 30m for CCXT)
            tf_map = {
                '30min': '30m',
                '45min': '45m',
                '1h': '1h',
                '4h': '4h',
                '1d': '1d'
            }
            ccxt_timeframe = tf_map.get(timeframe, timeframe)

            # Fetch data from API
            ohlcv_data = self.api.get_ohlcv(symbol, ccxt_timeframe, limit)

            if ohlcv_data is None or len(ohlcv_data) == 0:
                logger.warning(f"No data received for {symbol} {timeframe}")
                return None

            # Convert to DataFrame
            # OHLCV format: [[timestamp_ms, open, high, low, close, volume], ...]
            df = pd.DataFrame(
                ohlcv_data,
                columns=['timestamp', 'open', 'high', 'low', 'close', 'volume']
            )

            # Convert timestamp from milliseconds to datetime
            df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
            df.set_index('timestamp', inplace=True)

            logger.debug(f"Fetched {len(df)} bars for {symbol} {timeframe}")
            return df

        except Exception as e:
            logger.error(f"Error fetching data for {symbol}: {e}")
            return None
