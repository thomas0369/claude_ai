#!/usr/bin/env python3
"""
Market Data Cache Update Script

Run this script periodically (e.g., hourly via cron) to keep cache updated:
  0 * * * * cd /path/to/project && python scripts/update_market_data_cache.py

Or run manually:
  python scripts/update_market_data_cache.py
  python scripts/update_market_data_cache.py --full-refresh  # Force 2-year update
  python scripts/update_market_data_cache.py --stats        # View cache statistics
"""

import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

import argparse
from data_cache_manager import DataCacheManager
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


def main():
    parser = argparse.ArgumentParser(
        description='Update market data cache',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__
    )
    parser.add_argument(
        '--full-refresh',
        action='store_true',
        help='Force full 2-year refresh for all symbols'
    )
    parser.add_argument(
        '--symbol',
        help='Update only specific symbol (e.g., EUR/USD)'
    )
    parser.add_argument(
        '--stats',
        action='store_true',
        help='Show cache statistics and exit'
    )
    parser.add_argument(
        '--demo',
        action='store_true',
        help='Use demo data (for testing without API)'
    )

    args = parser.parse_args()

    manager = DataCacheManager()

    # Show stats if requested
    if args.stats:
        stats = manager.get_cache_stats()
        print(f"\n{'='*70}")
        print(f"ðŸ“Š MARKET DATA CACHE STATISTICS")
        print(f"{'='*70}")
        print(f"Total symbols cached: {stats['total_symbols']}")
        print(f"\nDetails:")
        print(f"{'Symbol':<12} {'Bars':>7} {'Last Update':<20} {'Age (h)':>8} {'Status':<15}")
        print(f"{'-'*70}")

        for symbol, info in sorted(stats['symbols'].items()):
            status = 'ðŸ”´ NEEDS UPDATE' if info['needs_update'] else 'ðŸŸ¢ CURRENT'
            print(f"{symbol:<12} {info['bars']:>7} {info['last_update'][:19]:<20} {info['age_hours']:>8.1f} {status:<15}")

        print(f"{'='*70}\n")
        return

    # Initialize data provider
    if args.demo:
        logger.info("ðŸŽ® Using DEMO data provider (no real API calls)")
        from multi_strategy_screener import MultiStrategyScreener

        screener = MultiStrategyScreener(use_demo_data=True)

        class DemoProvider:
            """Wrapper to make screener compatible with cache manager"""
            def __init__(self, screener):
                self.screener = screener

            def fetch_ohlcv(self, symbol, timeframe, bars):
                return self.screener.fetch_data(symbol, timeframe, bars)

        provider = DemoProvider(screener)
        symbols = [args.symbol] if args.symbol else screener.DEFAULT_ASSETS

    else:
        logger.info("ðŸŒ Using REAL data provider (Capital.com API)")
        try:
            from capital_data_provider import CapitalDataProvider
            provider = CapitalDataProvider()
        except Exception as e:
            logger.error(f"Failed to initialize data provider: {e}")
            logger.error("Try running with --demo flag for testing")
            return 1

        # Default symbols
        symbols = [args.symbol] if args.symbol else [
            'EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CHF',
            'XAU/USD', 'XAG/USD', 'USOIL', 'UKOIL',
            'US500', 'NAS100', 'GER40',
            'BTC/USD', 'ETH/USD'
        ]

    # Update cache
    logger.info(f"\n{'='*70}")
    logger.info(f"ðŸ”„ STARTING CACHE UPDATE")
    logger.info(f"{'='*70}")
    logger.info(f"Mode: {'FULL REFRESH' if args.full_refresh else 'INCREMENTAL'}")
    logger.info(f"Symbols: {len(symbols)}")
    logger.info(f"Provider: {'Demo' if args.demo else 'Capital.com'}")
    logger.info(f"{'='*70}\n")

    results = manager.update_all_symbols(symbols, provider, args.full_refresh)

    # Print final summary
    successful = sum(1 for v in results.values() if v)
    failed = len(results) - successful

    print(f"\n{'='*70}")
    print(f"âœ… CACHE UPDATE COMPLETE")
    print(f"{'='*70}")
    print(f"Successful: {successful}/{len(results)}")
    if failed > 0:
        print(f"Failed: {failed}")
        failed_symbols = [s for s, v in results.items() if not v]
        print(f"Failed symbols: {', '.join(failed_symbols)}")
    print(f"{'='*70}\n")

    return 0 if failed == 0 else 1


if __name__ == '__main__':
    sys.exit(main())
