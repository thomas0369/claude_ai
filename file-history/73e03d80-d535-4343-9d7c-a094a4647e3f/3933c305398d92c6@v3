/**
 * Konva Game Integration Test
 *
 * Verify the Konva game loads and initializes correctly on the play page
 */

import { test, expect } from '@playwright/test';

test('Konva game loads and initializes on play page', async ({ page }) => {
  const consoleLogs: string[] = [];
  const errors: string[] = [];

  // Capture console logs
  page.on('console', msg => {
    const text = msg.text();
    console.log(`BROWSER: ${text}`);
    consoleLogs.push(text);
  });

  // Capture errors
  page.on('pageerror', exception => {
    console.log(`âŒ PAGE ERROR: ${exception.toString()}`);
    errors.push(exception.toString());
  });

  console.log('\n=== Loading Level 1 ===');
  await page.goto('http://localhost:3000/play/1');
  await page.waitForLoadState('networkidle');

  // Wait for game to initialize
  await page.waitForTimeout(5000);

  console.log('\n=== Taking Screenshot ===');
  await page.screenshot({ path: 'konva-game-level-1.png', fullPage: true });

  console.log('\n=== Summary ===');
  console.log(`Console Logs: ${consoleLogs.length}`);
  console.log(`Errors: ${errors.length}`);

  if (errors.length > 0) {
    console.log('\nâŒ Errors found:');
    errors.forEach(err => console.log(`  - ${err}`));
  }

  const spawnLogs = consoleLogs.filter(log => log.includes('spawned') || log.includes('Drag'));
  if (spawnLogs.length > 0) {
    console.log('\nâœ… Game activity detected:');
    spawnLogs.slice(0, 5).forEach(log => console.log(`  ${log}`));
  }

  // Verify no critical errors
  expect(errors.length).toBe(0);

  console.log('\nâœ… Konva game loaded successfully!');
  console.log('ðŸ“¸ Screenshot saved to konva-game-level-1.png');
});
