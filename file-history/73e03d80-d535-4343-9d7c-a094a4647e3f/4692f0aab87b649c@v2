# Implementation Plan: Drag and Drop System Comprehensive Study and Rebuild

**Branch**: `001-game-app-monetization` | **Date**: 2025-11-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-game-app-monetization/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This plan focuses on a comprehensive study and potential rebuild of the Phaser.js drag and drop system to ensure pixel-perfect control and reliability. The current implementation has been extensively debugged and is working, but the user wants to understand the system from the ground up to ensure it can be controlled at every pixel. This involves documenting Phaser's input system architecture, hit area mechanics, Container interaction quirks, event flow, object pooling impact on interaction state, and creating testing methodologies for drag behavior validation.

## Technical Context

**Language/Version**: TypeScript 5.6.3 (strict mode)
**Primary Dependencies**:
- Phaser 3.87.0 (game engine, input system, drag and drop)
- Next.js 14.2.15 (web framework)
- React 18.3.1 (UI layer)
- Playwright 1.48.2 (E2E testing)
- Jest 29.7.0 (unit testing)
- Zustand 4.5.5 (state management)

**Storage**:
- PostgreSQL (via Prisma ORM for user data)
- Redis (for session/cache)
- Browser localStorage (offline PWA support)

**Testing**:
- Playwright (E2E drag and drop simulation)
- Jest + React Testing Library (component/unit tests)
- Lighthouse CI (performance validation)
- ESLint + Prettier (code quality)

**Target Platform**: Web-first (desktop + mobile responsive), Progressive Web App (PWA)

**Project Type**: Web application with game engine integration (Next.js + Phaser.js)

**Performance Goals**:
- 60 FPS gameplay (non-negotiable per constitution)
- <100ms interaction-to-paint
- <5s initial load (p95)
- <2s returning user load

**Constraints**:
- Solo developer with AI assistant
- Bootstrap/self-funded (minimize paid services)
- Must support offline gameplay (PWA)
- Mobile-first responsive design
- Cross-device progress sync

**Scale/Scope**:
- 50 game levels
- Target: 1000 concurrent users
- 100 trial users in month 1
- 15% trial-to-premium conversion

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Documentation = First-Class Citizen
**Status**: ✅ PASS

This plan itself embodies this principle - we're creating comprehensive documentation of the drag and drop system before making any changes. The research.md will follow Problem → Alternatives → Decision format for any modifications.

**Evidence**: Existing documentation (HIT_AREA_BUG_ANALYSIS.md, BUG_FIX_SUMMARY.md, DRAG_DROP_INVESTIGATION.md) demonstrates commitment to this principle. This study will add to this knowledge base.

### Principle II: Performance = Feature (Non-Negotiable)
**Status**: ✅ PASS

The drag system already meets performance requirements:
- 60 FPS maintained during gameplay
- <100ms interaction response time
- Lighthouse CI enforces performance metrics

**Evidence**: Constitution mandates 60 FPS, and current implementation maintains this. Any rebuild MUST preserve performance metrics, with automated testing via Lighthouse CI.

### Principle III: Clean Code = Testable Code
**Status**: ✅ PASS

Current implementation:
- TypeScript strict mode ✅
- Comprehensive E2E tests (Playwright) ✅
- ESLint + Prettier enforced in CI ✅
- Test coverage exists for drag scenarios ✅

**Action**: Study will document how to maintain testability in any rebuild.

### Principle IV: Vendor Lock-In Only With Exit Strategy
**Status**: ✅ PASS

Phaser.js is MIT licensed with documented migration path:
- **Current**: Phaser 3.87.0 (MIT license)
- **Exit Strategy**: Canvas API directly, or alternative game engines (PixiJS, BabylonJS)
- **Mitigation**: Game logic separated from rendering (can extract to pure TypeScript)

**Evidence**: Phaser is open-source with permissive licensing. No platform lock-in.

### Principle V: Platform Independence > Instant Traffic
**Status**: ✅ PASS

Web-based game engine ensures platform independence:
- Works on any modern browser
- No app store requirements
- PWA enables offline play
- Cross-device compatibility

**Evidence**: Next.js + Phaser runs on desktop, mobile, tablet without platform-specific code.

### Principle VI: User Feedback < 5 Seconds
**Status**: ✅ PASS

Drag and drop provides immediate feedback:
- Visual scale change on dragstart
- Real-time placement validation overlay
- Snap-back animation on invalid drop
- All interactions <100ms response

**Evidence**: Current implementation uses optimistic UI with instant visual feedback.

### Principle VII: Fail Fast, Pivot Smart
**Status**: ✅ PASS

This study embodies this principle:
- Research phase BEFORE any rebuild
- Identify blockers upfront
- Document current working system before changes
- ROI analysis: "Is rebuild needed or just better documentation?"

**Decision Point**: Research may reveal rebuild is unnecessary - just improved documentation and testing.

**Gate Result**: ✅ ALL GATES PASS - Proceed to Phase 0 Research

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
lib/
├── game/
│   ├── phaser/
│   │   ├── entities/
│   │   │   └── Block.ts              # Main drag and drop implementation (Lines 190-513)
│   │   ├── pools/
│   │   │   └── BlockPool.ts          # Object pooling with activation order (Lines 34-107)
│   │   ├── scenes/
│   │   │   └── MainScene.ts          # Scene setup, placement validation (Lines 52-278)
│   │   ├── mechanics/
│   │   │   └── line-clearing.ts      # Game mechanics
│   │   ├── utils/
│   │   │   ├── gameDebugHelper.ts    # Debug utilities (window.gameDebug)
│   │   │   └── autonomousControl.ts  # Test automation (window.autonomousControl)
│   │   └── config.ts                 # Game configuration (cellSize, offsets)
│   ├── scoring.ts                    # Score calculation
│   └── tierAccess.ts                 # Free/Trial/Premium logic
│
├── storage/
│   ├── postgres/
│   │   └── client.ts                 # Prisma client
│   └── redis/
│       └── client.ts                 # Redis client
│
└── utils/
    ├── error-handling.ts
    └── validation.ts

app/                                   # Next.js 14 App Router
├── (auth)/                           # Auth routes
├── (game)/                           # Game routes
├── api/                              # API routes
└── layout.tsx

components/
├── ui/                               # Reusable UI components
├── game/                             # Game-specific React components
└── providers/                        # Context providers

stores/
├── authStore.ts                      # Zustand auth state
└── uiStore.ts                        # Zustand UI state

tests/
├── e2e/                              # Playwright E2E tests
│   ├── verify-fix.spec.ts           # Respawn drag verification
│   ├── hit-area-measurement.spec.ts # Hit area coverage validation
│   ├── complete-game-playthrough.spec.ts # Full game workflow
│   └── [20+ other drag/drop test files]
└── unit/                             # Jest unit tests

prisma/
├── schema.prisma                     # Database schema
└── migrations/                       # Database migrations
```

**Structure Decision**:

This is a **Next.js web application with Phaser game engine integration**. The structure separates concerns:

1. **lib/game/phaser/** - Pure Phaser game logic (TypeScript, no React)
   - Entities (Block with drag and drop)
   - Pooling (BlockPool for object reuse)
   - Scenes (MainScene for game loop)
   - Utilities (debug helpers, autonomous testing)

2. **app/** - Next.js 14 App Router for UI shell and routing

3. **components/** - React components for non-game UI

4. **stores/** - Zustand state management for app-level state (separate from Phaser game state)

5. **tests/** - Comprehensive E2E (Playwright) and unit (Jest) tests

The Phaser game runs in a React component but maintains separation of concerns - game logic is pure TypeScript/Phaser, not coupled to React lifecycle.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**Status**: No constitution violations detected. This section is intentionally left empty.

