/**
 * Test Drag and Drop with Full Console Logging
 */

import { test } from '@playwright/test';

test('perform drag and drop with debug logging', async ({ page }) => {
  const consoleLogs: string[] = [];

  // Capture ALL console output
  page.on('console', msg => {
    const text = msg.text();
    console.log(`BROWSER: ${text}`);
    consoleLogs.push(text);
  });

  await page.goto('http://localhost:3001/demo');
  await page.waitForLoadState('networkidle');

  const canvas = await page.locator('canvas').first();
  await canvas.waitFor({ timeout: 15000 });

  // Wait for game initialization
  await page.waitForTimeout(3000);

  const canvasBounds = await canvas.boundingBox();
  if (!canvasBounds) {
    throw new Error('Canvas not found');
  }

  console.log('\n=== CANVAS BOUNDS ===');
  console.log(JSON.stringify(canvasBounds, null, 2));

  // First block position (leftmost block at bottom)
  const blockX = canvasBounds.x + 280;
  const blockY = canvasBounds.y + 500;

  // Grid center position (row 4, col 4)
  const gridX = canvasBounds.x + 100 + (4 * 50) + 25;
  const gridY = canvasBounds.y + 50 + (4 * 50) + 25;

  console.log('\n=== DRAG COORDINATES ===');
  console.log(`Block start: (${blockX}, ${blockY})`);
  console.log(`Grid target: (${gridX}, ${gridY})`);

  // Take before screenshot
  await page.screenshot({ path: 'drag-test-before.png', fullPage: true });

  console.log('\n=== STARTING DRAG ===');

  await page.mouse.move(blockX, blockY);
  await page.waitForTimeout(500);

  await page.mouse.down();
  await page.waitForTimeout(300);

  console.log('=== DRAGGING TO GRID ===');
  await page.mouse.move(gridX, gridY, { steps: 20 });
  await page.waitForTimeout(500);

  // Take during screenshot
  await page.screenshot({ path: 'drag-test-during.png', fullPage: true });

  console.log('=== DROPPING BLOCK ===');
  await page.mouse.up();
  await page.waitForTimeout(2000);

  // Take after screenshot
  await page.screenshot({ path: 'drag-test-after.png', fullPage: true });

  console.log('\n=== RELEVANT CONSOLE LOGS ===');
  const relevantLogs = consoleLogs.filter(log =>
    log.includes('ðŸŽ¯') ||
    log.includes('ðŸŽ¨') ||
    log.includes('ðŸ–Œï¸') ||
    log.includes('ðŸ“Š') ||
    log.includes('ðŸ“¥') ||
    log.includes('âœ…') ||
    log.includes('âŒ')
  );

  relevantLogs.forEach(log => console.log(log));

  console.log('\n=== SCREENSHOTS SAVED ===');
  console.log('- drag-test-before.png');
  console.log('- drag-test-during.png');
  console.log('- drag-test-after.png');
});
