/**
 * Edit Permissions Guard System
 *
 * CRITICAL SECURITY RULES:
 * 1. ONLY PDF-imported data can be edited in the dashboard table
 * 2. ZEREZ GraphQL imported data is READ-ONLY in the dashboard table
 * 3. ZEREZ data can ONLY be replaced or deleted via ZEREZ Importer (/import/zerez)
 *
 * This ensures ZEREZ data integrity and prevents accidental modification
 * of certified official data from the ZEREZ database.
 *
 * To modify ZEREZ data, users must:
 * - Go to /import/zerez
 * - Use "Replace" mode to overwrite all ZEREZ data
 * - Use "Merge" mode to update existing + add new
 * - Never use dashboard table editing
 */

import type { EnhancedProductData } from './types-enhanced';

/**
 * Data source types for permission checking
 */
export type DataSource = 'pdf' | 'zerez' | 'manual' | 'unknown';

/**
 * Determine data source from extraction_method field
 */
export function getDataSource(product: EnhancedProductData): DataSource {
  const method = product.data_source.extraction_method;

  // ZEREZ GraphQL import
  if (method === 'graphql_import') {
    return 'zerez';
  }

  // PDF extraction methods
  if (['pdfplumber', 'camelot', 'text', 'gemini_vision', 'claude_vision'].includes(method)) {
    return 'pdf';
  }

  // Manual entry
  if (method === 'manual') {
    return 'manual';
  }

  return 'unknown';
}

/**
 * Check if a product can be edited
 *
 * @returns true if product is from PDF (editable), false if from ZEREZ (read-only)
 */
export function canEditProduct(product: EnhancedProductData): boolean {
  const source = getDataSource(product);

  // ONLY PDF and manual data can be edited
  return source === 'pdf' || source === 'manual';
}

/**
 * Check if a specific field can be edited
 *
 * Even for PDF products, some fields are always read-only:
 * - Data source metadata
 * - Calculated fields (power_density, power_to_weight, etc.)
 * - Benchmarks and competitive intelligence (auto-generated)
 */
export function canEditField(product: EnhancedProductData, fieldPath: string): boolean {
  // First check if product itself is editable
  if (!canEditProduct(product)) {
    return false;
  }

  // Always read-only fields (even for PDF products)
  const readOnlyFields = [
    // Data source metadata
    'data_source.extraction_method',
    'data_source.parsed_at',
    'data_source.last_updated',
    'data_source.source',

    // Auto-calculated fields
    'volume_m3',
    'power_to_weight',
    'power_density',
    'efficiency_percentile',

    // Auto-generated competitive intelligence
    'benchmarks',
    'competitive',
    'insights',
    'certification_timeline',
    'market',

    // ZEREZ metadata (from certification)
    'identification.zerez_id',
    'identification.zerez_variant_count',
    'certifications.zerez_certifications',
  ];

  // Check if field is in read-only list
  return !readOnlyFields.some(field => fieldPath.startsWith(field));
}

/**
 * Get reason why a product cannot be edited
 * Used for showing user-friendly error messages
 */
export function getEditRestrictionReason(product: EnhancedProductData): string | null {
  const source = getDataSource(product);

  if (source === 'zerez') {
    return 'This product was imported from ZEREZ GraphQL database and cannot be edited to preserve data integrity. ZEREZ data is official certification data. To modify ZEREZ data, use the ZEREZ Importer at /import/zerez with "Replace" or "Merge" mode.';
  }

  if (source === 'unknown') {
    return 'Cannot determine data source. Editing disabled for safety.';
  }

  return null; // Can edit
}

/**
 * Get reason why a specific field cannot be edited
 */
export function getFieldRestrictionReason(product: EnhancedProductData, fieldPath: string): string | null {
  // Check product-level restriction first
  const productReason = getEditRestrictionReason(product);
  if (productReason) {
    return productReason;
  }

  // Check field-level restrictions
  if (fieldPath.startsWith('data_source')) {
    return 'Data source metadata cannot be edited. This field tracks data provenance.';
  }

  if (['volume_m3', 'power_to_weight', 'power_density', 'efficiency_percentile'].some(f => fieldPath.includes(f))) {
    return 'This is an auto-calculated field. Edit the source values (power, weight, dimensions) instead.';
  }

  if (fieldPath.startsWith('benchmarks') || fieldPath.startsWith('competitive') || fieldPath.startsWith('insights')) {
    return 'This field is auto-generated by AI. It will update automatically when you edit the source data.';
  }

  if (fieldPath.includes('zerez_id') || fieldPath.includes('zerez_variant') || fieldPath.startsWith('certifications.zerez')) {
    return 'ZEREZ certification metadata cannot be edited. This is official certification data.';
  }

  return null; // Can edit
}

/**
 * Get list of editable fields for a product
 * Returns field paths that can be edited
 */
export function getEditableFields(product: EnhancedProductData): string[] {
  if (!canEditProduct(product)) {
    return [];
  }

  // PDF products can edit these fields
  return [
    // Identification (except ZEREZ IDs)
    'identification.model',
    'identification.manufacturer',
    'identification.product_family',
    'identification.generation',

    // Technical specs
    'power.rated_power_kw',
    'power.max_power_kw',
    'power.standby_power_w',
    'power.power_factor',

    // Efficiency
    'efficiency.peak_percent',
    'efficiency.euro_percent',
    'efficiency.cec_percent',
    'efficiency.weighted_efficiency',

    // Physical
    'physical.weight_kg',
    'physical.width_mm',
    'physical.height_mm',
    'physical.depth_mm',
    'physical.volume_l',
    'physical.ip_rating',
    'physical.cooling',
    'physical.mounting_type',

    // Electrical
    'electrical.max_dc_voltage_v',
    'electrical.min_dc_voltage_v',
    'electrical.mppt_count',
    'electrical.max_input_current_a',
    'electrical.thd_percent',
    'electrical.output_voltage_range',
    'electrical.frequency_hz',

    // Environmental
    'environmental.temp_min_c',
    'environmental.temp_max_c',
    'environmental.humidity_max_percent',
    'environmental.altitude_max_m',
    'environmental.noise_level_db',

    // Battery
    'battery.type',
    'battery.capacity_kwh',
    'battery.voltage_v',
    'battery.dod_percent',
    'battery.cycle_life',
    'battery.chemistry',

    // Warranty
    'warranty.years',
    'warranty.performance_guarantee_percent',
    'warranty.extension_available',

    // Data quality (validation workflow)
    'data_source.validation_status',
    'data_source.confidence_level',
    'data_source.data_quality_score',
    'data_source.completeness_percent',
  ];
}

/**
 * Visual indicator for cell editability
 * Returns CSS class name based on edit permissions
 */
export function getCellEditabilityClass(product: EnhancedProductData, fieldPath: string): string {
  if (!canEditProduct(product)) {
    return 'cell-readonly-zerez'; // Red border for ZEREZ data
  }

  if (!canEditField(product, fieldPath)) {
    return 'cell-readonly-calculated'; // Gray border for calculated fields
  }

  return 'cell-editable'; // Green border for editable
}

/**
 * Get icon for cell editability
 */
export function getCellEditabilityIcon(product: EnhancedProductData, fieldPath: string): string {
  if (!canEditProduct(product)) {
    return 'ðŸ”’'; // Lock icon for ZEREZ data
  }

  if (!canEditField(product, fieldPath)) {
    return 'âš™ï¸'; // Gear icon for auto-calculated
  }

  return 'âœï¸'; // Pencil icon for editable
}

/**
 * Validation helper: Check if edit operation is allowed
 * Throws error if not allowed (for API endpoints)
 */
export function validateEditPermission(product: EnhancedProductData, fieldPath: string): void {
  if (!canEditProduct(product)) {
    throw new Error(`FORBIDDEN: Cannot edit ZEREZ-imported products. Product ${product.identification.zerez_id} is from official ZEREZ database.`);
  }

  if (!canEditField(product, fieldPath)) {
    const reason = getFieldRestrictionReason(product, fieldPath);
    throw new Error(`FORBIDDEN: Cannot edit field "${fieldPath}". Reason: ${reason}`);
  }
}

/**
 * Filter products by editability
 * Useful for bulk edit operations
 */
export function filterEditableProducts(products: EnhancedProductData[]): EnhancedProductData[] {
  return products.filter(canEditProduct);
}

export function filterReadOnlyProducts(products: EnhancedProductData[]): EnhancedProductData[] {
  return products.filter(p => !canEditProduct(p));
}

/**
 * Get summary of edit permissions
 */
export function getEditPermissionSummary(products: EnhancedProductData[]): {
  total: number;
  editable: number;
  readOnly: number;
  bySource: Record<DataSource, number>;
} {
  const total = products.length;
  const editable = products.filter(canEditProduct).length;
  const readOnly = total - editable;

  const bySource: Record<DataSource, number> = {
    pdf: 0,
    zerez: 0,
    manual: 0,
    unknown: 0,
  };

  products.forEach(p => {
    const source = getDataSource(p);
    bySource[source]++;
  });

  return {
    total,
    editable,
    readOnly,
    bySource,
  };
}
