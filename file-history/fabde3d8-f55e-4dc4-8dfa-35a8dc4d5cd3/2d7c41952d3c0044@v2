# Dashboard Implementation Plan - Editable Table, Filtering & Charts

**Date:** November 8, 2025
**Status:** In Progress
**Objective:** Upgrade dashboard with editable validation workflow, advanced filtering, and professional charts

---

## Executive Summary

User requested 3 critical features:
1. **Editable Table** - Verify PDF-imported data with validation status tracking
2. **Advanced Filtering** - Quickly find products with complex filter criteria
3. **Professional Charts** - Analyze competition data visually

**Approach:** Enhance existing SimpleDataTable component instead of adding AG Grid Enterprise to avoid $999/year licensing cost.

---

## Architecture Decision

### Libraries Used

**✅ Already Installed:**
- ECharts 5.5.0 - Professional charts (MIT License, free)
- Recharts 2.10.3 - React charts (MIT License, free)
- Lucide Icons - UI icons

**❌ NOT Installing:**
- AG Grid Enterprise - $999/year, overkill for our needs
- TanStack Table - Unnecessary, our table works well

**Strategy:** Extend SimpleDataTable with inline editing using native HTML contenteditable and React state management.

---

## Phase 1: Editable Table with Validation Workflow

### 1.1 Add Validation Status Field

**Schema Change:**
```typescript
// Already exists in types-enhanced.ts:
data_source: {
  validation_status?: 'passed' | 'needs_review' | 'failed';
  // ... other fields
}
```

**New Statuses:**
- `imported` - Just imported from PDF/ZEREZ, not verified
- `review` - Flagged for manual verification
- `validated` - Verified and approved
- `rejected` - Data incorrect, needs re-extraction

### 1.2 Inline Cell Editing

**Implementation:**
- Double-click cell to edit
- Input validation (e.g., efficiency must be 0-100%)
- Save on blur or Enter key
- Cancel on Escape key
- Visual feedback (border highlight, save indicator)

**Editable Fields:**
- Efficiency (peak, euro, cec)
- Physical specs (weight, dimensions, IP rating)
- Power ratings
- Environmental ranges

**Read-Only Fields:**
- Manufacturer
- Model
- ZEREZ ID
- Data source metadata

### 1.3 Validation Actions

**Toolbar Actions:**
1. **Validate Selected** - Mark rows as `validated`
2. **Mark for Review** - Flag suspicious data as `review`
3. **Reject Selected** - Mark as `rejected`
4. **Bulk Edit** - Change multiple cells at once

**Visual Indicators:**
- `imported` - Blue border, info icon
- `review` - Orange border, warning icon
- `validated` - Green border, checkmark icon
- `rejected` - Red border, X icon

### 1.4 Edit History & Undo

**Features:**
- Track all edits with timestamp + user
- Undo last 10 edits
- View edit history per product
- Export edit log to CSV

---

## Phase 2: Advanced Filtering System

### 2.1 Quick Filters (Already Partially Implemented)

**Existing:**
- Power density filters (PowerDensityFilters component exists)

**New Quick Filters:**
- **Manufacturer** - Multi-select dropdown
- **Power Range** - Slider (0-500 kW)
- **Efficiency Range** - Slider (90-100%)
- **Validation Status** - Checkboxes (imported, review, validated, rejected)
- **Certification** - Has ZEREZ cert (Yes/No)
- **Market Position** - Multi-select (leader, challenger, innovator, follower)

### 2.2 Advanced Filter Builder

**Visual Filter Builder:**
```
┌─────────────────────────────────────────────┐
│ Filter Builder                               │
├─────────────────────────────────────────────┤
│ [AND ▼] Efficiency > [95] %                 │
│ [AND ▼] Power Range [100] - [200] kW        │
│ [OR  ▼] Manufacturer = [GoodWe]             │
│                                              │
│ [+ Add Condition] [Clear All] [Save Filter] │
└─────────────────────────────────────────────┘
```

**Filter Logic:**
- AND/OR operators
- Comparison: =, !=, >, <, >=, <=, contains, starts with
- Nested conditions
- Save/load filter presets

### 2.3 Filter Presets

**Pre-configured Filters:**
1. **Needs Validation** - Status = imported OR review
2. **High Performers** - Efficiency > 97% AND Power Density > 300 kW/m³
3. **Market Leaders** - Market Position = leader
4. **Premium Products** - Innovation Score > 80
5. **Compact Units** - Power Density > 400 kW/m³
6. **Heavy Duty** - Power > 200 kW AND IP Rating >= 65

**UI:**
- Dropdown with preset names
- Apply preset instantly
- Modify and save as new preset
- Export/import presets as JSON

---

## Phase 3: Professional Chart System

### 3.1 Chart Types for Competitive Analysis

**ECharts Charts to Implement:**

1. **Scatter Plot** - Efficiency vs Power Density
   - X-axis: Power Density (kW/m³)
   - Y-axis: Efficiency (%)
   - Bubble size: Power Rating (kW)
   - Color: Manufacturer
   - Use case: Identify best performers

2. **Bubble Chart** - 3D Competitive Positioning
   - X-axis: Innovation Score
   - Y-axis: Market Share (%)
   - Bubble size: Product Count
   - Color: Market Position
   - Use case: Market landscape overview

3. **Bar Chart** - Manufacturer Comparison
   - Grouped by manufacturer
   - Metrics: Avg Efficiency, Avg Power Density, Product Count
   - Sorted by selected metric
   - Use case: Brand benchmarking

4. **Heatmap** - Efficiency Distribution
   - X-axis: Power Range (bins: <100, 100-150, 150-200, >200 kW)
   - Y-axis: Manufacturer
   - Color intensity: Average Efficiency
   - Use case: Identify efficiency gaps

5. **Radar Chart** - Multi-Metric Comparison
   - Axes: Efficiency, Power Density, Innovation, Reliability, Cost Index
   - Multiple products overlaid
   - Use case: Head-to-head comparison

6. **Line Chart** - Certification Timeline
   - X-axis: Time (months/years)
   - Y-axis: Certification Count
   - Lines: Per manufacturer
   - Use case: Market entry trends

7. **Sankey Diagram** - Market Flow
   - From: Manufacturer → Market Position → Power Class
   - Width: Product count
   - Use case: Market segmentation

8. **Box Plot** - Statistical Distribution
   - Metrics: Efficiency, Power Density, Weight
   - Per manufacturer
   - Shows: Min, Q1, Median, Q3, Max, Outliers
   - Use case: Quality consistency analysis

### 3.2 Chart Configuration System

**Dynamic Chart Builder:**
```typescript
interface ChartBuilderConfig {
  chartType: 'scatter' | 'bubble' | 'bar' | 'heatmap' | 'radar' | 'line' | 'sankey' | 'boxplot';
  xAxis: string; // Field name
  yAxis: string;
  groupBy?: string;
  colorBy?: string;
  sizeBy?: string;
  filters?: FilterConfig;
  title?: string;
  subtitle?: string;
}
```

**Chart Builder UI:**
- Drag-and-drop field selection
- Live preview
- Save chart configuration
- Export chart (PNG, SVG, PDF)
- Share chart link

### 3.3 Interactive Features

**Chart Interactions:**
- **Hover** - Show detailed tooltip with all product info
- **Click** - Highlight row in table below
- **Zoom** - Box zoom for detailed analysis
- **Filter** - Click legend to filter data
- **Export** - Download chart as image
- **Link to Table** - Click data point → scroll to row in table

**Linked Views:**
- Filter table → Charts update
- Click chart → Table filters to selection
- Select rows → Charts highlight
- Bidirectional sync

---

## Implementation Timeline

### Week 1: Editable Table (Phase 1)

**Day 1-2: Core Editing**
- [ ] Add contenteditable cells to SimpleDataTable
- [ ] Implement edit mode toggle (double-click)
- [ ] Add input validation (efficiency 0-100%, weight > 0, etc.)
- [ ] Save/cancel edit logic

**Day 3-4: Validation Workflow**
- [ ] Update data_source.validation_status field
- [ ] Add validation status column renderer
- [ ] Create validation action toolbar
- [ ] Implement bulk validation actions

**Day 5: Edit History**
- [ ] Add edit tracking system
- [ ] Implement undo/redo functionality
- [ ] Create edit history viewer
- [ ] Add edit log export

### Week 2: Advanced Filtering (Phase 2)

**Day 1-2: Quick Filters**
- [ ] Extend PowerDensityFilters to include all quick filters
- [ ] Add manufacturer multi-select
- [ ] Add power/efficiency range sliders
- [ ] Add validation status checkboxes

**Day 3-4: Filter Builder**
- [ ] Create FilterBuilder component
- [ ] Implement AND/OR logic
- [ ] Add comparison operators
- [ ] Build filter expression evaluator

**Day 5: Filter Presets**
- [ ] Create preset dropdown UI
- [ ] Implement preset save/load logic
- [ ] Add 6 default presets
- [ ] Add preset import/export

### Week 3: Professional Charts (Phase 3)

**Day 1-2: Core Charts**
- [ ] Implement Scatter Plot (Efficiency vs Power Density)
- [ ] Implement Bubble Chart (Competitive Positioning)
- [ ] Implement Bar Chart (Manufacturer Comparison)
- [ ] Add chart container layout

**Day 3-4: Advanced Charts**
- [ ] Implement Heatmap (Efficiency Distribution)
- [ ] Implement Radar Chart (Multi-Metric Comparison)
- [ ] Implement Line Chart (Certification Timeline)
- [ ] Add chart export functionality

**Day 5: Chart Builder**
- [ ] Create dynamic chart builder UI
- [ ] Add field drag-and-drop
- [ ] Implement live preview
- [ ] Add save/share chart functionality

### Week 4: Integration & Testing

**Day 1-2: Linked Views**
- [ ] Implement table-chart sync
- [ ] Add click-to-filter interactions
- [ ] Add hover highlighting
- [ ] Test bidirectional updates

**Day 3-4: Testing**
- [ ] Write Playwright tests for editing
- [ ] Write tests for filtering
- [ ] Write tests for charts
- [ ] Test validation workflow

**Day 5: Documentation**
- [ ] Update user guide
- [ ] Create video tutorials
- [ ] Document API changes
- [ ] Update IMPLEMENTATION_STATUS.md

---

## UI Mockup

### Dashboard Layout

```
┌──────────────────────────────────────────────────────────────────┐
│ C&I BESS Competition Analytics Platform                           │
│ [ZEREZ Import] [CSV] [Excel] [PDF] [PPTX]                        │
├──────────────────────────────────────────────────────────────────┤
│ KPI Cards (10 metrics)                                            │
├──────────────────────────────────────────────────────────────────┤
│ Tabs: [Product Analysis] [Timeline] [Matrix] [Heatmap] [Charts]  │
├──────────────────────────────────────────────────────────────────┤
│                                                                    │
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ Quick Filters:                                              │   │
│ │ Manufacturer [All ▼] Power [0-500 kW] Efficiency [90-100%] │   │
│ │ Status: [✓ Imported] [✓ Review] [✓ Validated] [ ] Rejected│   │
│ │ [Advanced Filters ▼] [Presets: High Performers ▼] [Clear]  │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                    │
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ Validation Actions:                                         │   │
│ │ [Validate Selected] [Mark for Review] [Reject] [Bulk Edit] │   │
│ │ Selected: 5 rows | [Undo] [Redo] [Edit History]            │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                    │
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ Product Analysis Table (Editable)                           │   │
│ │ ┌───┬──────┬───────┬──────┬────────┬──────┬──────────────┐ │   │
│ │ │ ☑ │ Mfr  │ Model │ Eff% │ Power  │ Wght │ Status       │ │   │
│ │ ├───┼──────┼───────┼──────┼────────┼──────┼──────────────┤ │   │
│ │ │ ☑ │ GW   │ 100K  │ 96.5 │ 100 kW │ 950  │ ✓ Validated  │ │   │
│ │ │ ☑ │ Huawei│SUN2000│ 97.2 │ 125 kW │1100  │ ⚠ Review     │ │   │
│ │ │   │ Sungrow│250K  │ 97.5 │ 250 kW │2200  │ ℹ Imported   │ │   │
│ │ └───┴──────┴───────┴──────┴────────┴──────┴──────────────┘ │   │
│ │ [Double-click cell to edit] 58 products | Page 1 of 3      │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                    │
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ Competitive Analysis Charts                                 │   │
│ │ [Scatter ▼] [Bubble] [Bar] [Heatmap] [Radar] [+ Builder]   │   │
│ │                                                              │   │
│ │   Efficiency vs Power Density (Scatter Plot)                │   │
│ │   100% ┤        ● GoodWe                                     │   │
│ │    98% ┤     ●  ● Huawei                                     │   │
│ │    96% ┤  ●  ●    ● Sungrow                                  │   │
│ │    94% ┤ ●        [Bubble size = Power Rating]              │   │
│ │        └────────────────────────────────                    │   │
│ │         200   400   600   800 kW/m³                          │   │
│ │ [Export PNG] [Export SVG] [Share] [Full Screen]             │   │
│ └────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Technical Implementation Details

### 1. Editable Cell Component

```typescript
// components/EditableCell.tsx
interface EditableCellProps {
  value: string | number;
  field: string;
  onSave: (newValue: string | number) => Promise<void>;
  validation?: (value: string | number) => boolean;
  format?: (value: string | number) => string;
}

export function EditableCell({ value, field, onSave, validation, format }: EditableCellProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [editValue, setEditValue] = useState(value);
  const [isSaving, setIsSaving] = useState(false);

  const handleDoubleClick = () => setIsEditing(true);

  const handleSave = async () => {
    if (validation && !validation(editValue)) {
      toast.error('Invalid value');
      return;
    }

    setIsSaving(true);
    await onSave(editValue);
    setIsSaving(false);
    setIsEditing(false);
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') handleSave();
    if (e.key === 'Escape') { setEditValue(value); setIsEditing(false); }
  };

  return isEditing ? (
    <input
      type={typeof value === 'number' ? 'number' : 'text'}
      value={editValue}
      onChange={(e) => setEditValue(e.target.value)}
      onBlur={handleSave}
      onKeyDown={handleKeyDown}
      className="w-full border-2 border-blue-500 px-2 py-1"
      autoFocus
    />
  ) : (
    <div onDoubleClick={handleDoubleClick} className="cursor-pointer hover:bg-gray-100 px-2 py-1">
      {format ? format(value) : value}
      {isSaving && <Loader2 className="inline ml-2 animate-spin" size={14} />}
    </div>
  );
}
```

### 2. Filter Builder Component

```typescript
// components/FilterBuilder.tsx
interface FilterCondition {
  id: string;
  field: string;
  operator: '=' | '!=' | '>' | '<' | '>=' | '<=' | 'contains';
  value: string | number;
  logic: 'AND' | 'OR';
}

export function FilterBuilder({ onFilterChange }: { onFilterChange: (filters: FilterCondition[]) => void }) {
  const [conditions, setConditions] = useState<FilterCondition[]>([]);

  const addCondition = () => {
    setConditions([...conditions, {
      id: nanoid(),
      field: 'efficiency.peak_percent',
      operator: '>',
      value: 95,
      logic: 'AND'
    }]);
  };

  const removeCondition = (id: string) => {
    setConditions(conditions.filter(c => c.id !== id));
  };

  const updateCondition = (id: string, updates: Partial<FilterCondition>) => {
    setConditions(conditions.map(c => c.id === id ? { ...c, ...updates } : c));
  };

  useEffect(() => {
    onFilterChange(conditions);
  }, [conditions]);

  return (
    <div className="bg-white dark:bg-gray-800 p-4 rounded-lg">
      <h3 className="font-semibold mb-4">Advanced Filter Builder</h3>
      {conditions.map((condition, index) => (
        <div key={condition.id} className="flex gap-2 mb-2 items-center">
          {index > 0 && (
            <select
              value={condition.logic}
              onChange={(e) => updateCondition(condition.id, { logic: e.target.value as 'AND' | 'OR' })}
              className="px-2 py-1 border rounded"
            >
              <option value="AND">AND</option>
              <option value="OR">OR</option>
            </select>
          )}
          <select
            value={condition.field}
            onChange={(e) => updateCondition(condition.id, { field: e.target.value })}
            className="px-2 py-1 border rounded flex-1"
          >
            <option value="efficiency.peak_percent">Efficiency</option>
            <option value="power.rated_power_kw">Power</option>
            <option value="physical.weight_kg">Weight</option>
            <option value="power_density">Power Density</option>
            <option value="identification.manufacturer">Manufacturer</option>
          </select>
          <select
            value={condition.operator}
            onChange={(e) => updateCondition(condition.id, { operator: e.target.value as any })}
            className="px-2 py-1 border rounded"
          >
            <option value="=">=</option>
            <option value="!=">!=</option>
            <option value=">">&gt;</option>
            <option value="<">&lt;</option>
            <option value=">=">&gt;=</option>
            <option value="<=">&lt;=</option>
            <option value="contains">contains</option>
          </select>
          <input
            type="text"
            value={condition.value}
            onChange={(e) => updateCondition(condition.id, { value: e.target.value })}
            className="px-2 py-1 border rounded w-32"
          />
          <button
            onClick={() => removeCondition(condition.id)}
            className="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"
          >
            Remove
          </button>
        </div>
      ))}
      <button
        onClick={addCondition}
        className="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        + Add Condition
      </button>
    </div>
  );
}
```

### 3. Chart Builder Component

```typescript
// components/ChartBuilder.tsx
export function ChartBuilder({ data }: { data: EnhancedProductData[] }) {
  const [chartType, setChartType] = useState<'scatter' | 'bubble' | 'bar'>('scatter');
  const [xAxis, setXAxis] = useState('power_density');
  const [yAxis, setYAxis] = useState('efficiency.peak_percent');
  const [colorBy, setColorBy] = useState('identification.manufacturer');

  const chartOptions = useMemo(() => {
    if (chartType === 'scatter') {
      return {
        xAxis: { name: xAxis, type: 'value' },
        yAxis: { name: yAxis, type: 'value' },
        series: [{
          type: 'scatter',
          data: data.map(p => [
            getNestedValue(p, xAxis),
            getNestedValue(p, yAxis)
          ])
        }]
      };
    }
    // ... other chart types
  }, [chartType, xAxis, yAxis, colorBy, data]);

  return (
    <div className="grid grid-cols-2 gap-4">
      <div>
        <h3>Chart Configuration</h3>
        <label>Chart Type</label>
        <select value={chartType} onChange={(e) => setChartType(e.target.value as any)}>
          <option value="scatter">Scatter Plot</option>
          <option value="bubble">Bubble Chart</option>
          <option value="bar">Bar Chart</option>
        </select>

        <label>X-Axis</label>
        <select value={xAxis} onChange={(e) => setXAxis(e.target.value)}>
          <option value="power_density">Power Density</option>
          <option value="power.rated_power_kw">Power</option>
          <option value="efficiency.peak_percent">Efficiency</option>
        </select>

        <label>Y-Axis</label>
        <select value={yAxis} onChange={(e) => setYAxis(e.target.value)}>
          <option value="efficiency.peak_percent">Efficiency</option>
          <option value="power_density">Power Density</option>
          <option value="competitive.innovation_score">Innovation</option>
        </select>
      </div>

      <div>
        <h3>Live Preview</h3>
        <ReactECharts option={chartOptions} style={{ height: 400 }} />
      </div>
    </div>
  );
}
```

---

## Data Persistence

### Local Storage Structure

```typescript
// Edit history
localStorage.setItem('editHistory', JSON.stringify([
  {
    timestamp: '2025-11-08T10:30:00Z',
    productId: 'zerez-123',
    field: 'efficiency.peak_percent',
    oldValue: 96.5,
    newValue: 97.0,
    user: 'local_user'
  }
]));

// Filter presets
localStorage.setItem('filterPresets', JSON.stringify({
  'high-performers': {
    name: 'High Performers',
    conditions: [
      { field: 'efficiency.peak_percent', operator: '>', value: 97 },
      { field: 'power_density', operator: '>', value: 300, logic: 'AND' }
    ]
  }
}));

// Saved charts
localStorage.setItem('savedCharts', JSON.stringify({
  'efficiency-vs-density': {
    type: 'scatter',
    xAxis: 'power_density',
    yAxis: 'efficiency.peak_percent',
    filters: { ... }
  }
}));
```

---

## Testing Strategy

### Unit Tests
- EditableCell validation logic
- Filter expression evaluator
- Chart data transformations

### Integration Tests (Playwright)
1. **Edit Workflow Test:**
   - Double-click cell
   - Edit value
   - Press Enter
   - Verify save
   - Undo edit
   - Verify revert

2. **Filter Test:**
   - Apply quick filter
   - Build advanced filter
   - Save preset
   - Load preset
   - Verify table updates

3. **Chart Test:**
   - Select chart type
   - Configure axes
   - Verify data points
   - Click data point
   - Verify table highlights

---

## Success Metrics

### Performance Targets
- [ ] Table edit latency < 100ms
- [ ] Filter application < 200ms
- [ ] Chart render time < 500ms
- [ ] Undo/redo < 50ms

### User Experience
- [ ] 100% editable fields functional
- [ ] Validation prevents invalid data
- [ ] Filters work with 1000+ products
- [ ] Charts interactive and exportable

### Data Quality
- [ ] All edits logged
- [ ] Validation status tracked
- [ ] Edit history preserved
- [ ] No data loss on edit

---

## Next Steps

1. **Review this plan** - Confirm approach and timeline
2. **Start Phase 1** - Implement editable table
3. **Iterate** - Get feedback after each phase
4. **Deploy** - Production ready in 4 weeks

**Status:** ⏳ AWAITING APPROVAL TO START IMPLEMENTATION
