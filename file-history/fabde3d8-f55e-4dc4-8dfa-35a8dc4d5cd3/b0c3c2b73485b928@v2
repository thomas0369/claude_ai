import { test, expect } from '@playwright/test';
import * as fs from 'fs';
import * as path from 'path';

/**
 * PDF EXTRACTION WORKFLOW TESTING
 *
 * Tests the DeepSeek PDF extraction functionality:
 * 1. UI component loads and renders
 * 2. File upload (drag & drop simulation)
 * 3. PDF processing workflow
 * 4. API endpoint validation
 * 5. Error handling
 */

test.describe('PDF Extraction Workflow', () => {
  test.setTimeout(120000); // 2 minutes for PDF processing

  test.describe('1. UI Component Tests', () => {
    test('should load test-staging page with PDF extractor', async ({ page }) => {
      console.log('üß™ Testing test-staging page...');

      await page.goto('/test-staging');

      // Wait for page to load
      await page.waitForLoadState('networkidle');

      // Check if page exists and loads
      const pageExists = await page.locator('body').isVisible();
      expect(pageExists).toBeTruthy();

      console.log('‚úÖ Test-staging page loaded');

      // Take screenshot
      await page.screenshot({
        path: 'test-results/pdf-extraction-page.png',
        fullPage: true
      });
    });

    test('should verify PDF extractor component elements', async ({ page }) => {
      console.log('üîç Checking PDF extractor UI elements...');

      await page.goto('/test-staging');
      await page.waitForTimeout(2000);

      // Look for file upload related elements
      const uploadElements = page.locator(
        'input[type="file"], [class*="upload"], [class*="drop"], button:has-text("Upload")'
      );

      const count = await uploadElements.count();

      if (count > 0) {
        console.log(`‚úÖ Found ${count} upload-related elements`);
      } else {
        console.log('‚ÑπÔ∏è No upload elements found - component may not be on this page');
      }
    });
  });

  test.describe('2. API Endpoint Tests', () => {
    test('should test PDF extract API with mock data', async ({ page }) => {
      console.log('üîå Testing /api/pdf/extract endpoint...');

      // Create a mock base64 image (1x1 transparent PNG)
      const mockBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';

      const payload = {
        images: [mockBase64],
        aggregate: true
      };

      const response = await page.request.post('/api/pdf/extract', {
        data: payload,
        headers: { 'Content-Type': 'application/json' },
        timeout: 30000
      });

      // Check if endpoint exists
      if (response.status() === 404) {
        console.log('‚ö†Ô∏è PDF extract API not found at /api/pdf/extract');
        return;
      }

      // If endpoint exists, verify it handles requests
      console.log(`üìä API responded with status: ${response.status()}`);

      if (response.ok()) {
        const data = await response.json();
        console.log('‚úÖ PDF extract API responded successfully');
        console.log(`   Response keys: ${Object.keys(data).join(', ')}`);
      } else {
        const errorText = await response.text();
        console.log(`‚ö†Ô∏è API error (${response.status()}): ${errorText.substring(0, 100)}`);
      }
    });

    test('should handle invalid requests gracefully', async ({ page }) => {
      console.log('üö´ Testing API error handling...');

      // Send invalid payload
      const response = await page.request.post('/api/pdf/extract', {
        data: { invalid: 'data' },
        headers: { 'Content-Type': 'application/json' },
        timeout: 10000
      });

      if (response.status() === 404) {
        console.log('‚ÑπÔ∏è Endpoint not found - skipping validation test');
        return;
      }

      // Should return error status for invalid data
      if (!response.ok()) {
        console.log(`‚úÖ Invalid request rejected with status ${response.status()}`);
      } else {
        console.log('‚ö†Ô∏è API accepted invalid payload');
      }
    });
  });

  test.describe('3. File Upload Simulation', () => {
    test('should test file input if available', async ({ page }) => {
      console.log('üìé Testing file input...');

      await page.goto('/test-staging');
      await page.waitForTimeout(2000);

      // Look for file input
      const fileInput = page.locator('input[type="file"]');

      if (await fileInput.isVisible({ timeout: 2000 }).catch(() => false)) {
        console.log('‚úÖ File input found');

        // Check if we can access the input
        const isEnabled = await fileInput.isEnabled();
        console.log(`   File input enabled: ${isEnabled}`);
      } else {
        console.log('‚ÑπÔ∏è No visible file input found');
      }
    });

    test('should verify drag and drop area exists', async ({ page }) => {
      console.log('üéØ Testing drag & drop area...');

      await page.goto('/test-staging');
      await page.waitForTimeout(2000);

      // Look for drop zone indicators
      const dropZones = page.locator(
        '[class*="drop"], [class*="drag"], [data-drop], [ondrop]'
      );

      const count = await dropZones.count();

      if (count > 0) {
        console.log(`‚úÖ Found ${count} potential drop zone(s)`);
      } else {
        console.log('‚ÑπÔ∏è No explicit drop zones found');
      }
    });
  });

  test.describe('4. Integration Tests', () => {
    test('should verify DeepSeek client configuration', async ({ page }) => {
      console.log('‚öôÔ∏è Checking DeepSeek configuration...');

      // Check if environment variable is set (via API test)
      const response = await page.request.post('/api/pdf/extract', {
        data: { images: [], aggregate: false },
        headers: { 'Content-Type': 'application/json' },
        timeout: 5000,
        failOnStatusCode: false
      });

      if (response.status() === 404) {
        console.log('‚ÑπÔ∏è PDF extraction endpoint not available');
      } else if (response.status() === 500) {
        const errorText = await response.text();
        if (errorText.includes('DEEPSEEK_API_KEY') || errorText.includes('API key')) {
          console.log('‚ö†Ô∏è DeepSeek API key not configured');
        } else {
          console.log('‚úÖ DeepSeek client initialized (key configured)');
        }
      } else {
        console.log('‚úÖ DeepSeek endpoint responding');
      }
    });
  });

  test.describe('5. Staging System Tests', () => {
    test('should test staging list endpoint', async ({ page }) => {
      console.log('üìã Testing staging list...');

      const response = await page.request.get('/api/staging/list');

      expect(response.ok()).toBeTruthy();
      const data = await response.json();

      console.log(`‚úÖ Staging list returned ${data.length} items`);
    });

    test('should verify staging directory structure', async ({ page }) => {
      console.log('üìÅ Verifying staging directory...');

      const stagingDir = path.join(process.cwd(), 'public', 'data', 'staging');

      if (fs.existsSync(stagingDir)) {
        const files = fs.readdirSync(stagingDir);
        console.log(`‚úÖ Staging directory exists with ${files.length} files`);

        // List first 5 files
        files.slice(0, 5).forEach(file => {
          console.log(`   - ${file}`);
        });
      } else {
        console.log('‚ÑπÔ∏è Staging directory does not exist yet');
      }
    });
  });

  test.describe('6. Error Handling', () => {
    test('should handle missing API key gracefully', async ({ page }) => {
      console.log('üîê Testing API key error handling...');

      await page.goto('/test-staging');
      await page.waitForTimeout(2000);

      // Look for error messages
      const errorMessages = page.locator(
        '[class*="error"], [class*="alert"], [role="alert"]'
      );

      const count = await errorMessages.count();

      if (count > 0) {
        for (let i = 0; i < Math.min(count, 3); i++) {
          const text = await errorMessages.nth(i).textContent();
          console.log(`   Error message: ${text?.substring(0, 100)}`);
        }
      } else {
        console.log('‚úÖ No error messages displayed on page load');
      }
    });

    test('should handle timeout errors', async ({ page }) => {
      console.log('‚è±Ô∏è Testing timeout handling...');

      // This test verifies the system can handle slow/timeout responses
      const response = await page.request.post('/api/pdf/extract', {
        data: { images: [], aggregate: false },
        headers: { 'Content-Type': 'application/json' },
        timeout: 2000, // Short timeout
        failOnStatusCode: false
      });

      console.log(`‚úÖ Timeout test completed with status ${response.status()}`);
    });
  });
});
