'use client';

import React, { useMemo } from 'react';
import ReactECharts from 'echarts-for-react';
import type { EnhancedProductData } from '@/lib/types-enhanced';
import {
  type CallbackDataParams,
  type CompetitiveDataPoint,
  isCompetitiveData,
  createTooltipHtml,
} from '@/lib/echarts-types';
import { MarketPositionAnalyzer } from '@/lib/market-position';
import {
  MARKET_POSITION_COLORS,
  CHART_FONT_SIZES,
  CHART_FONT_WEIGHTS,
  CHART_LABEL_SPACING,
  CHART_TEXT_COLORS,
  CHART_BACKGROUND_COLORS,
  CHART_BORDER_RADIUS,
  CHART_OPACITY,
  CHART_GRID_CONFIGS,
  getChartThemeColors,
} from '@/lib/ui-constants';
import { calculateAxisRange } from '@/lib/ui-utils';
import { useDarkMode } from '@/lib/use-dark-mode';
import { Target } from 'lucide-react';

/**
 * Configuration for a single quadrant label
 */
interface QuadrantLabelConfig {
  left: string;
  top: string;
  text: string;
  color: string;
}

/**
 * ECharts graphic element configuration for text labels
 */
interface GraphicTextElement {
  type: 'text';
  left: string;
  top: string;
  style: {
    text: string;
    fontSize: number;
    fontWeight: number;
    fill: string;
    opacity: number;
    textBorderColor: string;
    textBorderWidth: number;
  };
}

/**
 * Generate ECharts graphic elements for quadrant labels
 * Ensures consistent styling across all quadrant labels with theme awareness
 *
 * @param themeColors - Theme-specific color configuration
 * @returns Array of ECharts graphic configuration objects
 */
function createQuadrantLabels(themeColors: ReturnType<typeof getChartThemeColors>): GraphicTextElement[] {
  const quadrants: QuadrantLabelConfig[] = [
    { left: '78%', top: '22%', text: 'Leaders', color: MARKET_POSITION_COLORS.leader },
    { left: '78%', top: '78%', text: 'Innovators', color: MARKET_POSITION_COLORS.innovator },
    { left: '18%', top: '22%', text: 'Challengers', color: MARKET_POSITION_COLORS.challenger },
    { left: '18%', top: '78%', text: 'Followers', color: MARKET_POSITION_COLORS.follower },
  ];

  return quadrants.map(({ left, top, text, color }) => ({
    type: 'text',
    left,
    top,
    style: {
      text,
      fontSize: CHART_FONT_SIZES.QUADRANT_LABEL,
      fontWeight: CHART_FONT_WEIGHTS.BOLD,
      fill: color,
      opacity: themeColors.quadrantOpacity,
      textBorderColor: themeColors.textBorder,
      textBorderWidth: 2,
    },
  }));
}

interface CompetitiveMatrixProps {
  data: EnhancedProductData[];
  title?: string;
}

export default function CompetitiveMatrix({
  data,
  title = 'Competitive Positioning Matrix',
}: CompetitiveMatrixProps) {
  // Use React hook for theme detection with proper reactivity
  const isDark = useDarkMode();

  const chartOption = useMemo(() => {
    // Get theme-aware colors for dark mode support
    const themeColors = getChartThemeColors(isDark);

    // Group by manufacturer
    const byManufacturer = new Map<string, EnhancedProductData[]>();
    data.forEach(product => {
      const mfr = product.identification.manufacturer;
      if (!byManufacturer.has(mfr)) {
        byManufacturer.set(mfr, []);
      }
      const group = byManufacturer.get(mfr);
      if (group) {
        group.push(product);
      } else {
        console.error(`Manufacturer not found in map: ${mfr}`);
        byManufacturer.set(mfr, [product]);
      }
    });

    // Calculate aggregate metrics per manufacturer
    const manufacturerData = Array.from(byManufacturer.entries()).map(([mfr, products]) => {
      const avgInnovation = products.reduce((sum, p) => sum + p.competitive.innovation_score, 0) / products.length;
      const totalMarketShare = products.reduce((sum, p) => sum + p.competitive.market_share_estimate_percent, 0);
      const avgEfficiency = products.reduce((sum, p) => sum + (p.efficiency?.peak_percent || 0), 0) / products.length;
      const productCount = products.length;
      const totalVariants = products.reduce((sum, p) => sum + (p.identification.zerez_variant_count || 0), 0);

      // Determine quadrant for visualization using centralized logic
      // Uses fixed thresholds (60/5) for consistent 2x2 matrix display
      const position = MarketPositionAnalyzer.determinePositionForVisualization(
        avgInnovation,
        totalMarketShare
      );
      const positionCapitalized = position.charAt(0).toUpperCase() + position.slice(1);

      return {
        manufacturer: mfr,
        innovation: avgInnovation,
        marketShare: totalMarketShare,
        efficiency: avgEfficiency,
        productCount,
        variants: totalVariants,
        position: positionCapitalized,
      };
    });

    // Calculate dynamic Y-axis range using utility function
    // 20% padding for better visualization (market shares vary more than power values)
    const [yAxisMin, yAxisMax] = calculateAxisRange(
      manufacturerData.map(d => d.marketShare),
      20, // 20% padding
      0   // Don't go below 0
    );

    // Define quadrant colors using centralized constants
    const colorMap = {
      Leader: MARKET_POSITION_COLORS.leader,
      Innovator: MARKET_POSITION_COLORS.innovator,
      Challenger: MARKET_POSITION_COLORS.challenger,
      Follower: MARKET_POSITION_COLORS.follower,
    };

    return {
      title: {
        text: title,
        subtext: 'Innovation Index vs Market Presence',
        left: 'center',
        textStyle: {
          fontSize: CHART_FONT_SIZES.TITLE,
          fontWeight: CHART_FONT_WEIGHTS.BOLD,
        },
      },
      tooltip: {
        trigger: 'item',
        formatter: (params: CallbackDataParams | CallbackDataParams[]) => {
          const param = Array.isArray(params) ? params[0] : params;

          // Type guard for safety - use HTML-safe function for fallback
          if (!isCompetitiveData(param.data)) {
            return createTooltipHtml(
              String(param.name || 'Unknown'),
              [{ label: 'Value', value: String(param.value || 'N/A') }]
            );
          }

          const item = param.data;

          return createTooltipHtml(item.manufacturer, [
            { label: 'Position', value: item.position },
            { label: 'Innovation Index', value: `${item.innovation.toFixed(1)}/100` },
            { label: 'Market Share', value: `${item.marketShare.toFixed(2)}%` },
            { label: 'Avg Efficiency', value: `${item.efficiency.toFixed(2)}%` },
            { label: 'Products', value: item.productCount },
            { label: 'ZEREZ Variants', value: item.variants },
          ]);
        },
      },
      // Centralized grid configuration for consistent spacing
      grid: CHART_GRID_CONFIGS.STANDARD,
      /**
       * X-Axis Configuration - FIXED RANGE INTENTIONAL
       *
       * Range: 0-100 (Innovation Index scale)
       *
       * IMPORTANT: This axis uses a FIXED range (not dynamic like Y-axis) because:
       *
       * 1. **Normalized Scale**: Innovation Index is calculated as a 0-100 percentile score
       *    across all products in the dataset (see data-enrichment.ts)
       *
       * 2. **Quadrant Consistency**: The chart displays a 2x2 matrix with fixed thresholds:
       *    - Vertical line at x=60 divides high innovation (right) from low innovation (left)
       *    - These boundaries define Leaders/Innovators vs Challengers/Followers
       *    - See MarketPositionAnalyzer.determinePositionForVisualization() for logic
       *
       * 3. **Cross-View Comparability**: Fixed range ensures quadrants remain consistent
       *    when filtering data or comparing different time periods/subsets
       *
       * 4. **Visual Stability**: Dynamic range would cause quadrant boundaries to shift,
       *    making the "Leader" quadrant appear in different positions - confusing users
       *
       * When to consider dynamic range:
       * - If future data shows all manufacturers clustering in 40-60 range (poor distribution)
       * - If innovation_score calculation changes to non-percentile metric
       * - For exploration views where relative positioning matters more than absolute quadrants
       *
       * Implementation note: Use calculateAxisRange() for Y-axis because market share
       * varies significantly (0.1% to 20%+) and benefits from zoom-to-data behavior.
       *
       * @see MarketPositionAnalyzer.determinePositionForVisualization for quadrant thresholds
       * @see data-enrichment.ts for innovation_score calculation methodology
       */
      xAxis: {
        name: 'Innovation Index',
        nameLocation: 'middle',
        nameGap: 30,
        min: 0,
        max: 100,
        splitLine: {
          lineStyle: {
            type: 'dashed',
          },
        },
        axisLine: {
          lineStyle: {
            width: 2,
          },
        },
      },
      yAxis: {
        name: 'Market Presence (%)',
        nameLocation: 'middle',
        nameGap: 40,
        min: yAxisMin,
        max: yAxisMax,
        splitLine: {
          lineStyle: {
            type: 'dashed',
          },
        },
        axisLine: {
          lineStyle: {
            width: 2,
          },
        },
      },
      visualMap: {
        show: false,
        dimension: 2,
        min: 90,
        max: 99,
        inRange: {
          color: ['#d1fae5', '#047857'],
        },
      },
      series: [
        {
          name: 'Manufacturers',
          type: 'scatter' as const,
          symbolSize: (_rawValue: unknown, params: CallbackDataParams) => {
            const item = params.data as CompetitiveDataPoint;
            return Math.sqrt(item.productCount) * 30 + 20; // Size by product count
          },
          data: manufacturerData.map((d): CompetitiveDataPoint => ({
            value: [d.innovation, d.marketShare, d.efficiency, d.productCount],
            manufacturer: d.manufacturer,
            position: d.position as 'Leader' | 'Innovator' | 'Challenger' | 'Follower',
            innovation: d.innovation,
            marketShare: d.marketShare,
            efficiency: d.efficiency,
            productCount: d.productCount,
            variants: d.variants,
            itemStyle: {
              color: colorMap[d.position as keyof typeof colorMap],
              opacity: CHART_OPACITY.BUBBLE_DEFAULT,
            },
          })),
          /**
           * Bubble label configuration optimized for readability
           *
           * Design decisions:
           * - fontSize 11: Readable without overwhelming bubbles
           * - distance 8: Prevents overlap with bubble edge (tested with max bubble size)
           * - backgroundColor 0.85 opacity: Visible over chart gridlines without blocking data
           * - Theme-aware colors: Adapts to light/dark mode automatically
           *
           * @see CHART_LABEL_SPACING.BUBBLE_LABEL_DISTANCE for coupling with bubble size
           */
          label: {
            show: true,
            formatter: (params: CallbackDataParams) => {
              const item = params.data as CompetitiveDataPoint;
              return item.manufacturer;
            },
            position: 'top',
            fontSize: CHART_FONT_SIZES.BUBBLE_LABEL,
            fontWeight: CHART_FONT_WEIGHTS.BOLD,
            distance: CHART_LABEL_SPACING.BUBBLE_LABEL_DISTANCE,
            color: themeColors.labelText,
            backgroundColor: themeColors.labelBackground,
            padding: CHART_LABEL_SPACING.LABEL_PADDING,
            borderRadius: CHART_BORDER_RADIUS.LABEL,
          },
          emphasis: {
            scale: true,
            label: {
              show: true,
              fontSize: CHART_FONT_SIZES.EMPHASIS_LABEL,
            },
          },
        },
        // Add quadrant dividing lines
        {
          type: 'line',
          markLine: {
            silent: true,
            symbol: 'none',
            lineStyle: {
              type: 'solid',
              width: 2,
              color: '#cbd5e1',
            },
            data: [
              // Vertical line at innovation = 60
              {
                xAxis: 60,
                label: {
                  show: false,
                },
              },
              // Horizontal line at market share = 5
              {
                yAxis: 5,
                label: {
                  show: false,
                },
              },
            ],
          },
        },
      ],
      // Quadrant labels using DRY helper for consistency and maintainability
      graphic: createQuadrantLabels(themeColors),
    };
  }, [data, title, isDark]); // Theme changes trigger chart updates

  // Count manufacturers in each quadrant
  const quadrantStats = useMemo(() => {
    const stats = {
      leaders: 0,
      challengers: 0,
      innovators: 0,
      followers: 0,
    };

    const byManufacturer = new Map<string, EnhancedProductData[]>();
    data.forEach(product => {
      const mfr = product.identification.manufacturer;
      if (!byManufacturer.has(mfr)) {
        byManufacturer.set(mfr, []);
      }
      const group = byManufacturer.get(mfr);
      if (group) {
        group.push(product);
      } else {
        console.error(`Manufacturer not found in map: ${mfr}`);
        byManufacturer.set(mfr, [product]);
      }
    });

    Array.from(byManufacturer.entries()).forEach(([, products]) => {
      const avgInnovation = products.reduce((sum, p) => sum + p.competitive.innovation_score, 0) / products.length;
      const totalMarketShare = products.reduce((sum, p) => sum + p.competitive.market_share_estimate_percent, 0);

      // Uses same fixed thresholds as chart for consistency via MarketPositionAnalyzer
      const position = MarketPositionAnalyzer.determinePositionForVisualization(
        avgInnovation,
        totalMarketShare
      );

      // Increment appropriate counter
      switch (position) {
        case 'leader':
          stats.leaders++;
          break;
        case 'challenger':
          stats.challengers++;
          break;
        case 'innovator':
          stats.innovators++;
          break;
        case 'follower':
          stats.followers++;
          break;
      }
    });

    return stats;
  }, [data]);

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg">
      <div className="p-6 border-b border-gray-200 dark:border-gray-700">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <Target className="text-purple-600" size={28} />
              {title}
            </h2>
            <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Strategic positioning by innovation and market presence (bubble size = product count)
            </p>
          </div>
        </div>

        {/* Legend */}
        <div className="grid grid-cols-4 gap-4 mt-6">
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-green-500"></div>
            <div>
              <p className="font-semibold text-gray-900 dark:text-white">Leaders</p>
              <p className="text-sm text-gray-600 dark:text-gray-400">{quadrantStats.leaders} manufacturers</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-blue-500"></div>
            <div>
              <p className="font-semibold text-gray-900 dark:text-white">Challengers</p>
              <p className="text-sm text-gray-600 dark:text-gray-400">{quadrantStats.challengers} manufacturers</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-purple-500"></div>
            <div>
              <p className="font-semibold text-gray-900 dark:text-white">Innovators</p>
              <p className="text-sm text-gray-600 dark:text-gray-400">{quadrantStats.innovators} manufacturers</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-gray-500"></div>
            <div>
              <p className="font-semibold text-gray-900 dark:text-white">Followers</p>
              <p className="text-sm text-gray-600 dark:text-gray-400">{quadrantStats.followers} manufacturers</p>
            </div>
          </div>
        </div>
      </div>

      <div className="p-6">
        <ReactECharts option={chartOption} style={{ height: '550px' }} />
      </div>

      <div className="p-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 rounded-b-lg">
        <div className="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
          <span>ðŸ’¡ Bubble color indicates market position, size reflects product portfolio</span>
        </div>
      </div>
    </div>
  );
}
