/**
 * Enrich ZEREZ Products Script
 *
 * This script reads the products.json file created by ZEREZ import,
 * runs data enrichment on it, and writes back the enriched data.
 *
 * Usage: npx tsx scripts/enrich-zerez-products.ts
 */

import { promises as fs } from 'fs';
import path from 'path';
import { DataEnricher } from '../lib/data-enrichment';
import type { RawProductData, EnhancedProductData } from '../lib/types-enhanced';

async function enrichProducts() {
  console.log('ğŸ”„ Starting ZEREZ product enrichment...\n');

  // Read products.json
  const productsPath = path.join(process.cwd(), 'public', 'data', 'zerez', 'products.json');
  console.log(`ğŸ“‚ Reading from: ${productsPath}`);

  let rawProducts: RawProductData[];
  try {
    const content = await fs.readFile(productsPath, 'utf-8');
    rawProducts = JSON.parse(content);
    console.log(`âœ… Loaded ${rawProducts.length} products\n`);
  } catch (error) {
    console.error(`âŒ Failed to read products.json:`, error);
    process.exit(1);
  }

  // Analyze data quality BEFORE enrichment
  console.log('ğŸ“Š Data Quality Analysis (BEFORE enrichment):');
  const emptyEfficiency = rawProducts.filter(p => !p.efficiency || Object.keys(p.efficiency).length === 0).length;
  const emptyPhysical = rawProducts.filter(p => !p.physical || Object.keys(p.physical).length === 0).length;
  console.log(`  - Products with empty efficiency: ${emptyEfficiency}/${rawProducts.length} (${((emptyEfficiency/rawProducts.length)*100).toFixed(1)}%)`);
  console.log(`  - Products with empty physical: ${emptyPhysical}/${rawProducts.length} (${((emptyPhysical/rawProducts.length)*100).toFixed(1)}%)\n`);

  // Run enrichment
  console.log('ğŸ§  Running data enrichment...');
  const enrichedProducts: EnhancedProductData[] = DataEnricher.enrichProducts(rawProducts);
  console.log(`âœ… Enriched ${enrichedProducts.length} products\n`);

  // Analyze data quality AFTER enrichment
  console.log('ğŸ“Š Data Quality Analysis (AFTER enrichment):');
  const enrichedEmptyEfficiency = enrichedProducts.filter(p => !p.efficiency || !p.efficiency.peak_percent).length;
  const enrichedEmptyPhysical = enrichedProducts.filter(p => !p.physical || !p.physical.weight_kg).length;
  console.log(`  - Products with missing efficiency: ${enrichedEmptyEfficiency}/${enrichedProducts.length} (${((enrichedEmptyEfficiency/enrichedProducts.length)*100).toFixed(1)}%)`);
  console.log(`  - Products with missing physical: ${enrichedEmptyPhysical}/${enrichedProducts.length} (${((enrichedEmptyPhysical/enrichedProducts.length)*100).toFixed(1)}%)\n`);

  // Show sample enriched product
  if (enrichedProducts.length > 0) {
    const sample = enrichedProducts[0];
    console.log('ğŸ“‹ Sample Enriched Product:');
    console.log(`  Model: ${sample.identification.model}`);
    console.log(`  Power: ${sample.power?.rated_power_kw} kW`);
    console.log(`  Efficiency: ${sample.efficiency?.peak_percent}% (peak)`);
    console.log(`  Weight: ${sample.physical?.weight_kg} kg`);
    console.log(`  Dimensions: ${sample.physical?.width_mm}Ã—${sample.physical?.height_mm}Ã—${sample.physical?.depth_mm} mm`);
    console.log(`  Power Density: ${sample.power_density?.toFixed(1)} kW/mÂ³`);
    console.log(`  Power/Weight: ${sample.power_to_weight?.toFixed(3)} kW/kg`);
    console.log(`  Market Position: ${sample.competitive?.market_position}`);
    console.log(`  Innovation Score: ${sample.competitive?.innovation_score?.toFixed(1)}/100\n`);
  }

  // Write enriched products back to file
  console.log('ğŸ’¾ Writing enriched data back to products.json...');
  await fs.writeFile(productsPath, JSON.stringify(enrichedProducts, null, 2), 'utf-8');
  console.log('âœ… Successfully wrote enriched products\n');

  // Create backup
  const backupPath = path.join(process.cwd(), 'public', 'data', 'zerez', `products.backup.${Date.now()}.json`);
  console.log(`ğŸ’¾ Creating backup at: ${backupPath}`);
  await fs.writeFile(backupPath, JSON.stringify(rawProducts, null, 2), 'utf-8');
  console.log('âœ… Backup created\n');

  console.log('ğŸ‰ Enrichment complete!');
  console.log(`\nğŸ“ˆ Improvement:`);
  console.log(`  - Efficiency: ${emptyEfficiency} â†’ ${enrichedEmptyEfficiency} missing (${emptyEfficiency - enrichedEmptyEfficiency} fixed)`);
  console.log(`  - Physical: ${emptyPhysical} â†’ ${enrichedEmptyPhysical} missing (${emptyPhysical - enrichedEmptyPhysical} fixed)`);
}

enrichProducts().catch(error => {
  console.error('âŒ Enrichment failed:', error);
  process.exit(1);
});
