#!/bin/bash

# Comprehensive Testing Script for C&I BESS Platform
# This script runs ALL tests iteratively until everything passes

set -e

echo "ðŸš€ C&I BESS Comprehensive Testing Suite"
echo "========================================"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test results directory
RESULTS_DIR="test-results"
REPORT_FILE="$RESULTS_DIR/comprehensive-test-report.md"

# Create results directory
mkdir -p "$RESULTS_DIR"

# Initialize report
cat > "$REPORT_FILE" << EOF
# Comprehensive Test Report
**Generated:** $(date)
**Platform:** C&I BESS Competition Analysis

---

## Test Summary

EOF

# Counter for test iterations
ITERATION=1
MAX_ITERATIONS=3

echo -e "${BLUE}ðŸ“‹ Test Configuration${NC}"
echo "  - Results Directory: $RESULTS_DIR"
echo "  - Max Iterations: $MAX_ITERATIONS"
echo "  - Report: $REPORT_FILE"
echo ""

# Function to run a test suite
run_test_suite() {
    local test_name=$1
    local test_file=$2

    echo -e "${YELLOW}â–¶ Running: $test_name${NC}"
    echo ""

    if npm run test:e2e -- "$test_file" --reporter=list 2>&1 | tee "$RESULTS_DIR/${test_name// /-}.log"; then
        echo -e "${GREEN}âœ… PASSED: $test_name${NC}"
        echo "- âœ… **$test_name**: PASSED" >> "$REPORT_FILE"
        return 0
    else
        echo -e "${RED}âŒ FAILED: $test_name${NC}"
        echo "- âŒ **$test_name**: FAILED" >> "$REPORT_FILE"
        return 1
    fi
}

# Main testing loop
while [ $ITERATION -le $MAX_ITERATIONS ]; do
    echo ""
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}   ITERATION $ITERATION of $MAX_ITERATIONS${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""

    echo "### Iteration $ITERATION" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"

    FAILED_TESTS=0
    PASSED_TESTS=0

    # Test Suite 1: Comprehensive Platform Tests
    if run_test_suite "Comprehensive Platform Tests" "comprehensive-platform-test.spec.ts"; then
        ((PASSED_TESTS++))
    else
        ((FAILED_TESTS++))
    fi

    echo ""

    # Test Suite 2: ZEREZ Import Validation
    if run_test_suite "ZEREZ Import Validation" "zerez-import-validation.spec.ts"; then
        ((PASSED_TESTS++))
    else
        ((FAILED_TESTS++))
    fi

    echo ""

    # Test Suite 3: PDF Extraction Tests
    if run_test_suite "PDF Extraction Tests" "pdf-extraction-test.spec.ts"; then
        ((PASSED_TESTS++))
    else
        ((FAILED_TESTS++))
    fi

    echo ""

    # Summary for this iteration
    echo "" >> "$REPORT_FILE"
    echo "**Results:** $PASSED_TESTS passed, $FAILED_TESTS failed" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}   Iteration $ITERATION Summary${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo -e "  ${GREEN}Passed: $PASSED_TESTS${NC}"
    echo -e "  ${RED}Failed: $FAILED_TESTS${NC}"
    echo ""

    # Check if all tests passed
    if [ $FAILED_TESTS -eq 0 ]; then
        echo -e "${GREEN}ðŸŽ‰ ALL TESTS PASSED!${NC}"
        echo "" >> "$REPORT_FILE"
        echo "---" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "## âœ… Final Result: ALL TESTS PASSED" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "All test suites completed successfully on iteration $ITERATION." >> "$REPORT_FILE"

        # Generate HTML report
        npm run test:e2e:report

        exit 0
    fi

    # Increment iteration
    ((ITERATION++))

    if [ $ITERATION -le $MAX_ITERATIONS ]; then
        echo -e "${YELLOW}âš ï¸  Some tests failed. Retrying in 5 seconds...${NC}"
        sleep 5
    fi
done

# If we get here, tests failed after all iterations
echo ""
echo -e "${RED}âŒ TESTS FAILED AFTER $MAX_ITERATIONS ITERATIONS${NC}"
echo ""
echo "" >> "$REPORT_FILE"
echo "---" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "## âŒ Final Result: TESTS FAILED" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "Some tests failed after $MAX_ITERATIONS iterations. Review logs for details." >> "$REPORT_FILE"

echo "ðŸ“Š Test report saved to: $REPORT_FILE"
echo "ðŸ“‹ Individual logs saved to: $RESULTS_DIR/"
echo ""
echo "To view detailed results:"
echo "  npm run test:e2e:report"
echo ""

exit 1
