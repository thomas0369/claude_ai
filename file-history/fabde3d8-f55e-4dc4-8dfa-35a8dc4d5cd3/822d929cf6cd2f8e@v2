import { test, expect } from '@playwright/test';

/**
 * ZEREZ Import Automatic Enrichment Test
 *
 * Purpose: Verify that ZEREZ imports automatically enrich products with
 * efficiency and physical data, so dashboard displays complete values.
 *
 * This test validates the complete integration from import ‚Üí enrichment ‚Üí dashboard.
 */

test.describe('ZEREZ Import Automatic Enrichment', () => {
  test('should automatically enrich products during ZEREZ import', async ({ page }) => {
    console.log('\nüîÑ Testing automatic enrichment during ZEREZ import...\n');

    // Step 1: Navigate to ZEREZ import page
    console.log('üìç Step 1: Navigate to ZEREZ import page');
    await page.goto('/import/zerez');
    await page.waitForSelector('h1:has-text("ZEREZ Database Import")', { timeout: 30000 });
    console.log('‚úÖ ZEREZ import page loaded\n');

    // Step 2: Get current product count from database
    console.log('üìç Step 2: Check current product count');
    const beforeResponse = await page.request.get('/data/zerez/products.json');
    const beforeProducts = await beforeResponse.json();
    const beforeCount = beforeProducts.length;
    console.log(`‚úÖ Current database has ${beforeCount} products\n`);

    // Step 3: Configure filters for a small test import (just 3 products)
    console.log('üìç Step 3: Configure filters for test import');
    await page.selectOption('select#category-filter', 'STORAGE_INVERTER');
    console.log('‚úÖ Selected category: STORAGE_INVERTER');

    // Set power range to get fewer results (e.g., 125-130kW)
    await page.fill('input#power-min', '125');
    await page.fill('input#power-max', '130');
    console.log('‚úÖ Set power range: 125-130 kW');

    // Click preview button
    await page.click('button:has-text("Preview Products")');
    console.log('‚úÖ Clicked preview button\n');

    // Wait for preview results
    await page.waitForSelector('text=/Found \\d+ products/', { timeout: 60000 });
    const previewText = await page.locator('text=/Found \\d+ products/').textContent();
    const previewCount = parseInt(previewText?.match(/\\d+/)?.[0] || '0');
    console.log(`üìä Preview found ${previewCount} products to import\n`);

    // Skip if no products found
    if (previewCount === 0) {
      console.log('‚è≠Ô∏è  No products found in this range, skipping import test');
      return;
    }

    // Step 4: Select "Add" mode (to avoid overwriting existing data)
    console.log('üìç Step 4: Select import mode');
    await page.click('input[value="add"]');
    console.log('‚úÖ Selected "Add" mode (preserve existing products)\n');

    // Step 5: Execute import
    console.log('üìç Step 5: Execute import');
    await page.click('button:has-text("Import to Database")');
    console.log('üîÑ Import started...');

    // Wait for import success message (may take a while for GraphQL queries)
    await page.waitForSelector('text=/Successfully imported/', { timeout: 120000 });
    const successText = await page.locator('text=/Successfully imported/').textContent();
    console.log(`‚úÖ ${successText}\n`);

    // Step 6: Verify enrichment response
    console.log('üìç Step 6: Verify import response includes enrichment flag');
    // The API should have logged enrichment in console
    // We can check the response by looking at network traffic or logs

    // Step 7: Check imported products have enriched data
    console.log('üìç Step 7: Verify imported products are enriched');
    const afterResponse = await page.request.get('/data/zerez/products.json');
    const afterProducts = await afterResponse.json();
    const afterCount = afterProducts.length;

    console.log(`üìä Product count: ${beforeCount} ‚Üí ${afterCount} (${afterCount - beforeCount} added)`);
    expect(afterCount).toBeGreaterThan(beforeCount);
    console.log('‚úÖ Products were added to database\n');

    // Get the newly added products (last N products)
    const newProductsCount = afterCount - beforeCount;
    const newProducts = afterProducts.slice(-newProductsCount);

    console.log(`üîç Analyzing ${newProducts.length} newly imported products...`);

    // Check data quality of new products
    let enrichedEfficiency = 0;
    let enrichedPhysical = 0;
    let hasBenchmarks = 0;
    let hasCompetitive = 0;

    for (const product of newProducts) {
      // Check efficiency enrichment
      if (product.efficiency && product.efficiency.peak_percent) {
        enrichedEfficiency++;
      }

      // Check physical enrichment
      if (product.physical && product.physical.weight_kg) {
        enrichedPhysical++;
      }

      // Check benchmarks
      if (product.benchmarks) {
        hasBenchmarks++;
      }

      // Check competitive data
      if (product.competitive) {
        hasCompetitive++;
      }
    }

    console.log(`\nüìä Enrichment Quality of New Products:`);
    console.log(`  - Efficiency enriched: ${enrichedEfficiency}/${newProducts.length} (${((enrichedEfficiency/newProducts.length)*100).toFixed(0)}%)`);
    console.log(`  - Physical enriched: ${enrichedPhysical}/${newProducts.length} (${((enrichedPhysical/newProducts.length)*100).toFixed(0)}%)`);
    console.log(`  - Benchmarks added: ${hasBenchmarks}/${newProducts.length} (${((hasBenchmarks/newProducts.length)*100).toFixed(0)}%)`);
    console.log(`  - Competitive data: ${hasCompetitive}/${newProducts.length} (${((hasCompetitive/newProducts.length)*100).toFixed(0)}%)`);

    // Assert: All new products should be fully enriched
    expect(enrichedEfficiency).toBe(newProducts.length);
    expect(enrichedPhysical).toBe(newProducts.length);
    expect(hasBenchmarks).toBe(newProducts.length);
    expect(hasCompetitive).toBe(newProducts.length);

    console.log('\n‚úÖ ALL new products are fully enriched!\n');

    // Step 8: Verify sample product structure
    console.log('üìç Step 8: Verify sample product structure');
    const sampleProduct = newProducts[0];
    console.log(`\nüìã Sample Imported Product:`);
    console.log(`  Model: ${sampleProduct.identification?.model}`);
    console.log(`  Manufacturer: ${sampleProduct.identification?.manufacturer}`);
    console.log(`  Power: ${sampleProduct.power?.rated_power_kw} kW`);
    console.log(`  Efficiency: ${sampleProduct.efficiency?.peak_percent}% (peak)`);
    console.log(`  Weight: ${sampleProduct.physical?.weight_kg} kg`);
    console.log(`  Dimensions: ${sampleProduct.physical?.width_mm}√ó${sampleProduct.physical?.height_mm}√ó${sampleProduct.physical?.depth_mm} mm`);
    console.log(`  Power Density: ${sampleProduct.power_density?.toFixed(1)} kW/m¬≥`);
    console.log(`  Market Position: ${sampleProduct.competitive?.market_position}`);
    console.log(`  Data Source: ${sampleProduct.data_source?.source}`);

    // Assert: Sample product has all required fields
    expect(sampleProduct.efficiency?.peak_percent).toBeGreaterThan(0);
    expect(sampleProduct.physical?.weight_kg).toBeGreaterThan(0);
    expect(sampleProduct.power_density).toBeGreaterThan(0);
    expect(sampleProduct.competitive?.market_position).toBeTruthy();

    console.log('\n‚úÖ Sample product has complete enriched data\n');

    // Step 9: Verify dashboard shows new data correctly
    console.log('üìç Step 9: Verify dashboard displays new enriched products');
    await page.goto('/dashboard');
    await page.waitForSelector('h1:has-text("C&I BESS Competition Analytics Platform")');

    // Check KPI cards are not showing N/A
    const avgEfficiency = await page.locator('p:has-text("Avg Efficiency")').locator('..').locator('p').nth(1).textContent();
    const avgPowerDensity = await page.locator('p:has-text("Avg Power Density")').locator('..').locator('p').nth(1).textContent();

    console.log(`\nüìä Dashboard KPIs:`);
    console.log(`  - Avg Efficiency: ${avgEfficiency}`);
    console.log(`  - Avg Power Density: ${avgPowerDensity}`);

    expect(avgEfficiency).not.toContain('N/A');
    expect(avgEfficiency).not.toContain('0.00%');
    expect(avgPowerDensity).not.toContain('N/A');

    console.log('\n‚úÖ Dashboard KPIs display complete data\n');

    // Step 10: Verify Product Analysis table has no N/A values
    console.log('üìç Step 10: Verify Product Analysis table');
    await page.waitForSelector('table tbody tr', { timeout: 10000 });

    const firstRow = await page.locator('table tbody tr').first();
    const cells = await firstRow.locator('td').allTextContents();
    const naCells = cells.filter(cell => cell.trim() === 'N/A').length;

    console.log(`üìä First row in Product Analysis table:`);
    console.log(`  - Total cells: ${cells.length}`);
    console.log(`  - Cells with "N/A": ${naCells}`);

    // We allow some N/A for optional fields (like dimensions if not enriched)
    // But efficiency, weight, and power density should never be N/A
    expect(naCells).toBeLessThan(cells.length / 2); // Less than 50% N/A

    console.log('\n‚úÖ Product Analysis table shows mostly complete data\n');

    console.log('üéâ AUTOMATIC ENRICHMENT INTEGRATION TEST PASSED!\n');
    console.log('‚úÖ ZEREZ imports now automatically enrich products');
    console.log('‚úÖ Dashboard displays complete data without manual intervention');
    console.log('‚úÖ No need to run enrichment script manually anymore\n');
  });

  test('should show enrichment status in import response', async ({ page, request }) => {
    console.log('\nüîç Testing enrichment status in API response...\n');

    // Create a minimal test import via API
    const testProduct = {
      id: 'test-enrichment-' + Date.now(),
      modelName: 'Test Product for Enrichment',
      manufacturerName: 'Test Manufacturer',
      ratedActivePower: 100,
      maxActivePower: 110,
      ratedVoltage: 400,
      ratedCurrent: 145,
    };

    const response = await request.post('/api/zerez/import-to-database', {
      data: {
        products: [testProduct],
        mode: 'add',
      },
    });

    expect(response.ok()).toBeTruthy();

    const result = await response.json();
    console.log('üìä Import API Response:', JSON.stringify(result, null, 2));

    // Verify response indicates enrichment
    expect(result.success).toBe(true);
    expect(result.enriched).toBe(true); // NEW: API should indicate enrichment happened
    expect(result.added).toBeGreaterThanOrEqual(1);

    console.log('\n‚úÖ Import API response includes enrichment flag');
    console.log('‚úÖ Enriched: true\n');
  });
});
