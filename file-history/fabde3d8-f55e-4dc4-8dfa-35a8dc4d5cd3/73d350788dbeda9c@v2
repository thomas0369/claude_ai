/**
 * Shared Validation Schemas for Product Editing
 *
 * These schemas are used on both client and server to ensure consistent validation.
 * Prevents the critical issue where client validation differs from server validation.
 */

import { z } from 'zod';

/**
 * Field-specific validation schemas
 * Each editable field has strict validation rules based on physical constraints
 */
export const FIELD_VALIDATORS = {
  // Efficiency fields (percentages: 0-100%)
  'efficiency.peak_percent': z.number().min(0, 'Efficiency cannot be negative').max(100, 'Efficiency cannot exceed 100%'),
  'efficiency.euro_percent': z.number().min(0, 'Efficiency cannot be negative').max(100, 'Efficiency cannot exceed 100%'),
  'efficiency.cec_percent': z.number().min(0, 'Efficiency cannot be negative').max(100, 'Efficiency cannot exceed 100%'),
  'efficiency.weighted_efficiency': z.number().min(0).max(100),

  // Power fields (kW: positive, reasonable max 10MW)
  'power.rated_power_kw': z.number().positive('Power must be positive').max(10000, 'Power exceeds reasonable limit (10MW)'),
  'power.max_power_kw': z.number().positive('Power must be positive').max(10000, 'Power exceeds reasonable limit (10MW)'),
  'power.standby_power_w': z.number().min(0, 'Standby power cannot be negative').max(10000, 'Standby power too high'),
  'power.power_factor': z.number().min(0).max(1, 'Power factor must be between 0 and 1'),

  // Physical dimensions (mm: positive, reasonable max 10 meters)
  'physical.weight_kg': z.number().positive('Weight must be positive').max(50000, 'Weight exceeds reasonable limit (50 tons)'),
  'physical.width_mm': z.number().positive('Width must be positive').max(10000, 'Width exceeds reasonable limit (10m)'),
  'physical.height_mm': z.number().positive('Height must be positive').max(10000, 'Height exceeds reasonable limit (10m)'),
  'physical.depth_mm': z.number().positive('Depth must be positive').max(10000, 'Depth exceeds reasonable limit (10m)'),
  'physical.volume_l': z.number().positive().max(1000000, 'Volume exceeds reasonable limit'),
  'physical.ip_rating': z.number().int('IP rating must be an integer').min(0).max(69, 'IP rating must be 0-69 (e.g., IP65)'),

  // Electrical parameters
  'electrical.max_dc_voltage_v': z.number().positive('Voltage must be positive').max(2000, 'DC voltage exceeds typical limit (2000V)'),
  'electrical.min_dc_voltage_v': z.number().positive('Voltage must be positive').max(2000, 'DC voltage exceeds typical limit (2000V)'),
  'electrical.mppt_count': z.number().int('MPPT count must be an integer').min(1).max(20, 'MPPT count exceeds typical limit'),
  'electrical.max_input_current_a': z.number().positive().max(1000, 'Current exceeds typical limit (1000A)'),
  'electrical.thd_percent': z.number().min(0, 'THD cannot be negative').max(100, 'THD cannot exceed 100%'),
  'electrical.frequency_hz': z.number().min(45).max(65, 'Frequency must be 45-65 Hz (typical grid range)'),

  // Environmental parameters
  'environmental.temp_min_c': z.number().min(-273.15, 'Temperature below absolute zero').max(200, 'Operating temperature too high'),
  'environmental.temp_max_c': z.number().min(-273.15, 'Temperature below absolute zero').max(200, 'Operating temperature too high'),
  'environmental.humidity_max_percent': z.number().min(0).max(100, 'Humidity must be 0-100%'),
  'environmental.altitude_max_m': z.number().min(0, 'Altitude cannot be negative').max(10000, 'Altitude exceeds typical limit'),
  'environmental.noise_level_db': z.number().min(0).max(150, 'Noise level exceeds safe human threshold'),

  // Battery parameters
  'battery.capacity_kwh': z.number().positive('Capacity must be positive').max(10000, 'Capacity exceeds typical limit (10MWh)'),
  'battery.voltage_v': z.number().positive().max(2000),
  'battery.dod_percent': z.number().min(0).max(100, 'DoD must be 0-100%'),
  'battery.cycle_life': z.number().int().positive().max(100000, 'Cycle life exceeds typical limit'),

  // Warranty
  'warranty.years': z.number().int().positive().max(50, 'Warranty period exceeds typical limit'),
  'warranty.performance_guarantee_percent': z.number().min(0).max(100),

  // Data source metadata (editable for validation workflow)
  'data_source.validation_status': z.enum(['passed', 'needs_review', 'failed']),
  'data_source.confidence_level': z.number().min(0).max(100),
  'data_source.data_quality_score': z.number().min(0).max(100),
  'data_source.completeness_percent': z.number().min(0).max(100),
} as const;

/**
 * Type-safe field path type
 * Ensures only valid fields can be edited
 */
export type EditableFieldPath = keyof typeof FIELD_VALIDATORS;

/**
 * Get all editable field paths
 */
export function getEditableFields(): EditableFieldPath[] {
  return Object.keys(FIELD_VALIDATORS) as EditableFieldPath[];
}

/**
 * Validate a field value against its schema
 * Returns validation result with error details
 */
export function validateFieldValue(
  field: string,
  value: unknown
): { success: boolean; error?: string; data?: number | string } {
  const validator = FIELD_VALIDATORS[field as EditableFieldPath];

  if (!validator) {
    return {
      success: false,
      error: `Unknown field: ${field}. This field is not editable.`,
    };
  }

  const result = validator.safeParse(value);

  if (!result.success) {
    return {
      success: false,
      error: result.error.issues[0]?.message || 'Validation failed',
    };
  }

  return {
    success: true,
    data: result.data,
  };
}

/**
 * Get human-readable validation hint for a field
 * Used in UI tooltips and error messages
 */
export function getFieldValidationHint(field: string): string {
  const hints: Record<string, string> = {
    'efficiency.peak_percent': 'Peak efficiency: 0-100%',
    'efficiency.euro_percent': 'Euro efficiency: 0-100%',
    'efficiency.cec_percent': 'CEC efficiency: 0-100%',
    'power.rated_power_kw': 'Rated power: 1-10,000 kW',
    'power.max_power_kw': 'Max power: 1-10,000 kW',
    'power.standby_power_w': 'Standby power: 0-10,000 W',
    'physical.weight_kg': 'Weight: 1-50,000 kg',
    'physical.width_mm': 'Width: 1-10,000 mm',
    'physical.height_mm': 'Height: 1-10,000 mm',
    'physical.depth_mm': 'Depth: 1-10,000 mm',
    'physical.ip_rating': 'IP rating: 0-69 (e.g., IP65)',
    'electrical.max_dc_voltage_v': 'Max DC voltage: 1-2,000 V',
    'electrical.mppt_count': 'MPPT count: 1-20',
    'electrical.thd_percent': 'Total Harmonic Distortion: 0-100%',
    'environmental.temp_min_c': 'Min temperature: -273.15 to 200°C',
    'environmental.temp_max_c': 'Max temperature: -273.15 to 200°C',
    'environmental.humidity_max_percent': 'Max humidity: 0-100%',
    'battery.capacity_kwh': 'Battery capacity: 1-10,000 kWh',
    'battery.dod_percent': 'Depth of Discharge: 0-100%',
    'warranty.years': 'Warranty period: 1-50 years',
    'data_source.validation_status': 'Status: passed, needs_review, or failed',
    'data_source.confidence_level': 'Confidence: 0-100',
  };

  return hints[field] || 'Double-click to edit';
}

/**
 * Check if a field accepts numeric values
 */
export function isNumericField(field: string): boolean {
  const validator = FIELD_VALIDATORS[field as EditableFieldPath];
  if (!validator) return false;

  // All current validators are numeric except validation_status
  return field !== 'data_source.validation_status';
}

/**
 * Get the expected type for a field
 */
export function getFieldType(field: string): 'number' | 'string' | 'enum' | 'unknown' {
  if (!FIELD_VALIDATORS[field as EditableFieldPath]) {
    return 'unknown';
  }

  if (field === 'data_source.validation_status') {
    return 'enum';
  }

  return 'number';
}
