/**
 * E2E Tests for Edit Workflow
 *
 * Tests the complete edit workflow including:
 * - Dashboard loading
 * - Permission system (ZEREZ locked, PDF editable)
 * - Inline editing UI
 * - Server-side validation
 * - Optimistic updates
 */

import { test, expect } from '@playwright/test';

test.describe('Dashboard Edit Workflow', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('http://localhost:3000/dashboard');
    await page.waitForLoadState('networkidle');
  });

  test('dashboard loads without errors', async ({ page }) => {
    // Verify page title
    await expect(page).toHaveTitle(/C&I BESS/);

    // Verify table is present
    const table = page.locator('table');
    await expect(table).toBeVisible();

    // Verify at least one row exists (ZEREZ products)
    const rows = page.locator('tbody tr');
    const count = await rows.count();
    expect(count).toBeGreaterThan(0);
  });

  test('data source column displays badges correctly', async ({ page }) => {
    // Wait for table to load
    await page.waitForSelector('tbody tr');

    // Find Data Source column header
    const headers = page.locator('thead th');
    const dataSourceHeader = headers.filter({ hasText: 'Data Source' });
    await expect(dataSourceHeader).toBeVisible();

    // Check for ZEREZ badges (all current products are ZEREZ)
    const zerezBadges = page.locator('text=ZEREZ');
    const badgeCount = await zerezBadges.count();
    expect(badgeCount).toBeGreaterThan(0);

    // Verify badge styling (should have red/lock indicator)
    const firstBadge = zerezBadges.first();
    await expect(firstBadge).toHaveClass(/bg-red|text-red/);
  });

  test('efficiency cells are editable visually', async ({ page }) => {
    // Find efficiency column
    await page.waitForSelector('tbody tr');

    // Get first efficiency cell
    const efficiencyCell = page.locator('tbody tr:first-child td').filter({ hasText: /\d+\.\d+%/ }).first();

    // Hover to see edit indicator
    await efficiencyCell.hover();

    // Check for edit cursor or icon
    const cellStyle = await efficiencyCell.evaluate(el => window.getComputedStyle(el).cursor);
    expect(cellStyle).toBe('pointer');
  });

  test('double-click on ZEREZ efficiency shows permission error', async ({ page }) => {
    await page.waitForSelector('tbody tr');

    // Find first efficiency cell (should be ZEREZ product)
    const efficiencyCell = page.locator('tbody tr:first-child').locator('td').filter({ hasText: /\d+\.\d+%/ }).first();

    // Double-click to trigger edit mode
    await efficiencyCell.dblclick();

    // Wait for error toast/message
    const errorToast = page.locator('text=/ZEREZ.*cannot.*edit/i');
    await expect(errorToast).toBeVisible({ timeout: 2000 });

    // Verify error message content
    await expect(errorToast).toContainText('ZEREZ');
    await expect(errorToast).toContainText(/cannot|read-only|forbidden/i);
  });

  test('EditableCell component renders correctly', async ({ page }) => {
    await page.waitForSelector('tbody tr');

    // Find efficiency cell
    const efficiencyCell = page.locator('tbody tr:first-child').locator('td').filter({ hasText: /\d+\.\d+%/ }).first();

    // Get current value
    const currentValue = await efficiencyCell.textContent();
    expect(currentValue).toMatch(/\d+\.\d+%/);

    // Verify tooltip exists (permission hint)
    await efficiencyCell.hover();
    const tooltip = page.locator('[role="tooltip"]');
    // Tooltip might appear, but not required for ZEREZ products
  });

  test('API returns 403 for ZEREZ product edit attempt', async ({ page, request }) => {
    // Load dashboard to get product ID
    await page.goto('http://localhost:3000/dashboard');
    await page.waitForLoadState('networkidle');

    // Get first product's ZEREZ ID from data attribute or text
    const firstRow = page.locator('tbody tr:first-child');
    const productId = await firstRow.getAttribute('data-product-id') ||
                      await page.evaluate(() => {
                        const products = (window as any).__NEXT_DATA__?.props?.pageProps?.products;
                        return products?.[0]?.identification?.zerez_id;
                      });

    // Attempt to edit via API
    const response = await request.post('http://localhost:3000/api/products/edit', {
      data: {
        productId: productId || 'test-zerez-id',
        field: 'efficiency.peak_percent',
        newValue: 99.5
      }
    });

    // Verify 403 Forbidden response
    expect(response.status()).toBe(403);

    const body = await response.json();
    expect(body.error).toMatch(/FORBIDDEN|forbidden/i);
    expect(body.message).toContain('ZEREZ');
  });

  test('API validates field names', async ({ page, request }) => {
    const response = await request.post('http://localhost:3000/api/products/edit', {
      data: {
        productId: 'test-id',
        field: 'invalid.field.name',
        newValue: 123
      }
    });

    expect(response.status()).toBe(400);

    const body = await response.json();
    expect(body.error).toMatch(/Invalid|validation/i);
  });

  test('API validates field values', async ({ page, request }) => {
    // Attempt to set efficiency > 100%
    const response = await request.post('http://localhost:3000/api/products/edit', {
      data: {
        productId: 'test-id',
        field: 'efficiency.peak_percent',
        newValue: 150 // Invalid - exceeds 100%
      }
    });

    // Should fail validation (400 or 403 depending on permissions)
    expect(response.status()).toBeGreaterThanOrEqual(400);

    const body = await response.json();
    expect(body.error || body.message).toMatch(/100%|exceed|invalid/i);
  });
});

test.describe('PDF Product Editing (Future)', () => {
  test.skip('PDF product efficiency cell is editable', async ({ page }) => {
    // This test will pass once a PDF product is imported
    await page.goto('http://localhost:3000/dashboard');

    // Find PDF product row (badge shows "PDF")
    const pdfRow = page.locator('tbody tr').filter({ hasText: 'PDF' }).first();
    await expect(pdfRow).toBeVisible();

    // Find efficiency cell
    const efficiencyCell = pdfRow.locator('td').filter({ hasText: /\d+\.\d+%/ }).first();

    // Double-click to enter edit mode
    await efficiencyCell.dblclick();

    // Verify input appears
    const input = page.locator('input[type="number"]');
    await expect(input).toBeVisible();
    await expect(input).toBeFocused();
  });

  test.skip('editing PDF product efficiency saves correctly', async ({ page }) => {
    await page.goto('http://localhost:3000/dashboard');

    // Find PDF product
    const pdfRow = page.locator('tbody tr').filter({ hasText: 'PDF' }).first();
    const efficiencyCell = pdfRow.locator('td').filter({ hasText: /\d+\.\d+%/ }).first();

    // Get original value
    const originalValue = await efficiencyCell.textContent();

    // Enter edit mode
    await efficiencyCell.dblclick();
    const input = page.locator('input[type="number"]');

    // Change value
    await input.fill('96.5');
    await input.press('Enter');

    // Wait for save (either page reload or optimistic update)
    await page.waitForTimeout(1000);

    // Verify new value appears
    const updatedValue = await efficiencyCell.textContent();
    expect(updatedValue).toContain('96.5');
    expect(updatedValue).not.toBe(originalValue);

    // Verify success toast
    const successToast = page.locator('text=/success|updated/i');
    await expect(successToast).toBeVisible();
  });

  test.skip('edit validation prevents invalid values', async ({ page }) => {
    await page.goto('http://localhost:3000/dashboard');

    const pdfRow = page.locator('tbody tr').filter({ hasText: 'PDF' }).first();
    const efficiencyCell = pdfRow.locator('td').filter({ hasText: /\d+\.\d+%/ }).first();

    await efficiencyCell.dblclick();
    const input = page.locator('input[type="number"]');

    // Try to enter invalid value (>100%)
    await input.fill('150');
    await input.press('Enter');

    // Should show error toast
    const errorToast = page.locator('text=/100%|exceed|invalid/i');
    await expect(errorToast).toBeVisible();

    // Cell should not update
    await page.waitForTimeout(500);
    const cellValue = await efficiencyCell.textContent();
    expect(cellValue).not.toContain('150');
  });
});

test.describe('Performance & UX', () => {
  test('dashboard loads in under 3 seconds', async ({ page }) => {
    const startTime = Date.now();

    await page.goto('http://localhost:3000/dashboard');
    await page.waitForLoadState('networkidle');

    const loadTime = Date.now() - startTime;
    expect(loadTime).toBeLessThan(3000);
  });

  test('table renders all products', async ({ page }) => {
    await page.goto('http://localhost:3000/dashboard');
    await page.waitForSelector('tbody tr');

    const rows = page.locator('tbody tr');
    const count = await rows.count();

    // Should have 58 ZEREZ products
    expect(count).toBe(58);
  });

  test('no console errors on page load', async ({ page }) => {
    const consoleErrors: string[] = [];

    page.on('console', msg => {
      if (msg.type() === 'error') {
        consoleErrors.push(msg.text());
      }
    });

    await page.goto('http://localhost:3000/dashboard');
    await page.waitForLoadState('networkidle');

    // Should have no console errors
    expect(consoleErrors).toHaveLength(0);
  });
});
