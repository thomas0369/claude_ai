// Enhanced Type Definitions for World-Class Analytics Platform
// Version 2.0 - Comprehensive BESS Competition Analysis

/**
 * Raw product data structure as loaded from YAML files
 * Represents the exact structure before enrichment with competitive intelligence
 */
export interface RawProductData {
  identification: {
    model: string;
    zerez_id: string;
    manufacturer: string;
    zerez_variant_count?: number;
  };
  power: {
    rated_power_kw?: number;
    max_power_kw?: number;
    standby_power_w?: number;
  };
  efficiency: {
    peak_percent?: number;
    euro_percent?: number;
    cec_percent?: number;
  };
  physical: {
    weight_kg?: number;
    width_mm?: number;
    height_mm?: number;
    depth_mm?: number;
    ip_rating?: number;
    cooling?: string;
    mounting_type?: string;
  };
  electrical: {
    max_dc_voltage_v?: number;
    min_dc_voltage_v?: number;
    mppt_count?: number;
    max_input_current_a?: number;
    rated_ac_current_a?: number;  // AC output current from CSV
    thd_percent?: number;
  };
  environmental: {
    temp_min_c?: number;
    temp_max_c?: number;
    humidity_max_percent?: number;
    altitude_max_m?: number;
  };
  battery?: {
    type?: string;
    capacity_kwh?: number;
    voltage_v?: number;
    dod_percent?: number;
    cycle_life?: number;
  };
  warranty?: {
    years?: number;
    performance_guarantee_percent?: number;
  };
  data_source: {
    pdf_filename?: string;
    extraction_method: string;
    confidence_level: number;
    validation_status?: string;
    parsed_at: string;
  };
}

export interface EnhancedProductData {
  // Core Identification
  identification: {
    model: string;
    zerez_id: string;
    manufacturer: string;
    zerez_variant_count: number;
    product_family?: string;
    generation?: number;
  };

  // Technical Specifications
  power: {
    rated_power_kw?: number;
    max_power_kw?: number;
    standby_power_w?: number;
    power_factor?: number;
  };

  efficiency: {
    peak_percent?: number;
    euro_percent?: number;
    cec_percent?: number;
    weighted_efficiency?: number;
    efficiency_curve?: EfficiencyCurve[];
  };

  physical: {
    weight_kg?: number;
    width_mm?: number;
    height_mm?: number;
    depth_mm?: number;
    volume_l?: number;
    ip_rating?: number;
    cooling?: string;
    mounting_type?: string;
  };

  electrical: {
    max_dc_voltage_v?: number;
    min_dc_voltage_v?: number;
    mppt_count?: number;
    max_input_current_a?: number;
    thd_percent?: number;
    output_voltage_range?: string;
    frequency_hz?: number;
  };

  environmental: {
    temp_min_c?: number;
    temp_max_c?: number;
    humidity_max_percent?: number;
    altitude_max_m?: number;
    noise_level_db?: number;
  };

  battery: {
    type?: string;
    capacity_kwh?: number;
    voltage_v?: number;
    dod_percent?: number;
    cycle_life?: number;
    chemistry?: string;
  };

  certifications: {
    zerez_certifications: ZerezCertification[];
    safety_standards: string[];
    grid_codes: string[];
    regional_compliance: string[];
    ce_marking?: boolean;
    ul_certified?: boolean;
  };

  warranty: {
    years?: number;
    performance_guarantee_percent?: number;
    extension_available?: boolean;
  };

  // Competitive Intelligence (NEW)
  competitive: {
    market_position: 'leader' | 'challenger' | 'innovator' | 'follower';
    price_index: number; // vs market average (1.0 = average)
    innovation_score: number; // 0-100
    market_share_estimate_percent: number;
    unique_selling_points: string[];
    technology_advantages: string[];
  };

  // Pre-calculated Power Density Metrics (NEW - Added for CSV import)
  volume_m3?: number | null;        // Calculated from dimensions (length × width × height)
  power_to_weight?: number | null;  // Calculated as power/weight (kW/kg)
  power_density?: number | null;    // Calculated as power/volume (kW/m³)
  efficiency_percentile?: number | null;  // Relative ranking 0-100

  // Performance Benchmarks (NEW)
  benchmarks: {
    efficiency_percentile: number; // 0-100
    power_density_rank: number; // lower is better
    cost_efficiency_score: number; // 0-100
    reliability_score: number; // 0-100
    overall_rank: number;
    comparison_vs_avg: {
      efficiency_delta: number;
      power_delta: number;
      weight_delta: number;
    };
  };

  // Time Series Data (NEW)
  certification_timeline: {
    zerez_certification_dates: Date[];
    standard_versions: string[];
    recertification_count: number;
    first_certification_date?: Date;
    latest_certification_date?: Date;
    certification_velocity: number; // certs per year
  };

  // AI-Generated Insights (NEW)
  insights: {
    strengths: string[];
    weaknesses: string[];
    market_opportunities: string[];
    risk_factors: string[];
    competitive_threats: string[];
    recommendation_score: number; // 0-100
    confidence_level: number; // 0-100
  };

  // Data Provenance
  data_source: {
    pdf_filename?: string;
    extraction_method: 'pdfplumber' | 'camelot' | 'text' | 'gemini_vision' | 'claude_vision' | 'graphql_import' | 'manual';
    confidence_level: number;
    validation_status?: 'passed' | 'needs_review' | 'failed';
    parsed_at: string;
    last_updated: string;
    data_quality_score: number;
    completeness_percent: number;
    source?: string; // Source identifier (e.g., 'zerez', 'pdf_upload')
  };

  // Market Data (NEW)
  market: {
    launch_date?: Date;
    end_of_life_date?: Date;
    market_status: 'active' | 'discontinued' | 'upcoming';
    target_markets: string[];
    competitor_products: string[];
    pricing_tier: 'budget' | 'mid-range' | 'premium';
  };
}

export interface EfficiencyCurve {
  load_percent: number;
  efficiency_percent: number;
}

export interface ZerezCertification {
  zerez_id: string;
  certification_date: Date;
  expiry_date?: Date;
  status: 'valid' | 'expired' | 'pending';
  norm: string;
  certification_body: string;
  grid_code: string;
  restrictions?: string;
  unit_number?: string;
}

export interface CompanyData {
  name: string;
  country: string;
  headquarters: {
    city: string;
    country: string;
    coordinates?: [number, number]; // [lng, lat]
  };
  founded_year?: number;
  employee_count?: number;
  revenue_usd?: number;
  product_count: number;
  zerez_variant_count: number;
  market_presence: string[];
  technology_focus: string[];
  products: EnhancedProductSummary[];
  competitive_analysis: {
    market_position: 'leader' | 'challenger' | 'innovator' | 'follower';
    innovation_index: number;
    market_share_percent: number;
    growth_rate_percent: number;
    strengths: string[];
    weaknesses: string[];
  };
}

export interface EnhancedProductSummary {
  model: string;
  zerez_id: string;
  power_kw: number;
  efficiency_peak: number;
  pdf_source: string;
  extraction_method: string;
  confidence: number;
  market_position: string;
  certification_count: number;
}

export interface BenchmarkRow {
  filename: string;
  manufacturer: string;
  model_from_filename: string;
  zerez_id: string;
  zerez_model: string;
  zerez_power_kw: number;
  zerez_match_count: number;
  extraction_method: string;
  confidence_level: number;
  validation_status: string;
  parsed_at: string;

  // Technical specs
  efficiency_peak?: number;
  efficiency_euro?: number;
  efficiency_cec?: number;
  weight?: number;
  width_mm?: number;
  height_mm?: number;
  depth_mm?: number;
  ip_rating?: number;
  max_dc_voltage?: number;
  mppt_count?: number;
  thd?: number;
  temp_min?: number;
  temp_max?: number;
  cooling?: string;
  warranty?: number;

  // Enhanced metrics
  power_density?: number; // kW/kg
  efficiency_score?: number;
  market_position?: string;
  competitive_rank?: number;
}

export interface ZerezEntry {
  zerez_id: string;
  zerez_id_unit?: string;
  model: string;
  manufacturer: string;
  norm: string;
  max_power_kw: number;
  rated_power_kw: number;
  rated_voltage_v: number;
  certification_date: Date;
  certification_status: 'valid' | 'verified' | 'expired';
  certification_body: string;
  grid_code?: string;
  restrictions?: string;
  uploaded_date?: Date;
  validity?: string;
  software_version?: string;

  // Technical parameters
  initial_short_circuit_current?: number;
  flicker_coefficients?: {
    cpsi_30deg?: number;
    cpsi_50deg?: number;
    cpsi_70deg?: number;
    cpsi_85deg?: number;
  };

  // Additional metadata
  primary_energy_source?: string;
  equipment_category?: string;
  documentation_link?: string;
}

// Statistical Analysis Types
export interface StatisticalSummary {
  mean: number;
  median: number;
  mode: number;
  stdDev: number;
  variance: number;
  min: number;
  max: number;
  q1: number;
  q3: number;
  iqr: number;
  outliers: number[];
  count: number;
}

export interface CorrelationMatrix {
  variables: string[];
  matrix: number[][];
  pValues: number[][];
  significantPairs: Array<{
    var1: string;
    var2: string;
    correlation: number;
    pValue: number;
  }>;
}

export interface TrendAnalysis {
  trend: 'increasing' | 'decreasing' | 'stable';
  slope: number;
  r_squared: number;
  forecast: Array<{
    date: Date;
    value: number;
    confidence_lower: number;
    confidence_upper: number;
  }>;
  seasonality_detected: boolean;
  anomalies: Array<{
    date: Date;
    value: number;
    expected: number;
    deviation: number;
  }>;
}

// Filter System Types
export interface GlobalFilters {
  dateRange: {
    start: Date | null;
    end: Date | null;
  };
  powerRange: {
    min: number;
    max: number;
  };
  manufacturers: string[];
  efficiencyThreshold: number;
  certificationStatus: ('valid' | 'expired' | 'pending')[];
  marketPosition: ('leader' | 'challenger' | 'innovator' | 'follower')[];
  searchQuery: string;
}

export interface SavedView {
  id: string;
  name: string;
  description: string;
  filters: GlobalFilters;
  activeCharts: string[];
  createdAt: Date;
  updatedAt: Date;
  shared: boolean;
}

// Chart Configuration Types

/**
 * Generic chart data point for flexible visualization
 */
export type ChartDataPoint = {
  x: string | number | Date;
  y: number;
  [key: string]: string | number | Date | boolean | null | undefined;
};

/**
 * ECharts-specific options type
 * Represents common ECharts configuration structure
 */
export interface EChartsOptions {
  title?: { text?: string; [key: string]: unknown };
  legend?: Record<string, unknown>;
  tooltip?: Record<string, unknown>;
  xAxis?: Record<string, unknown>;
  yAxis?: Record<string, unknown>;
  series?: Array<Record<string, unknown>>;
  grid?: Record<string, unknown>;
  [key: string]: unknown;
}

export interface ChartConfig {
  type: 'line' | 'bar' | 'scatter' | 'heatmap' | 'radar' | 'sankey' | 'network' | 'map';
  title: string;
  data: ChartDataPoint[] | EnhancedProductData[];
  xAxis?: string;
  yAxis?: string;
  groupBy?: string;
  colorBy?: string;
  sizeBy?: string;
  filters?: Partial<GlobalFilters>;
  customOptions?: EChartsOptions | Record<string, unknown>;
}

// Export Types
export interface ExportOptions {
  format: 'csv' | 'json' | 'xlsx' | 'pdf' | 'pptx';
  includeCharts: boolean;
  includeSummary: boolean;
  dateRange?: { start: Date; end: Date };
  selectedData?: string[];
}

// AI Insights Types
export interface AIInsight {
  id: string;
  type: 'opportunity' | 'threat' | 'trend' | 'anomaly' | 'recommendation';
  title: string;
  description: string;
  confidence: number;
  impact: 'high' | 'medium' | 'low';
  affectedProducts: string[];
  affectedManufacturers: string[];
  timestamp: Date;
  actionable: boolean;
  actions?: string[];
}

export interface NLQueryResult {
  query: string;
  interpretation: string;
  filters: Partial<GlobalFilters>;
  results: EnhancedProductData[];
  chartSuggestion?: ChartConfig;
  confidence: number;
}

// Dashboard Types

/**
 * Specific configuration types for each widget type
 */
export interface KPIWidgetConfig {
  metric: string;
  value: number;
  change?: number;
  trend?: 'up' | 'down' | 'stable';
  format?: 'number' | 'percentage' | 'currency';
}

export interface TableWidgetConfig {
  columns: Array<{ field: string; header: string; width?: number }>;
  data: EnhancedProductData[];
  sortable?: boolean;
  filterable?: boolean;
}

export interface InsightWidgetConfig {
  insights: AIInsight[];
  maxDisplay?: number;
  filterByType?: AIInsight['type'][];
}

export interface FilterWidgetConfig {
  filters: Partial<GlobalFilters>;
  onFilterChange?: (filters: Partial<GlobalFilters>) => void;
}

/**
 * Discriminated union for type-safe widget configs
 */
export type WidgetConfig =
  | { type: 'chart'; config: ChartConfig }
  | { type: 'kpi'; config: KPIWidgetConfig }
  | { type: 'table'; config: TableWidgetConfig }
  | { type: 'insight'; config: InsightWidgetConfig }
  | { type: 'filter'; config: FilterWidgetConfig };

export interface DashboardLayout {
  id: string;
  name: string;
  widgets: DashboardWidget[];
  layout: 'grid' | 'flex' | 'masonry';
  theme: 'light' | 'dark';
}

export interface DashboardWidget {
  id: string;
  type: 'chart' | 'kpi' | 'table' | 'insight' | 'filter';
  position: { x: number; y: number; w: number; h: number };
  config: ChartConfig | KPIWidgetConfig | TableWidgetConfig | InsightWidgetConfig | FilterWidgetConfig;
  refreshInterval?: number;
}

// Performance Metrics
export interface PerformanceMetrics {
  loadTime: number;
  renderTime: number;
  dataPointsRendered: number;
  memoryUsage: number;
  cacheHitRate: number;
}
