/**
 * ZEREZ Table Validation Script
 *
 * This script validates the ZEREZ import table by:
 * 1. Fetching data from the API
 * 2. Loading the same data in the browser
 * 3. Extracting and comparing 10 products
 * 4. Verifying sticky columns work correctly
 * 5. Checking German technical field headers
 */

const { chromium } = require('playwright');

async function validateTable() {
  console.log('\n═══════════════════════════════════════════════════════════════');
  console.log('  ZEREZ TABLE VALIDATION - Comparing API vs Browser Display');
  console.log('═══════════════════════════════════════════════════════════════\n');

  const browser = await chromium.launch({ headless: true });
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // Step 1: Fetch data from API
    console.log('Step 1: Fetching data from ZEREZ API...');
    const searchResponse = await page.request.post('http://localhost:3000/api/zerez/search', {
      data: {
        manufacturerName: 'Sungrow',
        page: 1,
        pageSize: 10
      }
    });

    const searchData = await searchResponse.json();
    const unitIds = searchData.units.slice(0, 10).map(u => u.id);
    console.log(`✓ Found ${unitIds.length} units from search API\n`);

    // Step 2: Get detailed data from API
    console.log('Step 2: Fetching detailed data from API...');
    const detailResponse = await page.request.post('http://localhost:3000/api/zerez/fetch-detailed', {
      data: { unitIds }
    });

    const detailData = await detailResponse.json();
    const apiUnits = detailData.units;
    console.log(`✓ Fetched detailed data for ${apiUnits.length} units`);
    console.log(`  - Total fields available: 75+`);
    console.log(`  - Units with data: ${apiUnits.length}\n`);

    // Step 3: Load same data in browser
    console.log('Step 3: Loading ZEREZ import page in browser...');
    await page.goto('http://localhost:3000/import/zerez', {
      waitUntil: 'networkidle',
      timeout: 60000
    });
    console.log('✓ Page loaded\n');

    // Step 4: Search for products
    console.log('Step 4: Searching for Sungrow products...');
    await page.fill('input[placeholder*="manufacturer"]', 'Sungrow');
    await page.click('button:has-text("Search")');
    await page.waitForSelector('text=found', { timeout: 30000 });
    console.log('✓ Search completed\n');

    // Step 5: Click preview to load detailed table
    console.log('Step 5: Loading preview table with detailed data...');
    const previewButton = page.locator('button:has-text("Preview")');
    await previewButton.click();

    // Wait for table to appear
    await page.waitForSelector('div.border.rounded-lg.overflow-hidden', { timeout: 30000 });
    await page.waitForTimeout(3000); // Give time for all data to render
    console.log('✓ Preview table loaded\n');

    // Step 6: Verify sticky columns exist
    console.log('Step 6: Verifying sticky column structure...');
    const stickyCheckbox = await page.locator('div.sticky.left-0 input[type="checkbox"]').first().isVisible();
    const stickyModelName = await page.locator('div.sticky.left-16').first().isVisible();

    console.log(`  Checkbox column (left-0): ${stickyCheckbox ? '✓' : '✗'}`);
    console.log(`  Model name column (left-16): ${stickyModelName ? '✓' : '✗'}`);

    if (!stickyCheckbox || !stickyModelName) {
      throw new Error('Sticky columns not found!');
    }
    console.log('✓ Both sticky columns present\n');

    // Step 7: Extract data from first 10 products
    console.log('Step 7: Extracting data from first 10 products...\n');
    console.log('─'.repeat(80));

    const rows = page.locator('div[role="row"]').filter({
      has: page.locator('div.sticky.left-16 span')
    });
    const rowCount = Math.min(await rows.count(), 10);
    console.log(`Found ${rowCount} product rows in browser\n`);

    const browserData = [];
    for (let i = 0; i < rowCount; i++) {
      const row = rows.nth(i);

      // Extract model name from sticky column
      const modelNameEl = row.locator('div.sticky.left-16 span');
      const modelName = await modelNameEl.textContent();

      // Extract scrollable columns
      const scrollableCols = row.locator('div.flex.items-stretch > div');
      const colCount = await scrollableCols.count();

      const manufacturer = colCount > 0 ? await scrollableCols.nth(0).textContent() : null;
      const maxActivePower = colCount > 1 ? await scrollableCols.nth(1).textContent() : null;
      const ratedActivePower = colCount > 2 ? await scrollableCols.nth(2).textContent() : null;

      const product = {
        index: i + 1,
        modelName: modelName?.trim() || 'N/A',
        manufacturer: manufacturer?.trim() || 'N/A',
        maxActivePower: maxActivePower?.trim() || 'N/A',
        ratedActivePower: ratedActivePower?.trim() || 'N/A',
        totalColumns: colCount
      };

      browserData.push(product);

      console.log(`Product ${i + 1}:`);
      console.log(`  Model: ${product.modelName}`);
      console.log(`  Manufacturer: ${product.manufacturer}`);
      console.log(`  Max Active Power: ${product.maxActivePower}`);
      console.log(`  Rated Active Power: ${product.ratedActivePower}`);
      console.log(`  Columns: ${product.totalColumns}`);
      console.log('─'.repeat(80));
    }

    // Step 8: Compare API vs Browser data
    console.log('\nStep 8: Comparing API vs Browser data...\n');
    console.log('─'.repeat(80));

    let matches = 0;
    let mismatches = 0;

    for (let i = 0; i < Math.min(apiUnits.length, browserData.length); i++) {
      const apiUnit = apiUnits[i];
      const browserUnit = browserData[i];

      const modelMatch = apiUnit.modelName === browserUnit.modelName;
      matches += modelMatch ? 1 : 0;
      mismatches += modelMatch ? 0 : 1;

      console.log(`Product ${i + 1}:`);
      console.log(`  API Model: ${apiUnit.modelName}`);
      console.log(`  Browser Model: ${browserUnit.modelName}`);
      console.log(`  Match: ${modelMatch ? '✓' : '✗'}`);

      if (apiUnit.maxActivePower !== null) {
        console.log(`  API Max Power: ${apiUnit.maxActivePower} kW`);
        console.log(`  Browser Max Power: ${browserUnit.maxActivePower}`);
      }

      console.log('─'.repeat(80));
    }

    // Step 9: Test sticky column behavior
    console.log('\nStep 9: Testing sticky column behavior during scroll...');

    const modelNameBefore = await page.locator('div.sticky.left-16').first().boundingBox();
    console.log(`  Model column X position before scroll: ${modelNameBefore?.x}px`);

    // Scroll horizontally
    const scrollContainer = page.locator('div.overflow-x-auto').nth(1);
    await scrollContainer.evaluate(el => el.scrollLeft = 500);
    await page.waitForTimeout(500);

    const modelNameAfter = await page.locator('div.sticky.left-16').first().boundingBox();
    console.log(`  Model column X position after scroll: ${modelNameAfter?.x}px`);

    const stickyWorks = modelNameBefore?.x === modelNameAfter?.x;
    console.log(`  Sticky behavior: ${stickyWorks ? '✓ PASS' : '✗ FAIL'}\n`);

    // Step 10: Verify German technical field headers
    console.log('Step 10: Checking German technical field headers...');
    const germanFields = [
      'Bemessungswirkleistung',
      'Bemessungsspannung',
      'Bemessungsstrom',
      'Stoßkurzschlussstrom'
    ];

    for (const field of germanFields) {
      const exists = await page.locator(`[role="columnheader"]:has-text("${field}")`).isVisible().catch(() => false);
      console.log(`  ${exists ? '✓' : '✗'} ${field}`);
    }

    // Final Summary
    console.log('\n═══════════════════════════════════════════════════════════════');
    console.log('  VALIDATION SUMMARY');
    console.log('═══════════════════════════════════════════════════════════════');
    console.log(`  Products validated: ${browserData.length}`);
    console.log(`  API vs Browser matches: ${matches}/${browserData.length}`);
    console.log(`  Mismatches: ${mismatches}`);
    console.log(`  Sticky columns working: ${stickyWorks ? 'YES' : 'NO'}`);
    console.log(`  Average columns per row: ${(browserData.reduce((sum, p) => sum + p.totalColumns, 0) / browserData.length).toFixed(1)}`);
    console.log('═══════════════════════════════════════════════════════════════\n');

    if (mismatches > 0) {
      console.log('⚠️  WARNING: Some products did not match between API and browser');
    } else if (matches === browserData.length && stickyWorks) {
      console.log('✅ SUCCESS: All validations passed!');
    }

  } catch (error) {
    console.error('\n❌ ERROR during validation:');
    console.error(error.message);
    console.error('\nStack trace:');
    console.error(error.stack);
    process.exit(1);
  } finally {
    await browser.close();
  }
}

// Run validation
validateTable().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
