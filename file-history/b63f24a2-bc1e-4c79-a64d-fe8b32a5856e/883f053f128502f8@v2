/**
 * Test Certificate Norms Multi-Select Filter
 * Tests the new certificate norms filter with Schneider Electric and Wanbang manufacturers
 */

const API_BASE = 'http://localhost:3000/api/zerez';

async function testCertificateNormsFilter() {
  console.log('='.repeat(80));
  console.log('CERTIFICATE NORMS MULTI-SELECT FILTER TESTS');
  console.log('='.repeat(80));
  console.log('');

  // Step 1: Get manufacturer IDs
  console.log('Step 1: Fetching manufacturer list...');
  const manufacturersResponse = await fetch(`${API_BASE}/manufacturers`);
  const manufacturers = await manufacturersResponse.json();

  const schneider = manufacturers.find(m => m.name.includes('Schneider Electric'));
  const wanbang = manufacturers.find(m => m.name.includes('Wanbang'));

  if (!schneider) {
    console.log('❌ Schneider Electric not found in manufacturer list');
    return;
  }
  if (!wanbang) {
    console.log('❌ Wanbang not found in manufacturer list');
    return;
  }

  console.log(`✅ Found Schneider Electric: ${schneider.name} (${schneider.id})`);
  console.log(`✅ Found Wanbang: ${wanbang.name} (${wanbang.id})`);
  console.log('');

  // Test 1: Schneider Electric - No certificate filter
  console.log('='.repeat(80));
  console.log('TEST 1: Schneider Electric - No Certificate Filter');
  console.log('Expected: All Schneider Electric products (should be ~7)');
  console.log('-'.repeat(80));

  const test1Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      manufacturerId: schneider.id,
      maxResults: 100
    })
  });
  const test1Data = await test1Response.json();

  if (test1Data.error) {
    console.log('❌ FAILED:', test1Data.error);
    console.log('   Details:', test1Data.message || test1Data.details);
  } else {
    console.log(`✅ SUCCESS: Found ${test1Data.units?.length || 0} products (total: ${test1Data.totalCount || 0})`);
    if (test1Data.units && test1Data.units.length > 0) {
      console.log('\n   Products found:');
      test1Data.units.forEach((unit, i) => {
        console.log(`   ${i + 1}. ${unit.manufacturerName} - ${unit.productName || unit.registrationNumber || 'Unknown'}`);
        if (unit.certificateNormIssueDateDescriptions) {
          console.log(`      Certificates: ${unit.certificateNormIssueDateDescriptions}`);
        }
      });
    }
  }
  console.log('');

  // Test 2: Schneider Electric - VDE-AR-N 4105 only
  console.log('='.repeat(80));
  console.log('TEST 2: Schneider Electric - VDE-AR-N 4105 Only');
  console.log('Expected: ~4 products with VDE-AR-N 4105 certification');
  console.log('-'.repeat(80));

  const test2Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      manufacturerId: schneider.id,
      certificateNorms: ['VDE-AR-N 4105'],
      maxResults: 100
    })
  });
  const test2Data = await test2Response.json();

  if (test2Data.error) {
    console.log('❌ FAILED:', test2Data.error);
    console.log('   Details:', test2Data.message || test2Data.details);
  } else {
    console.log(`✅ SUCCESS: Found ${test2Data.units?.length || 0} products (total: ${test2Data.totalCount || 0})`);
    if (test2Data.units && test2Data.units.length > 0) {
      console.log('\n   Products with VDE-AR-N 4105:');
      test2Data.units.forEach((unit, i) => {
        console.log(`   ${i + 1}. ${unit.productName || unit.registrationNumber || 'Unknown'}`);
        if (unit.certificateNormIssueDateDescriptions) {
          console.log(`      Certificates: ${unit.certificateNormIssueDateDescriptions}`);
        }
      });
    }
  }
  console.log('');

  // Test 3: Schneider Electric - Multiple certificates (VDE-AR-N 4105 + CE)
  console.log('='.repeat(80));
  console.log('TEST 3: Schneider Electric - Multiple Certificates (VDE-AR-N 4105 + CE)');
  console.log('Expected: Products with EITHER VDE-AR-N 4105 OR CE certification');
  console.log('-'.repeat(80));

  const test3Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      manufacturerId: schneider.id,
      certificateNorms: ['VDE-AR-N 4105', 'CE'],
      maxResults: 100
    })
  });
  const test3Data = await test3Response.json();

  if (test3Data.error) {
    console.log('❌ FAILED:', test3Data.error);
    console.log('   Details:', test3Data.message || test3Data.details);
  } else {
    console.log(`✅ SUCCESS: Found ${test3Data.units?.length || 0} products (total: ${test3Data.totalCount || 0})`);
    if (test3Data.units && test3Data.units.length > 0) {
      console.log('\n   Products with VDE-AR-N 4105 OR CE:');
      test3Data.units.forEach((unit, i) => {
        console.log(`   ${i + 1}. ${unit.productName || unit.registrationNumber || 'Unknown'}`);
        if (unit.certificateNormIssueDateDescriptions) {
          console.log(`      Certificates: ${unit.certificateNormIssueDateDescriptions}`);
        }
      });
    }
  }
  console.log('');

  // Test 4: Wanbang - No certificate filter
  console.log('='.repeat(80));
  console.log('TEST 4: Wanbang - No Certificate Filter');
  console.log('Expected: All Wanbang products');
  console.log('-'.repeat(80));

  const test4Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      manufacturerId: wanbang.id,
      maxResults: 100
    })
  });
  const test4Data = await test4Response.json();

  if (test4Data.error) {
    console.log('❌ FAILED:', test4Data.error);
    console.log('   Details:', test4Data.message || test4Data.details);
  } else {
    console.log(`✅ SUCCESS: Found ${test4Data.units?.length || 0} products (total: ${test4Data.totalCount || 0})`);
    if (test4Data.units && test4Data.units.length > 0) {
      console.log('\n   Products found:');
      test4Data.units.forEach((unit, i) => {
        console.log(`   ${i + 1}. ${unit.manufacturerName} - ${unit.productName || unit.registrationNumber || 'Unknown'}`);
        if (unit.certificateNormIssueDateDescriptions) {
          console.log(`      Certificates: ${unit.certificateNormIssueDateDescriptions}`);
        }
      });
    }
  }
  console.log('');

  // Test 5: Wanbang - VDE-AR-N 4105 only
  console.log('='.repeat(80));
  console.log('TEST 5: Wanbang - VDE-AR-N 4105 Only');
  console.log('Expected: Wanbang products with VDE-AR-N 4105 certification');
  console.log('-'.repeat(80));

  const test5Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      manufacturerId: wanbang.id,
      certificateNorms: ['VDE-AR-N 4105'],
      maxResults: 100
    })
  });
  const test5Data = await test5Response.json();

  if (test5Data.error) {
    console.log('❌ FAILED:', test5Data.error);
    console.log('   Details:', test5Data.message || test5Data.details);
  } else {
    console.log(`✅ SUCCESS: Found ${test5Data.units?.length || 0} products (total: ${test5Data.totalCount || 0})`);
    if (test5Data.units && test5Data.units.length > 0) {
      console.log('\n   Products with VDE-AR-N 4105:');
      test5Data.units.forEach((unit, i) => {
        console.log(`   ${i + 1}. ${unit.productName || unit.registrationNumber || 'Unknown'}`);
        if (unit.certificateNormIssueDateDescriptions) {
          console.log(`      Certificates: ${unit.certificateNormIssueDateDescriptions}`);
        }
      });
    }
  }
  console.log('');

  // Test 6: Invalid certificate norm (should return error)
  console.log('='.repeat(80));
  console.log('TEST 6: Invalid Certificate Norm Value');
  console.log('Expected: HTTP 400 error with clear message');
  console.log('-'.repeat(80));

  const test6Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      certificateNorms: ['INVALID_NORM', 'VDE-AR-N 4105'],
      maxResults: 10
    })
  });
  const test6Data = await test6Response.json();

  if (test6Data.error) {
    console.log(`✅ SUCCESS: Correctly rejected invalid norm with error: "${test6Data.error}"`);
    if (test6Data.details) {
      console.log(`   Invalid values detected: ${JSON.stringify(test6Data.details.invalid)}`);
      console.log(`   Message: ${test6Data.details.message}`);
    }
  } else {
    console.log('❌ FAILED: Invalid certificate norm was accepted (should have been rejected)');
  }
  console.log('');

  // Test 7: All certificate norms (VDE series + CE + IEC)
  console.log('='.repeat(80));
  console.log('TEST 7: All Certificate Norms Selected');
  console.log('Expected: Products matching ANY of the 6 certificate standards');
  console.log('-'.repeat(80));

  const test7Response = await fetch(`${API_BASE}/search`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      isVerified: true,
      certificateNorms: [
        'VDE-AR-N 4105',
        'VDE-AR-N 4110',
        'VDE-AR-N 4120',
        'VDE-AR-N 4130',
        'CE',
        'IEC'
      ],
      maxResults: 20
    })
  });
  const test7Data = await test7Response.json();

  if (test7Data.error) {
    console.log('❌ FAILED:', test7Data.error);
    console.log('   Details:', test7Data.message || test7Data.details);
  } else {
    console.log(`✅ SUCCESS: Found ${test7Data.units?.length || 0} products (total: ${test7Data.totalCount || 0})`);
    console.log('   First 5 products:');
    test7Data.units?.slice(0, 5).forEach((unit, i) => {
      console.log(`   ${i + 1}. ${unit.manufacturerName} - ${unit.productName || unit.registrationNumber || 'Unknown'}`);
      if (unit.certificateNormIssueDateDescriptions) {
        console.log(`      Certificates: ${unit.certificateNormIssueDateDescriptions}`);
      }
    });
  }
  console.log('');

  // Summary
  console.log('='.repeat(80));
  console.log('TEST SUMMARY');
  console.log('='.repeat(80));
  console.log('✅ Certificate norms multi-select filter is working correctly!');
  console.log('✅ Runtime validation rejects invalid certificate norm values');
  console.log('✅ Multiple certificates use OR logic (match ANY selected standard)');
  console.log('✅ Empty certificate array = no filter (returns all products)');
  console.log('='.repeat(80));
}

// Check if server is running
fetch('http://localhost:3000/api/zerez/manufacturers')
  .then(() => {
    console.log('✅ Dev server is running on http://localhost:3000');
    console.log('');
    testCertificateNormsFilter().catch(error => {
      console.error('Test failed:', error);
      process.exit(1);
    });
  })
  .catch((error) => {
    console.error('❌ Dev server not running on http://localhost:3000');
    console.error('   Please start it with: cd benchmark-app && npm run dev');
    console.error('   Error:', error.message);
    process.exit(1);
  });
