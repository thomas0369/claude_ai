'use client';

import { memo, useMemo } from 'react';
import { FixedSizeList as List } from 'react-window';
import { CheckCircle2 } from 'lucide-react';
import { ZEREZUnit } from '@/lib/zerez-types';
import { UnitFormatters } from '@/lib/unit-formatters';
import { ZEREZ_UI_STRINGS } from '@/lib/ui-constants';

type ZEREZUnitWithSelection = ZEREZUnit & {
  selected?: boolean;
};

interface VirtualizedProductTableProps {
  products: ZEREZUnitWithSelection[];
  onToggleSelection: (id: string, checked: boolean) => void;
}

// Memoized row component - only re-renders when product selection changes
const ProductRow = memo(({
  product,
  index,
  style,
  onToggle
}: {
  product: ZEREZUnitWithSelection;
  index: number;
  style: React.CSSProperties;
  onToggle: (id: string, checked: boolean) => void;
}) => {
  return (
    <div
      style={style}
      className={`flex items-center gap-3 px-4 border-b hover:bg-gray-50 dark:hover:bg-gray-800 ${
        index % 2 === 0 ? 'bg-white dark:bg-gray-900' : 'bg-gray-50 dark:bg-gray-800'
      }`}
    >
      {/* Checkbox - native input for better performance */}
      <div className="flex-shrink-0">
        <input
          type="checkbox"
          checked={product.selected ?? false}
          onChange={(e) => onToggle(product.id, e.target.checked)}
          className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
          aria-label={`Select ${product.modelName ?? 'product'}`}
        />
      </div>

      {/* Grid for 6 essential columns */}
      <div className="flex-1 grid grid-cols-1 md:grid-cols-5 gap-2 md:gap-4 py-2">
        {/* Model Name (most important) */}
        <div className="font-medium text-gray-900 dark:text-gray-100 md:col-span-1">
          <div className="md:hidden text-xs text-gray-500 dark:text-gray-400">Model</div>
          {UnitFormatters.string(product.modelName)}
        </div>

        {/* Manufacturer */}
        <div className="text-gray-600 dark:text-gray-400 text-sm md:col-span-1">
          <div className="md:hidden text-xs text-gray-500 dark:text-gray-400">Manufacturer</div>
          {product.manufacturerName ? (
            UnitFormatters.string(product.manufacturerName)
          ) : (
            <span
              className="text-xs italic text-gray-500 dark:text-gray-500"
              title={ZEREZ_UI_STRINGS.MANUFACTURER_PLACEHOLDER_TOOLTIP}
            >
              {ZEREZ_UI_STRINGS.MANUFACTURER_PLACEHOLDER}
            </span>
          )}
        </div>

        {/* Power */}
        <div className="text-gray-600 dark:text-gray-400 text-sm md:col-span-1">
          <div className="md:hidden text-xs text-gray-500 dark:text-gray-400">Max Power</div>
          {UnitFormatters.power(product.maxActivePower)}
        </div>

        {/* Category */}
        <div className="text-gray-600 dark:text-gray-400 text-sm md:col-span-1">
          <div className="md:hidden text-xs text-gray-500 dark:text-gray-400">Category</div>
          {UnitFormatters.string(product.category)}
        </div>

        {/* Status - Verification badge */}
        <div className="text-sm md:col-span-1">
          <div className="md:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">Status</div>
          {product.isVerified ? (
            <span title="Verified" className="inline-flex items-center gap-1 text-green-600 dark:text-green-400">
              <CheckCircle2 className="h-4 w-4" aria-hidden="true" />
              <span className="text-xs font-medium">Verified</span>
            </span>
          ) : (
            <span className="text-xs text-gray-400 dark:text-gray-500">Not verified</span>
          )}
        </div>
      </div>
    </div>
  );
}, (prev, next) => {
  // Only re-render if selection state or id changes
  return prev.product.selected === next.product.selected
    && prev.product.id === next.product.id;
});

ProductRow.displayName = 'ProductRow';

function VirtualizedProductTable({
  products,
  onToggleSelection
}: VirtualizedProductTableProps) {
  // Memoize the row renderer to prevent unnecessary recreations
  const Row = useMemo(() => {
    const RowRenderer = ({ index, style }: { index: number; style: React.CSSProperties }) => (
      <ProductRow
        product={products[index]}
        index={index}
        style={style}
        onToggle={onToggleSelection}
      />
    );
    RowRenderer.displayName = 'RowRenderer';
    return RowRenderer;
  }, [products, onToggleSelection]);

  return (
    <div className="border rounded-lg overflow-hidden">
      {/* Table Header - Hidden on mobile, shows on tablet+ */}
      <div className="hidden md:flex items-center gap-3 px-4 py-3 bg-gray-50 dark:bg-gray-800 border-b font-semibold text-sm sticky top-0 z-10">
        <div className="flex-shrink-0 w-4"></div>
        <div className="flex-1 grid grid-cols-5 gap-4">
          <div lang="de">Modell</div>
          <div lang="de">Hersteller</div>
          <div lang="de">Max. Wirkleistung</div>
          <div lang="de">Kategorie</div>
          <div lang="de">Status</div>
        </div>
      </div>

      {/* Virtualized List - Only renders visible rows */}
      <div style={{ contain: 'layout style paint' }}>
        <List
          height={400}
          itemCount={products.length}
          itemSize={80} // Increased for mobile stacked layout
          width="100%"
          overscanCount={5} // Render 5 extra rows for smooth scrolling
        >
          {Row}
        </List>
      </div>

      {/* Empty state */}
      {products.length === 0 && (
        <div className="p-8 text-center text-gray-500 dark:text-gray-400">
          No products found
        </div>
      )}
    </div>
  );
}

VirtualizedProductTable.displayName = 'VirtualizedProductTable';

export default VirtualizedProductTable;
