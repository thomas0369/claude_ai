#!/bin/bash

echo "════════════════════════════════════════════════════════════"
echo "  ZEREZ Table Validation Runner"
echo "════════════════════════════════════════════════════════════"
echo ""

# Step 1: Kill all existing Node processes
echo "Step 1: Cleaning up existing processes..."
pkill -9 node 2>/dev/null
sleep 2
echo "✓ Cleanup complete"
echo ""

# Step 2: Clear Next.js cache
echo "Step 2: Clearing Next.js cache..."
cd "/mnt/c/Workspace/C&I BESS/benchmark-app"
rm -rf .next 2>/dev/null
echo "✓ Cache cleared"
echo ""

# Step 3: Start dev server in background
echo "Step 3: Starting dev server..."
npm run dev > /tmp/zerez-dev-server.log 2>&1 &
DEV_PID=$!
echo "✓ Dev server starting (PID: $DEV_PID)"
echo ""

# Step 4: Wait for server to be ready
echo "Step 4: Waiting for server to be ready..."
for i in {1..60}; do
  if curl -s http://localhost:3000/api/zerez/manufacturers > /dev/null 2>&1; then
    echo "✓ Server is ready!"
    echo ""
    break
  fi
  echo -n "."
  sleep 1
done
echo ""

# Step 5: Run validation script
echo "Step 5: Running validation..."
echo "════════════════════════════════════════════════════════════"
echo ""
node validate-zerez-table.js
VALIDATION_EXIT=$?

# Step 6: Cleanup
echo ""
echo "════════════════════════════════════════════════════════════"
echo "Step 6: Cleaning up..."
kill $DEV_PID 2>/dev/null
echo "✓ Dev server stopped"
echo ""

if [ $VALIDATION_EXIT -eq 0 ]; then
  echo "✅ Validation completed successfully!"
else
  echo "❌ Validation failed with exit code: $VALIDATION_EXIT"
  echo ""
  echo "Dev server logs:"
  tail -50 /tmp/zerez-dev-server.log
fi

exit $VALIDATION_EXIT
