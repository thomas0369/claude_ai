// Direct browser validation script for ZEREZ table
// Usage: node validate-table-browser.js

const { chromium } = require('playwright');

async function validateTableInBrowser() {
  console.log('\n=== ZEREZ Table Browser Validation ===\n');

  const browser = await chromium.launch({ headless: false });
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // Step 1: Navigate to ZEREZ import wizard
    console.log('Step 1: Loading ZEREZ import page...');
    await page.goto('http://localhost:3000/import/zerez');
    await page.waitForLoadState('networkidle');
    console.log('✓ Page loaded\n');

    // Step 2: Click "Preview Products" to go to search interface
    console.log('Step 2: Opening preview interface...');
    await page.click('button:has-text("Preview Products")');
    await page.waitForLoadState('networkidle');
    await page.waitForTimeout(2000); // Wait for transition
    console.log('✓ Preview interface loaded\n');

    // Step 3: Search for Sungrow products (if search interface exists)
    console.log('Step 3: Searching for products...');
    // Check if there's a search input, if not just preview all
    const searchInput = page.locator('input[type="text"]').first();
    const hasSearchInput = await searchInput.isVisible().catch(() => false);

    if (hasSearchInput) {
      await searchInput.fill('Sungrow');
      await page.waitForTimeout(1000);
      console.log('✓ Search term entered\n');
    } else {
      console.log('✓ No search input, using default results\n');
    }

    // Wait for table to load with data
    console.log('Step 4: Waiting for table data...');
    await page.waitForSelector('div.sticky.left-16', { timeout: 30000 });
    await page.waitForTimeout(3000); // Wait for data to fully load
    console.log('✓ Table loaded with data\n');

    // Step 5: Validate sticky columns
    console.log('Step 5: Testing sticky column behavior...');

    // Get initial checkbox position
    const checkboxBefore = await page.locator('div.sticky.left-0 input[type="checkbox"]').first().boundingBox();

    // Get initial model name position
    const modelBefore = await page.locator('div.sticky.left-16').first().boundingBox();

    console.log(`  Initial positions:`);
    console.log(`    Checkbox X: ${checkboxBefore?.x}`);
    console.log(`    Model Name X: ${modelBefore?.x}`);

    // Scroll horizontally
    const scrollContainer = page.locator('div.overflow-x-auto').nth(1);
    await scrollContainer.evaluate(el => el.scrollLeft = 800);
    await page.waitForTimeout(500);

    // Check positions after scroll
    const checkboxAfter = await page.locator('div.sticky.left-0 input[type="checkbox"]').first().boundingBox();
    const modelAfter = await page.locator('div.sticky.left-16').first().boundingBox();

    console.log(`  After scrolling 800px:`);
    console.log(`    Checkbox X: ${checkboxAfter?.x}`);
    console.log(`    Model Name X: ${modelAfter?.x}`);

    const checkboxFixed = checkboxBefore?.x === checkboxAfter?.x;
    const modelFixed = modelBefore?.x === modelAfter?.x;

    console.log(`  ${checkboxFixed ? '✓' : '✗'} Checkbox column stays fixed`);
    console.log(`  ${modelFixed ? '✓' : '✗'} Model name column stays fixed\n`);

    // Step 6: Extract data from 10 products
    console.log('Step 6: Extracting data from first 10 products...\n');
    console.log('─'.repeat(100));

    const rows = page.locator('div[style*="height: 48px"]').filter({
      has: page.locator('input[type="checkbox"]')
    });

    const rowCount = Math.min(await rows.count(), 10);
    console.log(`Found ${rowCount} product rows\n`);

    const products = [];

    for (let i = 0; i < rowCount; i++) {
      const row = rows.nth(i);

      // Get model name from sticky column
      const modelName = await row.locator('div.sticky.left-16 span').textContent();

      // Get scrollable columns
      const scrollableDiv = row.locator('div.flex.items-stretch').last();
      const columns = scrollableDiv.locator('> div');
      const columnCount = await columns.count();

      // Extract first few columns
      const manufacturer = columnCount > 0 ? await columns.nth(0).locator('span').textContent() : '-';
      const maxActivePower = columnCount > 1 ? await columns.nth(1).locator('span').textContent() : '-';
      const ratedActivePower = columnCount > 2 ? await columns.nth(2).locator('span').textContent() : '-';
      const maxApparentPower = columnCount > 3 ? await columns.nth(3).locator('span').textContent() : '-';
      const ratedApparentPower = columnCount > 4 ? await columns.nth(4).locator('span').textContent() : '-';
      const ratedVoltage = columnCount > 5 ? await columns.nth(5).locator('span').textContent() : '-';
      const ratedCurrent = columnCount > 6 ? await columns.nth(6).locator('span').textContent() : '-';

      const product = {
        index: i + 1,
        modelName: modelName?.trim() || '-',
        manufacturer: manufacturer?.trim() || '-',
        maxActivePower: maxActivePower?.trim() || '-',
        ratedActivePower: ratedActivePower?.trim() || '-',
        maxApparentPower: maxApparentPower?.trim() || '-',
        ratedApparentPower: ratedApparentPower?.trim() || '-',
        ratedVoltage: ratedVoltage?.trim() || '-',
        ratedCurrent: ratedCurrent?.trim() || '-',
        totalColumns: columnCount
      };

      products.push(product);

      console.log(`Product ${product.index}: ${product.modelName}`);
      console.log(`  Manufacturer: ${product.manufacturer}`);
      console.log(`  Max Active Power: ${product.maxActivePower}`);
      console.log(`  Rated Active Power: ${product.ratedActivePower}`);
      console.log(`  Max Apparent Power: ${product.maxApparentPower}`);
      console.log(`  Rated Apparent Power: ${product.ratedApparentPower}`);
      console.log(`  Rated Voltage: ${product.ratedVoltage}`);
      console.log(`  Rated Current: ${product.ratedCurrent}`);
      console.log(`  Total Columns: ${product.totalColumns}`);
      console.log('─'.repeat(100));
    }

    // Step 4: Validation checks
    console.log('\n=== Validation Results ===\n');

    // Check 1: All products have model names
    const withModelName = products.filter(p => p.modelName !== '-' && p.modelName !== '');
    console.log(`✓ Products with model names: ${withModelName.length}/${products.length}`);

    // Check 2: Products have power data
    const withPowerData = products.filter(p =>
      p.maxActivePower !== '-' && !p.maxActivePower.includes('null')
    );
    console.log(`✓ Products with Max Active Power: ${withPowerData.length}/${products.length}`);

    const withRatedPower = products.filter(p =>
      p.ratedActivePower !== '-' && !p.ratedActivePower.includes('null')
    );
    console.log(`✓ Products with Rated Active Power: ${withRatedPower.length}/${products.length}`);

    const withVoltage = products.filter(p =>
      p.ratedVoltage !== '-' && !p.ratedVoltage.includes('null')
    );
    console.log(`✓ Products with Rated Voltage: ${withVoltage.length}/${products.length}`);

    const withCurrent = products.filter(p =>
      p.ratedCurrent !== '-' && !p.ratedCurrent.includes('null')
    );
    console.log(`✓ Products with Rated Current: ${withCurrent.length}/${products.length}`);

    // Check 3: Column count
    const avgColumns = products.reduce((sum, p) => sum + p.totalColumns, 0) / products.length;
    console.log(`✓ Average columns per product: ${avgColumns.toFixed(1)}`);

    // Check 4: German technical headers
    console.log('\nStep 7: Checking German technical field headers...');
    const germanFields = [
      'Bemessungswirkleistung',
      'Bemessungsscheinleistung',
      'Bemessungsspannung',
      'Bemessungsstrom',
      'Stoßkurzschlussstrom',
      'Anfangs-Kurzschlusswechselstrom',
      'Flicker cΨ(30°)',
      'Flicker cΨ(50°)'
    ];

    for (const field of germanFields) {
      const headerExists = await page.locator(`[role="columnheader"]`).filter({ hasText: field }).count() > 0;
      console.log(`  ${headerExists ? '✓' : '✗'} ${field}`);
    }

    // Summary
    console.log('\n=== Summary ===\n');
    console.log(`Total products validated: ${products.length}`);
    console.log(`Products with complete power data: ${Math.min(withPowerData.length, withRatedPower.length)}`);
    console.log(`Sticky columns working: ${checkboxFixed && modelFixed ? 'Yes ✓' : 'No ✗'}`);
    console.log(`Average columns per row: ${avgColumns.toFixed(1)}`);
    console.log(`Data completeness: ${((withPowerData.length / products.length) * 100).toFixed(1)}%`);

    // Keep browser open for 5 seconds to see the result
    console.log('\nKeeping browser open for 5 seconds...');
    await page.waitForTimeout(5000);

  } catch (error) {
    console.error('\n❌ Error during validation:', error.message);
    throw error;
  } finally {
    await browser.close();
    console.log('\n✓ Validation complete\n');
  }
}

// Run validation
validateTableInBrowser().catch(error => {
  console.error('Failed:', error);
  process.exit(1);
});
