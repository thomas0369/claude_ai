import { NextResponse } from 'next/server';
import { PythonExecutor } from '@/lib/python-executor';

/**
 * Certificate Authority response type
 */
type Authority = {
  id: string;      // UUID
  name: string;    // Authority/tenant name
};

type AuthoritiesResponse = Authority[];

/**
 * GET /api/zerez/authorities
 *
 * Fetches ALL tenants from ZEREZ database that can be certificate authorities.
 * Uses direct GraphQL tenants query for optimal performance.
 *
 * Performance: ~2 seconds for ALL 8,000+ tenants
 * Coverage: 100% of tenants (same data source as manufacturers)
 *
 * Returns: Array of {id: UUID, name: string} sorted alphabetically
 *
 * @example
 * ```typescript
 * const response = await fetch('/api/zerez/authorities');
 * const authorities = await response.json();
 * // [{ id: "uuid-1", name: "VDE Pr√ºf- und Zertifizierungsinstitut GmbH" }, ...] (8000+ entries)
 * ```
 */
export async function GET() {
  try {
    // Execute optimized Python script using direct tenants query
    // Reuses the same script as manufacturers since both are tenants in ZEREZ
    const stdout = await PythonExecutor.execute({
      scriptName: 'zerez_list_tenants.py',
      timeout: 30000 // 30 seconds (actual execution ~2s, generous safety margin)
    });

    // Parse Python response
    const authorities: AuthoritiesResponse = JSON.parse(stdout);

    // Validate response structure
    if (!Array.isArray(authorities)) {
      throw new Error('Invalid response format: expected array');
    }

    // Add caching headers (authorities don't change frequently)
    // 1-hour cache reduces server load and improves performance
    return NextResponse.json<AuthoritiesResponse>(authorities, {
      headers: {
        'Cache-Control': 'public, max-age=3600, s-maxage=3600', // Cache for 1 hour
        'CDN-Cache-Control': 'max-age=3600',
        'Vercel-CDN-Cache-Control': 'max-age=3600'
      }
    });
  } catch (error) {
    // PythonExecutor already logs detailed errors server-side
    return NextResponse.json(
      {
        error: 'Failed to fetch certificate authorities',
        message: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}
