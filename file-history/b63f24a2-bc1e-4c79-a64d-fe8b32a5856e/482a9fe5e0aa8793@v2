/**
 * Direct test for Schneider Electric product count using Python script
 * Bypasses the dev server to get accurate results
 */

const { spawn } = require('child_process');
const path = require('path');

async function testSchneiderProducts() {
  console.log('='.repeat(80));
  console.log('SCHNEIDER ELECTRIC PRODUCT COUNT TEST');
  console.log('='.repeat(80));
  console.log('');

  // First, get the manufacturers list to find Schneider Electric UUID
  console.log('Step 1: Finding Schneider Electric manufacturer UUID...');

  const manufacturersScript = path.join(__dirname, '..', 'scripts', 'zerez_list_tenants.py');
  const manufacturersProcess = spawn('python3', [manufacturersScript]);

  let manufacturersData = '';
  let manufacturersError = '';

  manufacturersProcess.stdout.on('data', (data) => {
    manufacturersData += data.toString();
  });

  manufacturersProcess.stderr.on('data', (data) => {
    manufacturersError += data.toString();
  });

  await new Promise((resolve, reject) => {
    manufacturersProcess.on('close', (code) => {
      if (code !== 0) {
        reject(new Error(`Manufacturers script failed with code ${code}: ${manufacturersError}`));
      } else {
        resolve();
      }
    });
  });

  const manufacturers = JSON.parse(manufacturersData);
  const schneider = manufacturers.find(m =>
    m.name.toLowerCase().includes('schneider electric')
  );

  if (!schneider) {
    console.log('❌ FAILED: Could not find Schneider Electric in manufacturers list');
    console.log(`   Found ${manufacturers.length} manufacturers, but none match "Schneider Electric"`);
    console.log('   Searching for any "Schneider"...');
    const schneiders = manufacturers.filter(m => m.name.toLowerCase().includes('schneider'));
    schneiders.forEach(s => console.log(`   - ${s.name} (ID: ${s.id})`));
    return;
  }

  console.log(`✅ Found: ${schneider.name}`);
  console.log(`   UUID: ${schneider.id}`);
  console.log('');

  // Now search for products with this manufacturer
  console.log('Step 2: Searching for products from this manufacturer...');

  const searchScript = path.join(__dirname, '..', 'scripts', 'zerez_search_advanced.py');
  const searchFilters = JSON.stringify({
    isVerified: true,
    is4105: false,
    manufacturerId: schneider.id,
    maxResults: 20
  });

  const searchProcess = spawn('python3', [searchScript], {
    stdio: ['pipe', 'pipe', 'pipe']
  });

  searchProcess.stdin.write(searchFilters);
  searchProcess.stdin.end();

  let searchData = '';
  let searchError = '';

  searchProcess.stdout.on('data', (data) => {
    searchData += data.toString();
  });

  searchProcess.stderr.on('data', (data) => {
    searchError += data.toString();
  });

  await new Promise((resolve, reject) => {
    searchProcess.on('close', (code) => {
      if (code !== 0) {
        reject(new Error(`Search script failed with code ${code}: ${searchError}`));
      } else {
        resolve();
      }
    });
  });

  const results = JSON.parse(searchData);

  console.log('');
  console.log('='.repeat(80));
  console.log('RESULTS');
  console.log('='.repeat(80));
  console.log(`Total products found: ${results.totalCount}`);
  console.log(`Products returned: ${results.units.length}`);
  console.log('');

  if (results.totalCount >= 7) {
    console.log(`✅ SUCCESS: Found ${results.totalCount} products (expected 7-8)`);
  } else {
    console.log(`❌ FAILED: Only found ${results.totalCount} products (expected 7-8)`);
  }

  console.log('');
  console.log('Product list:');
  results.units.forEach((unit, index) => {
    console.log(`  ${index + 1}. ${unit.productName || 'N/A'} (${unit.unitCode || 'N/A'})`);
  });

  console.log('');
  console.log('='.repeat(80));
}

testSchneiderProducts().catch(error => {
  console.error('❌ Test failed:', error.message);
  if (error.stack) {
    console.error(error.stack);
  }
  process.exit(1);
});
