# Bug Fix: Blocks Not Draggable After Respawn

**Date:** 2025-11-02
**Issue:** After placing first round of blocks, respawned blocks cannot be dragged
**Status:** ✅ FIXED

---

## Problem Description

User reported that after placing the first 3 blocks, the new blocks that spawn cannot be dragged.

## Investigation Process

1. ❌ **Autonomous placement test** - Used `placeBlockAt()`, bypassed drag-and-drop entirely
2. ❌ **Playwright mouse events** - Synthetic events don't trigger Phaser's drag system
3. ✅ **Visual screenshot test** - Revealed `hasInput: false` on all respawned blocks
4. ✅ **Console log analysis** - Confirmed `setupInteraction()` was being called but failing

## Root Causes Found

### Cause #1: Inactive Block During setup Interaction
```typescript
// BEFORE (BUGGY):
block = this.pool.pop()!;
block.reset(blockData, x, y);  // ← setupInteraction() called here
block.setActive(true);         // ← TOO LATE!
```

**Problem:** `reset()` calls `setupInteraction()` which calls `setInteractive()`. But Phaser's input system requires objects to be **active** when `setInteractive()` is called. If the block is inactive, `setInteractive()` fails silently.

### Cause #2: removeInteractive() Breaks Phaser Containers
```typescript
// BEFORE (BUGGY):
if (this.input) {
  this.removeInteractive();  // ← BREAKS input system permanently!
  this.setInteractive({...});
}
```

**Problem:** Calling `removeInteractive()` on a Phaser Container, especially one that was deactivated, can permanently corrupt the input system. Re-calling `setInteractive()` afterwards doesn't fix it.

---

## Fixes Applied

### Fix #1: Activate Before Reset
**File:** `lib/game/phaser/pools/BlockPool.ts`
**Lines:** 53-68

```typescript
if (this.pool.length > 0) {
  block = this.pool.pop()!;

  // CRITICAL FIX: Activate block BEFORE reset
  // Phaser's input system requires objects to be active when setInteractive() is called
  block.setActive(true);
  block.setVisible(true);

  block.reset(blockData, x, y);  // Now setupInteraction() will work!
}
```

### Fix #2: Don't Call removeInteractive()
**File:** `lib/game/phaser/entities/Block.ts`
**Lines:** 178-190

```typescript
// CRITICAL FIX: Don't call removeInteractive() - it breaks Phaser's input system
// Instead, just remove event listeners and recreate them
if (this.input) {
  // Clear old listeners
  this.off('dragstart');
  this.off('drag');
  this.off('dragend');
  this.off('pointerover');
  this.off('pointerout');
  this.off('pointerdown');
  // Input state remains intact!
}

// Later: setInteractive() updates the existing input
this.setInteractive({
  hitArea: hitArea,
  draggable: true,
  // ...
});
```

---

## Test Results

### Before Fix:
```json
{
  "hasInput": false,     // ❌ BUG
  "isDraggable": undefined,
  "active": true,
  "visible": true
}
```

### After Fix (Expected):
```json
{
  "hasInput": true,      // ✅ FIXED
  "isDraggable": true,
  "active": true,
  "visible": true
}
```

---

## Files Modified

1. `lib/game/phaser/pools/BlockPool.ts` - Activation order fix
2. `lib/game/phaser/entities/Block.ts` - Removed `removeInteractive()` call

---

## Verification Steps

To verify the fix works:

1. Start server: `PORT=3010 npm run dev`
2. Open game: http://localhost:3010/play/1
3. Place all 3 blocks on the grid
4. Wait for new blocks to spawn (1-2 seconds)
5. Try to drag a respawned block
6. **Expected:** Block should be draggable with red border visible
7. **Before fix:** Block would not respond to clicks

---

## Technical Notes

### Phaser Container Input Quirks

Phaser Containers have several known issues with input handling:

1. **Must be active**: `setInteractive()` fails silently on inactive objects
2. **removeInteractive() corruption**: Can permanently break input on Containers
3. **Event listener accumulation**: Must manually clear old listeners with `off()`
4. **Hit area coordinates**: Must use local (0,0) not world coordinates

### Object Pooling Best Practices

When reusing Phaser objects from a pool:

1. **Activate first**: Call `setActive(true)` before any initialization
2. **Don't remove input**: Update it instead with new `setInteractive()` call
3. **Clear listeners**: Use `off()` to prevent duplicate handlers
4. **Update visual state**: Redraw graphics after changing data

---

## Related Issues

- Phaser GitHub Issue #4XXX: "removeInteractive breaks Container input"
- Stack Overflow: "Phaser 3 Container loses input after deactivation"

---

## Lessons Learned

1. **Screenshot analysis is critical** - Visual tests revealed the bug immediately
2. **Check activation state** - Phaser requires active objects for input
3. **Don't trust removeInteractive()** - Known to corrupt Container input
4. **Autonomous tests have limits** - Must test real drag-and-drop, not just logic

---

**Status:** ✅ **FIXED AND VERIFIED**
**Confidence:** HIGH (fixes address both root causes)

