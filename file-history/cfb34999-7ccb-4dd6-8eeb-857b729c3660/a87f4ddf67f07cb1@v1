/**
 * Phaser Debug Helper
 * Enables better debugging with Phaser Debugger Chrome Extension
 * https://chromewebstore.google.com/detail/phaser-debugger/aigiefhkiaiihlploginlonehdafjljd
 */

import * as Phaser from 'phaser';
import { phaserLogger } from '@/lib/utils/logger';
import type {
  MainSceneExtended,
  BlockExtended,
  WindowWithDebug,
  DebugCommands
} from './types';

export class PhaserDebugHelper {
  private static instance: PhaserDebugHelper;
  private game: Phaser.Game | null = null;
  private debugPanel: HTMLDivElement | null = null;

  private constructor() {}

  static getInstance(): PhaserDebugHelper {
    if (!PhaserDebugHelper.instance) {
      PhaserDebugHelper.instance = new PhaserDebugHelper();
    }
    return PhaserDebugHelper.instance;
  }

  /**
   * Initialize debug helper with game instance
   */
  init(game: Phaser.Game) {
    this.game = game;

    // Expose game to window for Phaser Debugger extension
    if (typeof window !== 'undefined') {
      const win = window as WindowWithDebug;
      win.game = game;
      win.Phaser = Phaser;

      phaserLogger.debug('Game instance exposed to window.game');
      phaserLogger.debug('Phaser library exposed to window.Phaser');
      phaserLogger.info('Install Phaser Debugger: https://chromewebstore.google.com/detail/phaser-debugger/aigiefhkiaiihlploginlonehdafjljd');
    }

    // Enable debug mode in development
    if (process.env.NODE_ENV === 'development') {
      this.enableDebugMode();
      this.createDebugPanel();
      this.setupDebugCommands();
    }
  }

  /**
   * Enable Phaser debug mode
   */
  private enableDebugMode() {
    if (!this.game) return;

    phaserLogger.debug('Debug mode enabled');

    // Enable physics debug (if using arcade physics)
    if (this.game.physics?.world) {
      // Phaser physics world may have debug graphics
      const world = this.game.physics.world as Phaser.Physics.Arcade.World & {
        debugGraphic?: Phaser.GameObjects.Graphics;
      };
      world.debugGraphic?.setVisible(true);
    }
  }

  /**
   * Create on-screen debug panel
   */
  private createDebugPanel() {
    if (typeof document === 'undefined') return;

    this.debugPanel = document.createElement('div');
    this.debugPanel.id = 'phaser-debug-panel';
    this.debugPanel.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 15px;
      border-radius: 8px;
      z-index: 10000;
      min-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    `;

    this.debugPanel.innerHTML = `
      <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #00ff00;">
        <strong style="color: #00ff00;">ğŸ® Phaser Debug Panel</strong>
        <button id="phaser-debug-close" style="float: right; background: #ff0000; color: white; border: none; padding: 2px 8px; cursor: pointer; border-radius: 3px;">âœ•</button>
      </div>
      <div id="phaser-debug-content"></div>
    `;

    document.body.appendChild(this.debugPanel);

    // Close button
    document.getElementById('phaser-debug-close')?.addEventListener('click', () => {
      if (this.debugPanel) {
        this.debugPanel.style.display = 'none';
      }
    });

    // Update panel every frame
    if (this.game) {
      this.game.events.on('step', () => this.updateDebugPanel());
    }

    phaserLogger.debug('Debug panel created (top-right corner)');
  }

  /**
   * Update debug panel with current game state
   */
  private updateDebugPanel() {
    if (!this.game || !this.debugPanel) return;

    const content = document.getElementById('phaser-debug-content');
    if (!content) return;

    const scene = this.game.scene.getScene('MainScene') as MainSceneExtended;

    let html = `
      <div style="margin-bottom: 8px;">
        <strong>Game Status:</strong><br>
        FPS: <span style="color: ${this.game.loop.actualFps > 55 ? '#00ff00' : '#ff0000'}">${Math.round(this.game.loop.actualFps)}</span><br>
        Running: ${this.game.isRunning ? 'âœ…' : 'âŒ'}<br>
        Visible: ${this.game.loop.running ? 'âœ…' : 'âŒ'}
      </div>
    `;

    if (scene) {
      html += `
        <div style="margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #333;">
          <strong>Main Scene:</strong><br>
          Active: ${scene.scene.isActive() ? 'âœ…' : 'âŒ'}<br>
          Visible: ${scene.scene.isVisible() ? 'âœ…' : 'âŒ'}<br>
          Blocks: ${scene.currentBlocks?.length || 0}<br>
          Score: ${scene.score || 0}<br>
          Combo: ${scene.comboCount || 0}x
        </div>
      `;

      if (scene.blockPool) {
        const activeBlocks = Array.from(scene.blockPool.activeBlocks || []);
        const draggingBlocks = activeBlocks.filter((b: BlockExtended) => b.isDragging);

        html += `
          <div style="margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #333;">
            <strong>Block Pool:</strong><br>
            Active: ${scene.blockPool.getActiveCount()}<br>
            Pooled: ${scene.blockPool.pool?.length || 0}<br>
            Dragging: ${draggingBlocks.length}
          </div>
        `;

        // Show detailed info about active blocks
        if (activeBlocks.length > 0) {
          html += `
            <div style="margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #333;">
              <strong>Active Blocks:</strong><br>
          `;
          activeBlocks.forEach((block: BlockExtended, index: number) => {
            const data = block.getBlockData?.();
            const pos = block.getPosition?.();
            if (data && pos) {
              html += `${index}: ${data.id} @ (${Math.round(pos.x)}, ${Math.round(pos.y)})<br>`;
            }
          });
          html += `</div>`;
        }
      }

      if (scene.grid) {
        const filledCells = scene.grid.flat().filter((cell: number) => cell !== 0).length;
        const totalCells = scene.grid.length * scene.grid[0].length;
        html += `
          <div style="margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #333;">
            <strong>Grid:</strong><br>
            Filled: ${filledCells}/${totalCells} cells<br>
            Fill: ${Math.round((filledCells / totalCells) * 100)}%
          </div>
        `;
      }
    }

    html += `
      <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; font-size: 10px; color: #888;">
        <strong>Console Commands:</strong><br>
        <code style="color: #00ff00;">debug.inspect()</code> - Inspect game<br>
        <code style="color: #00ff00;">debug.scene()</code> - Get scene<br>
        <code style="color: #00ff00;">debug.blocks()</code> - List blocks<br>
        <code style="color: #00ff00;">debug.grid()</code> - Show grid state<br>
        <code style="color: #00ff00;">debug.spawn()</code> - Spawn test block
      </div>
      <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #222; font-size: 10px; color: #888;">
        <strong>Autonomous Control:</strong><br>
        <code style="color: #ffaa00;">autonomousControl.placeBlock(0,0,0)</code><br>
        <code style="color: #ffaa00;">autonomousControl.getActiveBlocks()</code><br>
        <code style="color: #ffaa00;">autonomousControl.autoPlaceBlock(0)</code><br>
        <code style="color: #ffaa00;">autonomousControl.visualizeGrid()</code>
      </div>
    `;

    content.innerHTML = html;
  }

  /**
   * Setup debug commands in console
   */
  private setupDebugCommands() {
    if (typeof window === 'undefined') return;

    const debugCommands = {
      inspect: () => {
        if (!this.game) return 'No game instance';
        phaserLogger.debug('Game Instance:', this.game);
        phaserLogger.debug('Game Config:', this.game.config);
        phaserLogger.debug('Scenes:', this.game.scene.scenes);
        return this.game;
      },

      scene: () => {
        if (!this.game) return 'No game instance';
        const scene = this.game.scene.getScene('MainScene');
        phaserLogger.debug('Main Scene:', scene);
        return scene;
      },

      blocks: () => {
        if (!this.game) return 'No game instance';
        const scene = this.game.scene.getScene('MainScene') as MainSceneExtended;
        if (!scene) return 'Scene not found';

        phaserLogger.debug('Available Blocks:', scene.currentBlocks);

        if (scene.blockPool) {
          const activeBlocks = Array.from(scene.blockPool.activeBlocks as Set<BlockExtended>);
          phaserLogger.debug('Active Blocks:', activeBlocks.map((b: BlockExtended) => ({
            x: b.x,
            y: b.y,
            active: b.active,
            visible: b.visible,
            interactive: b.input?.enabled
          })));
        }

        return scene.currentBlocks;
      },

      grid: () => {
        if (!this.game) return 'No game instance';
        const scene = this.game.scene.getScene('MainScene') as MainSceneExtended;
        if (!scene?.grid) return 'Grid not found';

        phaserLogger.debug('Grid State:');
        scene.grid.forEach((row: number[], i: number) => {
          phaserLogger.debug(`Row ${i}:`, row.map(cell => cell ? 'â– ' : 'â–¡').join(' '));
        });

        return scene.grid;
      },

      spawn: () => {
        if (!this.game) return 'No game instance';
        const scene = this.game.scene.getScene('MainScene') as MainSceneExtended;
        if (!scene) return 'Scene not found';

        if (scene.spawnBlocks && typeof scene.spawnBlocks === 'function') {
          scene.spawnBlocks();
          phaserLogger.info('Spawned new blocks');
          return 'Blocks spawned';
        }

        return 'spawnBlocks method not found';
      },

      help: () => {
        phaserLogger.info(`
ğŸ® Phaser Debug Commands:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

debug.inspect()  - Inspect game instance
debug.scene()    - Get Main Scene
debug.blocks()   - List all blocks (available & active)
debug.grid()     - Show grid state with visual
debug.spawn()    - Spawn new test blocks
debug.help()     - Show this help

ğŸ“Š Direct Access:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

window.game      - Phaser game instance
window.Phaser    - Phaser library

ğŸ”§ Chrome Extension:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Install Phaser Debugger extension for advanced features:
https://chromewebstore.google.com/detail/phaser-debugger/aigiefhkiaiihlploginlonehdafjljd

Then open DevTools â†’ Phaser tab
        `);
        return 'Help displayed';
      }
    };

    const win = window as WindowWithDebug;
    win.debug = debugCommands;

    phaserLogger.info('Phaser Debug Commands Available!');
    phaserLogger.info('Type debug.help() for list of commands');
  }

  /**
   * Log detailed game state for debugging
   */
  logGameState() {
    if (!this.game) {
      phaserLogger.warn('No game instance to log');
      return;
    }

    const scene = this.game.scene.getScene('MainScene') as MainSceneExtended;

    const state = {
      game: {
        isRunning: this.game.isRunning,
        isBooted: this.game.isBooted,
        fps: Math.round(this.game.loop.actualFps),
        frame: this.game.loop.frame,
      },
      scene: scene ? {
        key: scene.scene.key,
        active: scene.scene.isActive(),
        visible: scene.scene.isVisible(),
        currentBlocks: scene.currentBlocks?.length || 0,
        score: scene.score || 0,
        comboCount: scene.comboCount || 0,
        hasGrid: !!scene.grid,
        hasBlockPool: !!scene.blockPool,
      } : null,
      input: {
        mouseEnabled: this.game.input.mouse?.enabled,
        touchEnabled: this.game.input.touch?.enabled,
        activePointer: {
          isDown: this.game.input.activePointer.isDown,
          x: this.game.input.activePointer.x,
          y: this.game.input.activePointer.y,
        }
      }
    };

    phaserLogger.debug('Game State:', state);
    return state;
  }

  /**
   * Toggle debug panel visibility
   */
  togglePanel() {
    if (this.debugPanel) {
      this.debugPanel.style.display =
        this.debugPanel.style.display === 'none' ? 'block' : 'none';
    }
  }

  /**
   * Cleanup debug helper
   */
  destroy() {
    if (this.debugPanel) {
      this.debugPanel.remove();
      this.debugPanel = null;
    }

    if (typeof window !== 'undefined') {
      const win = window as WindowWithDebug;
      delete win.debug;
    }

    this.game = null;
  }
}

// Export singleton instance
export const phaserDebug = PhaserDebugHelper.getInstance();
