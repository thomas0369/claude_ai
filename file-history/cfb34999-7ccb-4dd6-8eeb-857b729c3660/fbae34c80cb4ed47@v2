/**
 * DEBUG: Test Canvas Input System
 * Check if Phaser is receiving pointer events at all
 */

import { test } from '@playwright/test';

test('Debug Canvas Input System', async ({ page }) => {
  console.log('\nðŸ” CANVAS INPUT DEBUG TEST\n');
  console.log('='.repeat(80));

  test.setTimeout(120000);

  await page.goto('/play/1', { waitUntil: 'networkidle', timeout: 60000 });
  await page.locator('canvas').waitFor({ state: 'visible', timeout: 30000 });
  await page.waitForFunction(() => typeof (window as any).game !== 'undefined', { timeout: 40000 });
  await page.waitForTimeout(8000);

  console.log('âœ… Game loaded\n');

  // Get canvas element info
  const canvasInfo = await page.evaluate(() => {
    const canvas = document.querySelector('canvas');
    if (!canvas) return null;

    const rect = canvas.getBoundingClientRect();
    const game = (window as any).game;
    const scene = game.scene.scenes[0];

    return {
      canvas: {
        width: canvas.width,
        height: canvas.height,
        displayWidth: rect.width,
        displayHeight: rect.height,
        left: rect.left,
        top: rect.top,
        pointerEvents: window.getComputedStyle(canvas).pointerEvents,
        zIndex: window.getComputedStyle(canvas).zIndex
      },
      input: {
        enabled: game.input.enabled,
        activePointers: game.input.pointersTotal,
        inputPluginEnabled: scene.input.enabled
      }
    };
  });

  console.log('ðŸ“Š Canvas Info:');
  console.log(JSON.stringify(canvasInfo, null, 2));
  console.log('');

  // Test clicking directly on canvas
  console.log('ðŸ–±ï¸  Testing direct canvas click at (160, 495) (block center)...\n');

  const clicked = await page.evaluate(async () => {
    return new Promise((resolve) => {
      const game = (window as any).game;
      const scene = game.scene.scenes[0];

      // Set up listeners on the scene's input plugin
      let pointerDownFired = false;
      let pointerMoveFired = false;

      const cleanup = () => {
        scene.input.off('pointerdown');
        scene.input.off('pointermove');
      };

      scene.input.on('pointerdown', (pointer: any) => {
        console.log(`[SCENE INPUT] pointerdown at (${pointer.x}, ${pointer.y})`);
        pointerDownFired = true;
        cleanup();
        resolve({ pointerDownFired, pointerMoveFired, x: pointer.x, y: pointer.y });
      });

      scene.input.on('pointermove', (pointer: any) => {
        console.log(`[SCENE INPUT] pointermove at (${pointer.x}, ${pointer.y})`);
        pointerMoveFired = true;
      });

      // Also check if ANY game object is hit
      setTimeout(() => {
        const hitObjects = scene.input.hitTestPointer({ x: 160, y: 495 } as any);
        console.log(`[HIT TEST] Objects at (160, 495):`, hitObjects?.length || 0);
        if (hitObjects && hitObjects.length > 0) {
          hitObjects.forEach((obj: any) => {
            console.log(`  - ${obj.constructor.name} draggable=${obj.input?.draggable}`);
          });
        }
        cleanup();
        resolve({ pointerDownFired, pointerMoveFired, hitObjects: hitObjects?.length || 0 });
      }, 2000);
    });
  });

  console.log('Results:', clicked);
  console.log('');

  // Check if blocks are actually interactive
  const blockInputStatus = await page.evaluate(() => {
    const game = (window as any).game;
    const scene = game.scene.scenes[0];
    const blocks = Array.from(scene.blockPool.activeBlocks);

    return blocks.map((block: any) => {
      return {
        id: block.blockData.id,
        hasInput: !!block.input,
        interactive: block.input?.enabled,
        draggable: block.input?.draggable,
        hitArea: block.input?.hitArea ? {
          x: block.input.hitArea.x,
          y: block.input.hitArea.y,
          width: block.input.hitArea.width,
          height: block.input.hitArea.height
        } : null,
        // Check if block is in the scene's input plugin
        inDisplayList: scene.children.exists(block),
        active: block.active,
        visible: block.visible
      };
    });
  });

  console.log('ðŸ“¦ Block Input Status:');
  blockInputStatus.forEach((status: any) => {
    console.log(`\n  ${status.id}:`);
    console.log(`    Has Input: ${status.hasInput}`);
    console.log(`    Interactive: ${status.interactive}`);
    console.log(`    Draggable: ${status.draggable}`);
    console.log(`    Hit Area: ${JSON.stringify(status.hitArea)}`);
    console.log(`    In Display List: ${status.inDisplayList}`);
    console.log(`    Active: ${status.active}`);
    console.log(`    Visible: ${status.visible}`);
  });

  console.log('\n' + '='.repeat(80));
  console.log('âœ… DEBUG TEST COMPLETE\n');
});
