'use client';

import { useEffect, useRef, useState } from 'react';
import type * as PhaserType from 'phaser';
import { createPhaserConfig } from '@/lib/game/phaser/config';
import { MainScene } from '@/lib/game/phaser/scenes/MainScene';
import { phaserDebug } from '@/lib/game/phaser/debug';
import { phaserLogger } from '@/lib/utils/logger';
import type { LevelConfig } from '@/lib/game/levels/levelService';

export interface PhaserCanvasProps {
  level: LevelConfig;
  onScoreUpdate?: (score: number) => void;
  onGameOver?: () => void;
  onLevelComplete?: () => void;
}

export function PhaserCanvas({ level, onScoreUpdate, onGameOver, onLevelComplete }: PhaserCanvasProps) {
  const gameRef = useRef<PhaserType.Game | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [isLoading, setIsLoading] = useState(true);
  const initRef = useRef<boolean>(false);

  useEffect(() => {
    if (!containerRef.current) return;

    // Prevent double initialization in React StrictMode
    if (initRef.current) {
      phaserLogger.debug('Already initialized, skipping');
      return;
    }
    initRef.current = true;

    // Dynamically import Phaser to enable code splitting
    let game: PhaserType.Game;

    phaserLogger.debug('Dynamically importing Phaser...');
    import('phaser')
      .then((Phaser) => {
        phaserLogger.info('Phaser loaded successfully');

        // CRITICAL: Validate level data before initializing game
        if (!level.blocks || level.blocks.length === 0) {
          phaserLogger.error('Invalid level: No blocks defined', { level });
          setIsLoading(false);
          return;
        }

        // Validate each block has proper shape array
        const invalidBlocks = level.blocks.filter(
          block => !block.shape || block.shape.length === 0 || !block.shape[0] || block.shape[0].length === 0
        );

        if (invalidBlocks.length > 0) {
          phaserLogger.error('Invalid block shapes detected', {
            invalidCount: invalidBlocks.length,
            invalidBlocks
          });
          setIsLoading(false);
          return;
        }

        if (!containerRef.current) {
          phaserLogger.error('Container ref lost during Phaser import');
          setIsLoading(false);
          return;
        }

        const containerId = `phaser-game-${Date.now()}`;
        containerRef.current.id = containerId;

        phaserLogger.debug('Creating scene with level data', {
          blocksCount: level.blocks.length,
          levelNumber: level.levelNumber,
          firstBlock: level.blocks[0]
        });

        const sceneData = {
          blocks: level.blocks,
          onScoreUpdate,
          onGameOver,
          onLevelComplete,
        };

        // Create custom MainScene that pre-initializes with data
        class InitializedMainScene extends MainScene {
          constructor() {
            super();
            phaserLogger.debug('InitializedMainScene constructor', {
              blocksCount: sceneData.blocks?.length
            });
            // Set the data directly before Phaser's lifecycle starts
            this['currentBlocks'] = sceneData.blocks || [];
            this['onScoreUpdate'] = sceneData.onScoreUpdate;
            this['onGameOver'] = sceneData.onGameOver;
            this['onLevelComplete'] = sceneData.onLevelComplete;
          }
        }

        // Create Phaser game config
        const config = createPhaserConfig(containerId);
        config.scene = [InitializedMainScene];

        // Initialize game
        game = new Phaser.Game(config);
        gameRef.current = game;

        // Initialize debug helper (exposes window.game, window.Phaser, debug commands)
        phaserDebug.init(game);

        game.events.once('ready', () => {
          phaserLogger.info('Game ready');
          phaserDebug.logGameState();
          setIsLoading(false);
        });
      })
      .catch((error) => {
        phaserLogger.error('Failed to load Phaser', error);
        setIsLoading(false);
      });

    // Proper cleanup for all environments
    return () => {
      phaserLogger.debug('Cleaning up Phaser game instance');
      if (gameRef.current) {
        gameRef.current.destroy(true);
        gameRef.current = null;
      }
      // Clean up window reference
      if (typeof window !== 'undefined' && (window as Window & { game?: PhaserType.Game }).game === game) {
        delete (window as Window & { game?: PhaserType.Game }).game;
      }
    };
  }, [level, onScoreUpdate, onGameOver, onLevelComplete]);

  return (
    <div className="relative w-full flex items-center justify-center">
      {isLoading && (
        <div className="absolute inset-0 flex items-center justify-center bg-gray-100 rounded-lg z-50 pointer-events-none">
          <div className="text-center pointer-events-auto">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"></div>
            <p className="text-gray-600">Loading game...</p>
          </div>
        </div>
      )}
      <div
        ref={containerRef}
        className="rounded-lg overflow-hidden shadow-lg"
        style={{ pointerEvents: 'auto', touchAction: 'none', position: 'relative', zIndex: 1 }}
      />
    </div>
  );
}
