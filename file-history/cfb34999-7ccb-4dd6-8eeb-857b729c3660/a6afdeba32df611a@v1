/**
 * API Request Validation Schemas using Zod
 *
 * Provides type-safe validation for API route parameters and request bodies.
 */

import { z } from 'zod';

// ============================================================================
// Enums
// ============================================================================

export const TierSchema = z.enum(['FREE', 'TRIAL', 'PREMIUM']);

export const SubscriptionStatusSchema = z.enum(['ACTIVE', 'EXPIRED', 'CANCELLED']);

export const AuthProviderSchema = z.enum(['GOOGLE', 'FACEBOOK', 'APPLE']);

// ============================================================================
// Common Schemas
// ============================================================================

/**
 * Schema for level number validation
 * Levels are numbered 1-50
 */
export const LevelNumberSchema = z.number().int().min(1).max(50);

/**
 * Schema for CUID validation (Prisma default ID format)
 */
export const CuidSchema = z.string().cuid();

/**
 * Schema for pagination parameters
 */
export const PaginationSchema = z.object({
  page: z.number().int().min(1).default(1),
  limit: z.number().int().min(1).max(100).default(20),
});

// ============================================================================
// Level API Schemas
// ============================================================================

/**
 * Schema for GET /api/game/levels query parameters
 */
export const GetLevelsQuerySchema = z.object({
  tier: TierSchema.optional(),
  page: z.coerce.number().int().min(1).optional(),
  limit: z.coerce.number().int().min(1).max(100).optional(),
});

/**
 * Schema for GET /api/game/levels/[id] path parameters
 */
export const GetLevelByIdParamsSchema = z.object({
  id: z.string().min(1), // Can be CUID or number
});

/**
 * Validate if a string is a valid level ID (CUID or number)
 */
export function validateLevelId(id: string): { type: 'cuid' | 'number'; value: string | number } {
  // Check if it's a number
  if (/^\d+$/.test(id)) {
    const num = parseInt(id, 10);
    LevelNumberSchema.parse(num);
    return { type: 'number', value: num };
  }

  // Otherwise treat as CUID
  CuidSchema.parse(id);
  return { type: 'cuid', value: id };
}

// ============================================================================
// Game Session API Schemas
// ============================================================================

/**
 * Schema for POST /api/game/sessions (create game session)
 */
export const CreateGameSessionSchema = z.object({
  levelId: CuidSchema,
  userId: CuidSchema,
});

/**
 * Schema for PATCH /api/game/sessions/[id] (update game session)
 */
export const UpdateGameSessionSchema = z.object({
  score: z.number().int().min(0).optional(),
  movesCount: z.number().int().min(0).optional(),
  timeSpent: z.number().int().min(0).optional(),
  completed: z.boolean().optional(),
  sessionData: z.record(z.unknown()).optional(),
});

// ============================================================================
// User/Subscription API Schemas
// ============================================================================

/**
 * Schema for subscription tier check
 */
export const CheckTierAccessSchema = z.object({
  userId: CuidSchema,
  levelNumber: LevelNumberSchema,
});

/**
 * Schema for subscription update
 */
export const UpdateSubscriptionSchema = z.object({
  tier: TierSchema,
  status: SubscriptionStatusSchema.optional(),
  trialEndsAt: z.string().datetime().optional(),
  premiumEndsAt: z.string().datetime().optional(),
  handcashPaymentId: z.string().optional(),
  autoRenew: z.boolean().optional(),
});

// ============================================================================
// Error Response Schemas
// ============================================================================

/**
 * Standard error response format
 */
export const ErrorResponseSchema = z.object({
  error: z.object({
    message: z.string(),
    code: z.string(),
    statusCode: z.number(),
    details: z.record(z.unknown()).optional(),
  }),
});

// ============================================================================
// Helper Functions
// ============================================================================

/**
 * Validate and parse request data with Zod schema
 * Returns parsed data or throws validation error
 */
export function validateRequest<T>(
  schema: z.ZodSchema<T>,
  data: unknown
): T {
  return schema.parse(data);
}

/**
 * Safe validation that returns success/error object
 */
export function safeValidateRequest<T>(
  schema: z.ZodSchema<T>,
  data: unknown
): { success: true; data: T } | { success: false; error: z.ZodError } {
  const result = schema.safeParse(data);

  if (result.success) {
    return { success: true, data: result.data };
  }

  return { success: false, error: result.error };
}

/**
 * Format Zod validation errors for API response
 */
export function formatValidationError(error: z.ZodError) {
  return {
    error: {
      message: 'Validation failed',
      code: 'VALIDATION_ERROR',
      statusCode: 400,
      details: {
        issues: error.errors.map(err => ({
          path: err.path.join('.'),
          message: err.message,
          code: err.code,
        })),
      },
    },
  };
}

// ============================================================================
// Type Exports
// ============================================================================

export type GetLevelsQuery = z.infer<typeof GetLevelsQuerySchema>;
export type GetLevelByIdParams = z.infer<typeof GetLevelByIdParamsSchema>;
export type CreateGameSession = z.infer<typeof CreateGameSessionSchema>;
export type UpdateGameSession = z.infer<typeof UpdateGameSessionSchema>;
export type CheckTierAccess = z.infer<typeof CheckTierAccessSchema>;
export type UpdateSubscription = z.infer<typeof UpdateSubscriptionSchema>;
