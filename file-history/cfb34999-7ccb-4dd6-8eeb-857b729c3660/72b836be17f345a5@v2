# Drag-and-Drop Investigation Report

**Issue:** User reports that after first round, blocks cannot be dragged anymore.

**Date:** 2025-11-02

---

## Investigation Summary

### Tests Performed:

1. **âœ… Autonomous Placement Test** (`complete-game-playthrough.spec.ts`)
   - Used `gameDebug.placeBlockAt()` - bypasses drag-and-drop
   - Result: 100 moves, 5000 score, 25 lines cleared
   - **Limitation:** Does NOT test actual drag-and-drop functionality

2. **âŒ Playwright Mouse Events Test** (`drag-drop-test.spec.ts`)
   - Used `page.mouse.move()`, `page.mouse.down()`, etc.
   - Result: Phaser did NOT recognize these as drag events
   - **Finding:** No "DRAG START" or "POINTER DOWN" logs in console
   - **Conclusion:** Synthetic mouse events don't trigger Phaser's input system

3. **âš ï¸  Simulate Drag Test** (`simulate-drag-test.spec.ts`)
   - Used `gameDebug.simulateDrag()` - triggers Phaser events
   - Result: First block placed âœ…, next 2 blocks failed âŒ
   - **Finding:** "Block returned to original position" - placement validation failed
   - **Note:** Test had logic errors (tried to place all blocks at same position)

---

## Code Analysis

### Block Respawn Flow:

1. Block placed â†’ `onPlacedCallback()` called
2. Block calls `poolCleanupCallback()` â†’ `blockPool.despawn()`
3. Despawn: `setActive(false)`, `setVisible(false)`, add back to pool
4. When all blocks placed: `onAllBlocksPlacedCallback()` â†’ `spawnBlocks()`
5. Spawn: get block from pool â†’ `block.reset(blockData, x, y)`
6. Reset: `setupInteraction()` called âœ…
7. Setup: removes old listeners, creates new hit area, attaches drag events âœ…

### Callbacks Set on Respawn:

âœ… `setPlacedCallback()` - handles placement (BlockPool.ts:66)
âœ… `setGridStateCallback()` - provides grid for collision detection (BlockPool.ts:71)
âœ… `setPoolCleanupCallback()` - handles despawn (BlockPool.ts:75)
âœ… `setupInteraction()` - creates hit area and drag events (Block.ts:86)

### Debug Visualizations:

The code includes extensive debug logging:
- ðŸ”´ **Red borders** drawn around each block's clickable area
- ðŸ–±ï¸  **Console logs** for pointer events: `POINTER DOWN`, `MOUSE OVER`
- ðŸŽ¯ **Drag events** logged: `DRAG START`, `drag`, `dragend`
- âœ… **Placement validation** logged with green/red overlay

---

## Possible Causes

### Theory #1: Input Events Not Firing
- **Symptom:** No console logs when clicking blocks
- **Cause:** `setInteractive()` not working after reset
- **Debug:** Check if red borders are visible, check for console errors

### Theory #2: Hit Area Calculation Wrong
- **Symptom:** Can click but not drag
- **Cause:** Hit area too small or offset incorrectly
- **Debug:** Red borders show exact hit area size/position

### Theory #3: Z-Index/Depth Issue
- **Symptom:** Something covering the blocks
- **Cause:** Another game object at higher depth blocking input
- **Debug:** Check if blocks are visible, try clicking different areas

### Theory #4: Grid State Callback Not Set
- **Symptom:** Blocks always snap back (fail placement validation)
- **Cause:** `this.gridStateCallback` is undefined
- **Debug:** Check console for "No grid state callback" warning

### Theory #5: Timing/Race Condition
- **Symptom:** Blocks spawn but interaction setup fails
- **Cause:** Phaser scene not ready when `setupInteraction()` called
- **Debug:** Check initialization order in console logs

---

## Diagnostic Steps for User

Please open the game at http://localhost:3010/play/1 and perform these steps:

### Step 1: Check Initial Blocks (Before Placing Any)
1. Open browser console (F12)
2. Look at the 3 blocks at the bottom
3. **Question:** Do you see **red borders** around each block?
   - âœ… YES â†’ Interaction is set up correctly
   - âŒ NO â†’ `setupInteraction()` is not being called

### Step 2: Test First Round (Original Blocks)
1. Try to click and drag the first block
2. **Questions:**
   - Do you see console log: `ðŸ–±ï¸ POINTER DOWN`?
   - Do you see console log: `ðŸŽ¯ DRAG START`?
   - Does the block scale up (get bigger) when dragging?
   - Do you see green/red overlay on grid showing valid placement?

### Step 3: Place All 3 Blocks
1. Place all 3 blocks on the grid
2. Wait 1 second for respawn
3. **Question:** Do 3 new blocks appear at the bottom?

### Step 4: Test Second Round (Respawned Blocks)
1. Look at the new blocks
2. **Question:** Do you see **red borders** around the new blocks?
   - âœ… YES â†’ Interaction is set up
   - âŒ NO â†’ **BUG FOUND:** `setupInteraction()` not called on respawn

3. Try to click and drag one of the new blocks
4. **Questions:**
   - Do you see console log: `ðŸ–±ï¸ POINTER DOWN`?
   - Do you see console log: `ðŸŽ¯ DRAG START`?
   - Does the block respond to clicks at all?

### Step 5: Copy Console Logs
1. After attempting Step 4, copy ALL console messages
2. Look for:
   - Any ERROR messages (red)
   - Any "Block RESET called with" messages
   - Any "setupInteraction" or "HIT AREA CALCULATION" messages
   - Any warnings about missing callbacks

---

## Expected Console Output (Normal Behavior)

### On Game Load:
```
[Block.ts] Module loaded - v8 - Fix drag debug graphics to use local coords
[DEBUG] [Phaser] MainScene create() started
[DEBUG] [Phaser] Block RESET called with {id: I, shape: ..., position: ...}
[DEBUG] [Phaser] Block I shape VALIDATED: {rows: 1, cols: 4, ...}
[WARN] [Phaser] [Block I] ðŸ”§ HIT AREA CALCULATION: {calculatedWidth: 120, calculatedHeight: 30}
[ERROR] [Phaser] [Block I] ðŸ”´ RED BORDER DRAWN (local 0,0) size 120x30 at world (100, 480)
```

### When Clicking a Block:
```
[WARN] [Phaser] [Block I] ðŸ–±ï¸ POINTER DOWN at (556, 591)
```

### When Dragging a Block:
```
[WARN] [Phaser] [Block I] ðŸŽ¯ DRAG START at (556, 591)
[DEBUG] [Phaser] Invalid placement detected {blockPos: ..., invalidCells: ...}
```

### After Placing Block (Successful):
```
[DEBUG] [Phaser] onBlockPlaced called {shape: ..., position: ...}
[DEBUG] [Phaser] Placed 4 cells on grid
[INFO] [Phaser] SCORE UPDATE {linesCleared: 0, combo: 0, totalScore: 0}
[DEBUG] [Phaser] Block I placed - despawning
[DEBUG] [Phaser] After despawn {activeBlocksSize: 2}
```

### After All 3 Blocks Placed:
```
[DEBUG] [Phaser] After despawn {activeBlocksSize: 0}
[INFO] [Phaser] All blocks placed, triggering respawn callback
[DEBUG] [Phaser] spawn() called {poolSize: 7, blockData: ...}
[DEBUG] [Phaser] Reusing block from pool
[DEBUG] [Phaser] Block RESET called with {id: O, shape: ...}
[DEBUG] [Phaser] Block O shape VALIDATED: ...
[WARN] [Phaser] [Block O] ðŸ”§ HIT AREA CALCULATION: ...
[ERROR] [Phaser] [Block O] ðŸ”´ RED BORDER DRAWN ...
```

---

## Potential Fix (If Bug Confirmed)

If respawned blocks don't have red borders or don't respond to clicks, the issue is in `Block.reset()` or `setupInteraction()`.

### Fix Option 1: Ensure setupInteraction is called
Add explicit logging to confirm:

```typescript
// In Block.ts reset() method (line 84-87)
if (blockData.shape.length > 0 && blockData.shape[0].length > 0) {
  phaserLogger.error(`ðŸ”§ CALLING setupInteraction for ${blockData.id}`);
  this.setupInteraction();
  phaserLogger.error(`âœ… setupInteraction COMPLETED for ${blockData.id}`);
}
```

### Fix Option 2: Force re-add to scene
If blocks lose scene reference:

```typescript
// In BlockPool.spawn() after reset (line 62-63)
block.setActive(true);
block.setVisible(true);
this.scene.add.existing(block); // Re-add to scene
```

### Fix Option 3: Delay interaction setup
If there's a timing issue:

```typescript
// In Block.reset() (line 86)
this.scene.time.delayedCall(100, () => {
  this.setupInteraction();
});
```

---

## Next Steps

1. User performs diagnostic steps above
2. User provides:
   - Answers to the questions
   - Console log output
   - Whether red borders are visible on respawned blocks
3. Based on findings, apply appropriate fix

---

**Status:** AWAITING USER FEEDBACK

