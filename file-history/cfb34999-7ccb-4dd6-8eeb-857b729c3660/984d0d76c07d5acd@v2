/**
 * TEST: Verify debug mode console output appears
 */

import { test } from '@playwright/test';

test('Verify debug banner and logging system', async ({ page }) => {
  console.log('\nğŸ” VERIFYING DEBUG MODE\n');
  console.log('='.repeat(80));

  test.setTimeout(120000);

  // Capture all console messages
  const consoleLogs: string[] = [];
  page.on('console', msg => {
    consoleLogs.push(msg.text());
  });

  await page.goto('/play/1', { waitUntil: 'networkidle', timeout: 60000 });
  await page.locator('canvas').waitFor({ state: 'visible', timeout: 30000 });
  await page.waitForFunction(() => typeof (window as any).game !== 'undefined', { timeout: 40000 });
  await page.waitForTimeout(8000);

  console.log('âœ… Game loaded\n');

  // Check if debug banner appeared
  const debugBanner = consoleLogs.find(log => log.includes('BLOCK DEBUG MODE ACTIVE'));

  console.log('ğŸ“Š Console Log Analysis:\n');
  console.log(`Total console messages: ${consoleLogs.length}`);
  console.log(`Debug banner found: ${debugBanner ? 'âœ… YES' : 'âŒ NO'}\n`);

  if (debugBanner) {
    console.log('ğŸ‰ DEBUG BANNER DETECTED:\n');
    // Find all related debug lines
    const debugLines = consoleLogs.filter(log =>
      log.includes('BLOCK DEBUG') ||
      log.includes('Block.ts Module loaded') ||
      log.includes('Enhanced debug logging')
    );
    debugLines.forEach(line => console.log(line));
  } else {
    console.log('âš ï¸  Debug banner NOT found in console logs\n');
    console.log('First 10 console messages:');
    consoleLogs.slice(0, 10).forEach((log, idx) => {
      console.log(`  ${idx + 1}. ${log}`);
    });
  }

  console.log('\n' + '='.repeat(80));

  // Now try to get detailed block info to see if logging is set up
  const blockInfo = await page.evaluate(() => {
    const game = (window as any).game;
    const scene = game.scene.scenes[0];
    const blocks = Array.from(scene.blockPool.activeBlocks);

    return blocks.map((block: any) => ({
      id: block.blockData.id,
      hasPointerDownListener: block.listenerCount('pointerdown') > 0,
      hasPointerOverListener: block.listenerCount('pointerover') > 0,
      hasPointerOutListener: block.listenerCount('pointerout') > 0,
      hasDragStartListener: block.listenerCount('dragstart') > 0,
      shape: block.blockData.shape.length + 'x' + (block.blockData.shape[0]?.length || 0),
      position: { x: block.x, y: block.y }
    }));
  });

  console.log('ğŸ“¦ Block Event Listener Status:\n');
  blockInfo.forEach((block: any) => {
    console.log(`Block ${block.id}:`);
    console.log(`  Shape: ${block.shape}`);
    console.log(`  Position: (${block.position.x}, ${block.position.y})`);
    console.log(`  pointerdown listeners: ${block.hasPointerDownListener ? 'âœ…' : 'âŒ'}`);
    console.log(`  pointerover listeners: ${block.hasPointerOverListener ? 'âœ…' : 'âŒ'}`);
    console.log(`  pointerout listeners: ${block.hasPointerOutListener ? 'âœ…' : 'âŒ'}`);
    console.log(`  dragstart listeners: ${block.hasDragStartListener ? 'âœ…' : 'âŒ'}`);
    console.log('');
  });

  console.log('='.repeat(80));
  console.log('âœ… DEBUG MODE VERIFICATION COMPLETE\n');
});
